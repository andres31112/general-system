<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Asistencia y Calificaciones</title>
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profesor/Gestion_LC.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a class="navbar-brand" href="#">
                <div class="logo-circle"></div>
                <h1>Gestión Académica</h1>
            </a>
        </div>
    </nav>
    <div class="page-container">
        <div class="container">
            <main>
                <section class="main-header">
                    <div class="profile-card">
                        <div class="avatar-large">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="profile-info">
                            <h2>{{ current_user.nombre_completo }}</h2>
                            <p>
                                {% if curso %}
                                    {{ curso.sede.nombre }}
                                {% else %}
                                    Sede no asignada
                                {% endif %}
                            </p>
                            <p><strong>Rol:</strong> Profesor</p>
                        </div>
                    </div>
                    <div class="info-cards">
                        <div class="card students-card">
                            <div class="card-body">
                                <p class="card-title">Estudiantes</p>
                                <p class="card-content">{{ estudiantes|length }}</p>
                                <p class="card-footer mb-0 text-muted small">Total de estudiantes</p>
                            </div>
                        </div>
                        <div class="card course-card">
                             <div class="card-body">
                                <p class="fw-bold mb-1">Curso</p>
                                <p class="mb-1">
                                    {% if curso %}
                                        {{ curso.nombreCurso }}
                                    {% else %}
                                        Curso no seleccionado
                                    {% endif %}
                                </p>
                                <p class="mb-0 text-muted small">
                                    {% if curso and curso.sede %}
                                        Sede: {{ curso.sede.nombre }}
                                    {% endif %}
                                </p>
                             </div>
                        </div>
                    </div>
                </section>

                <!-- Alerta si no hay curso seleccionado -->
                {% if not curso %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Primero debes <a href="{{ url_for('profesor.seleccionar_curso') }}" class="alert-link">seleccionar un curso</a> para gestionar asistencias y calificaciones.
                </div>
                {% endif %}

                <nav class="content-tabs">
                    <a id="attendance-tab" class="tab-link active">Asistencia</a>
                    <a id="grades-tab" class="tab-link">Calificaciones</a>
                </nav>

                <div id="attendance-content">
                    <!-- Monthly List View (Default) -->
                    <section id="monthly-view" class="content-section">
                        <div class="attendance-header">
                            <div class="month-navigation">
                                <button id="prev-month-btn" class="nav-btn"><i class="fas fa-chevron-left"></i></button>
                                <h2 id="month-year-display"></h2>
                                <button id="next-month-btn" class="nav-btn"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="controls">
                               <button id="go-to-today-btn" class="save-button">Tomar Asistencia de Hoy</button>
                            </div>
                        </div>
                        
                        <!-- Información del curso para JavaScript -->
                        <div id="course-data" 
                             data-curso-id="{{ curso.id if curso else '' }}"
                             data-profesor-id="{{ current_user.id_usuario }}"
                             style="display: none;">
                        </div>

                        <div class="monthly-list-container">
                            <table class="monthly-grid-table">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Daily Attendance View (Hidden by default) -->
                    <section id="daily-view" class="content-section" style="display: none;">
                        <div class="attendance-header">
                            <h2 id="daily-view-title">Asistencia</h2>
                            <div class="controls">
                                <button id="back-to-monthly-btn" class="back-button">Volver al Mes</button>
                            </div>
                        </div>

                        <div class="summary-cards">
                            <div class="summary-card present">
                                <span class="count" id="present-count">0</span>
                                <span>Presentes</span>
                            </div>
                            <div class="summary-card absent">
                                <span class="count" id="absent-count">0</span>
                                <span>Ausentes</span>
                            </div>
                            <div class="summary-card late">
                                <span class="count" id="late-count">0</span>
                                <span>Tardes</span>
                            </div>
                        </div>

                        <div class="student-list">
                            {% if estudiantes %}
                                {% for estudiante in estudiantes %}
                                <div class="student-row" data-student-id="{{ estudiante.id_usuario }}">
                                    <div class="student-info">
                                        <span class="student-name">{{ estudiante.nombre }} {{ estudiante.apellido }}</span>
                                        <span class="student-id">{{ estudiante.no_identidad }}</span>
                                    </div>
                                    <div class="attendance-actions">
                                        <button class="attendance-btn present" data-status="presente">
                                            <i class="fas fa-check"></i> Presente
                                        </button>
                                        <button class="attendance-btn absent" data-status="ausente">
                                            <i class="fas fa-times"></i> Ausente
                                        </button>
                                        <button class="attendance-btn late" data-status="tardanza">
                                            <i class="fas fa-clock"></i> Tarde
                                        </button>
                                        <button class="attendance-btn justified" data-status="justificado">
                                            <i class="fas fa-file-medical"></i> Justificado
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="no-students">
                                    <i class="fas fa-users-slash"></i>
                                    <p>No hay estudiantes en este curso</p>
                                </div>
                            {% endif %}
                        </div>

                        <div class="save-footer">
                            <button id="save-daily-attendance-btn" class="save-button" 
                                    {% if not estudiantes %}disabled{% endif %}>
                                Guardar Asistencia <i class="fas fa-check-circle"></i>
                            </button>
                        </div>
                    </section>
                </div>

                <div id="grades-content" style="display: none;">
                    <section class="content-section">
                        <div class="grades-summary-cards">
                            <div class="grades-summary-card">
                                <div id="lowest-grade" class="value">0</div>
                                <div class="label">Calificación Más Baja</div>
                            </div>
                            <div class="grades-summary-card">
                                <div id="highest-grade" class="value">0</div>
                                <div class="label">Calificación Más Alta</div>
                            </div>
                            <div class="grades-summary-card">
                                <div id="average-grade" class="value">0</div>
                                <div class="label">Promedio de Clase</div>
                            </div>
                        </div>
                        
                        <div class="grades-actions">
                            <div class="grades-settings">
                                <label for="subject-select">Asignatura:</label>
                                <select id="subject-select">
                                    <option value="">Todas las asignaturas</option>
                                    {% if asignaturas %}
                                        {% for asignatura in asignaturas %}
                                        <option value="{{ asignatura.id }}">{{ asignatura.nombre }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                
                                <label for="category-select">Categoría:</label>
                                <select id="category-select">
                                    <option value="">Todas las categorías</option>
                                    {% if categorias %}
                                        {% for categoria in categorias %}
                                        <option value="{{ categoria.id }}">{{ categoria.nombre }} ({{ categoria.porcentaje }}%)</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            <div>
                                <button id="generate-report-btn" class="back-button">Generar Reporte</button>
                                <button id="export-grades-btn" class="back-button">Exportar</button>
                                <button id="add-grade-btn" class="save-button">Añadir Calificación</button>
                            </div>
                        </div>
                        
                        <div class="grades-table-container">
                            {% if estudiantes %}
                            <table class="grades-table">
                                <thead>
                                    <tr>
                                        <th>Estudiante</th>
                                        <th>Identificación</th>
                                        {% if asignaturas %}
                                            {% for asignatura in asignaturas %}
                                            <th>{{ asignatura.nombre }}</th>
                                            {% endfor %}
                                        {% endif %}
                                        <th>Promedio</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for estudiante in estudiantes %}
                                    <tr data-student-id="{{ estudiante.id_usuario }}">
                                        <td>{{ estudiante.nombre }} {{ estudiante.apellido }}</td>
                                        <td>{{ estudiante.no_identidad }}</td>
                                        {% if asignaturas %}
                                            {% for asignatura in asignaturas %}
                                            <td class="grade-cell" data-student-id="{{ estudiante.id_usuario }}" data-subject-id="{{ asignatura.id }}">
                                                {% set grade_found = false %}
                                                {% for calificacion in calificaciones %}
                                                    {% if calificacion.estudianteId == estudiante.id_usuario and calificacion.asignaturaId == asignatura.id %}
                                                        {{ calificacion.valor }}
                                                        {% set grade_found = true %}
                                                    {% endif %}
                                                {% endfor %}
                                                {% if not grade_found %}-{% endif %}
                                            </td>
                                            {% endfor %}
                                        {% endif %}
                                        <td class="average-grade">-</td>
                                        <td>
                                            <button class="btn-grade-edit" data-student-id="{{ estudiante.id_usuario }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <div class="no-data">
                                <i class="fas fa-graduation-cap"></i>
                                <p>No hay estudiantes en este curso</p>
                            </div>
                            {% endif %}
                        </div>
                    </section>
                </div>

            </main>
        </div>
    </div>
    
    <!-- Custom Modals -->
    <div id="alertModal" class="modal-overlay">
        <div class="modal-content">
            <h5 class="modal-title">Notificación</h5>
            <p id="alertModalBody"></p>
            <div class="modal-footer">
                <button id="alertModalAcceptBtn" class="save-button">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="gradeModal" class="modal-overlay">
        <div class="modal-content">
            <h5 id="gradeModalTitle" class="modal-title">Registrar Calificación</h5>
            <div class="modal-body">
                <div class="form-group">
                    <label for="gradeStudent">Estudiante:</label>
                    <select id="gradeStudent" class="modal-input">
                        {% for estudiante in estudiantes %}
                        <option value="{{ estudiante.id_usuario }}">{{ estudiante.nombre }} {{ estudiante.apellido }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="gradeSubject">Asignatura:</label>
                    <select id="gradeSubject" class="modal-input">
                        {% for asignatura in asignaturas %}
                        <option value="{{ asignatura.id }}">{{ asignatura.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="gradeCategory">Categoría:</label>
                    <select id="gradeCategory" class="modal-input">
                        {% for categoria in categorias %}
                        <option value="{{ categoria.id }}">{{ categoria.nombre }} ({{ categoria.porcentaje }}%)</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="gradeValue">Calificación:</label>
                    <input type="number" id="gradeValue" class="modal-input" min="0" max="100" step="0.1">
                </div>
                <div class="form-group">
                    <label for="gradeObservations">Observaciones:</label>
                    <textarea id="gradeObservations" class="modal-input" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="gradeModalCancelBtn" class="back-button">Cancelar</button>
                <button id="gradeModalConfirmBtn" class="save-button">Guardar</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h5 class="modal-title">Confirmar Acción</h5>
            <p id="confirmModalBody"></p>
            <div class="modal-footer">
                <button id="confirmModalCancelBtn" class="back-button">Cancelar</button>
                <button id="confirmModalConfirmBtn" class="save-button">Confirmar</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/profesor/Gestion_LC.js') }}"></script>
</body>
</html>