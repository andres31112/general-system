<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Asistencia y Calificaciones</title>
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --color-primario: #0078ad;
            --color-primario-oscuro: #00628e;
            --color-texto-principal: #2c3e50;
            --color-texto-secundario: #7f8c8d;
            --color-blanco: #FFFFFF;
            --color-fondo-seccion: #f8f9fa;
            --color-borde-suave: #ecf0f1;
            --color-presente: #28a745;
            --color-ausente: #dc3545;
            --color-ausente-claro: #f8d7da;
            --color-tarde: #ffc107;
            --color-hoy: #ffc107;
        }

        /* --- General Styles --- */
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--color-fondo-seccion);
            margin: 0;
            color: var(--color-texto-principal);
        }

        /* --- Navbar --- */
        .navbar {
            background-color: var(--color-blanco);
            border-bottom: 1px solid var(--color-borde-suave);
            box-shadow: 0 .125rem .25rem rgba(0,0,0,.08);
            padding: 10px 30px;
            position: sticky;
            top: 0;
            z-index: 1020;
            display: flex;
            justify-content: center;
        }

        .navbar-container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            text-decoration: none;
            gap: 0.75rem;
        }

        .navbar-brand .logo-circle {
            width: 30px;
            height: 30px;
            background-color: var(--color-primario);
            border-radius: 50%;
        }

        .navbar-brand h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-texto-principal);
            margin: 0;
        }
        
        .page-container {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .container {
            width: 100%;
            max-width: 1200px;
        }

        /* --- Main Content --- */
        main {
            padding: 20px 50px;
        }

        .main-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            margin-top: 20px;
        }

        .profile-card {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .avatar-large {
            width: 90px;
            height: 90px;
            background-color: var(--color-borde-suave);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5em;
            color: var(--color-texto-secundario);
        }

        .profile-info h2 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 700;
            color: var(--color-texto-principal);
        }

        .profile-info p {
            margin: 5px 0;
            color: var(--color-texto-secundario);
        }

        .info-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .card {
            background-color: var(--color-blanco);
            border: 1px solid var(--color-borde-suave);
            border-radius: 0.75rem;
            padding: 15px;
            min-width: 220px;
            box-shadow: 0 2px 5px rgba(0,0,0,.05);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 10px rgba(0,0,0,.1);
        }

        .students-card .card-title {
            margin: 0;
            color: var(--color-texto-secundario);
            font-weight: 600;
        }

        .students-card .card-content {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--color-texto-principal);
            margin: 10px 0;
        }

        .students-card .card-footer {
            margin: 0;
            color: var(--color-texto-secundario);
        }

        .course-card {
            padding: 20px;
        }
        .course-card p {
            margin: 5px 0;
        }

        /* --- Content Tabs --- */
        .content-tabs {
            margin-top: 30px;
            border-bottom: 1px solid var(--color-borde-suave);
        }

        .tab-link {
            text-decoration: none;
            color: var(--color-texto-secundario);
            padding: 10px 20px;
            display: inline-block;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s;
        }

        .tab-link.active, .tab-link:hover {
            color: var(--color-primario);
            border-bottom: 3px solid var(--color-primario);
        }

        /* --- Attendance & Grades Section --- */
        .content-section {
            background-color: var(--color-blanco);
            border: 1px solid var(--color-borde-suave);
            border-radius: 0.75rem;
            margin-top: 20px;
            padding: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,.05);
        }
        
        .attendance-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .attendance-header h2 {
            margin: 0;
            font-size: 1.5rem;
            flex-shrink: 0;
            color: var(--color-texto-principal);
        }
        
        .month-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            flex-grow: 1;
        }

        .month-navigation .nav-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--color-primario);
            cursor: pointer;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }
        
        .back-button {
            padding: 9px 20px;
            background-color: var(--color-fondo-seccion);
            border: 1px solid var(--color-borde-suave);
            border-radius: 0.5rem;
            font-weight: 600;
            color: var(--color-texto-principal);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .back-button:hover {
            background-color: #e9ecef;
        }

        /* --- Summary Cards --- */
        .summary-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }

        .summary-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            border-radius: 0.75rem;
            background-color: var(--color-fondo-seccion);
            border: 1px solid var(--color-borde-suave);
            font-weight: 600;
        }
        .summary-card .count {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .summary-card.present .count { color: var(--color-presente); }
        .summary-card.absent .count { color: var(--color-ausente); }
        .summary-card.late .count { color: var(--color-tarde); }

        /* --- Monthly List View --- */
        .monthly-list-container {
            overflow-x: auto;
        }
        .monthly-grid-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        .monthly-grid-table th, .monthly-grid-table td {
            border: 1px solid var(--color-borde-suave);
            text-align: center;
            padding: 5px;
        }
        .monthly-grid-table thead th {
            padding: 10px 5px;
            font-weight: 700;
            background-color: var(--color-fondo-seccion);
            position: sticky;
            top: 0;
        }
        .monthly-grid-table th.student-name-header {
            text-align: left;
            min-width: 200px;
            position: sticky;
            left: 0;
            z-index: 2;
        }
        .monthly-grid-table td.student-name-cell {
            text-align: left;
            font-weight: 600;
            position: sticky;
            left: 0;
            background-color: var(--color-blanco);
            z-index: 1;
            transition: background-color 0.3s;
        }
        .monthly-grid-table tr.highlight-absentee td.student-name-cell {
            background-color: var(--color-ausente-claro);
            color: var(--color-ausente);
        }
        .monthly-grid-table th.day-header {
            min-width: 40px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .monthly-grid-table th.day-header:hover {
            background-color: var(--color-primario);
            color: var(--color-blanco);
        }
        .monthly-grid-table th.today {
            background-color: var(--color-hoy);
            color: var(--color-texto-principal);
        }
        .monthly-grid-table .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin: auto;
            position: relative;
        }
        .status-indicator.present { background-color: var(--color-presente); }
        .status-indicator.absent { background-color: var(--color-ausente); }
        .status-indicator.late { background-color: var(--color-tarde); }
        
        .excuse-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background-color: var(--color-primario);
            border-radius: 50%;
            border: 1px solid var(--color-blanco);
        }

        /* --- Daily Student List --- */
        .student-list {
            margin-top: 25px;
            overflow-x: auto;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            color: var(--color-texto-secundario);
            font-weight: 600;
            padding: 0 20px 10px 20px;
            border-bottom: 2px solid var(--color-borde-suave);
            min-width: 650px;
        }

        .student-name-header-daily {
            flex-basis: 40%;
        }
        
        .attendance-status-header {
            flex-basis: 60%;
            text-align: left;
            padding-left: 10px;
        }

        .student-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--color-borde-suave);
            min-width: 650px;
        }

        .student-row:last-child {
            border-bottom: none;
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-basis: 40%;
        }

        .avatar-small {
            width: 35px;
            height: 35px;
            background-color: var(--color-borde-suave);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: var(--color-texto-secundario);
            flex-shrink: 0;
        }

        .attendance-controls {
            display: flex;
            gap: 10px;
            flex-basis: 60%;
            justify-content: flex-start;
            align-items: center;
        }

        .status-btn {
            padding: 6px 18px;
            border-radius: 15px;
            border: 1px solid var(--color-borde-suave);
            background-color: var(--color-blanco);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--color-texto-secundario);
        }

        .status-btn:hover {
            background-color: var(--color-fondo-seccion);
            border-color: #d4d9db;
        }

        .status-btn.selected.present { background-color: var(--color-presente); border-color: var(--color-presente); color: var(--color-blanco); }
        .status-btn.selected.absent { background-color: var(--color-ausente); border-color: var(--color-ausente); color: var(--color-blanco); }
        .status-btn.selected.late { background-color: var(--color-tarde); border-color: var(--color-tarde); color: var(--color-texto-principal); }

        .excuse-container {
            display: flex;
            align-items: center;
            margin-left: 15px;
            transition: opacity 0.3s ease;
        }
        .excuse-label {
            font-weight: 600;
            color: var(--color-texto-secundario);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .excuse-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* --- Grades Section --- */
        .grades-summary-cards {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }
        .grades-summary-card {
            border: 1px solid var(--color-borde-suave);
            padding: 15px;
            border-radius: 0.75rem;
            text-align: center;
            flex: 1;
            min-width: 150px;
        }
        .grades-summary-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-primario);
        }
        .grades-summary-card .label {
            color: var(--color-texto-secundario);
            font-weight: 600;
        }
        .grades-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .grades-settings {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .grades-settings label {
            font-weight: 600;
        }
        .grades-settings input {
            width: 60px;
            padding: 4px 8px;
            border-radius: 0.5rem;
            border: 1px solid var(--color-borde-suave);
        }
        .grades-table-container {
            overflow-x: auto;
        }
        .grades-table {
            width: 100%;
            min-width: 900px;
            border-collapse: collapse;
        }
        .grades-table th, .grades-table td {
            border: 1px solid var(--color-borde-suave);
            padding: 8px 12px;
            text-align: center;
            vertical-align: middle;
        }
        .grades-table thead th {
            background-color: var(--color-fondo-seccion);
            font-weight: 700;
        }
        .grades-table .student-name-cell {
            text-align: left;
            font-weight: 600;
        }
        .grades-table tr.failing-student td.student-name-cell, .grades-table .average-cell.failing {
            color: var(--color-ausente);
            font-weight: 700;
        }
        .grades-table tr.failing-student td.student-name-cell {
            background-color: var(--color-ausente-claro);
        }
        .grades-table input.grade-input {
            width: 50px;
            border: 1px solid transparent;
            text-align: center;
            border-radius: 4px;
            padding: 4px;
        }
        .grades-table input.grade-input:focus {
            outline: none;
            border-color: var(--color-primario);
            background-color: #eef;
        }
        .grades-table .assignment-actions i {
            cursor: pointer;
            margin: 0 4px;
            color: var(--color-texto-secundario);
            transition: color 0.2s;
        }
        .grades-table .assignment-actions i:hover {
            color: var(--color-primario);
        }
        .grades-table .delete-assignment-icon:hover {
            color: var(--color-ausente);
        }

        /* --- Footer Action --- */
        .save-footer {
            text-align: right;
            margin-top: 25px;
        }

        .save-button {
            background-color: var(--color-primario);
            color: var(--color-blanco);
            border: none;
            padding: 12px 25px;
            border-radius: 0.5rem;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .save-button:hover {
            background-color: var(--color-primario-oscuro);
        }

        .save-button i {
            margin-left: 8px;
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999 !important;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            pointer-events: none;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        .modal-content {
            background-color: var(--color-blanco);
            padding: 25px;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0,0,0,.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s;
            position: relative;
            z-index: 100000 !important;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        .modal-title {
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 700;
            color: var(--color-texto-principal);
        }
        .modal-content p {
            margin-bottom: 25px;
        }
        .modal-footer {
            text-align: center;
        }
        .modal-input {
            width: 100%;
            padding: 8px;
            border-radius: 0.5rem;
            border: 1px solid var(--color-borde-suave);
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <!-- Left action: volver al inicio -->
            <div class="left-actions">
                <a href="/profesor/dashboard" class="back-button" style="margin-right:10px;">&larr; Volver al inicio</a>
            </div>
            <a class="navbar-brand" href="#">
                <div class="logo-circle"></div>
                <h1>Gestión Académica</h1>
            </a>
        </div>
    </nav>
    <div class="page-container">
        <div class="container">
            <main>
                <section class="main-header">
                    <div class="profile-card">
                        <div class="avatar-large">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="profile-info">
                            <h2 id="professor-name">Nombre Profesor</h2>
                            <p id="professor-campus">Sede Correspondiente</p>
                            <p><strong>Rol:</strong> Profesor</p>
                        </div>
                    </div>
                    <div class="info-cards">
                        <div class="card students-card">
                            <div class="card-body">
                                <p class="card-title">Estudiantes</p>
                                <p class="card-content" id="total-students">5</p>
                                <p class="card-footer mb-0 text-muted small">Total de estudiantes</p>
                            </div>
                        </div>
                        <div class="card course-card">
                             <div class="card-body">
                                <p class="fw-bold mb-1">Curso</p>
                                <p class="mb-1" id="course-info">702 - Director de Curso: Juan Pérez</p>
                                <p class="mb-0 text-muted small" id="course-representative">Representante de curso: Cielo Rubio</p>
                             </div>
                        </div>
                    </div>
                </section>

                <nav class="content-tabs">
                    <a id="attendance-tab" class="tab-link active">Asistencia</a>
                    <a id="grades-tab" class="tab-link">Calificaciones</a>
                </nav>

                <div id="attendance-content">
                    <!-- Monthly List View (Default) -->
                    <section id="monthly-view" class="content-section">
                        <div class="attendance-header">
                            <div class="month-navigation">
                                <button id="prev-month-btn" class="nav-btn"><i class="fas fa-chevron-left"></i></button>
                                <h2 id="month-year-display"></h2>
                                <button id="next-month-btn" class="nav-btn"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="controls">
                               <button id="go-to-today-btn" class="save-button">Tomar Asistencia de Hoy</button>
                            </div>
                        </div>
                        <div class="monthly-list-container">
                            <table class="monthly-grid-table">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Daily Attendance View (Hidden by default) -->
                    <section id="daily-view" class="content-section" style="display: none;">
                        <div class="attendance-header">
                            <h2 id="daily-view-title">Asistencia</h2>
                            <div class="controls">
                                <button id="back-to-monthly-btn" class="back-button">Volver al Mes</button>
                            </div>
                        </div>

                        <div class="summary-cards">
                            <div class="summary-card present">
                                <span class="count" id="present-count">0</span>
                                <span>Presentes</span>
                            </div>
                            <div class="summary-card absent">
                                <span class="count" id="absent-count">0</span>
                                <span>Ausentes</span>
                            </div>
                            <div class="summary-card late">
                                <span class="count" id="late-count">0</span>
                                <span>Tardes</span>
                            </div>
                        </div>

                        <div class="student-list">
                            <!-- Student Rows will be populated by JS -->
                        </div>

                        <div class="save-footer">
                            <button id="save-daily-attendance-btn" class="save-button">Guardar Asistencia <i class="fas fa-check-circle"></i></button>
                        </div>
                    </section>
                </div>

                <div id="grades-content" style="display: none;">
                    <section class="content-section">
                        <div class="grades-summary-cards">
                            <div class="grades-summary-card">
                                <div id="lowest-grade" class="value">0</div>
                                <div class="label">Calificación Más Baja</div>
                            </div>
                            <div class="grades-summary-card">
                                <div id="highest-grade" class="value">0</div>
                                <div class="label">Calificación Más Alta</div>
                            </div>
                            <div class="grades-summary-card">
                                <div id="average-grade" class="value">0</div>
                                <div class="label">Promedio de Clase</div>
                            </div>
                        </div>
                        <div class="grades-actions">
                             <div class="grades-settings">
                                <label for="min-grade">Nota Mín:</label>
                                <input type="number" id="min-grade" value="0">
                                <label for="max-grade">Nota Máx:</label>
                                <input type="number" id="max-grade" value="100">
                                <label for="passing-grade">Nota Aprob:</label>
                                <input type="number" id="passing-grade" value="60">
                            </div>
                           <div id="categoriesPctWarningInline" style="display:none;margin-left:18px;margin-top:6px;color:#b71c1c;font-weight:700;">haz pasado el 100% reduce porcentajes</div>
                            <div id="categories-list" style="display:inline-block; margin-left:18px; vertical-align: middle;"></div>
                            <div>
                                <button id="generate-report-btn" class="back-button">Generar Reporte</button>
                                <button id="manage-categories-btn" class="back-button">Categorias</button>
                                <button id="add-assignment-btn" class="save-button">Añadir Asignación</button>
                            </div>
                        </div>
                        <div class="grades-table-container">
                            <table class="grades-table">
                                <thead>
                                    <!-- Headers generated by JS -->
                                </thead>
                                <tbody>
                                    <!-- Grade rows will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Custom Modals -->
    <div id="alertModal" class="modal-overlay">
        <div class="modal-content">
            <h5 class="modal-title">Notificación</h5>
            <p id="alertModalBody"></p>
            <div class="modal-footer">
                <button id="alertModalAcceptBtn" class="save-button">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="promptModal" class="modal-overlay">
        <div class="modal-content">
            <h5 id="promptModalTitle" class="modal-title"></h5>
            <p id="promptModalBody"></p>
            <input type="text" id="promptModalInput" class="modal-input">
            <div class="modal-footer">
                <button id="promptModalCancelBtn" class="back-button">Cancelar</button>
                <button id="promptModalConfirmBtn" class="save-button">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h5 class="modal-title">Confirmar Acción</h5>
            <p id="confirmModalBody"></p>
            <div class="modal-footer">
                <button id="confirmModalCancelBtn" class="back-button">Cancelar</button>
                <button id="confirmModalConfirmBtn" class="save-button">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal para crear/editar categoría -->
    <div id="categoryModal" class="modal-overlay">
        <div class="modal-content">
            <h5 class="modal-title">Crear Categoría</h5>
            <p id="categoryModalBody">Rellena los datos de la categoría</p>
            <div id="categoryPctWarning" style="display:none;margin-top:6px;color:#b71c1c;font-weight:700;">haz pasado el 100% reduce porcentajes</div>
            <div id="categoryListContainer" style="text-align:left; margin-bottom:12px; max-height:160px; overflow:auto; border:1px solid var(--color-borde-suave); padding:8px; border-radius:6px; background:#fff;">
                <!-- Lista de categorías con editar/eliminar se renderiza aquí -->
            </div>
            <input type="text" id="categoryNameInput" class="modal-input" placeholder="Nombre de la categoría">
            <input type="color" id="categoryColorInput" class="modal-input" style="height:40px; padding:4px;">
            <input type="number" id="categoryPctInput" class="modal-input" placeholder="Porcentaje (ej. 20)">
            <div class="modal-footer">
                <button id="categoryModalCancelBtn" class="back-button">Cancelar</button>
                <button id="categoryModalConfirmBtn" class="save-button">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para crear asignación -->
    <div id="assignmentModal" class="modal-overlay">
        <div class="modal-content">
            <h5 class="modal-title">Nueva Asignación</h5>
            <p id="assignmentModalBody">Introduce el nombre y selecciona la categoría</p>
            <input type="text" id="assignmentNameInput" class="modal-input" placeholder="Nombre de la asignación">
            <select id="assignmentCategorySelect" class="modal-input" style="height:40px;padding:6px;"></select>
            <div class="modal-footer">
                <button id="assignmentModalCancelBtn" class="back-button">Cancelar</button>
                <button id="assignmentModalConfirmBtn" class="save-button">Crear</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- MÓDULO DE UTILIDADES (MODALES Y VISTAS) ---
    const UI = (() => {
        const attendanceTab = document.getElementById('attendance-tab');
        const gradesTab = document.getElementById('grades-tab');
        const attendanceContent = document.getElementById('attendance-content');
        const gradesContent = document.getElementById('grades-content');

        const alertModal = document.getElementById('alertModal');
        const alertModalBody = document.getElementById('alertModalBody');
        const promptModal = document.getElementById('promptModal');
        const confirmModal = document.getElementById('confirmModal');

        const switchView = (activeTab, activeContent, inactiveTab, inactiveContent) => {
            activeTab.classList.add('active');
            inactiveTab.classList.remove('active');
            activeContent.style.display = 'block';
            inactiveContent.style.display = 'none';
        };

        // track overlays we temporarily hide so we can restore them
        let _temporarilyHiddenOverlays = [];

        const showModal = (modal, setup) => {
            if (!modal) return;
            // Reparent to body so it is outside other stacking contexts
            try { if (modal.parentNode !== document.body) document.body.appendChild(modal); } catch (e) { /* ignore */ }

            // Compute maximum z-index used in the page to ensure our modal is above it
            let maxZ = 0;
            try {
                const els = document.querySelectorAll('body *');
                els.forEach(el => {
                    const z = window.getComputedStyle(el).getPropertyValue('z-index');
                    const zi = parseInt(z, 10);
                    if (!isNaN(zi)) maxZ = Math.max(maxZ, zi);
                });
            } catch (err) {
                maxZ = 10000;
            }

            const overlayZ = Math.max(10000, maxZ + 10);
            const contentZ = overlayZ + 10;

            // Apply overlay and content styles
            modal.style.zIndex = String(overlayZ);
            modal.style.pointerEvents = 'auto';
            const content = modal.querySelector('.modal-content');
            if (content) {
                content.style.position = 'fixed';
                content.style.zIndex = String(contentZ);
                // center
                content.style.top = '50%';
                content.style.left = '50%';
                content.style.transform = 'translate(-50%, -50%)';
            }

            // Before showing, temporarily hide other visible modal overlays to avoid stacking/interaction issues
            try {
                _temporarilyHiddenOverlays = Array.from(document.querySelectorAll('.modal-overlay.show')).filter(m => m !== modal);
                _temporarilyHiddenOverlays.forEach(m => {
                    m.dataset._wasShown = '1';
                    m.classList.remove('show');
                    m.style.display = 'none';
                });
            } catch (e) { _temporarilyHiddenOverlays = []; }

            setup();
            modal.classList.add('show');
        };

        const hideModal = (modal) => {
            modal.classList.remove('show');
            try {
                // Reset inline styles we may have set
                modal.style.zIndex = '';
                modal.style.pointerEvents = '';
                const content = modal.querySelector('.modal-content');
                if (content) {
                    content.style.position = '';
                    content.style.zIndex = '';
                    content.style.top = '';
                    content.style.left = '';
                    content.style.transform = '';
                }
            } catch (err) { /* ignore */ }

            // restore any overlays we temporarily hid
            try {
                if (_temporarilyHiddenOverlays && _temporarilyHiddenOverlays.length > 0) {
                    _temporarilyHiddenOverlays.forEach(m => {
                        try {
                            m.style.display = '';
                            if (m.dataset._wasShown) {
                                m.classList.add('show');
                                delete m.dataset._wasShown;
                            }
                        } catch (e) { /* ignore */ }
                    });
                    _temporarilyHiddenOverlays = [];
                }
            } catch (e) { /* ignore */ }
        };

        const showAlert = (message) => {
            showModal(alertModal, () => {
                alertModalBody.innerHTML = message.replace(/\n/g, '<br>');
                document.getElementById('alertModalAcceptBtn').onclick = () => hideModal(alertModal);
            });
        };

        const showPrompt = (title, body, callback) => {
            showModal(promptModal, () => {
                promptModal.querySelector('#promptModalTitle').textContent = title;
                promptModal.querySelector('#promptModalBody').textContent = body;
                const input = promptModal.querySelector('#promptModalInput');
                input.value = '';

                const confirmBtn = promptModal.querySelector('#promptModalConfirmBtn');
                const cancelBtn = promptModal.querySelector('#promptModalCancelBtn');
                confirmBtn.onclick = () => { hideModal(promptModal); callback(input.value); };
                cancelBtn.onclick = () => { hideModal(promptModal); callback(null); };
            });
        };

        const showConfirm = (body, callback) => {
            showModal(confirmModal, () => {
                confirmModal.querySelector('#confirmModalBody').textContent = body;
                const confirmBtn = confirmModal.querySelector('#confirmModalConfirmBtn');
                const cancelBtn = confirmModal.querySelector('#confirmModalCancelBtn');
                confirmBtn.onclick = () => { hideModal(confirmModal); callback(true); };
                cancelBtn.onclick = () => { hideModal(confirmModal); callback(false); };
            });
        };

        return { switchView, showAlert, showPrompt, showConfirm, attendanceTab, gradesTab, attendanceContent, gradesContent };
    })();

    // --- DATOS GLOBALES ---
    // Si el servidor inyectó datos en window.SERVER_DATA, inicializarlos desde allí.
    let students = (window.SERVER_DATA && Array.isArray(window.SERVER_DATA.estudiantes)) ?
        window.SERVER_DATA.estudiantes.map(s => ({ id: s.id, name: ((s.nombre || '') + ' ' + (s.apellido || '')).trim(), grades: [] })) :
        [
            { id: 'AS', name: 'Alice Smith', grades: [] },
            { id: 'BJ', name: 'Bob Johnson', grades: [] },
            { id: 'CB', name: 'Charlie Brown', grades: [] },
            { id: 'DP', name: 'Diana Prince', grades: [] },
            { id: 'EH', name: 'Ethan Hunt', grades: [] },
        ];

    // assignmentMeta: [{ name, categoria_id, color, porcentaje }]
    let assignmentMeta = [];
    let categoriesMap = {}; // id -> {id, nombre, color, porcentaje}
    let attendanceData = {};
    let professorData = {};
    let courseData = {};

    // Debounce helper
    function debounce(fn, wait) {
        let t;
        return function(...args) {
            clearTimeout(t);
            t = setTimeout(() => fn.apply(this, args), wait);
        };
    }

    // Función global para renderizar la lista de categorías (usable desde DataLoader)
    function renderCategoriesList() {
        const container = document.getElementById('categories-list');
        if (!container) return;
        const cats = Object.values(categoriesMap || {});
        if (!cats || cats.length === 0) {
            container.innerHTML = '<small>No hay categorías</small>';
            return;
        }
        container.innerHTML = cats.map(c => {
            const color = c.color || '#cccccc';
            const name = c.nombre || 'Sin nombre';
            const pct = (c.porcentaje !== undefined && c.porcentaje !== null) ? `${c.porcentaje}%` : '';
            return `<div style="display:inline-flex;align-items:center;margin-right:8px;font-size:0.9em;"><span style="width:14px;height:14px;background:${color};display:inline-block;border-radius:3px;margin-right:6px;border:1px solid rgba(0,0,0,0.05);"></span><span>${name} ${pct}</span></div>`;
        }).join('');
    }

    // Normalizar array de categorías (acepta distintos nombres de campos)
    function normalizeCategoriesArray(arr) {
        if (!Array.isArray(arr)) return [];
        return arr.map(c => {
            const id = c.id || c.id_categoria || c.idCategoria || null;
            return {
                id: id,
                nombre: c.nombre || c.name || '',
                color: c.color || c.colour || '#cccccc',
                porcentaje: parseFloat(c.porcentaje || c.pct || c.percentage || 0) || 0
            };
        });
    }

    // --- FUNCIONES PARA CARGAR DATOS ---
    const DataLoader = (() => {
        const loadProfessorData = async () => {
            // Preferir datos inyectados por el servidor
            if (window.SERVER_DATA && window.SERVER_DATA.profesor) {
                professorData = {
                    name: window.SERVER_DATA.profesor.nombre || 'Profesor',
                    campus: window.SERVER_DATA.profesor.sede || 'N/A'
                };
            } else {
                professorData = { name: 'Nombre Profesor', campus: 'Sede Correspondiente' };
            }
            document.getElementById('professor-name').textContent = professorData.name;
            document.getElementById('professor-campus').textContent = professorData.campus;
        };

        const loadCourseData = async () => {
            if (window.SERVER_DATA && window.SERVER_DATA.curso) {
                courseData = {
                    id: window.SERVER_DATA.curso.id,
                    nombre: window.SERVER_DATA.curso.nombre || 'Curso',
                    director: window.SERVER_DATA.curso.director || 'No asignado',
                    representante: window.SERVER_DATA.curso.representante || 'N/A',
                    totalStudents: students.length
                };
            } else {
                courseData = {
                    nombre: '702',
                    director: 'Juan Pérez',
                    representante: 'Cielo Rubio',
                    totalStudents: students.length
                };
            }
            document.getElementById('course-info').textContent = `${courseData.nombre} - Director de Curso: ${courseData.director}`;
            document.getElementById('course-representative').textContent = `Representante de curso: ${courseData.representante}`;
        };

        const loadStudents = async () => {
            document.getElementById('total-students').textContent = students.length;
        };

        const loadAttendanceData = async () => {
            // Preferir cargar asistencias desde el servidor vía API si hay curso seleccionado
            attendanceData = {};
            try {
                const año = new Date().getFullYear();
                const mes = new Date().getMonth() + 1;
                const resp = await fetch(`/profesor/api/obtener-asistencias?año=${año}&mes=${mes}`);
                const data = await resp.json();
                if (data && data.success && Array.isArray(data.asistencias)) {
                    data.asistencias.forEach(a => {
                        attendanceData[a.fecha] = attendanceData[a.fecha] || {};
                        attendanceData[a.fecha][a.estudiante_id] = { present: a.estado === 'present', absent: a.estado === 'absent', late: a.estado === 'late', excuse: !!a.excusa };
                    });
                    return;
                }
            } catch (err) {
                console.warn('No se pudieron obtener asistencias vía API, usando datos inyectados si existen', err);
            }

            if (window.SERVER_DATA && Array.isArray(window.SERVER_DATA.asistencias)) {
                window.SERVER_DATA.asistencias.forEach(a => {
                    attendanceData[a.fecha] = attendanceData[a.fecha] || {};
                    attendanceData[a.fecha][a.estudiante_id] = { present: a.estado === 'present', absent: a.estado === 'absent', late: a.estado === 'late', excuse: !!a.excusa };
                });
            }
        };

    const loadGradesData = async () => {
            // Inicializar
            assignmentMeta = [];
            students.forEach(student => student.grades = []);

            // Si el servidor inyectó calificaciones, construir columnas y valores
            if (window.SERVER_DATA && Array.isArray(window.SERVER_DATA.calificaciones)) {
                const califs = window.SERVER_DATA.calificaciones;

                // Unificar por nombre_calificacion (o por id si falta nombre)
                const byName = {};
                califs.forEach(c => {
                    const name = c.nombre_calificacion || (`Asignación ${c.id || ''}`);
                    if (!byName[name]) byName[name] = { name: name, categoria_id: c.categoria_id || c.categoriaId || null, entries: [] };
                    byName[name].entries.push(c);
                });

                // Obtener categorías completas: preferir window.SERVER_DATA.categorias, si no tienen color, pedir vía API
                let categoriasMap = {};
                if (window.SERVER_DATA && Array.isArray(window.SERVER_DATA.categorias) && window.SERVER_DATA.categorias.length > 0 && window.SERVER_DATA.categorias[0].color) {
                    window.SERVER_DATA.categorias.forEach(cat => { categoriasMap[cat.id] = cat; });
                } else {
                    try {
                        const resp = await fetch('/profesor/api/categorias');
                        const data = await resp.json();
                        if (data && data.success && Array.isArray(data.categorias)) {
                            data.categorias.forEach(cat => { categoriasMap[cat.id] = cat; });
                        }
                    } catch (err) {
                        console.warn('No se pudieron obtener categorías completas:', err);
                    }
                }

                // Construir assignmentMeta en orden de aparición
                Object.keys(byName).forEach(name => {
                    const info = byName[name];
                    const catId = info.categoria_id || (info.entries[0] && (info.entries[0].categoria_id || info.entries[0].categoriaId)) || null;
                    const cat = categoriasMap[catId] || null;
                    const color = cat ? (cat.color || '#cccccc') : '#cccccc';
                    const porcentaje = cat ? (cat.porcentaje || 0) : 0;
                    assignmentMeta.push({ name: name, categoria_id: catId, color: color, porcentaje: porcentaje });
                });

                // Preparar mapa de estudiantes y llenar grades arrays
                const studentMap = {};
                students.forEach(s => { studentMap[s.id] = s; s.grades = Array(assignmentMeta.length).fill(''); });

                califs.forEach(c => {
                    const name = c.nombre_calificacion || (`Asignación ${c.id || ''}`);
                    const idx = assignmentMeta.findIndex(a => a.name === name);
                    const s = studentMap[c.estudiante_id];
                    if (s && idx >= 0) {
                        s.grades[idx] = c.valor !== null && c.valor !== undefined ? c.valor : '';
                    }
                });
            }

            // Construir categoriesMap global (si hay datos en SERVER_DATA)
            categoriesMap = {};
            if (window.SERVER_DATA && Array.isArray(window.SERVER_DATA.categorias)) {
                window.SERVER_DATA.categorias.forEach(cat => {
                    categoriesMap[cat.id] = { id: cat.id, nombre: cat.nombre, color: cat.color || '#cccccc', porcentaje: parseFloat(cat.porcentaje) || 0 };
                });
            }
            // Si no hay colores/porcentajes, intentar obtener via API
            if (Object.keys(categoriesMap).length === 0) {
                try {
                    const resp = await fetch('/profesor/api/categorias');
                    const data = await resp.json();
                    if (data && data.success && Array.isArray(data.categorias)) {
                        data.categorias.forEach(cat => {
                            categoriesMap[cat.id] = { id: cat.id, nombre: cat.nombre, color: cat.color || '#cccccc', porcentaje: parseFloat(cat.porcentaje) || 0 };
                        });
                    }
                } catch (err) {
                    console.warn('No se pudieron obtener categorías para el mapa global:', err);
                }
            }

            // Renderizar lista de categorias junto a las opciones
            renderCategoriesList();
        };

        const initializeAllData = async () => {
            try {
                try {
                    await loadProfessorData();
                } catch (err) {
                    console.error('Error loading professor data:', err);
                    UI.showAlert('Error al cargar datos del profesor: ' + (err && err.message ? err.message : String(err)));
                    return;
                }

                try {
                    await loadCourseData();
                } catch (err) {
                    console.error('Error loading course data:', err);
                    UI.showAlert('Error al cargar datos del curso: ' + (err && err.message ? err.message : String(err)));
                    return;
                }

                try {
                    await loadStudents();
                } catch (err) {
                    console.error('Error loading students:', err);
                    UI.showAlert('Error al cargar lista de estudiantes: ' + (err && err.message ? err.message : String(err)));
                    return;
                }

                try {
                    await loadAttendanceData();
                } catch (err) {
                    console.error('Error loading attendance data:', err);
                    UI.showAlert('Error al cargar asistencias: ' + (err && err.message ? err.message : String(err)));
                    return;
                }

                try {
                    await loadGradesData();
                    // cargar configuración de notas desde servidor
                    try {
                        await loadGradeConfig();
                    } catch (err) { console.warn('No se pudo cargar configuración de calificaciones', err); }
                } catch (err) {
                    console.error('Error loading grades data:', err);
                    UI.showAlert('Error al cargar calificaciones: ' + (err && err.message ? err.message : String(err)));
                    return;
                }

                // Inicializar módulos después de cargar datos
                try {
                    AttendanceModule.init();
                } catch (err) {
                    console.error('AttendanceModule.init error:', err);
                    UI.showAlert('Error en módulo de asistencia: ' + (err && err.message ? err.message : String(err)));
                    // no return; intentar inicializar GradesModule también
                }

                try {
                    GradesModule.init();
                } catch (err) {
                    console.error('GradesModule.init error:', err);
                    UI.showAlert('Error en módulo de calificaciones: ' + (err && err.message ? err.message : String(err)));
                }

            } catch (error) {
                // Catch all fallback (should be rare)
                console.error('Unexpected error initializing data:', error);
                UI.showAlert('Error inesperado al inicializar la página: ' + (error && error.message ? error.message : String(error)));
            }
        };

        return { initializeAllData };
    })();

    // --- MÓDULO DE ASISTENCIA ---
    const AttendanceModule = (() => {
        const monthlyView = document.getElementById('monthly-view');
        const dailyView = document.getElementById('daily-view');
        const monthYearDisplay = document.getElementById('month-year-display');
        const monthlyTableHead = document.querySelector('.monthly-grid-table thead');
        const monthlyTableBody = document.querySelector('.monthly-grid-table tbody');
        const dailyViewTitle = document.getElementById('daily-view-title');

        let currentDisplayDate = new Date();
        let selectedDateForDailyView = null;

        const countUnexcusedAbsences = (studentId, year, month) => {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let unexcusedCount = 0;
            for (let i = 1; i <= daysInMonth; i++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const studentData = attendanceData[dateKey]?.[studentId];
                if (studentData?.absent && !studentData.excuse) {
                    unexcusedCount++;
                }
            }
            return unexcusedCount;
        };

        const renderMonthlyList = (year, month) => {
            monthYearDisplay.textContent = new Date(year, month).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            monthlyTableHead.innerHTML = `<tr><th class="student-name-header">Estudiante</th>${Array.from({ length: new Date(year, month + 1, 0).getDate() }, (_, i) => {
                const day = i + 1;
                const date = new Date(year, month, day);
                const isToday = date.setHours(0, 0, 0, 0) === new Date().setHours(0, 0, 0, 0);
                return `<th class="day-header ${isToday ? 'today' : ''}" data-day="${day}">${day}</th>`;
            }).join('')}</tr>`;

            monthlyTableBody.innerHTML = students.map(student => {
                const unexcusedAbsences = countUnexcusedAbsences(student.id, year, month);
                const rowClass = unexcusedAbsences >= 3 ? 'highlight-absentee' : '';
                const days = Array.from({ length: new Date(year, month + 1, 0).getDate() }, (_, i) => {
                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i + 1).padStart(2, '0')}`;
                    const studentData = attendanceData[dateKey]?.[student.id];
                    const status = studentData ? (studentData.absent ? 'absent' : (studentData.late ? 'late' : (studentData.present ? 'present' : null))) : '';
                    const hasExcuse = studentData?.excuse ? '<div class="excuse-dot"></div>' : '';
                    return `<td><div class="status-indicator ${status}">${hasExcuse}</div></td>`;
                }).join('');
                return `<tr class="${rowClass}"><td class="student-name-cell">${student.name}</td>${days}</tr>`;
            }).join('');
        };

        const showDailyView = (date) => {
            selectedDateForDailyView = date;
            dailyViewTitle.textContent = `Asistencia para ${date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}`;
            populateStudentListForDay(date);
            monthlyView.style.display = 'none';
            dailyView.style.display = 'block';
        };

        const populateStudentListForDay = (date) => {
            const studentListContainer = dailyView.querySelector('.student-list');
            const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            studentListContainer.innerHTML = `<div class="list-header"><span class="student-name-header-daily">Nombre del Estudiante</span><span class="attendance-status-header">Estado de Asistencia</span></div>${students.map(student => {
                const studentData = attendanceData[dateKey]?.[student.id];
                const isAbsent = studentData?.absent || false;
                const isLate = studentData?.late || false;
                const isPresent = studentData?.present || false;
                const hasExcuse = studentData?.excuse || false;
                return `<div class="student-row" data-student-id="${student.id}"><div class="student-info"><div class="avatar-small">${student.id}</div><span>${student.name}</span></div><div class="attendance-controls"><button class="status-btn present ${isPresent ? 'selected' : ''}">Presente</button><button class="status-btn absent ${isAbsent ? 'selected' : ''}">Ausente</button><button class="status-btn late ${isLate ? 'selected' : ''}">Tarde</button><div class="excuse-container" style="display: ${isAbsent || isLate ? 'flex' : 'none'};"><label class="excuse-label"><input type="checkbox" class="excuse-checkbox" ${hasExcuse ? 'checked' : ''}> Trajo Excusa</label></div></div></div>`;
            }).join('')}`;
            setupDailyViewLogic();
        };

        const setupDailyViewLogic = () => {
            const studentRows = dailyView.querySelectorAll('.student-row');
            const presentCountEl = document.getElementById('present-count');
            const absentCountEl = document.getElementById('absent-count');
            const lateCountEl = document.getElementById('late-count');
            
            const updateSummary = () => {
                let present = 0, absent = 0, late = 0;
                studentRows.forEach(row => {
                    if (row.querySelector('.status-btn.present').classList.contains('selected')) present++;
                    if (row.querySelector('.status-btn.absent').classList.contains('selected')) absent++;
                    if (row.querySelector('.status-btn.late').classList.contains('selected')) late++;
                });
                presentCountEl.textContent = present;
                absentCountEl.textContent = absent;
                lateCountEl.textContent = late;
            };

            const updateExcuseVisibility = (row) => {
                const isAbsentOrLate = row.querySelector('.status-btn.absent').classList.contains('selected') || row.querySelector('.status-btn.late').classList.contains('selected');
                row.querySelector('.excuse-container').style.display = isAbsentOrLate ? 'flex' : 'none';
                if (!isAbsentOrLate) row.querySelector('.excuse-checkbox').checked = false;
            };

            studentRows.forEach(row => {
                const btns = row.querySelectorAll('.status-btn');
                btns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const status = btn.classList[1]; // present, absent, late
                        const presentBtn = row.querySelector('.status-btn.present');
                        const absentBtn = row.querySelector('.status-btn.absent');
                        const lateBtn = row.querySelector('.status-btn.late');

                        if (status === 'present') {
                            presentBtn.classList.toggle('selected');
                            absentBtn.classList.remove('selected');
                            if (!presentBtn.classList.contains('selected')) lateBtn.classList.remove('selected');
                        } else if (status === 'absent') {
                            absentBtn.classList.toggle('selected');
                            if (absentBtn.classList.contains('selected')) {
                                presentBtn.classList.remove('selected');
                                lateBtn.classList.remove('selected');
                            }
                        } else if (status === 'late') {
                            lateBtn.classList.toggle('selected');
                            if (lateBtn.classList.contains('selected')) {
                                presentBtn.classList.add('selected');
                                absentBtn.classList.remove('selected');
                            }
                        }
                        updateExcuseVisibility(row);
                        updateSummary();
                    });
                });
            });
            updateSummary();
        };

        const saveDailyAttendance = async () => {
            const date = selectedDateForDailyView;
            const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            attendanceData[dateKey] = {};
            
            dailyView.querySelectorAll('.student-row').forEach(row => {
                const studentId = row.dataset.studentId;
                const isPresent = row.querySelector('.status-btn.present').classList.contains('selected');
                const isAbsent = row.querySelector('.status-btn.absent').classList.contains('selected');
                const isLate = row.querySelector('.status-btn.late').classList.contains('selected');
                const hasExcuse = row.querySelector('.excuse-checkbox').checked;
                if (isPresent || isAbsent || isLate) {
                    attendanceData[dateKey][studentId] = { present: isPresent, absent: isAbsent, late: isLate, excuse: hasExcuse };
                }
            });

            // Intentar persistir via API
            try {
                const payload = { fecha: dateKey, asistencias: Object.keys(attendanceData[dateKey]).map(stId => ({ estudiante_id: stId, estado: attendanceData[dateKey][stId].absent ? 'absent' : (attendanceData[dateKey][stId].late ? 'late' : 'present') })) };
                const resp = await fetch('/profesor/api/guardar-asistencia', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await resp.json();
                if (data && data.success) {
                    UI.showAlert('Asistencia guardada!');
                } else {
                    UI.showAlert('Error guardando asistencia en el servidor, guardada localmente');
                }
            } catch (err) {
                console.error('Error guardando asistencias via API:', err);
                UI.showAlert('Error de red al guardar asistencia, guardada localmente');
            }
            showMonthlyView();
        };

        const showMonthlyView = () => {
            dailyView.style.display = 'none';
            monthlyView.style.display = 'block';
            renderMonthlyList(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
        };

        const setupEventListeners = () => {
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentDisplayDate.setMonth(currentDisplayDate.getMonth() - 1);
                renderMonthlyList(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentDisplayDate.setMonth(currentDisplayDate.getMonth() + 1);
                renderMonthlyList(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
            });
            document.getElementById('go-to-today-btn').addEventListener('click', () => showDailyView(new Date()));
            document.getElementById('back-to-monthly-btn').addEventListener('click', () => showMonthlyView());
            document.getElementById('save-daily-attendance-btn').addEventListener('click', saveDailyAttendance);
            monthlyTableHead.addEventListener('click', (e) => {
                if (e.target.dataset.day) {
                    const day = parseInt(e.target.dataset.day);
                    showDailyView(new Date(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth(), day));
                }
            });
        };

        const renderCategoriesList = () => {
            const container = document.getElementById('categories-list');
            if (!container) return;
            const cats = Object.values(categoriesMap || {});
            if (!cats || cats.length === 0) {
                container.innerHTML = '<small>No hay categorías</small>';
                return;
            }
            container.innerHTML = cats.map(c => {
                const color = c.color || '#cccccc';
                const name = c.nombre || 'Sin nombre';
                const pct = (c.porcentaje !== undefined && c.porcentaje !== null) ? `${c.porcentaje}%` : '';
                return `<div style="display:inline-flex;align-items:center;margin-right:8px;font-size:0.9em;"><span style="width:14px;height:14px;background:${color};display:inline-block;border-radius:3px;margin-right:6px;border:1px solid rgba(0,0,0,0.05);"></span><span>${name} ${pct}</span></div>`;
            }).join('');
        };

        return { 
            init: () => { 
                setupEventListeners(); 
                renderMonthlyList(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth()); 
            } 
        };
    })();

    // --- MÓDULO DE CALIFICACIONES ---
    const GradesModule = (() => {
        const gradesTable = document.querySelector('.grades-table');
        const gradesTableHead = gradesTable.querySelector('thead');
        const gradesTableBody = gradesTable.querySelector('tbody');
        const lowestGradeEl = document.getElementById('lowest-grade');
        const highestGradeEl = document.getElementById('highest-grade');
        const averageGradeEl = document.getElementById('average-grade');
        const passingGradeInput = document.getElementById('passing-grade');
        const minGradeInput = document.getElementById('min-grade');
        const maxGradeInput = document.getElementById('max-grade');

        const calculateAllAverages = () => {
            const passingGrade = parseFloat(passingGradeInput.value) || 60;

            const finals = [];

            gradesTableBody.querySelectorAll('tr').forEach((row, studentIndex) => {
                // Construir por categoría
                const categoryBuckets = {}; // catId -> {sum, count}
                row.querySelectorAll('.grade-input').forEach((input, gradeIndex) => {
                    const raw = input.value;
                    const value = raw === '' ? NaN : parseFloat(raw);
                    students[studentIndex].grades[gradeIndex] = isNaN(value) ? '' : value;
                    const meta = assignmentMeta[gradeIndex];
                    const catId = meta && meta.categoria_id ? meta.categoria_id : null;
                    const key = catId || '__nocat__';
                    if (!categoryBuckets[key]) categoryBuckets[key] = { sum: 0, count: 0, porcentaje: (meta && meta.porcentaje) ? parseFloat(meta.porcentaje) : (categoriesMap[catId] ? categoriesMap[catId].porcentaje : 0) };
                    if (!isNaN(value)) {
                        categoryBuckets[key].sum += value;
                        categoryBuckets[key].count += 1;
                    }
                });

                // Calcular promedio ponderado por categorías
                let finalScore = 0;
                // Si no hay categorías definidas, caemos al promedio simple
                if (assignmentMeta.length === 0) {
                    finalScore = 0;
                } else {
                    // Sumar por categoria: (avg_in_category) * (categoria_porcentaje / 100)
                    Object.keys(categoryBuckets).forEach(k => {
                        const b = categoryBuckets[k];
                        const avgCat = b.count > 0 ? (b.sum / b.count) : 0;
                        const weight = b.porcentaje ? (b.porcentaje / 100) : 0;
                        finalScore += avgCat * weight;
                    });
                }

                const averageCell = row.querySelector('.average-cell');
                const display = isNaN(finalScore) ? 'N/A' : (Math.round(finalScore * 10) / 10).toFixed(1);
                averageCell.textContent = display;
                const numericFinal = isNaN(finalScore) ? null : finalScore;
                if (numericFinal !== null) {
                    averageCell.classList.toggle('failing', numericFinal < passingGrade);
                    row.classList.toggle('failing-student', numericFinal < passingGrade);
                    finals.push(numericFinal);
                } else {
                    averageCell.classList.remove('failing');
                    row.classList.remove('failing-student');
                }
            });

            if (finals.length > 0) {
                lowestGradeEl.textContent = Math.min(...finals).toFixed(1);
                highestGradeEl.textContent = Math.max(...finals).toFixed(1);
                averageGradeEl.textContent = (finals.reduce((a, b) => a + b, 0) / finals.length).toFixed(1);
            } else {
                lowestGradeEl.textContent = '0';
                highestGradeEl.textContent = '0';
                averageGradeEl.textContent = '0';
            }
        };

        const renderGradesTable = () => {
            // construir encabezados con color según categoría
            const headers = assignmentMeta.map((a, idx) => {
                const colorStyle = a.color ? `style="background:${a.color};color:#fff;padding:6px;border-radius:4px;display:inline-block;min-width:80px;"` : '';
                return `<th><div ${colorStyle}>${a.name}</div> <div class="assignment-actions"><i class="fas fa-pencil-alt" data-action="edit-assignment" data-col="${idx}"></i><i class="fas fa-trash-alt delete-assignment-icon" data-action="delete-assignment" data-col="${idx}"></i></div></th>`;
            }).join('');

            gradesTableHead.innerHTML = `<tr><th class="student-name-header">Nombre</th>${headers}<th>Promedio</th></tr>`;

            gradesTableBody.innerHTML = students.map(student =>
                `<tr data-student-id="${student.id}"><td class="student-name-cell">${student.name}</td>${student.grades.map(grade =>
                    `<td><input type="number" class="grade-input" value="${grade}"></td>`
                ).join('')}<td class="average-cell">0</td></tr>`
            ).join('');

            calculateAllAverages();
        };

        const setupEventListeners = () => {
            // add-assignment: handled by modal below (assignmentModal)

            gradesTableHead.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                if (!action) return;
                const headerCell = e.target.closest('th');
                const columnIndex = Array.from(headerCell.parentNode.children).indexOf(headerCell) - 1;
                const currentMeta = assignmentMeta[columnIndex];

                if (action === 'delete-assignment') {
                    UI.showConfirm(`¿Estás seguro de que quieres eliminar la columna "${currentMeta ? currentMeta.name : 'Asignación'}"?`, async (confirmed) => {
                        if (confirmed) {
                            try {
                                // call backend to delete assignment placeholder (no direct id available; rely on nombre & asignatura)
                                const payload = { nombre_calificacion: currentMeta ? currentMeta.name : null };
                                const resp = await fetch('/profesor/api/eliminar-asignacion', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                                const data = await resp.json();
                                if (data && data.success) {
                                    assignmentMeta.splice(columnIndex, 1);
                                    students.forEach(student => student.grades.splice(columnIndex, 1));
                                    renderGradesTable();
                                    UI.showAlert('Asignación eliminada');
                                } else {
                                    UI.showAlert('Error eliminando asignación');
                                }
                            } catch (err) {
                                console.error('Error eliminando asignación:', err);
                                UI.showAlert('Error de red al eliminar asignación');
                            }
                        }
                    });
                } else if (action === 'edit-assignment') {
                    UI.showPrompt('Editar Asignación', `Introduce el nuevo nombre para "${currentMeta ? currentMeta.name : 'Asignación'}":`, async (newName) => {
                        if (newName && newName.trim() !== '') {
                            try {
                                const oldName = currentMeta ? currentMeta.name : null;
                                const resp = await fetch('/profesor/api/editar-asignacion', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre_antiguo: oldName, nombre_nuevo: newName.trim() }) });
                                const data = await resp.json();
                                if (data && data.success) {
                                    if (currentMeta) currentMeta.name = newName.trim();
                                    renderGradesTable();
                                    UI.showAlert('Asignación actualizada');
                                } else {
                                    UI.showAlert('Error actualizando asignación');
                                }
                            } catch (err) {
                                console.error('Error actualizando asignación:', err);
                                UI.showAlert('Error de red al actualizar asignación');
                            }
                        }
                    });
                }
            });

            gradesTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('grade-input')) {
                    const value = parseFloat(e.target.value);
                    const min = parseFloat(minGradeInput.value);
                    const max = parseFloat(maxGradeInput.value);
                    if (e.target.value !== '' && (value < min || value > max)) {
                        e.target.value = '';
                    }
                    calculateAllAverages();
                }
            });

            document.querySelectorAll('.grades-settings input').forEach(input => {
                input.addEventListener('change', calculateAllAverages);
            });

            // Autosave grade configuration (min/max/passing)
            const saveGradeConfig = debounce(async () => {
                try {
                    const payload = {
                        notaMinima: parseFloat(minGradeInput.value) || 0,
                        notaMaxima: parseFloat(maxGradeInput.value) || 100,
                        notaMinimaAprobacion: parseFloat(passingGradeInput.value) || 60
                    };
                    const resp = await fetch('/profesor/api/configuracion-calificaciones', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const data = await resp.json();
                    if (!(data && data.success)) console.warn('No se pudo guardar configuración de calificaciones', data);
                } catch (err) {
                    console.error('Error guardando configuración de calificaciones:', err);
                }
            }, 700);

            [minGradeInput, maxGradeInput, passingGradeInput].forEach(inp => inp.addEventListener('input', () => { calculateAllAverages(); saveGradeConfig(); }));

            const exportGradesBtn = document.getElementById('export-grades-btn');
            if (exportGradesBtn) {
                exportGradesBtn.addEventListener('click', () => {
                    UI.showAlert('Funcionalidad de exportación en desarrollo');
                });
            }

            document.getElementById('generate-report-btn').addEventListener('click', () => {
                UI.showAlert('Funcionalidad de reportes en desarrollo');
            });

            // Manejo de categorías con modal (crear y listar)
            const manageCategoriesBtn = document.getElementById('manage-categories-btn');
            if (manageCategoriesBtn) {
                manageCategoriesBtn.addEventListener('click', async () => {
                    // Abrir modal de categorías; rellenar inputs vacíos para crear
                    document.getElementById('categoryNameInput').value = '';
                    document.getElementById('categoryColorInput').value = '#2d8cff';
                    document.getElementById('categoryPctInput').value = 10;
                        // Renderizar lista de categorías dentro del modal
                            await refreshCategoryListInModal();
                            // recalcular y mostrar warning si corresponde
                            try { updateCategoryPctWarning(); } catch (e) { /* ignore */ }
                            document.getElementById('categoryModal').classList.add('show');
                });

                // Cancelar categoría
                document.getElementById('categoryModalCancelBtn').addEventListener('click', () => document.getElementById('categoryModal').classList.remove('show'));

                // Confirmar creación/actualización de categoría
                document.getElementById('categoryModalConfirmBtn').addEventListener('click', async () => {
                    const nombre = document.getElementById('categoryNameInput').value.trim();
                    const color = document.getElementById('categoryColorInput').value;
                    const porcentaje = parseFloat(document.getElementById('categoryPctInput').value) || 0;
                    if (!nombre) { UI.showAlert('El nombre es requerido'); return; }
                    const editingId = document.getElementById('categoryModal').dataset.editingId || null;
                    try {
                        if (editingId) {
                            // PUT actualizar
                            const resp = await fetch(`/profesor/api/categorias/${editingId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre: nombre, color: color, porcentaje: porcentaje }) });
                            const data = await resp.json();
                            if (data && data.success && data.categoria) {
                                const cat = data.categoria;
                                const normalized = normalizeCategoriesArray([cat])[0];
                                categoriesMap[normalized.id] = normalized;
                                renderCategoriesList();
                                await refreshCategoryListInModal();
                                updateCategoryPctWarning();
                                document.getElementById('categoryModal').classList.remove('show');
                                UI.showAlert('Categoría actualizada');
                                document.getElementById('categoryModal').dataset.editingId = '';
                            } else {
                                UI.showAlert('Error actualizando categoría');
                            }
                        } else {
                            // POST crear
                            const resp = await fetch('/profesor/api/categorias', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre: nombre, color: color, porcentaje: porcentaje }) });
                            const data = await resp.json();
                            if (data && data.success && data.categoria) {
                                const cat = data.categoria;
                                const normalized = normalizeCategoriesArray([cat])[0];
                                categoriesMap[normalized.id] = normalized;
                                renderCategoriesList();
                                await refreshCategoryListInModal();
                                updateCategoryPctWarning();
                                document.getElementById('categoryModal').classList.remove('show');
                                UI.showAlert('Categoría creada');
                            } else {
                                UI.showAlert('Error creando categoría');
                            }
                        }
                    } catch (err) {
                        console.error('Error creando/actualizando categoría:', err);
                        UI.showAlert('Error de red al crear/actualizar la categoría.');
                    }
                });
            }

            // Helper: render list inside modal with edit/delete buttons
            async function refreshCategoryListInModal() {
                const container = document.getElementById('categoryListContainer');
                container.innerHTML = 'Cargando...';
                try {
                    const resp = await fetch('/profesor/api/categorias');
                    const data = await resp.json();
                    if (data && data.success && Array.isArray(data.categorias)) {
                        // actualizar mapa global de categorias (normalizado)
                        const normalized = normalizeCategoriesArray(data.categorias);
                        normalized.forEach(c => { categoriesMap[c.id] = c; });

                        const list = normalized.map(cat => {
                            const id = cat.id || cat.id_categoria || cat.idCategoria;
                            const color = cat.color || '#cccccc';
                            const pct = (cat.porcentaje !== undefined && cat.porcentaje !== null) ? `${cat.porcentaje}%` : '';
                            return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 4px;border-bottom:1px solid var(--color-borde-suave);"><div style="display:flex;gap:8px;align-items:center;"><span style="width:14px;height:14px;background:${color};display:inline-block;border-radius:3px;border:1px solid rgba(0,0,0,0.05);"></span><strong>${cat.nombre}</strong> <small style="color:var(--color-texto-secundario);margin-left:6px;">${pct}</small></div><div><button data-id="${id}" class="edit-cat-btn back-button" style="margin-right:6px;">Editar</button><button data-id="${id}" class="delete-cat-btn back-button">Eliminar</button></div></div>`;
                        }).join('');
                        container.innerHTML = list || '<small>No hay categorías</small>';
                        // attach events
                        container.querySelectorAll('.edit-cat-btn').forEach(b => b.addEventListener('click', onEditCategory));
                        container.querySelectorAll('.delete-cat-btn').forEach(b => b.addEventListener('click', onDeleteCategory));
                    } else {
                        container.innerHTML = '<small>No hay categorías</small>';
                    }
                } catch (err) {
                    console.error('Error cargando categorías en modal:', err);
                    container.innerHTML = '<small>Error cargando categorías</small>';
                }
                // Después de cargar la lista, actualizar aviso según suma de porcentajes
                try { updateCategoryPctWarning(); } catch (e) { /* ignore */ }
            }

            async function onEditCategory(e) {
                const id = e.currentTarget.dataset.id;
                try {
                    const resp = await fetch('/profesor/api/categorias');
                    const data = await resp.json();
                    const found = (data.categorias || []).find(c => String(c.id || c.id_categoria) === String(id));
                    if (found) {
                        document.getElementById('categoryNameInput').value = found.nombre || '';
                        document.getElementById('categoryColorInput').value = found.color || '#2d8cff';
                        document.getElementById('categoryPctInput').value = found.porcentaje || 0;
                        document.getElementById('categoryModal').dataset.editingId = id;
                        // keep modal open
                    } else {
                        UI.showAlert('Categoría no encontrada');
                    }
                } catch (err) {
                    console.error('Error obteniendo categoría para editar:', err);
                    UI.showAlert('Error al obtener datos de la categoría');
                }
            }

            async function onDeleteCategory(e) {
                const id = e.currentTarget.dataset.id;
                UI.showConfirm('¿Eliminar esta categoría? Esto no borrará calificaciones existentes.', async (ok) => {
                    if (!ok) return;
                    try {
                        const resp = await fetch(`/profesor/api/categorias/${id}`, { method: 'DELETE' });
                        const data = await resp.json();
                        if (data && data.success) {
                            delete categoriesMap[id];
                            renderCategoriesList();
                            await refreshCategoryListInModal();
                            updateCategoryPctWarning();
                            UI.showAlert('Categoría eliminada');
                        } else {
                            UI.showAlert('Error eliminando categoría');
                        }
                    } catch (err) {
                        console.error('Error eliminando categoría:', err);
                        UI.showAlert('Error de red al eliminar categoría');
                    }
                });
            }

            // Añadir asignación con modal y select de categorías
            const addAssignmentBtn = document.getElementById('add-assignment-btn');
            if (addAssignmentBtn) {
                addAssignmentBtn.addEventListener('click', async () => {
                    // poblar select con categorías actuales
                    const select = document.getElementById('assignmentCategorySelect');
                    select.innerHTML = '';
                    const cats = Object.values(categoriesMap || {});
                    if (cats.length === 0) {
                        // intentar obtener vía API
                        try {
                            const resp = await fetch('/profesor/api/categorias');
                            const data = await resp.json();
                            if (data && data.success) {
                                const normalized = normalizeCategoriesArray(data.categorias);
                                normalized.forEach(c => { categoriesMap[c.id] = c; });
                            }
                        } catch (err) { console.warn('No se pudieron cargar categorías', err); }
                    }
                    Object.values(categoriesMap).forEach(c => {
                        const opt = document.createElement('option'); opt.value = c.id; opt.textContent = `${c.nombre} (${c.porcentaje}%)`; select.appendChild(opt);
                    });
                    document.getElementById('assignmentNameInput').value = '';
                    document.getElementById('assignmentModal').classList.add('show');
                });

                document.getElementById('assignmentModalCancelBtn').addEventListener('click', () => document.getElementById('assignmentModal').classList.remove('show'));

                document.getElementById('assignmentModalConfirmBtn').addEventListener('click', async () => {
                    const name = document.getElementById('assignmentNameInput').value.trim();
                    const catId = document.getElementById('assignmentCategorySelect').value || null;
                    if (!name) { UI.showAlert('El nombre es requerido'); return; }
                    // asignatura por defecto
                    let asignatura_id = null;
                    if (window.SERVER_DATA && Array.isArray(window.SERVER_DATA.asignaturas) && window.SERVER_DATA.asignaturas.length > 0) asignatura_id = window.SERVER_DATA.asignaturas[0].id;
                    try {
                        const resp = await fetch('/profesor/api/crear-asignacion', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ asignatura_id: asignatura_id, nombre_calificacion: name, categoria_id: catId }) });
                        const data = await resp.json();
                        if (data && data.success) {
                            // agregar meta local
                            const cat = categoriesMap[catId] || null;
                            assignmentMeta.push({ name: name, categoria_id: catId, color: cat ? cat.color : '#cccccc', porcentaje: cat ? cat.porcentaje : 0 });
                            students.forEach(s => s.grades.push(''));
                            renderGradesTable();
                            document.getElementById('assignmentModal').classList.remove('show');
                            UI.showAlert('Asignación creada');
                        } else {
                            UI.showAlert('Error creando asignación');
                        }
                    } catch (err) {
                        console.error('Error creando asignación:', err);
                        UI.showAlert('Error de red al crear asignación');
                    }
                });
            }
        };

        // ------------------ Helpers para porcentaje de categorías ------------------
        function computeTotalCategoriesPercentage(includeEditingId = null, editingValue = null) {
            // Sumar los porcentajes de categoriesMap, opcionalmente reemplazando el valor de una categoría que se está editando
            let total = 0;
            try {
                Object.keys(categoriesMap || {}).forEach(k => {
                    const c = categoriesMap[k];
                    if (!c) return;
                    // si estamos editando y coincide con editingId, tomar editingValue
                    if (includeEditingId && String(c.id) === String(includeEditingId) && editingValue !== null && editingValue !== undefined) {
                        total += parseFloat(editingValue) || 0;
                    } else {
                        total += parseFloat(c.porcentaje) || 0;
                    }
                });
            } catch (e) {
                console.warn('computeTotalCategoriesPercentage error', e);
            }
            return total;
        }

        function updateCategoryPctWarning() {
            const modalWarningEl = document.getElementById('categoryPctWarning');
            const inlineWarningEl = document.getElementById('categoriesPctWarningInline');
            // if neither exists, nothing to do
            if (!modalWarningEl && !inlineWarningEl) return;
            // considerar valor actual del input (por si estamos creando/actualizando una categoría)
            const editingId = document.getElementById('categoryModal') ? (document.getElementById('categoryModal').dataset.editingId || null) : null;
            const inputEl = document.getElementById('categoryPctInput');
            const inputVal = inputEl ? (parseFloat(inputEl.value) || 0) : 0;
            const total = computeTotalCategoriesPercentage(editingId, inputVal);
            const shouldShow = total > 100;
            try { if (modalWarningEl) modalWarningEl.style.display = shouldShow ? 'block' : 'none'; } catch (e) { /* ignore */ }
            try { if (inlineWarningEl) inlineWarningEl.style.display = shouldShow ? 'block' : 'none'; } catch (e) { /* ignore */ }
        }

        // Vincular eventos para recalcular al modificar el input de porcentaje
        const categoryPctInput = document.getElementById('categoryPctInput');
        if (categoryPctInput) {
            categoryPctInput.addEventListener('input', () => {
                try { updateCategoryPctWarning(); } catch (e) { /* ignore */ }
            });
        }

        return { init: () => { 
                // Comprobar elementos críticos
                if (!gradesTable || !gradesTableHead || !gradesTableBody) {
                    console.warn('GradesModule: elementos de tabla de calificaciones no encontrados, omitiendo inicialización.');
                    return;
                }
                setupEventListeners();
                renderGradesTable();
            } };
    })();

    // Cargar configuración de calificaciones desde backend
    async function loadGradeConfig() {
        try {
            const resp = await fetch('/profesor/api/configuracion-calificaciones');
            const data = await resp.json();
            if (data && data.success && data.configuracion) {
                const cfg = data.configuracion;
                const minEl = document.getElementById('min-grade');
                const maxEl = document.getElementById('max-grade');
                const passEl = document.getElementById('passing-grade');
                if (minEl && cfg.notaMinima !== undefined) minEl.value = parseFloat(cfg.notaMinima);
                if (maxEl && cfg.notaMaxima !== undefined) maxEl.value = parseFloat(cfg.notaMaxima);
                if (passEl && cfg.notaMinimaAprobacion !== undefined) passEl.value = parseFloat(cfg.notaMinimaAprobacion);
            }
        } catch (err) {
            console.warn('Error cargando configuración de calificaciones', err);
        }
    }

    // --- INICIALIZACIÓN GENERAL ---
    UI.attendanceTab.addEventListener('click', () => UI.switchView(UI.attendanceTab, UI.attendanceContent, UI.gradesTab, UI.gradesContent));
    UI.gradesTab.addEventListener('click', () => UI.switchView(UI.gradesTab, UI.gradesContent, UI.attendanceTab, UI.attendanceContent));

    // Iniciar carga de datos
    DataLoader.initializeAllData();
});
</script>
</body>
</html>