<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Asistencia y Calificaciones</title>
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --color-primario: #0078ad;
            --color-primario-oscuro: #00628e;
            --color-texto-principal: #2c3e50;
            --color-texto-secundario: #7f8c8d;
            --color-blanco: #FFFFFF;
            --color-fondo-seccion: #f8f9fa;
            --color-borde-suave: #ecf0f1;
            --color-presente: #28a745;
            --color-ausente: #dc3545;
            --color-ausente-claro: #f8d7da;
            --color-tarde: #ffc107;
            --color-hoy: #ffc107;
        }

        /* --- General Styles --- */
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--color-fondo-seccion);
            margin: 0;
            color: var(--color-texto-principal);
        }

        /* --- Navbar --- */
        .navbar {
            background-color: var(--color-blanco);
            border-bottom: 1px solid var(--color-borde-suave);
            box-shadow: 0 .125rem .25rem rgba(0,0,0,.08);
            padding: 10px 30px;
            position: sticky;
            top: 0;
            z-index: 1020;
            display: flex;
            justify-content: center;
        }

        .navbar-container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            text-decoration: none;
            gap: 0.75rem;
        }

        .navbar-brand .logo-circle {
            width: 30px;
            height: 30px;
            background-color: var(--color-primario);
            border-radius: 50%;
        }

        .navbar-brand h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-texto-principal);
            margin: 0;
        }
        
        .page-container {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .container {
            width: 100%;
            max-width: 1200px;
        }

        /* --- Main Content --- */
        main {
            padding: 20px 50px;
        }

        .main-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            margin-top: 20px;
        }

        .profile-card {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .avatar-large {
            width: 90px;
            height: 90px;
            background-color: var(--color-borde-suave);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5em;
            color: var(--color-texto-secundario);
        }

        .profile-info h2 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 700;
            color: var(--color-texto-principal);
        }

        .profile-info p {
            margin: 5px 0;
            color: var(--color-texto-secundario);
        }

        .info-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .card {
            background-color: var(--color-blanco);
            border: 1px solid var(--color-borde-suave);
            border-radius: 0.75rem;
            padding: 15px;
            min-width: 220px;
            box-shadow: 0 2px 5px rgba(0,0,0,.05);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 10px rgba(0,0,0,.1);
        }

        .students-card .card-title {
            margin: 0;
            color: var(--color-texto-secundario);
            font-weight: 600;
        }

        .students-card .card-content {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--color-texto-principal);
            margin: 10px 0;
        }

        .students-card .card-footer {
            margin: 0;
            color: var(--color-texto-secundario);
        }

        .course-card {
            padding: 20px;
        }
        .course-card p {
            margin: 5px 0;
        }

        /* --- Content Tabs --- */
        .content-tabs {
            margin-top: 30px;
            border-bottom: 1px solid var(--color-borde-suave);
        }

        .tab-link {
            text-decoration: none;
            color: var(--color-texto-secundario);
            padding: 10px 20px;
            display: inline-block;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s;
        }

        .tab-link.active, .tab-link:hover {
            color: var(--color-primario);
            border-bottom: 3px solid var(--color-primario);
        }

        /* --- Attendance & Grades Section --- */
        .content-section {
            background-color: var(--color-blanco);
            border: 1px solid var(--color-borde-suave);
            border-radius: 0.75rem;
            margin-top: 20px;
            padding: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,.05);
        }
        
        .attendance-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .attendance-header h2 {
            margin: 0;
            font-size: 1.5rem;
            flex-shrink: 0;
            color: var(--color-texto-principal);
        }
        
        .month-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            flex-grow: 1;
        }

        .month-navigation .nav-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--color-primario);
            cursor: pointer;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }
        
        .back-button {
            padding: 9px 20px;
            background-color: var(--color-fondo-seccion);
            border: 1px solid var(--color-borde-suave);
            border-radius: 0.5rem;
            font-weight: 600;
            color: var(--color-texto-principal);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .back-button:hover {
            background-color: #e9ecef;
        }

        /* --- Summary Cards --- */
        .summary-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }

        .summary-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            border-radius: 0.75rem;
            background-color: var(--color-fondo-seccion);
            border: 1px solid var(--color-borde-suave);
            font-weight: 600;
        }
        .summary-card .count {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .summary-card.present .count { color: var(--color-presente); }
        .summary-card.absent .count { color: var(--color-ausente); }
        .summary-card.late .count { color: var(--color-tarde); }

        /* --- Monthly List View --- */
        .monthly-list-container {
            overflow-x: auto;
        }
        .monthly-grid-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        .monthly-grid-table th, .monthly-grid-table td {
            border: 1px solid var(--color-borde-suave);
            text-align: center;
            padding: 5px;
        }
        .monthly-grid-table thead th {
            padding: 10px 5px;
            font-weight: 700;
            background-color: var(--color-fondo-seccion);
            position: sticky;
            top: 0;
        }
        .monthly-grid-table th.student-name-header {
            text-align: left;
            min-width: 200px;
            position: sticky;
            left: 0;
            z-index: 2;
        }
        .monthly-grid-table td.student-name-cell {
            text-align: left;
            font-weight: 600;
            position: sticky;
            left: 0;
            background-color: var(--color-blanco);
            z-index: 1;
            transition: background-color 0.3s;
        }
        .monthly-grid-table tr.highlight-absentee td.student-name-cell {
            background-color: var(--color-ausente-claro);
            color: var(--color-ausente);
        }
        .monthly-grid-table th.day-header {
            min-width: 40px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .monthly-grid-table th.day-header:hover {
            background-color: var(--color-primario);
            color: var(--color-blanco);
        }
        .monthly-grid-table th.today {
            background-color: var(--color-hoy);
            color: var(--color-texto-principal);
        }
        .monthly-grid-table .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin: auto;
            position: relative;
        }
        .status-indicator.present { background-color: var(--color-presente); }
        .status-indicator.absent { background-color: var(--color-ausente); }
        .status-indicator.late { background-color: var(--color-tarde); }
        
        .excuse-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background-color: var(--color-primario);
            border-radius: 50%;
            border: 1px solid var(--color-blanco);
        }

        /* --- Daily Student List --- */
        .student-list {
            margin-top: 25px;
            overflow-x: auto;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            color: var(--color-texto-secundario);
            font-weight: 600;
            padding: 0 20px 10px 20px;
            border-bottom: 2px solid var(--color-borde-suave);
            min-width: 650px;
        }

        .student-name-header-daily {
            flex-basis: 40%;
        }
        
        .attendance-status-header {
            flex-basis: 60%;
            text-align: left;
            padding-left: 10px;
        }

        .student-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--color-borde-suave);
            min-width: 650px;
        }

        .student-row:last-child {
            border-bottom: none;
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-basis: 40%;
        }

        .avatar-small {
            width: 35px;
            height: 35px;
            background-color: var(--color-borde-suave);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: var(--color-texto-secundario);
            flex-shrink: 0;
        }

        .attendance-controls {
            display: flex;
            gap: 10px;
            flex-basis: 60%;
            justify-content: flex-start;
            align-items: center;
        }

        .status-btn {
            padding: 6px 18px;
            border-radius: 15px;
            border: 1px solid var(--color-borde-suave);
            background-color: var(--color-blanco);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--color-texto-secundario);
        }

        .status-btn:hover {
            background-color: var(--color-fondo-seccion);
            border-color: #d4d9db;
        }

        .status-btn.selected.present { background-color: var(--color-presente); border-color: var(--color-presente); color: var(--color-blanco); }
        .status-btn.selected.absent { background-color: var(--color-ausente); border-color: var(--color-ausente); color: var(--color-blanco); }
        .status-btn.selected.late { background-color: var(--color-tarde); border-color: var(--color-tarde); color: var(--color-texto-principal); }

        .excuse-container {
            display: flex;
            align-items: center;
            margin-left: 15px;
            transition: opacity 0.3s ease;
        }
        .excuse-label {
            font-weight: 600;
            color: var(--color-texto-secundario);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .excuse-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* --- Grades Section --- */
        .grades-summary-cards {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }
        .grades-summary-card {
            border: 1px solid var(--color-borde-suave);
            padding: 15px;
            border-radius: 0.75rem;
            text-align: center;
            flex: 1;
            min-width: 150px;
        }
        .grades-summary-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-primario);
        }
        .grades-summary-card .label {
            color: var(--color-texto-secundario);
            font-weight: 600;
        }
        .grades-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .grades-settings {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .grades-settings label {
            font-weight: 600;
        }
        .grades-settings input {
            width: 60px;
            padding: 4px 8px;
            border-radius: 0.5rem;
            border: 1px solid var(--color-borde-suave);
        }
        .grades-table-container {
            overflow-x: auto;
        }
        .grades-table {
            width: 100%;
            min-width: 900px;
            border-collapse: collapse;
        }
        .grades-table th, .grades-table td {
            border: 1px solid var(--color-borde-suave);
            padding: 8px 12px;
            text-align: center;
            vertical-align: middle;
        }
        .grades-table thead th {
            background-color: var(--color-fondo-seccion);
            font-weight: 700;
        }
        .grades-table .student-name-cell {
            text-align: left;
            font-weight: 600;
        }
        .grades-table tr.failing-student td.student-name-cell, .grades-table .average-cell.failing {
            color: var(--color-ausente);
            font-weight: 700;
        }
        .grades-table tr.failing-student td.student-name-cell {
            background-color: var(--color-ausente-claro);
        }
        .grades-table input.grade-input {
            width: 50px;
            border: 1px solid transparent;
            text-align: center;
            border-radius: 4px;
            padding: 4px;
        }
        .grades-table input.grade-input:focus {
            outline: none;
            border-color: var(--color-primario);
            background-color: #eef;
        }
        .grades-table .assignment-actions i {
            cursor: pointer;
            margin: 0 4px;
            color: var(--color-texto-secundario);
            transition: color 0.2s;
        }
        .grades-table .assignment-actions i:hover {
            color: var(--color-primario);
        }
        .grades-table .delete-assignment-icon:hover {
            color: var(--color-ausente);
        }

        /* --- Footer Action --- */
        .save-footer {
            text-align: right;
            margin-top: 25px;
        }

        .save-button {
            background-color: var(--color-primario);
            color: var(--color-blanco);
            border: none;
            padding: 12px 25px;
            border-radius: 0.5rem;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .save-button:hover {
            background-color: var(--color-primario-oscuro);
        }

        .save-button i {
            margin-left: 8px;
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--color-blanco);
            padding: 25px;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0,0,0,.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        .modal-title {
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 700;
            color: var(--color-texto-principal);
        }
        .modal-content p {
            margin-bottom: 25px;
        }
        .modal-footer {
            text-align: center;
        }
        .modal-input {
            width: 100%;
            padding: 8px;
            border-radius: 0.5rem;
            border: 1px solid var(--color-borde-suave);
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a class="navbar-brand" href="#">
                <div class="logo-circle"></div>
                <h1>Gesti√≥n Acad√©mica</h1>
            </a>
        </div>
    </nav>
    <div class="page-container">
        <div class="container">
            <main>
                <section class="main-header">
                    <div class="profile-card">
                        <div class="avatar-large">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="profile-info">
                            <h2 id="professor-name">Cargando...</h2>
                            <p id="professor-campus">Cargando...</p>
                            <p><strong>Rol:</strong> Profesor</p>
                        </div>
                    </div>
                    <div class="info-cards">
                        <div class="card students-card">
                            <div class="card-body">
                                <p class="card-title">Estudiantes</p>
                                <p class="card-content" id="total-students">0</p>
                                <p class="card-footer mb-0 text-muted small">Total de estudiantes</p>
                            </div>
                        </div>
                        <div class="card course-card">
                             <div class="card-body">
                                <p class="fw-bold mb-1">Curso</p>
                                <p class="mb-1" id="course-info">Cargando...</p>
                                <p class="mb-0 text-muted small" id="course-representative">Cargando...</p>
                             </div>
                        </div>
                    </div>
                </section>

                <nav class="content-tabs">
                    <a id="attendance-tab" class="tab-link active">Asistencia</a>
                    <a id="grades-tab" class="tab-link">Calificaciones</a>
                </nav>

                <div id="attendance-content">
                    <!-- Monthly List View (Default) -->
                    <section id="monthly-view" class="content-section">
                        <div class="attendance-header">
                            <div class="month-navigation">
                                <button id="prev-month-btn" class="nav-btn"><i class="fas fa-chevron-left"></i></button>
                                <h2 id="month-year-display"></h2>
                                <button id="next-month-btn" class="nav-btn"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="controls">
                               <button id="go-to-today-btn" class="save-button">Tomar Asistencia de Hoy</button>
                            </div>
                        </div>
                        <div class="monthly-list-container">
                            <table class="monthly-grid-table">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Daily Attendance View (Hidden by default) -->
                    <section id="daily-view" class="content-section" style="display: none;">
                        <div class="attendance-header">
                            <h2 id="daily-view-title">Asistencia</h2>
                            <div class="controls">
                                <button id="back-to-monthly-btn" class="back-button">Volver al Mes</button>
                            </div>
                        </div>

                        <div class="summary-cards">
                            <div class="summary-card present">
                                <span class="count" id="present-count">0</span>
                                <span>Presentes</span>
                            </div>
                            <div class="summary-card absent">
                                <span class="count" id="absent-count">0</span>
                                <span>Ausentes</span>
                            </div>
                            <div class="summary-card late">
                                <span class="count" id="late-count">0</span>
                                <span>Tardes</span>
                            </div>
                        </div>

                        <div class="student-list">
                            <!-- Student Rows will be populated by JS -->
                        </div>

                        <div class="save-footer">
                            <button id="save-daily-attendance-btn" class="save-button">Guardar Asistencia <i class="fas fa-check-circle"></i></button>
                        </div>
                    </section>
                </div>

                <div id="grades-content" style="display: none;">
                    <section class="content-section">
                        <div class="grades-summary-cards">
                            <div class="grades-summary-card">
                                <div id="lowest-grade" class="value">0</div>
                                <div class="label">Calificaci√≥n M√°s Baja</div>
                            </div>
                            <div class="grades-summary-card">
                                <div id="highest-grade" class="value">0</div>
                                <div class="label">Calificaci√≥n M√°s Alta</div>
                            </div>
                            <div class="grades-summary-card">
                                <div id="average-grade" class="value">0</div>
                                <div class="label">Promedio de Clase</div>
                            </div>
                        </div>
                        <div class="grades-actions">
                             <div class="grades-settings">
                                <label for="min-grade">Nota M√≠n:</label>
                                <input type="number" id="min-grade" value="0">
                                <label for="max-grade">Nota M√°x:</label>
                                <input type="number" id="max-grade" value="100">
                                <label for="passing-grade">Nota Aprob:</label>
                                <input type="number" id="passing-grade" value="60">
                            </div>
                            <div>
                                <button id="generate-report-btn" class="back-button">Generar Reporte</button>
                                <button id="export-grades-btn" class="back-button">Exportar</button>
                                <button id="add-assignment-btn" class="save-button">A√±adir Asignaci√≥n</button>
                            </div>
                        </div>
                        <div class="grades-table-container">
                            <table class="grades-table">
                                <thead>
                                    <!-- Headers generated by JS -->
                                </thead>
                                <tbody>
                                    <!-- Grade rows will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Custom Modals -->
    <div id="alertModal" class="modal-overlay">
        <div class="modal-content">
            <h5 class="modal-title">Notificaci√≥n</h5>
            <p id="alertModalBody"></p>
            <div class="modal-footer">
                <button id="alertModalAcceptBtn" class="save-button">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="promptModal" class="modal-overlay">
        <div class="modal-content">
            <h5 id="promptModalTitle" class="modal-title"></h5>
            <p id="promptModalBody"></p>
            <input type="text" id="promptModalInput" class="modal-input">
            <div class="modal-footer">
                <button id="promptModalCancelBtn" class="back-button">Cancelar</button>
                <button id="promptModalConfirmBtn" class="save-button">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h5 class="modal-title">Confirmar Acci√≥n</h5>
            <p id="confirmModalBody"></p>
            <div class="modal-footer">
                <button id="confirmModalCancelBtn" class="back-button">Cancelar</button>
                <button id="confirmModalConfirmBtn" class="save-button">Confirmar</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- M√ìDULO DE UTILIDADES (MODALES Y VISTAS) ---
    const UI = (() => {
        const attendanceTab = document.getElementById('attendance-tab');
        const gradesTab = document.getElementById('grades-tab');
        const attendanceContent = document.getElementById('attendance-content');
        const gradesContent = document.getElementById('grades-content');

        const alertModal = document.getElementById('alertModal');
        const alertModalBody = document.getElementById('alertModalBody');
        const promptModal = document.getElementById('promptModal');
        const confirmModal = document.getElementById('confirmModal');

        const switchView = (activeTab, activeContent, inactiveTab, inactiveContent) => {
            activeTab.classList.add('active');
            inactiveTab.classList.remove('active');
            activeContent.style.display = 'block';
            inactiveContent.style.display = 'none';
        };

        const showModal = (modal, setup) => {
            setup();
            modal.classList.add('show');
        };

        const hideModal = (modal) => modal.classList.remove('show');

        const showAlert = (message) => {
            showModal(alertModal, () => {
                alertModalBody.innerHTML = message.replace(/\n/g, '<br>');
                document.getElementById('alertModalAcceptBtn').onclick = () => hideModal(alertModal);
            });
        };

        const showPrompt = (title, body, callback) => {
            showModal(promptModal, () => {
                promptModal.querySelector('#promptModalTitle').textContent = title;
                promptModal.querySelector('#promptModalBody').textContent = body;
                const input = promptModal.querySelector('#promptModalInput');
                input.value = '';

                const confirmBtn = promptModal.querySelector('#promptModalConfirmBtn');
                const cancelBtn = promptModal.querySelector('#promptModalCancelBtn');
                confirmBtn.onclick = () => { hideModal(promptModal); callback(input.value); };
                cancelBtn.onclick = () => { hideModal(promptModal); callback(null); };
            });
        };

        const showConfirm = (body, callback) => {
            showModal(confirmModal, () => {
                confirmModal.querySelector('#confirmModalBody').textContent = body;
                const confirmBtn = confirmModal.querySelector('#confirmModalConfirmBtn');
                const cancelBtn = confirmModal.querySelector('#confirmModalCancelBtn');
                confirmBtn.onclick = () => { hideModal(confirmModal); callback(true); };
                cancelBtn.onclick = () => { hideModal(confirmModal); callback(false); };
            });
        };

        return { switchView, showAlert, showPrompt, showConfirm, attendanceTab, gradesTab, attendanceContent, gradesContent };
    })();

    // --- DATOS GLOBALES ---
    let students = [];
    let assignmentNames = [];
    let attendanceData = {};
    let professorData = {};
    let courseData = {};

    // --- FUNCIONES PARA CARGAR DATOS ---
    const DataLoader = (() => {
        const loadProfessorData = async () => {
            // Usar datos inyectados por el servidor si existen
            if (window.SERVER_DATA && window.SERVER_DATA.profesor) {
                professorData = window.SERVER_DATA.profesor;
            } else {
                // fallback: intentar llamar a una API si se dispone
                try {
                    const res = await fetch('/profesor/api/mis-cursos');
                    if (res.ok) {
                        const json = await res.json();
                        // tomar primer curso si existe
                        professorData = { name: document.getElementById('professor-name').textContent || 'Profesor', campus: '' };
                    }
                } catch (e) {
                    professorData = { name: document.getElementById('professor-name').textContent || 'Profesor', campus: '' };
                }
            }

            document.getElementById('professor-name').textContent = professorData.nombre || professorData.name || 'Profesor';
            document.getElementById('professor-campus').textContent = professorData.sede || professorData.campus || '';
        };

        const loadCourseData = async () => {
            if (window.SERVER_DATA && window.SERVER_DATA.curso) {
                courseData = window.SERVER_DATA.curso;
                courseData.totalStudents = (window.SERVER_DATA.estudiantes || []).length;
            } else {
                // fallback: intentar usar API mis-cursos (tomar el primero)
                try {
                    const res = await fetch('/profesor/api/mis-cursos');
                    if (res.ok) {
                        const json = await res.json();
                        if (json.cursos && json.cursos.length > 0) {
                            courseData = json.cursos[0];
                        }
                    }
                } catch (e) {
                    courseData = {};
                }
            }

            document.getElementById('course-info').textContent = `${courseData.nombre || courseData.name || 'Curso'} - Director de Curso: ${courseData.director || 'No asignado'}`;
            document.getElementById('course-representative').textContent = `Representante de curso: ${courseData.representante || courseData.representative || ''}`;
        };

        const loadStudents = async () => {
            if (window.SERVER_DATA && Array.isArray(window.SERVER_DATA.estudiantes)) {
                students = window.SERVER_DATA.estudiantes.map(s => ({ id: s.id, name: `${s.nombre || ''} ${s.apellido || ''}`.trim(), grades: [] }));
            } else {
                // pedir a la API de calificaciones para obtener estudiantes incluidos (la API devuelve estudiante_nombre)
                try {
                    const res = await fetch('/profesor/api/obtener-calificaciones');
                    if (res.ok) {
                        const json = await res.json();
                        if (json.calificaciones) {
                            // construir lista √∫nica de estudiantes
                            const map = {};
                            json.calificaciones.forEach(c => {
                                map[c.estudiante_id] = map[c.estudiante_id] || { id: c.estudiante_id, name: c.estudiante_nombre, grades: [] };
                            });
                            students = Object.values(map);
                        }
                    }
                } catch (e) {
                    students = [];
                }
            }

            document.getElementById('total-students').textContent = students.length;
            courseData.totalStudents = students.length;
        };

        const loadAttendanceData = async () => {
            // Preferir datos inyectados por el servidor (si tuvieran historial),
            // caso contrario inicializar vac√≠o; la vista mensual pedir√° asistencias por mes usando la API.
            attendanceData = {};
        };

        const loadGradesData = async () => {
            // Intentar usar categorias y asignaturas inyectadas
            if (window.SERVER_DATA && Array.isArray(window.SERVER_DATA.asignaturas)) {
                assignmentNames = window.SERVER_DATA.asignaturas.map(a => a.nombre || a.name);
            } else {
                assignmentNames = [];
            }
            students.forEach(student => student.grades = []);
        };

        const initializeAllData = async () => {
            try {
                await loadProfessorData();
                await loadCourseData();
                await loadStudents();
                await loadAttendanceData();
                await loadGradesData();

                // Si hay datos pre-cargados (window.SERVER_DATA) y contiene calificaciones,
                // mapearlas a students.grades para mostrar en la tabla
                if (window.SERVER_DATA && Array.isArray(window.SERVER_DATA.calificaciones)) {
                    const calMap = {};
                    window.SERVER_DATA.calificaciones.forEach(c => {
                        const sid = c.estudiante_id;
                        calMap[sid] = calMap[sid] || [];
                        calMap[sid].push(c);
                    });
                    students.forEach(s => {
                        s.grades = (calMap[s.id] || []).map(x => x.valor !== null ? x.valor : '');
                    });
                }

                // Inicializar m√≥dulos despu√©s de cargar datos
                AttendanceModule.init();
                GradesModule.init();
                
            } catch (error) {
                console.error('Error loading data:', error);
                UI.showAlert('Error al cargar los datos. Por favor, recarga la p√°gina.');
            }
        };

        return { initializeAllData };
    })();

    // --- M√ìDULO DE ASISTENCIA ---
    const AttendanceModule = (() => {
        const monthlyView = document.getElementById('monthly-view');
        const dailyView = document.getElementById('daily-view');
        const monthYearDisplay = document.getElementById('month-year-display');
        const monthlyTableHead = document.querySelector('.monthly-grid-table thead');
        const monthlyTableBody = document.querySelector('.monthly-grid-table tbody');
        const dailyViewTitle = document.getElementById('daily-view-title');

        let currentDisplayDate = new Date();
        let selectedDateForDailyView = null;

        const countUnexcusedAbsences = (studentId, year, month) => {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let unexcusedCount = 0;
            for (let i = 1; i <= daysInMonth; i++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const studentData = attendanceData[dateKey]?.[studentId];
                if (studentData?.absent && !studentData.excuse) {
                    unexcusedCount++;
                }
            }
            return unexcusedCount;
        };

        const renderMonthlyList = (year, month) => {
            monthYearDisplay.textContent = new Date(year, month).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            monthlyTableHead.innerHTML = `<tr><th class="student-name-header">Estudiante</th>${Array.from({ length: new Date(year, month + 1, 0).getDate() }, (_, i) => {
                const day = i + 1;
                const date = new Date(year, month, day);
                const isToday = date.setHours(0, 0, 0, 0) === new Date().setHours(0, 0, 0, 0);
                return `<th class="day-header ${isToday ? 'today' : ''}" data-day="${day}">${day}</th>`;
            }).join('')}</tr>`;

            monthlyTableBody.innerHTML = students.map(student => {
                const unexcusedAbsences = countUnexcusedAbsences(student.id, year, month);
                const rowClass = unexcusedAbsences >= 3 ? 'highlight-absentee' : '';
                const days = Array.from({ length: new Date(year, month + 1, 0).getDate() }, (_, i) => {
                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i + 1).padStart(2, '0')}`;
                    const studentData = attendanceData[dateKey]?.[student.id];
                    const status = studentData ? (studentData.absent ? 'absent' : (studentData.late ? 'late' : (studentData.present ? 'present' : null))) : '';
                    const hasExcuse = studentData?.excuse ? '<div class="excuse-dot"></div>' : '';
                    return `<td><div class="status-indicator ${status}">${hasExcuse}</div></td>`;
                }).join('');
                return `<tr class="${rowClass}"><td class="student-name-cell">${student.name}</td>${days}</tr>`;
            }).join('');
        };

        const showDailyView = (date) => {
            selectedDateForDailyView = date;
            dailyViewTitle.textContent = `Asistencia para ${date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}`;
            populateStudentListForDay(date);
            monthlyView.style.display = 'none';
            dailyView.style.display = 'block';
        };

        const populateStudentListForDay = (date) => {
            const studentListContainer = dailyView.querySelector('.student-list');
            const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            studentListContainer.innerHTML = `<div class="list-header"><span class="student-name-header-daily">Nombre del Estudiante</span><span class="attendance-status-header">Estado de Asistencia</span></div>${students.map(student => {
                const studentData = attendanceData[dateKey]?.[student.id];
                const isAbsent = studentData?.absent || false;
                const isLate = studentData?.late || false;
                const isPresent = studentData?.present || false;
                const hasExcuse = studentData?.excuse || false;
                return `<div class="student-row" data-student-id="${student.id}"><div class="student-info"><div class="avatar-small">${student.id}</div><span>${student.name}</span></div><div class="attendance-controls"><button class="status-btn present ${isPresent ? 'selected' : ''}">Presente</button><button class="status-btn absent ${isAbsent ? 'selected' : ''}">Ausente</button><button class="status-btn late ${isLate ? 'selected' : ''}">Tarde</button><div class="excuse-container" style="display: ${isAbsent || isLate ? 'flex' : 'none'};"><label class="excuse-label"><input type="checkbox" class="excuse-checkbox" ${hasExcuse ? 'checked' : ''}> Trajo Excusa</label></div></div></div>`;
            }).join('')}`;
            setupDailyViewLogic();
        };

        const setupDailyViewLogic = () => {
            const studentRows = dailyView.querySelectorAll('.student-row');
            const presentCountEl = document.getElementById('present-count');
            const absentCountEl = document.getElementById('absent-count');
            const lateCountEl = document.getElementById('late-count');
            
            const updateSummary = () => {
                let present = 0, absent = 0, late = 0;
                studentRows.forEach(row => {
                    if (row.querySelector('.status-btn.present').classList.contains('selected')) present++;
                    if (row.querySelector('.status-btn.absent').classList.contains('selected')) absent++;
                    if (row.querySelector('.status-btn.late').classList.contains('selected')) late++;
                });
                presentCountEl.textContent = present;
                absentCountEl.textContent = absent;
                lateCountEl.textContent = late;
            };

            const updateExcuseVisibility = (row) => {
                const isAbsentOrLate = row.querySelector('.status-btn.absent').classList.contains('selected') || row.querySelector('.status-btn.late').classList.contains('selected');
                row.querySelector('.excuse-container').style.display = isAbsentOrLate ? 'flex' : 'none';
                if (!isAbsentOrLate) row.querySelector('.excuse-checkbox').checked = false;
            };

            studentRows.forEach(row => {
                const btns = row.querySelectorAll('.status-btn');
                btns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const status = btn.classList[1]; // present, absent, late
                        const presentBtn = row.querySelector('.status-btn.present');
                        const absentBtn = row.querySelector('.status-btn.absent');
                        const lateBtn = row.querySelector('.status-btn.late');

                        if (status === 'present') {
                            presentBtn.classList.toggle('selected');
                            absentBtn.classList.remove('selected');
                            if (!presentBtn.classList.contains('selected')) lateBtn.classList.remove('selected');
                        } else if (status === 'absent') {
                            absentBtn.classList.toggle('selected');
                            if (absentBtn.classList.contains('selected')) {
                                presentBtn.classList.remove('selected');
                                lateBtn.classList.remove('selected');
                            }
                        } else if (status === 'late') {
                            lateBtn.classList.toggle('selected');
                            if (lateBtn.classList.contains('selected')) {
                                presentBtn.classList.add('selected');
                                absentBtn.classList.remove('selected');
                            }
                        }
                        updateExcuseVisibility(row);
                        updateSummary();
                    });
                });
            });
            updateSummary();
        };

        const saveDailyAttendance = async () => {
            const date = selectedDateForDailyView;
            const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            attendanceData[dateKey] = {};
            
            dailyView.querySelectorAll('.student-row').forEach(row => {
                const studentId = row.dataset.studentId;
                const isPresent = row.querySelector('.status-btn.present').classList.contains('selected');
                const isAbsent = row.querySelector('.status-btn.absent').classList.contains('selected');
                const isLate = row.querySelector('.status-btn.late').classList.contains('selected');
                const hasExcuse = row.querySelector('.excuse-checkbox').checked;
                if (isPresent || isAbsent || isLate) {
                    attendanceData[dateKey][studentId] = { present: isPresent, absent: isAbsent, late: isLate, excuse: hasExcuse };
                }
            });

            // Aqu√≠ puedes guardar en tu API
            // Ejemplo: await fetch('/api/attendance', { method: 'POST', body: JSON.stringify(attendanceData[dateKey]) });
            
            UI.showAlert('Asistencia guardada!');
            showMonthlyView();
        };

        const showMonthlyView = () => {
            dailyView.style.display = 'none';
            monthlyView.style.display = 'block';
            renderMonthlyList(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
        };

        const setupEventListeners = () => {
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentDisplayDate.setMonth(currentDisplayDate.getMonth() - 1);
                renderMonthlyList(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentDisplayDate.setMonth(currentDisplayDate.getMonth() + 1);
                renderMonthlyList(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
            });
            document.getElementById('go-to-today-btn').addEventListener('click', () => showDailyView(new Date()));
            document.getElementById('back-to-monthly-btn').addEventListener('click', () => showMonthlyView());
            document.getElementById('save-daily-attendance-btn').addEventListener('click', saveDailyAttendance);
            monthlyTableHead.addEventListener('click', (e) => {
                if (e.target.dataset.day) {
                    const day = parseInt(e.target.dataset.day);
                    showDailyView(new Date(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth(), day));
                }
            });
        };

        return { 
            init: () => { 
                setupEventListeners(); 
                renderMonthlyList(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth()); 
            } 
        };
    })();

    // --- M√ìDULO DE CALIFICACIONES ---
    const GradesModule = (() => {
        const gradesTable = document.querySelector('.grades-table');
        const gradesTableHead = gradesTable.querySelector('thead');
        const gradesTableBody = gradesTable.querySelector('tbody');
        const lowestGradeEl = document.getElementById('lowest-grade');
        const highestGradeEl = document.getElementById('highest-grade');
        const averageGradeEl = document.getElementById('average-grade');
        const passingGradeInput = document.getElementById('passing-grade');
        const minGradeInput = document.getElementById('min-grade');
        const maxGradeInput = document.getElementById('max-grade');

        const calculateAllAverages = () => {
            let allGrades = [];
            const passingGrade = parseFloat(passingGradeInput.value) || 60;

            gradesTableBody.querySelectorAll('tr').forEach((row, studentIndex) => {
                let sum = 0, count = 0;
                row.querySelectorAll('.grade-input').forEach((input, gradeIndex) => {
                    const value = parseFloat(input.value);
                    if (!isNaN(value)) {
                        sum += value;
                        count++;
                        allGrades.push(value);
                    }
                    students[studentIndex].grades[gradeIndex] = isNaN(value) ? '' : value;
                });
                const average = count > 0 ? (sum / count).toFixed(1) : 'N/A';
                const averageCell = row.querySelector('.average-cell');
                averageCell.textContent = average;
                averageCell.classList.toggle('failing', average !== 'N/A' && parseFloat(average) < passingGrade);
                row.classList.toggle('failing-student', average !== 'N/A' && parseFloat(average) < passingGrade);
            });

            if (allGrades.length > 0) {
                lowestGradeEl.textContent = Math.min(...allGrades).toFixed(1);
                highestGradeEl.textContent = Math.max(...allGrades).toFixed(1);
                averageGradeEl.textContent = (allGrades.reduce((a, b) => a + b, 0) / allGrades.length).toFixed(1);
            } else {
                lowestGradeEl.textContent = '0';
                highestGradeEl.textContent = '0';
                averageGradeEl.textContent = '0';
            }
        };

        const renderGradesTable = () => {
            gradesTableHead.innerHTML = `<tr><th class="student-name-header">Nombre</th>${assignmentNames.map(name =>
                `<th><span>${name}</span> <span class="assignment-actions"><i class="fas fa-pencil-alt" data-action="edit-assignment"></i><i class="fas fa-trash-alt delete-assignment-icon" data-action="delete-assignment"></i></span></th>`
            ).join('')}<th>Promedio</th></tr>`;

            gradesTableBody.innerHTML = students.map(student =>
                `<tr data-student-id="${student.id}"><td class="student-name-cell">${student.name}</td>${student.grades.map(grade =>
                    `<td><input type="number" class="grade-input" value="${grade}"></td>`
                ).join('')}<td class="average-cell">0</td></tr>`
            ).join('');
            
            calculateAllAverages();
        };

        const setupEventListeners = () => {
            document.getElementById('add-assignment-btn').addEventListener('click', () => {
                UI.showPrompt("Nueva Asignaci√≥n", "Introduce el nombre de la nueva asignaci√≥n:", (name) => {
                    if (name && name.trim() !== '') {
                        assignmentNames.push(name.trim());
                        students.forEach(student => student.grades.push(''));
                        renderGradesTable();
                        
                        // Aqu√≠ puedes guardar en tu API
                        // Ejemplo: await fetch('/api/assignments', { method: 'POST', body: JSON.stringify({ name: name.trim() }) });
                    }
                });
            });

            gradesTableHead.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                if (!action) return;
                const headerCell = e.target.closest('th');
                const columnIndex = Array.from(headerCell.parentNode.children).indexOf(headerCell) - 1;
                const currentName = assignmentNames[columnIndex];

                if (action === 'delete-assignment') {
                    UI.showConfirm(`¬øEst√°s seguro de que quieres eliminar la columna "${currentName}"?`, async (confirmed) => {
                        if (confirmed) {
                            assignmentNames.splice(columnIndex, 1);
                            students.forEach(student => student.grades.splice(columnIndex, 1));
                            renderGradesTable();
                            
                            // Aqu√≠ puedes eliminar de tu API
                            // Ejemplo: await fetch(`/api/assignments/${columnIndex}`, { method: 'DELETE' });
                        }
                    });
                } else if (action === 'edit-assignment') {
                    UI.showPrompt('Editar Asignaci√≥n', `Introduce el nuevo nombre para "${currentName}":`, async (newName) => {
                        if (newName && newName.trim() !== '') {
                            assignmentNames[columnIndex] = newName.trim();
                            renderGradesTable();
                            
                            // Aqu√≠ puedes actualizar en tu API
                            // Ejemplo: await fetch(`/api/assignments/${columnIndex}`, { method: 'PUT', body: JSON.stringify({ name: newName.trim() }) });
                        }
                    });
                }
            });

            gradesTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('grade-input')) {
                    const value = parseFloat(e.target.value);
                    const min = parseFloat(minGradeInput.value);
                    const max = parseFloat(maxGradeInput.value);
                    if (e.target.value !== '' && (value < min || value > max)) {
                        e.target.value = '';
                    }
                    calculateAllAverages();
                    
                    // Aqu√≠ puedes guardar en tu API
                    // Ejemplo: await fetch('/api/grades', { method: 'POST', body: JSON.stringify(students) });
                }
            });

            document.querySelectorAll('.grades-settings input').forEach(input => {
                input.addEventListener('change', calculateAllAverages);
            });

            document.getElementById('export-grades-btn').addEventListener('click', () => {
                // Implementar exportaci√≥n de calificaciones
                UI.showAlert('Funcionalidad de exportaci√≥n en desarrollo');
            });

            document.getElementById('generate-report-btn').addEventListener('click', () => {
                // Implementar generaci√≥n de reportes
                UI.showAlert('Funcionalidad de reportes en desarrollo');
            });
        };

        return { init: () => { setupEventListeners(); renderGradesTable(); } };
    })();

    // --- INICIALIZACI√ìN GENERAL ---
    UI.attendanceTab.addEventListener('click', () => UI.switchView(UI.attendanceTab, UI.attendanceContent, UI.gradesTab, UI.gradesContent));
    UI.gradesTab.addEventListener('click', () => UI.switchView(UI.gradesTab, UI.gradesContent, UI.attendanceTab, UI.attendanceContent));

    // Iniciar carga de datos
    DataLoader.initializeAllData();
});
</script>
</body>
</html>