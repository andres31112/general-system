{% extends "base.html" %}

{% block title %}Notificaciones - Panel de Administrador{% endblock %}

{% block extra_css %}
<style>
    .notification-card {
        border-left: 4px solid #F95738;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .notification-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .notification-card.unread {
        background: linear-gradient(135deg, rgba(249, 87, 56, 0.05), rgba(249, 87, 56, 0.02));
        border-left-color: #F95738;
    }
    
    .notification-card.read {
        background: #f8f9fa;
        border-left-color: #6c757d;
        opacity: 0.8;
    }
    
    .notification-type-badge {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 600;
    }
    
    .type-comunicacion { background: #e3f2fd; color: #1976d2; }
    .type-calificacion { background: #f3e5f5; color: #7b1fa2; }
    .type-asistencia { background: #e8f5e8; color: #388e3c; }
    .type-solicitud { background: #fff3e0; color: #f57c00; }
    .type-evento { background: #fce4ec; color: #c2185b; }
    .type-votacion { background: #e1f5fe; color: #0277bd; }
    .type-admin { background: #f1f8e9; color: #689f38; }
    
    .filters-container {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }
    
    .btn-filter {
        border-radius: 25px;
        padding: 8px 20px;
        margin: 0 5px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-filter.active {
        background: var(--gradient-primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(13, 59, 102, 0.3);
    }
    
    .notification-actions {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .notification-card:hover .notification-actions {
        opacity: 1;
    }
    
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: #dee2e6;
    }
    .type-incidente { 
    background: linear-gradient(135deg, #ffebee, #ffcdd2); 
    color: #c62828; 
    border: 1px solid #ef9a9a;
    }
    .type-mantenimiento { 
        background: linear-gradient(135deg, #e8f5e8, #c8e6c9); 
        color: #2e7d32; 
        border: 1px solid #a5d6a7;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-bell text-primary me-2"></i>Notificaciones
                    </h2>
                    <p class="text-muted mb-0">Gestiona tus notificaciones del sistema</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary me-2" id="btnMarcarTodas">
                        <i class="fas fa-check-double me-1"></i>Marcar todas como leÃ­das
                    </button>
                    <button class="btn btn-danger" id="btnEliminarTodas">
                        <i class="fas fa-trash me-1"></i>Eliminar todas
                    </button>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filters-container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="mb-2">Filtrar por estado:</h6>
                        <div>
                            <button class="btn btn-filter active" data-filtro="todas" id="btnTodas">
                                Todas
                            </button>
                            <button class="btn btn-filter" data-filtro="pendientes" id="btnPendientes">
                                Pendientes
                            </button>
                            <button class="btn btn-filter" data-filtro="leidas" id="btnLeidas">
                                LeÃ­das
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="d-flex align-items-center justify-content-end">
                            <span class="me-2">Notificaciones por pÃ¡gina:</span>
                            <select class="form-select form-select-sm" style="width: auto;" id="selectPerPage">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de notificaciones -->
            <div id="notifications-container">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando notificaciones...</p>
                </div>
            </div>

            <!-- PaginaciÃ³n -->
            <div class="pagination-container" id="pagination-container" style="display: none;">
                <!-- Se llena dinÃ¡micamente -->
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmaciÃ³n -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar acciÃ³n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Â¿EstÃ¡s seguro de que quieres realizar esta acciÃ³n?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmButton">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPT INLINE - Esto SÃ funciona -->
<script>
// =============================================
// SISTEMA DE NOTIFICACIONES - SCRIPT INLINE
// =============================================

console.log('ðŸŽ¯ SCRIPT INLINE CARGADO - Iniciando sistema de notificaciones');

// Variables globales
let currentPage = 1;
let currentFilter = 'todas';
let currentPerPage = 20;

// FunciÃ³n para cargar notificaciones
function cargarNotificaciones() {
    console.log('ðŸ”„ Cargando notificaciones...');
    
    const container = document.getElementById('notifications-container');
    const url = `/admin/api/notificaciones?page=${currentPage}&per_page=${currentPerPage}&filtro=${currentFilter}`;
    
    console.log('ðŸ“¡ URL:', url);
    
    // Mostrar loading
    container.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2 text-muted">Cargando notificaciones...</p>
        </div>
    `;
    
    // Hacer peticiÃ³n
    fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log('ðŸ“¦ Datos recibidos:', data);
            
            if (data.success && data.data) {
                mostrarNotificaciones(data.data);
            } else {
                throw new Error(data.message || 'Error en los datos');
            }
        })
        .catch(error => {
            console.error('ðŸ’¥ Error:', error);
            mostrarError('Error al cargar notificaciones: ' + error.message);
        });
}

// FunciÃ³n para mostrar notificaciones
function mostrarNotificaciones(data) {
    console.log('ðŸŽ¨ Mostrando notificaciones...');
    
    const container = document.getElementById('notifications-container');
    
    if (!data.notificaciones || data.notificaciones.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-bell-slash"></i>
                <h4>No hay notificaciones</h4>
                <p>No se encontraron notificaciones en el sistema.</p>
            </div>
        `;
        return;
    }
    
    console.log(`ðŸ“ Mostrando ${data.notificaciones.length} notificaciones`);
    
    let html = '';
    
    data.notificaciones.forEach(notif => {
        const fecha = new Date(notif.creada_en).toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const esLeida = notif.leida === true;
        
        html += `
            <div class="card notification-card mb-3 ${esLeida ? 'read' : 'unread'}" data-id="${notif.id_notificacion}">
                <div class="card-body">
                    <div class="row align-items-start">
                        <div class="col-md-8">
                            <div class="d-flex align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 ${esLeida ? '' : 'fw-bold'}">
                                        ${notif.titulo}
                                        <span class="notification-type-badge type-${notif.tipo} ms-2">
                                            ${getTipoTexto(notif.tipo)}
                                        </span>
                                    </h6>
                                    <p class="text-muted mb-2">${notif.mensaje}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>${fecha}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="notification-actions">
                                ${esLeida ? '' : `
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="marcarComoLeida(${notif.id_notificacion})">
                                        <i class="fas fa-check"></i>
                                    </button>
                                `}
                                <button class="btn btn-sm btn-outline-danger" onclick="eliminarNotificacion(${notif.id_notificacion})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    console.log('âœ… Notificaciones mostradas correctamente');
}

// FunciÃ³n para mostrar errores
function mostrarError(mensaje) {
    const container = document.getElementById('notifications-container');
    container.innerHTML = `
        <div class="alert alert-danger">
            <h4><i class="fas fa-exclamation-triangle"></i> Error</h4>
            <p>${mensaje}</p>
            <button class="btn btn-warning btn-sm" onclick="cargarNotificaciones()">
                Reintentar
            </button>
        </div>
    `;
}

// FunciÃ³n para obtener texto del tipo
function getTipoTexto(tipo) {
    const tipos = {
        'comunicacion': 'ComunicaciÃ³n',
        'calificacion': 'CalificaciÃ³n',
        'asistencia': 'Asistencia',
        'solicitud': 'Solicitud',
        'evento': 'Evento',
        'votacion': 'VotaciÃ³n',
        'admin': 'AdministraciÃ³n',
        'general': 'General',
        'sistema': 'Sistema'
    };
    return tipos[tipo] || tipo;
}

// =============================================
// FUNCIONES PARA LOS BOTONES
// =============================================

// FunciÃ³n para marcar como leÃ­da
function marcarComoLeida(id) {
    console.log('âœ… Marcando como leÃ­da:', id);
    
    fetch('/admin/api/notificaciones/marcar-leidas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            notificacion_ids: [id]
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar UI
            const card = document.querySelector(`[data-id="${id}"]`);
            if (card) {
                card.classList.remove('unread');
                card.classList.add('read');
                card.querySelector('h6').classList.remove('fw-bold');
                
                // Ocultar botÃ³n de marcar como leÃ­da
                const actions = card.querySelector('.notification-actions');
                actions.innerHTML = `
                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarNotificacion(${id})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            }
            mostrarMensaje('NotificaciÃ³n marcada como leÃ­da', 'success');
        } else {
            mostrarMensaje('Error: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('Error de conexiÃ³n', 'danger');
    });
}

// FunciÃ³n para eliminar notificaciÃ³n
function eliminarNotificacion(id) {
    if (confirm('Â¿EstÃ¡s seguro de eliminar esta notificaciÃ³n?')) {
        console.log('ðŸ—‘ï¸ Eliminando:', id);
        
        fetch('/admin/api/notificaciones/eliminar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                notificacion_ids: [id]
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const card = document.querySelector(`[data-id="${id}"]`);
                if (card) {
                    card.style.opacity = '0';
                    setTimeout(() => {
                        card.remove();
                        
                        // Si no quedan notificaciones, mostrar estado vacÃ­o
                        if (document.querySelectorAll('.notification-card').length === 0) {
                            document.getElementById('notifications-container').innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-bell-slash"></i>
                                    <h4>No hay notificaciones</h4>
                                    <p>Todas las notificaciones han sido eliminadas.</p>
                                </div>
                            `;
                        }
                    }, 300);
                }
                mostrarMensaje('NotificaciÃ³n eliminada', 'success');
            } else {
                mostrarMensaje('Error: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarMensaje('Error de conexiÃ³n', 'danger');
        });
    }
}

// FunciÃ³n para marcar todas como leÃ­das
function marcarTodasComoLeidas() {
    if (confirm('Â¿Marcar todas las notificaciones como leÃ­das?')) {
        fetch('/admin/api/notificaciones/marcar-leidas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar todas las notificaciones en la UI
                document.querySelectorAll('.notification-card.unread').forEach(card => {
                    card.classList.remove('unread');
                    card.classList.add('read');
                    card.querySelector('h6').classList.remove('fw-bold');
                });
                mostrarMensaje('Todas las notificaciones marcadas como leÃ­das', 'success');
            } else {
                mostrarMensaje('Error: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarMensaje('Error de conexiÃ³n', 'danger');
        });
    }
}

// FunciÃ³n para eliminar todas
function eliminarTodas() {
    if (confirm('Â¿EstÃ¡s seguro de eliminar TODAS las notificaciones? Esta acciÃ³n no se puede deshacer.')) {
        fetch('/admin/api/notificaciones/eliminar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                eliminar_todas: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('notifications-container').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h4>No hay notificaciones</h4>
                        <p>Todas las notificaciones han sido eliminadas.</p>
                    </div>
                `;
                mostrarMensaje('Todas las notificaciones eliminadas', 'success');
            } else {
                mostrarMensaje('Error: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarMensaje('Error de conexiÃ³n', 'danger');
        });
    }
}

// FunciÃ³n para cambiar filtro
function cambiarFiltro(filtro) {
    console.log('ðŸŽ›ï¸ Cambiando filtro a:', filtro);
    
    // Actualizar botones activos
    document.querySelectorAll('.btn-filter').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-filtro="${filtro}"]`).classList.add('active');
    
    // Actualizar filtro y recargar
    currentFilter = filtro;
    currentPage = 1;
    cargarNotificaciones();
}

// FunciÃ³n para cambiar nÃºmero por pÃ¡gina
function cambiarPerPage(perPage) {
    console.log('ðŸ“„ Cambiando a:', perPage, 'por pÃ¡gina');
    currentPerPage = parseInt(perPage);
    currentPage = 1;
    cargarNotificaciones();
}

// FunciÃ³n para mostrar mensajes
    mostrarConfirmacion(
        'Â¿EstÃ¡s seguro de que quieres eliminar TODAS las notificaciones? Esta acciÃ³n no se puede deshacer.',
        () => {
            fetch('/admin/api/notificaciones/eliminar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    eliminar_todas: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cargarNotificaciones(currentPage);
                    actualizarBadge();
                    mostrarMensaje('Todas las notificaciones fueron eliminadas', 'success');
                } else {
                    mostrarError('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarError('Error de conexiÃ³n');
            });
        }
    );
}

function actualizarBadge() {
    // Actualizar el badge en el menÃº lateral
    fetch('/admin/api/notificaciones?page=1&per_page=1&filtro=pendientes')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const badge = document.querySelector('.badge-notification');
                if (badge) {
                    const count = data.data.total;
                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }
        })
        .catch(error => console.error('Error actualizando badge:', error));
}

function getTipoText(tipo) {
    const tipos = {
        'comunicacion': 'ComunicaciÃ³n',
        'calificacion': 'CalificaciÃ³n',
        'asistencia': 'Asistencia',
        'solicitud': 'Solicitud',
        'evento': 'Evento',
        'votacion': 'VotaciÃ³n',
        'admin': 'AdministraciÃ³n',
        'incicente': 'Incidente TIC',
        'mantenimiento': 'Mantenimiento'
    };
    return tipos[tipo] || tipo;
}

function mostrarConfirmacion(mensaje, callback) {
    document.getElementById('confirmMessage').textContent = mensaje;
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
    
    document.getElementById('confirmButton').onclick = () => {
        modal.hide();
        callback();
    };
}

function mostrarMensaje(mensaje, tipo = 'info') {
    // Remover mensajes existentes
    const alertas = document.querySelectorAll('.alert-temporal');
    alertas.forEach(alerta => alerta.remove());
    
    const alertClass = tipo === 'success' ? 'alert-success' : 
                      tipo === 'danger' ? 'alert-danger' : 'alert-info';
    
    const html = `
        <div class="alert ${alertClass} alert-temporal alert-dismissible fade show" 
             style="position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 300px;">
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', html);
    
    // Auto-remover despuÃ©s de 4 segundos
    setTimeout(() => {
        const alert = document.querySelector('.alert-temporal');
        if (alert) alert.remove();
    }, 4000);
}

// =============================================
// CONFIGURACIÃ“N DE EVENT LISTENERS
// =============================================

// Esperar a que el DOM estÃ© listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ“„ DOM cargado - Configurando eventos');
    
    // Configurar event listeners para los botones
    document.getElementById('btnMarcarTodas').addEventListener('click', marcarTodasComoLeidas);
    document.getElementById('btnEliminarTodas').addEventListener('click', eliminarTodas);
    document.getElementById('btnTodas').addEventListener('click', () => cambiarFiltro('todas'));
    document.getElementById('btnPendientes').addEventListener('click', () => cambiarFiltro('pendientes'));
    document.getElementById('btnLeidas').addEventListener('click', () => cambiarFiltro('leidas'));
    document.getElementById('selectPerPage').addEventListener('change', function() {
        cambiarPerPage(this.value);
    });
    
    // Iniciar carga de notificaciones
    console.log('ðŸš€ Iniciando carga de notificaciones...');
    cargarNotificaciones();
});

console.log('âœ… Script inline cargado - Esperando DOM...');
</script>
{% endblock %}

{% block extra_js %}
<!-- Este bloque estÃ¡ vacÃ­o porque el script estÃ¡ inline -->
{% endblock %}