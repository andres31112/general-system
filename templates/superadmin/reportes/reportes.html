{% extends "base.html" %}

{% block title %}Reportes{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- HEADER PRINCIPAL -->
    <div class="custom-header">
        <h1>
            <i class="fas fa-chart-line me-2"></i> Reportes del Sistema
        </h1>
        <div class="header-icons">
            <button class="btn btn-light btn-sm" id="refresh-all">
                <i class="fas fa-sync-alt me-1"></i> Actualizar Todo
            </button>
        </div>
    </div>

    <!-- PESTAÑAS PRINCIPALES -->
    <ul class="nav nav-tabs mb-4 tabla-head" id="mainTabs" role="tablist">
        <li class="nav-item" id="pestanas-sedes" role="presentation">
            <button class="nav-link active rounded-top px-4 py-3" id="inventario-tab" data-bs-toggle="tab" data-bs-target="#inventario-pane">
                <i class="fas fa-clipboard-list me-2"></i> Reportes de Inventario
            </button>
        </li>
        <li class="nav-item" id="pestanas-sedes" role="presentation">
            <button class="nav-link rounded-top px-4 py-3" id="calificaciones-tab" data-bs-toggle="tab" data-bs-target="#calificaciones-pane">
                <i class="fas fa-chart-bar me-2"></i> Reportes de Calificaciones
            </button>
        </li>
    </ul>

    <div class="tab-content" id="mainTabContent">
        <!-- PESTAÑA INVENTARIO -->
        <div class="tab-pane fade show active" id="inventario-pane" role="tabpanel">
            <h1> Reportes de Inventario</h1>
            <!-- Subpestañas Internas -->
            <ul class="nav nav-tabs mb-4 tabla-head " id="pestanas-sedes" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="incidentes-subtab" data-bs-toggle="tab" data-bs-target="#incidentes">
                        <i class="fa-solid fa-triangle-exclamation me-2"></i> Incidentes
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pestanas-sedes" data-bs-toggle="tab" data-bs-target="#mantenimiento">
                        <i class="fa-solid fa-wrench me-2"></i> Mantenimiento
                    </button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- INCIDENTES -->
                <div class="tab-pane fade show active" id="incidentes">
                    <div class="main-panel">
                        <div class="tabla-head">
                            <i class="fa-solid fa-triangle-exclamation me-2"></i> Historial de Incidentes por Equipo
                        </div>
                        <div class="tabla-body">
                            <div class="table-responsive">
                                <table class="table tabla-inventario table-hover mb-0" id="tablaIncidentes">
                                    <thead>
                                        <tr>
                                            <th>EQUIPO</th>
                                            <th>ESTADO</th>
                                            <th>SALÓN</th>
                                            <th>SEDE</th>
                                            <th>INCIDENTES</th>
                                            <th>ACCIÓN</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MANTENIMIENTO -->
                <div class="tab-pane fade" id="mantenimiento">
                    <div class="main-panel">
                        <div class="tabla-head" style="background: linear-gradient(135deg, var(--accent2), #d68542);">
                            <i class="fa-solid fa-wrench me-2"></i> Historial de Mantenimientos por Equipo
                        </div>
                        <div class="tabla-body">
                            <div class="table-responsive">
                                <table class="table tabla-inventario table-hover mb-0" id="tablaMantenimientos">
                                    <thead>
                                        <tr>
                                            <th>EQUIPO</th>
                                            <th>ESTADO</th>
                                            <th>SALÓN</th>
                                            <th>SEDE</th>
                                            <th>MANTENIMIENTOS</th>
                                            <th>ACCIÓN</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PESTAÑA CALIFICACIONES -->
        <div class="tab-pane fade" id="calificaciones-pane" role="tabpanel">
            <div class="main-panel">
                <div class="tabla-head d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i> Reportes de Calificaciones
                    </h5>
                    <button id="refresh-btn" class="btn btn-light btn-sm">
                        <i class="fas fa-sync-alt me-1"></i> Actualizar
                    </button>
                </div>
                <div class="panel-content p-4">
                    <!-- Filtros -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label class="form-label text-muted">Estado:</label>
                            <select id="filtro-estado" class="form-select form-select-sm">
                                <option value="">Todos los estados</option>
                                <option value="pendiente">Pendiente</option>
                                <option value="revisado">Revisado</option>
                                <option value="archivado">Archivado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted">Curso:</label>
                            <input type="text" id="filtro-curso" class="form-control form-control-sm" placeholder="Buscar por curso...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted">Profesor:</label>
                            <input type="text" id="filtro-profesor" class="form-control form-control-sm" placeholder="Buscar por profesor...">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button id="limpiar-filtros" class="btn btn-outline-secondary btn-sm w-100">
                                <i class="fas fa-times me-1"></i> Limpiar
                            </button>
                        </div>
                    </div>

                    <!-- Estados de carga -->
                    <div id="loading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Cargando reportes...</p>
                    </div>
                    <div id="no-reports" class="text-center py-5" style="display: none;">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay reportes</h5>
                    </div>

                    <!-- Tabla de reportes -->
                    <div class="table-responsive">
                        <table id="reportes-table" class="table tabla-inventario table-hover" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Profesor</th>
                                    <th>Curso</th>
                                    <th>Asignatura</th>
                                    <th>Estudiantes</th>
                                    <th>Promedio</th>
                                    <th>Nota Alta</th>
                                    <th>Nota Baja</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="reportes-tbody"></tbody>
                        </table>
                    </div>

                    <!-- Paginación -->
                    <div id="pagination-container" class="d-flex justify-content-between align-items-center mt-3" style="display: none;">
                        <div class="d-flex align-items-center">
                            <span class="text-muted me-3">Mostrando <span id="showing-start">0</span> a <span id="showing-end">0</span> de <span id="total-items">0</span></span>
                            <select id="per-page-select" class="form-select form-select-sm" style="width: auto;">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <nav>
                            <ul id="pagination-nav" class="pagination pagination-sm mb-0"></ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL HISTORIAL INVENTARIO -->
<div class="modal fade" id="modalHistorial" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title fw-bold" id="modalTitulo">
                    <i class="fa-solid fa-history"></i> Historial de <span id="tipoHistorial"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="loadingHistorial" class="text-center py-5">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                    <p class="mt-3 text-muted">Cargando historial...</p>
                </div>
                <div id="contenidoHistorial"></div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                    <i class="fa-solid fa-times me-2"></i> Cerrar
                </button>
                <button id="btnDescargarPDF" class="btn btn-danger px-5 shadow">
                    <i class="fa-solid fa-file-pdf me-2"></i> Descargar PDF
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODALES CALIFICACIONES -->
<div class="modal fade" id="detalleReporteModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title"><i class="fas fa-file-alt me-2"></i>Detalle del Reporte</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalle-contenido">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Cargando detalles...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="abrirComunicado()">
                    <i class="fas fa-paper-plane me-2"></i>Enviar Comunicado
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="comunicadoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745, #20c997);">
                <h5 class="modal-title text-white"><i class="fas fa-envelope me-2"></i>Enviar Comunicado</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="comunicadoForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Profesor:</label>
                        <input type="text" id="profesor-info" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Reporte:</label>
                        <input type="text" id="reporte-info" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Asunto:</label>
                        <input type="text" id="asunto-comunicado" class="form-control" required placeholder="Ej: Revisión de calificaciones del curso...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Mensaje:</label>
                        <textarea id="mensaje-comunicado" class="form-control" rows="6" required placeholder="Escriba el mensaje del comunicado..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="enviarComunicadoBtn">
                    <i class="fas fa-paper-plane me-2"></i>Enviar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
:root {
    --accent1: #F95738;
    --accent2: #EE964B;
    --accent3: #F4D35E;
    --accent4: #0D3B66;
    --light: #FAF0CA;
    --main-bg: #F8F9FA;
    --white: #FFFFFF;
    --black: #333333;
    --gray: #666666;
    --light-gray: #F8F9FA;
    --border: #E9ECEF;
    --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.12);
    --gradient-primary: linear-gradient(135deg, var(--accent4), #1a5080);
    --border-radius: 12px;
    --transition: all 0.3s ease;
}

body {
    background: linear-gradient(135deg, var(--light) 0%, var(--main-bg) 100%) !important;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Header Styles */
.custom-header {
    background: linear-gradient(135deg, var(--accent4), #1a5080);
    color: white;
    padding: 18px 25px;
    border-radius: 12px;
    max-width: 90%;
    margin: 0 auto 25px auto;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.custom-header h1 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 700;
}

.header-icons {
    display: flex;
    align-items: center;
    gap: 15px;
}

/* Tabs */
.nav-tabs .nav-link {
    border: none;
    color: var(--gray);
    font-weight: 600;
    padding: 1rem 1.5rem;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    transition: var(--transition);
    background: transparent;
}

.nav-tabs .nav-link:hover {
    color: var(--accent4);
}

.nav-tabs .nav-link.active {
    background: white;
    color: var(--accent4);
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    font-weight: 700;
}

/* Main Panel */
.main-panel {
    border-radius: 15px;
    overflow: hidden;
    box-shadow: var(--shadow);
    background: white;
}

.panel-content {
    padding: 0 !important;
}

.tabla-head {
    background: linear-gradient(135deg, var(--accent4), #1a5080);
    color: white;
    padding: 15px 20px;
    width: 100%;
    margin: 0;
    font-weight: 600;
    font-size: 1.1rem;
}

.tabla-body {
    background-color: white;
}

/* Tables */
.tabla-inventario {
    margin: 0;
    border-radius: 0 0 15px 15px;
}

.tabla-inventario thead {
    background-color: #f8f9fa;
}

.tabla-inventario thead th {
    background: var(--accent4);
    color: white;
    border: none;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
    padding: 12px;
}

.tabla-inventario tbody tr {
    transition: var(--transition);
}

.tabla-inventario tbody tr:hover {
    background-color: #f8f9fa;
}

.tabla-inventario tbody tr:last-child td:first-child {
    border-bottom-left-radius: 15px;
}

.tabla-inventario tbody tr:last-child td:last-child {
    border-bottom-right-radius: 15px;
}

/* Buttons */
.btn-detalle {
    background: var(--accent1);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.9rem;
    transition: var(--transition);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-detalle:hover {
    background: #e03e1f;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    color: white;
}

/* Badges */
.badge-incidente { 
    background: var(--accent1); 
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
}

.badge-mantenimiento { 
    background: var(--accent2); 
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
}

.badge-estado { 
    font-size: 0.85em;
    padding: 6px 12px;
    border-radius: 6px;
    font-weight: 600;
}

.badge-pendiente { 
    background-color: #ffc107; 
    color: #000; 
}

.badge-revisado { 
    background-color: #28a745; 
    color: #fff; 
}

.badge-archivado { 
    background-color: #6c757d; 
    color: #fff; 
}

/* Modal */
.modal-header {
    background: var(--gradient-primary);
    color: white;
}

.list-group-item {
    border-left: 5px solid var(--accent4);
    margin-bottom: 0.8rem;
    border-radius: 0 var(--border-radius) var(--border-radius) 0;
    padding: 1rem;
    background: #f8f9fa;
    transition: var(--transition);
}

.list-group-item:hover {
    background: #e9ecef;
    transform: translateX(4px);
}

/* Student Cards */
.student-card {
    border-left: 4px solid var(--accent4);
    background: #f8f9fa;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    transition: var(--transition);
}

.student-card:hover {
    background: #e9ecef;
    transform: translateX(3px);
}

.nota-badge {
    font-size: 1.1rem;
    font-weight: 700;
    padding: 8px 15px;
    border-radius: 8px;
}

.nota-alta {
    background: #d4edda;
    color: #155724;
}

.nota-media {
    background: #fff3cd;
    color: #856404;
}

.nota-baja {
    background: #f8d7da;
    color: #721c24;
}

/* Pagination */
.pagination .page-link {
    color: var(--accent4);
    border: 1px solid #dee2e6;
    border-radius: 6px;
    margin: 0 3px;
    transition: var(--transition);
}

.tabla-head{
    background: linear-gradient(135deg, var(--accent4), #1a5080);
    color: white;
    padding: 15px 20px;
    width: 100%;
    border-radius: 15px 15px 0 0;
    margin: 0;
}

#pestanas-sedes .nav-link.active {
    background-color: var(--accent3);
    color: black !important;
    font-weight: 600;
}


.pagination .page-link:hover {
    background-color: var(--accent4);
    color: white;
    border-color: var(--accent4);
}

.pagination .page-item.active .page-link {
    background-color: var(--accent4);
    border-color: var(--accent4);
}

/* Summary Cards (for detail view) */
.summary-card {
    background: linear-gradient(135deg, white, #f8f9fa);
    border-radius: 15px;
    padding: 25px;
    box-shadow: var(--shadow);
    text-align: center;
    transition: transform 0.3s, box-shadow 0.3s;
    margin-bottom: 20px;
}

.summary-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}

.summary-card i {
    font-size: 42px;
    margin-bottom: 15px;
}

.summary-card h3 {
    color: #666;
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 10px;
}

.summary-card .number {
    font-size: 2.2rem;
    font-weight: 700;
    color: var(--accent4);
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ==================== INVENTARIO ====================
    const equipos = [];
    const modalHistorial = new bootstrap.Modal(document.getElementById('modalHistorial'));
    let historialActual = [], equipoActual = '', tipoHistorialActual = '';

    async function cargarEquipos() {
        try {
            const res = await fetch('/admin/api/equipos');
            const data = await res.json();
            equipos.length = 0;
            data.forEach(e => equipos.push({
                id: e.id || e.id_equipo,
                nombre: e.nombre || 'Sin nombre',
                estado: e.estado || 'Desconocido',
                salon: e.salon_nombre || 'Sin salón',
                sede: e.sede_nombre || 'Sin sede',
                incidentes: e.incidentes || 0,
                mantenimientos: e.mantenimientos || 0
            }));
            renderTablas();
        } catch (err) { console.error('Error:', err); }
    }

    function renderTablas() {
        renderTabla('#tablaIncidentes', 'incidentes');
        renderTabla('#tablaMantenimientos', 'mantenimientos');
    }

    function renderTabla(selector, tipo) {
        const tbody = document.querySelector(`${selector} tbody`);
        tbody.innerHTML = '';
        equipos.forEach(eq => {
            const count = tipo === 'incidentes' ? eq.incidentes : eq.mantenimientos;
            const badgeClass = tipo === 'incidentes' ? 'badge-incidente' : 'badge-mantenimiento';
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${eq.nombre}</strong></td>
                <td><span class="badge" style="background: ${getColor(eq.estado)};">${eq.estado}</span></td>
                <td>${eq.salon}</td>
                <td>${eq.sede}</td>
                <td><span class="badge ${badgeClass} fw-bold">${count}</span></td>
                <td>
                    <button class="btn btn-sm btn-detalle ver-historial" 
                            data-equipo-id="${eq.id}" data-tipo="${tipo}">
                        <i class="fa-solid fa-eye me-1"></i> Ver
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
        document.querySelectorAll('.ver-historial').forEach(btn => {
            btn.addEventListener('click', function() {
                mostrarHistorial(this.getAttribute('data-equipo-id'), this.getAttribute('data-tipo'));
            });
        });
    }

    function getColor(estado) {
        const map = {
            'Disponible': '#28a745',
            'Asignado': '#0078ad',
            'Mantenimiento': '#ffc107',
            'Incidente': '#dc3545',
            'Revisión': '#17a2b8'
        };
        return map[estado] || '#6c757d';
    }

    async function mostrarHistorial(equipoId, tipo) {
        equipoActual = equipos.find(e => e.id === parseInt(equipoId))?.nombre || 'Equipo';
        tipoHistorialActual = tipo;
        const titulo = document.getElementById('tipoHistorial');
        const contenido = document.getElementById('contenidoHistorial');
        const loading = document.getElementById('loadingHistorial');
        titulo.textContent = tipo === 'incidentes' ? 'Incidentes' : 'Mantenimientos';
        loading.style.display = 'block';
        contenido.innerHTML = '';
        modalHistorial.show();

        try {
            const endpoint = tipo === 'incidentes' 
                ? `/admin/api/incidentes/equipo/${equipoId}`
                : `/admin/api/mantenimientos/equipo/${equipoId}`;
            const res = await fetch(endpoint);
            const data = await res.json();
            if (!data || data.length === 0) {
                contenido.innerHTML = '<div class="text-center py-5"><p class="text-muted fs-5">No hay registros.</p></div>';
                loading.style.display = 'none';
                historialActual = [];
                return;
            }
            historialActual = data;
            const lista = document.createElement('div');
            lista.className = 'list-group';
            data.forEach(item => {
                const fecha = tipo === 'incidentes' 
                    ? new Date(item.fecha).toLocaleDateString('es-CO')
                    : new Date(item.fecha_programada).toLocaleDateString('es-CO');
                const desc = item.descripcion || 'Sin descripción';
                const responsable = tipo === 'incidentes' 
                    ? item.usuario_reporte || 'Anónimo'
                    : item.tecnico || 'No asignado';
                const estado = item.estado || 'N/A';
                const div = document.createElement('div');
                div.className = 'list-group-item';
                div.innerHTML = `
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="me-3">
                            <h6 class="mb-1 text-primary"><i class="fa-solid fa-calendar-alt me-2"></i>${fecha}</h6>
                            <p class="mb-2 fw-medium">${desc}</p>
                            <small class="text-muted"><i class="fa-solid fa-user me-1"></i> ${responsable}</small>
                        </div>
                        <span class="badge ${estado.toLowerCase().includes('resuelto') ? 'bg-success' : 'bg-warning'} px-3 py-2">${estado}</span>
                    </div>
                `;
                lista.appendChild(div);
            });
            contenido.appendChild(lista);
        } catch (err) {
            contenido.innerHTML = `<div class="text-center py-5"><p class="text-danger fs-5">Error al cargar datos</p></div>`;
        } finally {
            loading.style.display = 'none';
        }
    }

    document.getElementById('btnDescargarPDF').addEventListener('click', () => {
        if (historialActual.length === 0) return alert('No hay datos para exportar');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const margin = 14;
        let y = 20;
        const primary = [13, 59, 102];
        const accent = tipoHistorialActual === 'incidentes' ? [249, 87, 56] : [238, 150, 75];

        doc.setFontSize(24).setTextColor(...primary).setFont('helvetica', 'bold').text('HISTORIAL DE EQUIPO', margin, y);
        y += 10;
        doc.setFontSize(18).setTextColor(...accent).text(equipoActual.toUpperCase(), margin, y);
        y += 12;
        doc.setFontSize(12).setTextColor(80,80,80).text(`Tipo: ${tipoHistorialActual.toUpperCase()}`, margin, y);
        y += 6;
        doc.text(`Generado: ${new Date().toLocaleString('es-CO')}`, margin, y);
        y += 12;

        const headers = tipoHistorialActual === 'incidentes'
            ? [['FECHA', 'DESCRIPCIÓN', 'REPORTADO POR', 'ESTADO']]
            : [['FECHA', 'DESCRIPCIÓN', 'TÉCNICO', 'ESTADO']];
        const rows = historialActual.map(item => {
            const fecha = tipoHistorialActual === 'incidentes'
                ? new Date(item.fecha).toLocaleDateString('es-CO')
                : new Date(item.fecha_programada).toLocaleDateString('es-CO');
            const desc = (item.descripcion || '').substring(0,70) + '...';
            const resp = tipoHistorialActual === 'incidentes' ? item.usuario_reporte : item.tecnico;
            return [fecha, desc, resp || 'N/A', item.estado || 'N/A'];
        });

        doc.autoTable({ head: headers, body: rows, startY: y, theme: 'grid', headStyles: { fillColor: primary }, margin: { left: margin, right: margin } });
        doc.save(`${equipoActual}_${tipoHistorialActual}_${new Date().toISOString().slice(0,10)}.pdf`);
    });

    // Cargar al abrir pestaña
    document.getElementById('inventario-tab').addEventListener('shown.bs.tab', cargarEquipos);

    // ==================== CALIFICACIONES ====================
    let reportes = [], paginationData = {}, currentPage = 1, perPage = 10, currentReporte = null;
    const loadingEl = document.getElementById('loading');
    const noReportsEl = document.getElementById('no-reports');
    const tableEl = document.getElementById('reportes-table');
    const tbodyEl = document.getElementById('reportes-tbody');
    const modalDetalle = new bootstrap.Modal(document.getElementById('detalleReporteModal'));
    const modalComunicado = new bootstrap.Modal(document.getElementById('comunicadoModal'));

    document.getElementById('calificaciones-tab').addEventListener('shown.bs.tab', () => cargarReportes(1));

    async function cargarReportes(page = 1) {
        try {
            loadingEl.style.display = 'block'; 
            tableEl.style.display = 'none'; 
            noReportsEl.style.display = 'none';
            
            const params = new URLSearchParams({ 
                page, 
                per_page: perPage, 
                estado: document.getElementById('filtro-estado').value, 
                curso: document.getElementById('filtro-curso').value, 
                profesor: document.getElementById('filtro-profesor').value 
            });
            
            const res = await fetch(`/admin/api/reportes-calificaciones?${params}`);
            const data = await res.json();
            
            if (data.success) {
                reportes = data.reportes; 
                paginationData = data.pagination; 
                currentPage = page;
                renderizarReportes(); 
                renderizarPaginacion();
            }
        } catch (err) { 
            console.error(err);
            noReportsEl.style.display = 'block';
            noReportsEl.innerHTML = '<i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i><h5 class="text-danger">Error al cargar reportes</h5>';
        } finally { 
            loadingEl.style.display = 'none'; 
        }
    }

    function renderizarReportes() {
        if (reportes.length === 0) { 
            noReportsEl.style.display = 'block'; 
            return; 
        }
        
        noReportsEl.style.display = 'none'; 
        tableEl.style.display = 'table';
        
        tbodyEl.innerHTML = reportes.map(r => {
            const fecha = new Date(r.fecha_generacion).toLocaleDateString('es-ES');
            const numEst = Array.isArray(r.datos_estudiantes?.estudiantes) 
                ? r.datos_estudiantes.estudiantes.length 
                : (Array.isArray(r.datos_estudiantes) ? r.datos_estudiantes.length : 0);
            
            return `
                <tr>
                    <td>${fecha}</td>
                    <td>${r.profesor_nombre}</td>
                    <td>${r.curso_nombre}</td>
                    <td>${r.asignatura_nombre}</td>
                    <td><span class="badge bg-info">${numEst}</span></td>
                    <td><strong>${r.promedio_general}</strong></td>
                    <td><span class="text-success fw-bold">${r.nota_mas_alta}</span></td>
                    <td><span class="text-danger fw-bold">${r.nota_mas_baja}</span></td>
                    <td>${getEstadoBadge(r.estado)}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="verDetalle(${r.id_reporte})" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="Cambiar estado">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="cambiarEstado(${r.id_reporte}, 'pendiente'); return false;">
                                        <i class="fas fa-clock text-warning me-2"></i>Pendiente
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="cambiarEstado(${r.id_reporte}, 'revisado'); return false;">
                                        <i class="fas fa-check text-success me-2"></i>Revisado
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="cambiarEstado(${r.id_reporte}, 'archivado'); return false;">
                                        <i class="fas fa-archive text-secondary me-2"></i>Archivar
                                    </a></li>
                                </ul>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="eliminarReporte(${r.id_reporte})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function getEstadoBadge(estado) {
        const badges = { 
            'pendiente': '<span class="badge badge-estado badge-pendiente">Pendiente</span>', 
            'revisado': '<span class="badge badge-estado badge-revisado">Revisado</span>', 
            'archivado': '<span class="badge badge-estado badge-archivado">Archivado</span>' 
        };
        return badges[estado] || '<span class="badge badge-secondary">Desconocido</span>';
    }

    function renderizarPaginacion() {
        const container = document.getElementById('pagination-container');
        const nav = document.getElementById('pagination-nav');
        
        if (!paginationData.total || paginationData.total === 0) { 
            container.style.display = 'none'; 
            return; 
        }
        
        container.style.display = 'flex';
        document.getElementById('showing-start').textContent = (currentPage - 1) * perPage + 1;
        document.getElementById('showing-end').textContent = Math.min(currentPage * perPage, paginationData.total);
        document.getElementById('total-items').textContent = paginationData.total;
        
        nav.innerHTML = '';
        
        // Botón anterior
        if (currentPage > 1) {
            const prevLi = document.createElement('li');
            prevLi.className = 'page-item';
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="cargarReportes(${currentPage - 1}); return false;">«</a>`;
            nav.appendChild(prevLi);
        }
        
        // Páginas numeradas
        for (let i = 1; i <= paginationData.pages; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="cargarReportes(${i}); return false;">${i}</a>`;
            nav.appendChild(li);
        }
        
        // Botón siguiente
        if (currentPage < paginationData.pages) {
            const nextLi = document.createElement('li');
            nextLi.className = 'page-item';
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="cargarReportes(${currentPage + 1}); return false;">»</a>`;
            nav.appendChild(nextLi);
        }
    }

    // Eventos
    document.getElementById('refresh-btn').addEventListener('click', () => cargarReportes(currentPage));
    document.getElementById('refresh-all').addEventListener('click', () => {
        cargarEquipos();
        cargarReportes(currentPage);
    });
    
    ['filtro-estado', 'filtro-curso', 'filtro-profesor'].forEach(id => 
        document.getElementById(id).addEventListener('input', () => cargarReportes(1))
    );
    
    document.getElementById('limpiar-filtros').addEventListener('click', () => { 
        document.querySelectorAll('#filtro-estado, #filtro-curso, #filtro-profesor').forEach(el => el.value = ''); 
        cargarReportes(1); 
    });
    
    document.getElementById('per-page-select').addEventListener('change', function() { 
        perPage = this.value; 
        cargarReportes(1); 
    });

    // ==================== FUNCIONES GLOBALES - DETALLE ====================
    window.verDetalle = async function(id) {
        currentReporte = reportes.find(r => r.id_reporte === id);
        if (!currentReporte) return;

        const contenido = document.getElementById('detalle-contenido');
        contenido.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2">Cargando detalles...</p></div>';
        modalDetalle.show();

        try {
            const res = await fetch(`/admin/api/reportes-calificaciones/${id}`);
            const data = await res.json();
            
            if (data.success) {
                const reporte = data.reporte;
                const estudiantes = Array.isArray(reporte.datos_estudiantes?.estudiantes) 
                    ? reporte.datos_estudiantes.estudiantes 
                    : (Array.isArray(reporte.datos_estudiantes) ? reporte.datos_estudiantes : []);

                contenido.innerHTML = `
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="summary-card">
                                <i class="fas fa-users text-primary"></i>
                                <h3>Estudiantes</h3>
                                <div class="number">${estudiantes.length}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-card">
                                <i class="fas fa-chart-line text-info"></i>
                                <h3>Promedio</h3>
                                <div class="number">${reporte.promedio_general}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-card">
                                <i class="fas fa-arrow-up text-success"></i>
                                <h3>Nota Más Alta</h3>
                                <div class="number text-success">${reporte.nota_mas_alta}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-card">
                                <i class="fas fa-arrow-down text-danger"></i>
                                <h3>Nota Más Baja</h3>
                                <div class="number text-danger">${reporte.nota_mas_baja}</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h5 class="fw-bold mb-3"><i class="fas fa-info-circle text-primary me-2"></i>Información del Reporte</h5>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <strong>Profesor:</strong> ${reporte.profesor_nombre}
                            </div>
                            <div class="col-md-6 mb-2">
                                <strong>Curso:</strong> ${reporte.curso_nombre}
                            </div>
                            <div class="col-md-6 mb-2">
                                <strong>Asignatura:</strong> ${reporte.asignatura_nombre}
                            </div>
                            <div class="col-md-6 mb-2">
                                <strong>Fecha:</strong> ${new Date(reporte.fecha_generacion).toLocaleDateString('es-ES')}
                            </div>
                        </div>
                    </div>

                    <h5 class="fw-bold mb-3"><i class="fas fa-user-graduate text-primary me-2"></i>Calificaciones por Estudiante</h5>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${estudiantes.map((est, idx) => {
                            const nota = parseFloat(est.nota_final || est.nota || 0);
                            const notaClass = nota >= 4.0 ? 'nota-alta' : (nota >= 3.0 ? 'nota-media' : 'nota-baja');
                            return `
                                <div class="student-card">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>${idx + 1}. ${est.nombre_completo || est.nombre || 'Sin nombre'}</strong>
                                        </div>
                                        <span class="nota-badge ${notaClass}">${nota.toFixed(1)}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                contenido.innerHTML = '<div class="alert alert-danger">No se pudo cargar el detalle del reporte</div>';
            }
        } catch (err) {
            console.error(err);
            contenido.innerHTML = '<div class="alert alert-danger">Error al cargar el detalle</div>';
        }
    };

    // ==================== CAMBIAR ESTADO ====================
    window.cambiarEstado = async function(id, nuevoEstado) {
        if (!confirm(`¿Cambiar estado a "${nuevoEstado}"?`)) return;

        try {
            const res = await fetch(`/admin/api/reportes-calificaciones/${id}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: nuevoEstado })
            });

            const data = await res.json();
            
            if (data.success) {
                alert('Estado actualizado correctamente');
                cargarReportes(currentPage);
            } else {
                alert('Error al actualizar estado: ' + (data.message || 'Error desconocido'));
            }
        } catch (err) {
            console.error(err);
            alert('Error al actualizar estado');
        }
    };

    // ==================== ELIMINAR REPORTE ====================
    window.eliminarReporte = async function(id) {
        if (!confirm('¿Está seguro de eliminar este reporte? Esta acción no se puede deshacer.')) return;

        try {
            const res = await fetch(`/admin/api/reportes-calificaciones/${id}`, {
                method: 'DELETE'
            });

            const data = await res.json();
            
            if (data.success) {
                alert('Reporte eliminado correctamente');
                cargarReportes(currentPage);
            } else {
                alert('Error al eliminar reporte: ' + (data.message || 'Error desconocido'));
            }
        } catch (err) {
            console.error(err);
            alert('Error al eliminar reporte');
        }
    };

    // ==================== COMUNICADO ====================
    window.abrirComunicado = function() {
        if (!currentReporte) return;
        
        document.getElementById('profesor-info').value = currentReporte.profesor_nombre;
        document.getElementById('reporte-info').value = `${currentReporte.curso_nombre} - ${currentReporte.asignatura_nombre}`;
        document.getElementById('asunto-comunicado').value = `Revisión de calificaciones - ${currentReporte.curso_nombre}`;
        document.getElementById('mensaje-comunicado').value = '';
        
        modalDetalle.hide();
        modalComunicado.show();
    };

    document.getElementById('enviarComunicadoBtn').addEventListener('click', async function() {
        const asunto = document.getElementById('asunto-comunicado').value.trim();
        const mensaje = document.getElementById('mensaje-comunicado').value.trim();

        if (!asunto || !mensaje) {
            alert('Por favor complete todos los campos');
            return;
        }

        if (!currentReporte) {
            alert('No hay reporte seleccionado');
            return;
        }

        try {
            const res = await fetch('/admin/api/comunicados', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id_reporte: currentReporte.id_reporte,
                    id_profesor: currentReporte.id_profesor,
                    asunto: asunto,
                    mensaje: mensaje
                })
            });

            const data = await res.json();
            
            if (data.success) {
                alert('Comunicado enviado correctamente');
                modalComunicado.hide();
                document.getElementById('comunicadoForm').reset();
            } else {
                alert('Error al enviar comunicado: ' + (data.message || 'Error desconocido'));
            }
        } catch (err) {
            console.error(err);
            alert('Error al enviar comunicado');
        }
    });

    // Inicializar
    cargarEquipos();
});
</script>

{% endblock %}