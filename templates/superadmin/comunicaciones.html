{% extends "base.html" %}

{% block title %}Comunicaciones{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Principal -->
    <header class="text-center mb-4">
        <h1 class="text-principal">
            <i class="fas fa-envelope"></i> Comunicaciones
        </h1>
        <p class="lead text-muted" style="color: var(--gray) !important;">
            Sistema de mensajería para administradores
        </p>
    </header>

    <!-- Barra de búsqueda y acciones -->
    <div class="row justify-content-center mb-4">
        <div class="col-12 col-lg-8">
            <div class="card search-card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="input-group search-bar">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       class="form-control border-0" 
                                       placeholder="Buscar comunicaciones..." 
                                       id="searchInput">
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary compose-btn" id="composeBtn">
                                <i class="fas fa-edit me-2"></i>Redactar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navegación de carpetas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card folder-nav-card">
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <div class="folder-item active" data-folder="inbox">
                                <div class="folder-icon-container">
                                    <div class="folder-icon">
                                        <i class="fas fa-inbox"></i>
                                    </div>
                                    <span class="email-count" id="inboxCount">0</span>
                                </div>
                                <div class="folder-info">
                                    <h6>Bandeja de entrada</h6>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="folder-item" data-folder="sent">
                                <div class="folder-icon-container">
                                    <div class="folder-icon">
                                        <i class="fas fa-paper-plane"></i>
                                    </div>
                                    <span class="email-count" id="sentCount">0</span>
                                </div>
                                <div class="folder-info">
                                    <h6>Enviados</h6>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="folder-item" data-folder="draft">
                                <div class="folder-icon-container">
                                    <div class="folder-icon">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <span class="email-count" id="draftsCount">0</span>
                                </div>
                                <div class="folder-info">
                                    <h6>Borradores</h6>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="folder-item" data-folder="deleted">
                                <div class="folder-icon-container">
                                    <div class="folder-icon">
                                        <i class="fas fa-trash-alt"></i>
                                    </div>
                                    <span class="email-count" id="deletedCount">0</span>
                                </div>
                                <div class="folder-info">
                                    <h6>Papelera</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="row">
        <!-- Contenedor principal que se reemplaza -->
        <div class="col-12" id="mainContainer">
            <!-- Lista de emails (vista por defecto) -->
            <div id="emailListView">
                <div class="card email-list-card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="checkbox" id="selectAll">
                                        <label class="form-check-label" for="selectAll">
                                            Seleccionar todo
                                        </label>
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-primary btn-sm" id="refreshBtn" title="Actualizar">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" id="deleteBtn" title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" id="emptyTrashBtn" title="Vaciar papelera" style="display: none;">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <span class="text-muted" id="emailRange">0-0 de 0</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="email-list" id="emailList">
                            <!-- Los emails se cargarán aquí dinámicamente -->
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <h4>No hay mensajes</h4>
                                <p>Tu bandeja de entrada está vacía</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista de email (se muestra cuando se selecciona un email) -->
            <div id="emailDetailView" style="display: none;">
                <div class="card email-view-card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <button class="btn btn-outline-secondary btn-sm" id="backToList">
                                <i class="fas fa-arrow-left me-2"></i>Volver a la lista
                            </button>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-info btn-sm" id="forwardEmail" title="Reenviar">
                                <i class="fas fa-share"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" id="deleteEmail" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="email-content" id="emailContent">
                            <!-- El contenido del email se cargará aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para redactar email -->
<div class="compose-modal" id="composeModal" style="display: none;">
    <div class="modal-content">
        <div class="compose-header">
            <h3>Nuevo mensaje</h3>
            <div class="compose-actions">
                <button class="modal-btn" id="minimizeCompose">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="modal-btn" id="closeCompose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <form class="compose-form" id="composeForm">
            <!-- Selector de destinatarios para administradores -->
            <div class="compose-field">
                <label>Enviar a:</label>
                <div class="recipient-options">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="recipientAll" name="recipientType" value="all">
                        <label class="form-check-label" for="recipientAll">
                            <i class="fas fa-users"></i> Todos los usuarios
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="recipientProfesores" name="recipientType" value="profesores">
                        <label class="form-check-label" for="recipientProfesores">
                            <i class="fas fa-chalkboard-teacher"></i> Profesores
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="recipientEstudiantes" name="recipientType" value="estudiantes">
                        <label class="form-check-label" for="recipientEstudiantes">
                            <i class="fas fa-user-graduate"></i> Estudiantes
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="recipientPadres" name="recipientType" value="padres">
                        <label class="form-check-label" for="recipientPadres">
                            <i class="fas fa-user-friends"></i> Padres
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="recipientSpecific" name="recipientType" value="specific">
                        <label class="form-check-label" for="recipientSpecific">
                            <i class="fas fa-user"></i> Usuarios específicos
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="compose-field">
                <label for="composeTo">Para:</label>
                <input type="text" placeholder="Buscar usuario..." id="composeTo" required>
                <div class="suggestions" id="userSuggestions"></div>
            </div>
            
            <div class="compose-field">
                <label for="composeSubject">Asunto:</label>
                <input type="text" placeholder="Asunto del mensaje" id="composeSubject" required>
            </div>
            
            <div class="compose-field compose-body">
                <label for="composeBody">Mensaje:</label>
                <textarea placeholder="Escribe tu mensaje aquí..." id="composeBody" required></textarea>
            </div>
            
            <div class="compose-footer">
                <button type="submit" class="send-btn">
                    <i class="fas fa-paper-plane"></i>
                    Enviar
                </button>
                <button type="button" class="save-draft-btn" id="saveDraft">
                    <i class="fas fa-save"></i>
                    Guardar borrador
                </button>
                <button type="button" class="cancel-btn" id="cancelCompose">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Notificaciones -->
<div class="notifications" id="notifications"></div>

<script>
// Estado de la aplicación para administradores
class AdminEmailApp {
    constructor() {
        this.currentFolder = 'inbox';
        this.selectedEmails = new Set();
        this.currentEmail = null;
        this.userCache = new Map();
        this.searchTimeout = null;
        this.hasLoaded = false;
        
        this.init();
    }

    init() {
        // Esperar un poco para asegurar que el DOM esté completamente cargado
        setTimeout(() => {
            this.bindEvents();
            
            // Cargar contadores inmediatamente
            this.refreshAllCounts();
            
            // Cargar emails automáticamente al inicializar
            this.loadEmails();
        }, 100);
        
        // Carga adicional de seguridad después de un tiempo más largo
        setTimeout(() => {
            if (this.currentFolder && !this.hasLoaded) {
                console.log("Carga de seguridad ejecutándose...");
                this.loadEmails();
            }
        }, 2000);
    }

    async loadEmailsWithRetry(maxRetries = 3, delay = 1000) {
        let retries = 0;
        
        while (retries < maxRetries) {
            try {
                await this.loadEmails();
                return; // Éxito, salir del bucle
            } catch (error) {
                retries++;
                console.warn(`Intento ${retries} falló, reintentando en ${delay}ms...`);
                
                if (retries < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 1.5; // Incrementar el delay para el siguiente intento
                } else {
                    console.error('Todos los intentos de carga fallaron');
                    throw error;
                }
            }
        }
    }

    bindEvents() {
        // Navegación de carpetas
        document.querySelectorAll('.folder-item').forEach(item => {
            item.addEventListener('click', (e) => {
                this.switchFolder(e.currentTarget.dataset.folder);
            });
        });

        // Botón redactar
        document.getElementById('composeBtn').addEventListener('click', () => {
            this.openComposeModal();
        });

        // Botón crear prueba eliminado

        // Controles de lista
        document.getElementById('selectAll').addEventListener('change', (e) => {
            this.toggleSelectAll(e.target.checked);
        });

        document.getElementById('refreshBtn').addEventListener('click', () => {
            this.loadEmails();
        });

        document.getElementById('deleteBtn').addEventListener('click', () => {
            this.deleteSelectedEmails();
        });

        document.getElementById('emptyTrashBtn').addEventListener('click', () => {
            this.emptyTrash();
        });

        // Búsqueda
        document.getElementById('searchInput').addEventListener('input', (e) => {
            this.handleSearch(e.target.value);
        });

        // Modal de redacción
        document.getElementById('closeCompose').addEventListener('click', () => {
            this.closeComposeModal();
        });

        document.getElementById('cancelCompose').addEventListener('click', () => {
            this.closeComposeModal();
        });

        document.getElementById('saveDraft').addEventListener('click', (e) => {
            e.preventDefault();
            this.saveDraft();
        });

        document.getElementById('composeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.sendEmail();
        });

        // Autocompletar usuarios
        document.getElementById('composeTo').addEventListener('input', (e) => {
            this.searchUsers(e.target.value);
        });

        // Selector de tipo de destinatario para administradores (checkboxes)
        document.querySelectorAll('input[name="recipientType"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                this.handleRecipientTypeChange();
            });
        });

        // Vista de email
        document.getElementById('backToList').addEventListener('click', () => {
            this.showEmailList();
        });

        document.getElementById('replyEmail').addEventListener('click', () => {
            this.replyToEmail();
        });

        document.getElementById('forwardEmail').addEventListener('click', () => {
            this.forwardEmail();
        });

        document.getElementById('deleteEmail').addEventListener('click', () => {
            this.deleteCurrentEmail();
        });

        // Cerrar sugerencias al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.compose-field')) {
                this.hideSuggestions();
            }
        });
    }

    async loadEmails() {
        try {
            this.showLoading();
            
            console.log("DEBUG: Cargando emails para folder:", this.currentFolder);
            
            // Usar timeout más corto para evitar esperas largas
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos timeout
            
            const response = await fetch(`/admin/api/comunicaciones?folder=${this.currentFolder}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
                cache: 'no-cache',
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log("DEBUG: Emails recibidos:", data);
            
            if (!data.success) {
                throw new Error(data.message || 'Error al cargar los emails');
            }
            
            // Adaptar datos según la carpeta
            let emails = [];
            if (this.currentFolder === 'inbox') {
                emails = data.recibidas || [];
            } else if (this.currentFolder === 'sent') {
                emails = data.enviadas || [];
            } else if (this.currentFolder === 'draft') {
                emails = data.data || [];
            } else if (this.currentFolder === 'deleted') {
                emails = data.data || [];
            } else {
                emails = [];
            }
            
            this.renderEmailList(emails);
            this.updateEmailCounts(data);
            this.hasLoaded = true;
            
        } catch (error) {
            console.error('Error cargando emails:', error);
            this.showNotification(`Error al cargar los emails: ${error.message}`, 'error');
            
            // Mostrar estado de error en la lista
            const emailList = document.getElementById('emailList');
            if (emailList) {
                emailList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h4>Error al cargar</h4>
                        <p>No se pudieron cargar los emails. Intenta recargar la página.</p>
                        <button class="btn btn-primary" onclick="reloadEmails()">
                            <i class="fas fa-sync-alt me-2"></i>Reintentar
                        </button>
                    </div>
                `;
            }
        } finally {
            this.hideLoading();
        }
    }

    renderEmailList(emails) {
        const emailList = document.getElementById('emailList');
        
        if (!emails || emails.length === 0) {
            emailList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h4>No hay mensajes</h4>
                    <p>No hay emails en ${this.getFolderName(this.currentFolder)}</p>
                </div>
            `;
            return;
        }

        emailList.innerHTML = emails.map(email => `
            <div class="email-item" data-email-id="${email.id || email.id_comunicacion}" onclick="adminEmailApp.viewEmail(${email.id || email.id_comunicacion})">
                <div class="row align-items-center">
                    <div class="col-1">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="email-${email.id || email.id_comunicacion}" 
                                   onchange="adminEmailApp.toggleEmailSelection(${email.id || email.id_comunicacion}, event)">
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="email-sender">
                            ${this.currentFolder === 'sent' ? (email.destinatario || email.destinatario_nombre) : (email.remitente || email.remitente_nombre)}
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="email-subject">
                            ${email.asunto || '(Sin asunto)'}
                            ${email.estado === 'inbox' ? '<span class="badge badge-no-leida ms-2">Nuevo</span>' : ''}
                        </div>
                        <div class="email-snippet">
                            ${this.truncateText(email.mensaje || '', 100)}
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="email-date">
                            ${this.formatDate(email.fecha_envio || email.fecha)}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');

        this.updateSelectionUI();
        this.updateEmailRange(emails.length);
    }

    async viewEmail(emailId) {
        try {
            // Buscar el email en los datos actuales
            const response = await fetch(`/admin/api/comunicaciones?folder=${this.currentFolder}`, { cache: 'no-cache' });
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Error al cargar el email');
            }
            
            let email = null;
            if (this.currentFolder === 'inbox') {
                email = (data.recibidas || []).find(e => Number(e.id || e.id_comunicacion) === Number(emailId));
            } else if (this.currentFolder === 'sent') {
                email = (data.enviadas || []).find(e => Number(e.id || e.id_comunicacion) === Number(emailId));
            }
            
            if (!email) {
                throw new Error('Email no encontrado');
            }
            
            this.currentEmail = email;
            this.renderEmailView(email);
            this.showEmailView();
            
            // Si es un mensaje recibido no leído, marcarlo como leído
            if (this.currentFolder === 'inbox' && email.estado === 'inbox') {
                try {
                    await fetch(`/admin/api/comunicaciones/${emailId}/marcar-leida`, {
                        method: 'PUT'
                    });
                    email.estado = 'sent';
                } catch (error) {
                    console.error('Error marcando como leída:', error);
                }
            }
            
        } catch (error) {
            console.error('Error:', error);
            this.showNotification('Error al cargar el email', 'error');
        }
    }

    renderEmailView(email) {
        const emailContent = document.getElementById('emailContent');
        
        emailContent.innerHTML = `
            <div class="email-header">
                <div class="email-meta">
                    <h2 class="email-subject">${email.asunto || '(Sin asunto)'}</h2>
                    <div class="email-participants">
                        <div class="participant">
                            <strong>De:</strong> ${email.remitente || email.remitente_nombre}
                        </div>
                        <div class="participant">
                            <strong>Para:</strong> ${email.destinatario || email.destinatario_nombre}
                        </div>
                    </div>
                    <div class="email-date">${this.formatDetailedDate(email.fecha_envio || email.fecha)}</div>
                </div>
            </div>
            
            <div class="email-body">
                <div class="email-content-text">
                    ${this.formatEmailBody(email.mensaje || '')}
                </div>
            </div>
            
            <div class="email-actions-footer">
                <button class="action-btn" onclick="adminEmailApp.replyToEmail()">
                    <i class="fas fa-reply"></i> Responder
                </button>
                <button class="action-btn" onclick="adminEmailApp.forwardEmail()">
                    <i class="fas fa-share"></i> Reenviar
                </button>
                <button class="action-btn delete" onclick="adminEmailApp.deleteCurrentEmail()">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        `;
    }

    async sendEmail() {
        const toInput = document.getElementById('composeTo');
        const subjectInput = document.getElementById('composeSubject');
        const bodyInput = document.getElementById('composeBody');
        
        // Obtener tipos de destinatarios seleccionados
        const selectedTypes = Array.from(document.querySelectorAll('input[name="recipientType"]:checked')).map(cb => cb.value);
        
        // Extraer el email del campo "Para"
        const toValue = toInput.value.trim();
        let emailTo = toValue;
        
        // Si el formato es "Nombre (email@dominio.com)", extraer solo el email
        const emailMatch = toValue.match(/\(([^)]+)\)/);
        if (emailMatch) {
            emailTo = emailMatch[1].trim();
        }
        
        console.log("DEBUG: Intentando enviar email a:", emailTo);

        // Validación básica de email
        const isSpecificOnly = selectedTypes.length === 1 && selectedTypes[0] === 'specific';
        if (!this.isValidEmail(emailTo) && (!selectedTypes.length || isSpecificOnly)) {
            this.showNotification('Por favor ingresa un email válido', 'error');
            return;
        }

        const emailData = {
            to: emailTo,
            asunto: subjectInput.value.trim(),
            mensaje: bodyInput.value.trim()
        };

        // Agregar tipo de destinatario para administradores
            if (selectedTypes.length > 1) {
                emailData.recipient_types = selectedTypes;
            } else if (selectedTypes.length === 1) {
                emailData.recipient_type = selectedTypes[0];
        }

        try {
            console.log("DEBUG: Enviando datos:", emailData);
            
            const response = await fetch('/admin/api/comunicaciones', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(emailData)
            });

            const result = await response.json();
            console.log("DEBUG: Respuesta del servidor:", result);

            if (response.ok && result.success) {
                this.showNotification('Email enviado correctamente', 'success');
                this.closeComposeModal();
                this.loadEmails();
            } else {
                throw new Error(result.message || 'Error al enviar el email');
            }
        } catch (error) {
            console.error('Error:', error);
            this.showNotification('Error al enviar el email: ' + error.message, 'error');
        }
    }

    handleRecipientTypeChange() {
        const toInput = document.getElementById('composeTo');
        const selectedTypes = Array.from(document.querySelectorAll('input[name="recipientType"]:checked')).map(cb => cb.value);
        
        const setLock = (text, lock) => {
            toInput.value = text;
            toInput.readOnly = lock;
            if (!lock) toInput.placeholder = 'Buscar usuario específico...';
        };
        
        if (!selectedTypes || selectedTypes.length === 0) {
            setLock('', false);
            return;
        }
        
        if (selectedTypes.includes('specific') && selectedTypes.length === 1) {
            setLock('', false);
            return;
        }
        
        if (selectedTypes.includes('all')) {
            setLock('Todos los usuarios', true);
            return;
        }
        
        const mapText = {
            'profesores': 'Todos los profesores',
            'estudiantes': 'Todos los estudiantes',
            'padres': 'Todos los padres'
        };
        const labels = selectedTypes.filter(t => t !== 'specific').map(t => mapText[t] || t);
        setLock(labels.join(' + '), true);
    }

    async searchUsers(query) {
        if (query.length < 2) {
            this.hideSuggestions();
            return;
        }

        try {
            console.log("DEBUG: Buscando usuarios con query:", query);
            
            const response = await fetch(`/admin/api/usuarios/buscar?q=${encodeURIComponent(query)}`);
            
            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
            
            const users = await response.json();
            console.log("DEBUG: Respuesta de búsqueda:", users);
            
            // Verificar si la respuesta es un array
            if (!Array.isArray(users)) {
                console.error("DEBUG: La respuesta no es un array:", users);
                if (users && users.error) {
                    throw new Error(users.error);
                } else {
                    throw new Error('Formato de respuesta inválido');
                }
            }
            
            this.showUserSuggestions(users);
            
        } catch (error) {
            console.error('Error buscando usuarios:', error);
            this.hideSuggestions();
            // No mostrar notificación para evitar spam durante la escritura
        }
    }

    showUserSuggestions(users) {
        const suggestions = document.getElementById('userSuggestions');
        const toInput = document.getElementById('composeTo');
        
        // Limpiar cache
        this.userCache.clear();
        
        // Verificar que users sea un array
        if (!Array.isArray(users)) {
            console.error('Users no es un array:', users);
            suggestions.style.display = 'none';
            return;
        }
        
        suggestions.innerHTML = users.map(user => {
            const displayText = `${user.nombre} (${user.email})`;
            this.userCache.set(displayText, user);
            
            return `
                <div class="suggestion-item" onclick="adminEmailApp.selectUser('${displayText.replace(/'/g, "\\'")}')">
                    <div class="suggestion-name">${user.nombre}</div>
                    <div class="suggestion-email">${user.email}</div>
                </div>
            `;
        }).join('');
        
        suggestions.style.display = users.length > 0 ? 'block' : 'none';
    }

    selectUser(displayText) {
        document.getElementById('composeTo').value = displayText;
        this.hideSuggestions();
    }

    hideSuggestions() {
        document.getElementById('userSuggestions').style.display = 'none';
    }

    // Métodos de selección
    toggleEmailSelection(emailId, event) {
        if (event) {
            event.stopPropagation();
        }
        
        // Convertir a número para asegurar consistencia
        const id = parseInt(emailId);
        
        if (this.selectedEmails.has(id)) {
            this.selectedEmails.delete(id);
        } else {
            this.selectedEmails.add(id);
        }
        
        // Actualizar el checkbox visual
        const checkbox = document.getElementById(`email-${id}`);
        if (checkbox) {
            checkbox.checked = this.selectedEmails.has(id);
        }
        
        this.updateSelectionUI();
    }

    toggleSelectAll(checked) {
        const checkboxes = document.querySelectorAll('.email-item .form-check-input');
        
        this.selectedEmails.clear();
        
        if (checked) {
            document.querySelectorAll('.email-item').forEach(item => {
                const emailId = parseInt(item.dataset.emailId);
                this.selectedEmails.add(emailId);
            });
        }
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = checked;
        });
        
        this.updateSelectionUI();
        
        // Log para debugging
        console.log('Emails seleccionados:', Array.from(this.selectedEmails));
    }

    async deleteSelectedEmails() {
        if (this.selectedEmails.size === 0) {
            this.showNotification('Selecciona al menos un email', 'warning');
            return;
        }

        if (!confirm(`¿Eliminar ${this.selectedEmails.size} email(s)?`)) {
            return;
        }

        try {
            // Usar la nueva ruta de eliminación masiva
            const response = await fetch('/admin/api/comunicaciones/bulk-delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ids: Array.from(this.selectedEmails)
                })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                this.showNotification(result.message, 'success');
                this.selectedEmails.clear();
                this.loadEmails();
                this.refreshAllCounts();
            } else {
                throw new Error(result.message || 'Error al eliminar los emails');
            }
        } catch (error) {
            console.error('Error:', error);
            this.showNotification('Error al eliminar los emails: ' + error.message, 'error');
        }
    }

    // Navegación
    switchFolder(folder) {
        this.currentFolder = folder;
        this.selectedEmails.clear();
        
        // Actualizar UI
        document.querySelectorAll('.folder-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-folder="${folder}"]`).classList.add('active');
        
        const selectAllCheckbox = document.getElementById('selectAll');
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        }
        
        // Mostrar/ocultar botón de vaciar papelera
        const emptyTrashBtn = document.getElementById('emptyTrashBtn');
        if (emptyTrashBtn) {
            emptyTrashBtn.style.display = folder === 'deleted' ? 'inline-block' : 'none';
        }
        
        // Cargar emails y actualizar contadores
        this.loadEmails();
        this.refreshAllCounts();
    }

    showEmailView() {
        document.getElementById('emailListView').style.display = 'none';
        document.getElementById('emailDetailView').style.display = 'block';
    }

    showEmailList() {
        document.getElementById('emailListView').style.display = 'block';
        document.getElementById('emailDetailView').style.display = 'none';
        this.currentEmail = null;
    }

    // Modal de redacción
    openComposeModal() {
        document.getElementById('composeModal').style.display = 'block';
        document.getElementById('composeTo').focus();
    }

    closeComposeModal() {
        document.getElementById('composeModal').style.display = 'none';
        document.getElementById('composeForm').reset();
        this.hideSuggestions();
        this.userCache.clear();
    }

    // Utilidades
    updateSelectionUI() {
        const selectedCount = this.selectedEmails.size;
        const totalCount = document.querySelectorAll('.email-item').length;
        const selectAllCheckbox = document.getElementById('selectAll');
        
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = selectedCount > 0 && selectedCount === totalCount;
            selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < totalCount;
        }
        
        // Actualizar botones de acción
        const deleteBtn = document.getElementById('deleteBtn');
        if (deleteBtn) {
            deleteBtn.disabled = selectedCount === 0;
            deleteBtn.style.opacity = selectedCount === 0 ? '0.5' : '1';
        }
        
        console.log(`Seleccionados: ${selectedCount}/${totalCount}`);
    }

    updateEmailRange(total) {
        const rangeText = total > 0 ? `1-${total} de ${total}` : '0-0 de 0';
        document.getElementById('emailRange').textContent = rangeText;
    }

    updateEmailCounts(data) {
        // Actualizar contadores globales: consultar todas las carpetas en segundo plano
        this.refreshAllCounts();
    }

    async refreshAllCounts() {
        try {
            const folders = ['inbox', 'sent', 'draft', 'deleted'];
            const [inbox, sent, draft, deleted] = await Promise.all(
                folders.map(f => fetch(`/admin/api/comunicaciones?folder=${f}`, { cache: 'no-cache' })
                    .then(r => r.ok ? r.json() : { success: false }))
            );
            
            const inboxCount = document.getElementById('inboxCount');
            const sentCount = document.getElementById('sentCount');
            const draftsCount = document.getElementById('draftsCount');
            const deletedCount = document.getElementById('deletedCount');
            
            // Actualizar contadores con animación
            if (inbox && inbox.recibidas && inboxCount) {
                inboxCount.textContent = inbox.recibidas.length;
                inboxCount.style.display = inbox.recibidas.length > 0 ? 'inline-flex' : 'none';
            }
            if (sent && sent.enviadas && sentCount) {
                sentCount.textContent = sent.enviadas.length;
                sentCount.style.display = sent.enviadas.length > 0 ? 'inline-flex' : 'none';
            }
            if (draft && draft.data && draftsCount) {
                draftsCount.textContent = draft.data.length;
                draftsCount.style.display = draft.data.length > 0 ? 'inline-flex' : 'none';
            }
            if (deleted && deleted.data && deletedCount) {
                deletedCount.textContent = deleted.data.length;
                deletedCount.style.display = deleted.data.length > 0 ? 'inline-flex' : 'none';
            }
        } catch(e) {
            console.error('Error actualizando contadores:', e);
        }
    }

    formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) {
            return 'Ayer';
        } else if (diffDays > 1) {
            return date.toLocaleDateString();
        } else {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
    }

    formatDetailedDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('es-ES', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    formatEmailBody(body) {
        return body.replace(/\n/g, '<br>');
    }

    truncateText(text, length) {
        return text.length > length ? text.substring(0, length) + '...' : text;
    }

    isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    getFolderName(folder) {
        const names = {
            'inbox': 'Bandeja de entrada',
            'sent': 'Enviados',
            'draft': 'Borradores',
            'deleted': 'Papelera'
        };
        return names[folder] || folder;
    }

    handleSearch(query) {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(() => {
            // Implementar búsqueda si es necesario
            console.log('Buscando:', query);
        }, 300);
    }

    showLoading() {
        const emailList = document.getElementById('emailList');
        if (emailList) {
            emailList.classList.add('loading');
            
            // Mostrar indicador de carga si no hay contenido
            if (emailList.children.length === 0 || emailList.querySelector('.empty-state')) {
                emailList.innerHTML = `
                    <div class="loading-state">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-3">Cargando comunicaciones...</p>
                    </div>
                `;
            }
        }
    }

    hideLoading() {
        const emailList = document.getElementById('emailList');
        if (emailList) {
            emailList.classList.remove('loading');
        }
    }

    showNotification(message, type = 'info') {
        const notifications = document.getElementById('notifications');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation' : 'info'}"></i>
            <span>${message}</span>
        `;
        
        notifications.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // Métodos para replies y forwards
    replyToEmail() {
        this.openComposeModal();
        if (this.currentEmail) {
            document.getElementById('composeTo').value = this.currentEmail.remitente || this.currentEmail.remitente_nombre;
            document.getElementById('composeSubject').value = `Re: ${this.currentEmail.asunto}`;
            document.getElementById('composeBody').value = `\n\n--- Mensaje original ---\n${this.currentEmail.mensaje}`;
        }
    }

    forwardEmail() {
        this.openComposeModal();
        if (this.currentEmail) {
            document.getElementById('composeSubject').value = `Fw: ${this.currentEmail.asunto}`;
            document.getElementById('composeBody').value = `\n\n--- Mensaje original ---\n${this.currentEmail.mensaje}`;
        }
    }

    async deleteCurrentEmail() {
        if (!this.currentEmail) return;
        
        if (confirm('¿Eliminar este email?')) {
            try {
                const response = await fetch(`/admin/api/comunicaciones/${this.currentEmail.id || this.currentEmail.id_comunicacion}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    this.showNotification('Email eliminado', 'success');
                    this.showEmailList();
                    this.loadEmails();
                } else {
                    throw new Error('Error al eliminar el email');
                }
            } catch (error) {
                console.error('Error:', error);
                this.showNotification('Error al eliminar el email', 'error');
            }
        }
    }

    async emptyTrash() {
        if (!confirm('¿Estás seguro de que quieres vaciar la papelera? Esta acción no se puede deshacer.')) {
            return;
        }

        try {
            // Seleccionar todos los elementos en papelera
            this.toggleSelectAll(true);
            
            if (this.selectedEmails.size === 0) {
                this.showNotification('No hay elementos en la papelera', 'info');
                return;
            }

            // Eliminar todos los elementos seleccionados
            const response = await fetch('/admin/api/comunicaciones/bulk-delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ids: Array.from(this.selectedEmails)
                })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                this.showNotification('Papelera vaciada correctamente', 'success');
                this.selectedEmails.clear();
                this.loadEmails();
            } else {
                throw new Error(result.message || 'Error al vaciar la papelera');
            }
        } catch (error) {
            console.error('Error:', error);
            this.showNotification('Error al vaciar la papelera: ' + error.message, 'error');
        }
    }

    async saveDraft() {
        const toInput = document.getElementById('composeTo');
        const subjectInput = document.getElementById('composeSubject');
        const bodyInput = document.getElementById('composeBody');
        
        const toValue = toInput.value.trim();
        let emailTo = toValue;
        
        const emailMatch = toValue.match(/\(([^)]+)\)/);
        if (emailMatch) {
            emailTo = emailMatch[1].trim();
        }

        const emailData = {
            to: emailTo || '',
            asunto: subjectInput.value.trim() || '(Sin asunto)',
            mensaje: bodyInput.value.trim()
        };

        try {
            const response = await fetch('/admin/api/comunicaciones/draft', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(emailData)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                this.showNotification('Borrador guardado', 'success');
                this.closeComposeModal();
                this.loadEmails();
            } else {
                throw new Error(result.message || 'Error al guardar el borrador');
            }
        } catch (error) {
            console.error('Error:', error);
            this.showNotification('Error al guardar el borrador', 'error');
        }
    }

    // Método crearComunicacionPrueba eliminado
}

// Inicializar la aplicación cuando el DOM esté listo
let adminEmailApp;

// Función para verificar que la aplicación esté lista
function isAppReady() {
    return adminEmailApp && typeof adminEmailApp.loadEmails === 'function';
}

document.addEventListener('DOMContentLoaded', () => {
    try {
        adminEmailApp = new AdminEmailApp();
        console.log('Aplicación de comunicaciones del administrador inicializada correctamente');
        
        // Carga adicional de seguridad después de que todo esté listo
        setTimeout(() => {
            if (adminEmailApp && !adminEmailApp.hasLoaded) {
                console.log('Ejecutando carga de seguridad adicional...');
                adminEmailApp.loadEmails();
            }
        }, 3000);
        
    } catch (error) {
        console.error('Error inicializando la aplicación:', error);
        
        // Mostrar mensaje de error al usuario
        const mainContainer = document.getElementById('mainContainer');
        if (mainContainer) {
            mainContainer.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading">Error de inicialización</h4>
                    <p>No se pudo inicializar la aplicación de comunicaciones. Por favor, recarga la página.</p>
                    <hr>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-sync-alt me-2"></i>Recargar página
                    </button>
                </div>
            `;
        }
    }
});

// Función global para recargar emails (útil para botones de error)
window.reloadEmails = function() {
    if (isAppReady()) {
        adminEmailApp.loadEmails();
    } else {
        console.error('La aplicación no está lista');
        location.reload();
    }
};
</script>

<style>
/* =======================================
   VARIABLES CSS - Paleta de colores coherente
   ======================================= */
:root {
    --accent1: #F95738; /* Acento rojo */
    --accent2: #EE964B; /* Acento naranja */
    --accent3: #F4D35E; /* Acento amarillo */
    --accent4: #0D3B66; /* Acento azul oscuro */
    --light: #FAF0CA; /* Fondo claro */
    --white: #FFFFFF; /* Blanco */
    --black: #333333; /* Negro para texto */
    --gray: #666666; /* Gris para subtítulos */
    --light-gray: #F8F9FA; /* Gris claro para fondos */
    --border: #E9ECEF; /* Bordes */
    --card-bg: #FFFFFF; /* Fondo de tarjetas */
    --header-bg: #FFFFFF; /* Fondo de encabezado */
    --main-bg: #F8F9FA; /* Fondo principal */
    --shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* Sombra estándar */
    --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15); /* Sombra en hover */
    --gradient-primary: linear-gradient(135deg, var(--accent4), #1a5080); /* Gradiente primario */
    --gradient-secondary: linear-gradient(135deg, var(--accent3), #e9c440); /* Gradiente secundario */
    --gradient-accent: linear-gradient(135deg, var(--accent1), #ff6b4a); /* Gradiente acento */
    --gradient-warning: linear-gradient(135deg, var(--accent2), #f0a868); /* Gradiente warning */
}

/* =======================================
   ESTILOS GENERALES MEJORADOS
   ======================================= */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--light) 0%, var(--main-bg) 100%);
    color: var(--black);
    margin: 0;
    min-height: 100vh;
}

/* Título principal con estilo del dashboard */
.text-principal {
    color: var(--accent4);
    font-weight: 800;
    font-size: 2.5rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: relative;
    display: inline-block;
    margin-bottom: 1rem;
}

.text-principal::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 4px;
    background: var(--gradient-accent);
    border-radius: 2px;
}

.text-principal i {
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-right: 15px;
}

/* =======================================
   TARJETAS BASE - Estilo del dashboard
   ======================================= */
.card {
    border-radius: 20px;
    background: var(--card-bg);
    border: none;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.6s;
    pointer-events: none;
    z-index: 1;
}

.card:hover::before {
    left: 100%;
}

.card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: var(--shadow-hover);
}

.card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 20% 80%, rgba(244, 211, 94, 0.1) 0%, transparent 50%),
               radial-gradient(circle at 80% 20%, rgba(13, 59, 102, 0.05) 0%, transparent 50%);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    z-index: 1;
}

.card:hover::after {
    opacity: 1;
}

/* =======================================
   BARRA DE BÚSQUEDA
   ======================================= */
.search-card {
    background: var(--white);
    border: 2px solid var(--border);
    border-radius: 20px;
    box-shadow: var(--shadow);
}

.search-bar {
    border-radius: 15px;
    border: 2px solid var(--border);
    background: var(--white);
    transition: all 0.3s ease;
    box-shadow: var(--shadow);
}

.search-bar:focus-within {
    border-color: var(--accent4);
    box-shadow: 0 0 0 0.2rem rgba(13, 59, 102, 0.1);
}

.search-bar .input-group-text {
    background: var(--gradient-primary);
    border: none;
    color: var(--white);
    border-radius: 15px 0 0 15px;
}

.search-bar .form-control {
    border: none;
    background: transparent;
    color: var(--black);
}

.search-bar .form-control:focus {
    box-shadow: none;
    border: none;
}

.compose-btn {
    background: var(--gradient-accent);
    border: none;
    color: var(--white);
    border-radius: 15px;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: var(--shadow);
}

.compose-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
    background: var(--gradient-accent);
    color: var(--white);
}

/* =======================================
   NAVEGACIÓN DE CARPETAS
   ======================================= */
.folder-nav-card {
    background: var(--white);
    border: 2px solid var(--border);
    border-radius: 20px;
    box-shadow: var(--shadow);
}

.folder-nav-card .card-body {
    padding: 0.75rem;
}

.folder-item {
    background: var(--white);
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 0.75rem;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    text-align: center;
    height: 90px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.folder-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.6s;
    pointer-events: none;
    z-index: 1;
}

.folder-item:hover::before {
    left: 100%;
}

.folder-item:hover {
    border-color: var(--accent4);
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}

.folder-item.active {
    background: var(--gradient-primary);
    border-color: var(--accent4);
    color: var(--white);
    box-shadow: var(--shadow-hover);
}

.folder-icon-container {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.5rem auto;
    position: relative;
}

.folder-icon {
    width: 35px;
    height: 35px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.folder-item:nth-child(1) .folder-icon {
    background: var(--gradient-primary);
    color: var(--white);
}

.folder-item:nth-child(2) .folder-icon {
    background: var(--gradient-accent);
    color: var(--white);
}

.folder-item:nth-child(3) .folder-icon {
    background: var(--gradient-secondary);
    color: var(--black);
}

.folder-item:nth-child(4) .folder-icon {
    background: var(--gradient-warning);
    color: var(--white);
}

.folder-item.active .folder-icon {
    background: var(--accent3);
    color: var(--black);
    transform: scale(1.1);
}

.folder-info h6 {
    color: var(--accent4);
    font-weight: 600;
    margin-bottom: 0.1rem;
    font-size: 0.8rem;
    line-height: 1.1;
}

.folder-item.active .folder-info h6 {
    color: var(--white);
}

.email-count {
    background: var(--accent1);
    color: var(--white);
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 0.65rem;
    font-weight: 600;
    min-width: 18px;
    height: 18px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: 8px;
    position: absolute;
    top: -5px;
    right: -5px;
    border: 2px solid var(--white);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.folder-item.active .email-count {
    background: var(--accent3);
    color: var(--black);
}

/* =======================================
   LISTA DE EMAILS
   ======================================= */
.email-list-card {
    background: var(--white);
    border: 2px solid var(--border);
    border-radius: 20px;
    box-shadow: var(--shadow);
    min-height: 500px;
}

.email-list-card .card-header {
    background: var(--light);
    border-bottom: 2px solid var(--accent3);
    border-radius: 20px 20px 0 0;
    padding: 1.5rem;
}

.email-list {
    max-height: 600px;
    overflow-y: auto;
}

.email-item {
    border-bottom: 1px solid var(--border);
    padding: 1.5rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    cursor: pointer;
}

.email-item::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 20% 80%, rgba(244, 211, 94, 0.1) 0%, transparent 50%);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    z-index: 1;
}

.email-item:hover::after {
    opacity: 1;
}

.email-item:hover {
    background: var(--light);
    transform: translateX(5px);
    box-shadow: var(--shadow);
}

.email-item:last-child {
    border-bottom: none;
}

.email-sender {
    color: var(--accent4);
    font-weight: 600;
    font-size: 1rem;
}

.email-subject {
    color: var(--black);
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
}

.email-snippet {
    color: var(--gray);
    font-size: 0.9rem;
    line-height: 1.4;
}

.email-date {
    color: var(--gray);
    font-size: 0.85rem;
    text-align: right;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--gray);
}

.empty-state i {
    font-size: 4rem;
    color: var(--accent2);
    margin-bottom: 1rem;
}

.empty-state h4 {
    color: var(--accent4);
    margin-bottom: 1rem;
}

.loading-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--gray);
}

.loading-state .spinner-border {
    width: 3rem;
    height: 3rem;
    border-width: 0.3em;
    color: var(--accent4);
}

.loading-state p {
    color: var(--accent4);
    font-weight: 500;
    margin-top: 1rem;
}

/* =======================================
   VISTA DE EMAIL
   ======================================= */
.email-view-card {
    background: var(--white);
    border: 2px solid var(--border);
    border-radius: 20px;
    box-shadow: var(--shadow);
    min-height: 500px;
}

.email-view-card .card-header {
    background: var(--light);
    border-bottom: 2px solid var(--accent3);
    border-radius: 20px 20px 0 0;
    padding: 1.5rem;
}

.email-content {
    padding: 2rem;
}

.email-header h2 {
    color: var(--accent4);
    border-bottom: 2px solid var(--accent3);
    padding-bottom: 15px;
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
}

.email-participants {
    margin-bottom: 1.5rem;
}

.participant {
    margin-bottom: 0.5rem;
    padding: 0.75rem;
    background: var(--light-gray);
    border-radius: 10px;
}

.participant strong {
    color: var(--accent4);
    font-weight: 600;
}

.email-date {
    color: var(--gray);
    font-size: 0.9rem;
    margin-bottom: 1.5rem;
}

.email-content-text {
    line-height: 1.6;
    color: var(--black);
    background: var(--light-gray);
    padding: 1.5rem;
    border-radius: 15px;
    border-left: 4px solid var(--accent3);
}

.email-actions-footer {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.email-actions-footer .action-btn {
    background: var(--gradient-secondary);
    color: var(--black);
    border: none;
    border-radius: 10px;
    padding: 10px 20px;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.email-actions-footer .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.email-actions-footer .action-btn.delete {
    background: var(--gradient-accent);
    color: var(--white);
}

/* =======================================
   MODAL DE COMPOSICIÓN
   ======================================= */
.compose-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    z-index: 1050;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.compose-modal .modal-content {
    background: var(--white);
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 600px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.compose-header {
    background: var(--gradient-primary);
    color: var(--white);
    border-radius: 20px 20px 0 0;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.compose-header h3 {
    margin: 0;
    font-weight: 600;
    font-size: 1.3rem;
}

.modal-btn {
    background: rgba(255, 255, 255, 0.2);
    color: var(--white);
    border: none;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.compose-form {
    padding: 2rem;
}

.compose-field {
    margin-bottom: 1.5rem;
}

.compose-field label {
    color: var(--accent4);
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: block;
}

.compose-field input,
.compose-field textarea,
.compose-field select {
    border: 2px solid var(--border);
    border-radius: 15px;
    padding: 12px 15px;
    transition: all 0.3s ease;
    width: 100%;
    font-size: 1rem;
}

.compose-field input:focus,
.compose-field textarea:focus,
.compose-field select:focus {
    border-color: var(--accent4);
    box-shadow: 0 0 0 3px rgba(13, 59, 102, 0.1);
    outline: none;
}

.compose-body textarea {
    min-height: 200px;
    resize: vertical;
}

.compose-footer {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    flex-wrap: wrap;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
}

.send-btn {
    background: var(--gradient-accent);
    color: var(--white);
    border: none;
    border-radius: 15px;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.send-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
    background: var(--gradient-accent);
    color: var(--white);
}

.save-draft-btn {
    background: var(--gradient-secondary);
    color: var(--black);
    border: none;
    border-radius: 15px;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.save-draft-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
    background: var(--gradient-secondary);
    color: var(--black);
}

.cancel-btn {
    background: var(--light-gray);
    color: var(--gray);
    border: 2px solid var(--border);
    border-radius: 15px;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.cancel-btn:hover {
    background: var(--border);
    color: var(--black);
    transform: translateY(-2px);
}

/* =======================================
   OPCIONES DE DESTINATARIOS
   ======================================= */
.recipient-options {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 1rem;
    background: var(--light-gray);
    border-radius: 15px;
    border: 2px solid var(--border);
}

.recipient-options .form-check {
    margin-bottom: 0;
    padding: 0.5rem;
    border-radius: 10px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.recipient-options .form-check:hover {
    background: var(--light);
    transform: translateX(5px);
}

.recipient-options .form-check-input {
    margin-right: 0.75rem;
    transform: scale(1.2);
}

.recipient-options .form-check-input:checked {
    background-color: var(--accent4);
    border-color: var(--accent4);
}

.recipient-options .form-check-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: var(--accent4);
    cursor: pointer;
    margin-bottom: 0;
}

.recipient-options .form-check-label i {
    color: var(--accent1);
    width: 20px;
    text-align: center;
}

.recipient-options .form-check:has(.form-check-input:checked) .form-check-label {
    color: var(--accent1);
}

.recipient-options .form-check:has(.form-check-input:checked) {
    background: var(--accent3);
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(244, 211, 94, 0.3);
}

/* =======================================
   SUGERENCIAS DE USUARIOS
   ======================================= */
.suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--white);
    border: 2px solid var(--accent3);
    border-radius: 15px;
    box-shadow: var(--shadow-hover);
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.suggestion-item {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    transition: all 0.3s ease;
    cursor: pointer;
}

.suggestion-item:hover {
    background: var(--light);
    transform: translateX(5px);
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-name {
    color: var(--accent4);
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.suggestion-email {
    color: var(--gray);
    font-size: 0.9rem;
}

/* =======================================
   NOTIFICACIONES
   ======================================= */
.notifications {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1060;
    max-width: 400px;
}

.notification {
    background: var(--gradient-primary);
    color: var(--white);
    border-radius: 15px;
    box-shadow: var(--shadow-hover);
    border-left: 5px solid var(--accent3);
    padding: 1rem 1.5rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.notification.success {
    background: linear-gradient(135deg, #28a745, #20c997);
    border-left-color: #20c997;
}

.notification.error {
    background: var(--gradient-accent);
    border-left-color: var(--accent1);
}

.notification.warning {
    background: var(--gradient-warning);
    border-left-color: var(--accent2);
}

/* =======================================
   BADGES Y ESTADOS
   ======================================= */
.badge-no-leida {
    background: var(--gradient-accent);
    color: var(--white);
    font-size: 0.7rem;
    padding: 4px 8px;
    border-radius: 10px;
    margin-left: 8px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
}

/* =======================================
   NAVEGACIÓN ENTRE VISTAS
   ======================================= */
#emailListView, #emailDetailView {
    transition: all 0.3s ease-in-out;
}

#emailDetailView {
    animation: slideInFromRight 0.3s ease-out;
}

@keyframes slideInFromRight {
    from {
        opacity: 0;
        transform: translateX(30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

#emailListView {
    animation: slideInFromLeft 0.3s ease-out;
}

@keyframes slideInFromLeft {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* =======================================
   RESPONSIVE ADJUSTMENTS
   ======================================= */
@media (max-width: 768px) {
    .text-principal {
        font-size: 2rem;
    }
    
    .container-fluid {
        padding: 1rem;
    }
    
    .folder-item {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        height: 80px;
    }
    
    .folder-icon {
        width: 30px;
        height: 30px;
        font-size: 0.9rem;
        margin-bottom: 0.3rem;
    }
    
    .folder-info h6 {
        font-size: 0.75rem;
    }
    
    .email-list-card,
    .email-view-card {
        margin-bottom: 1rem;
    }
    
    .compose-modal {
        padding: 1rem;
    }
    
    .compose-modal .modal-content {
        max-height: 90vh;
    }
    
    .compose-form {
        padding: 1.5rem;
    }
    
    .compose-footer {
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .compose-footer button {
        width: 100%;
        justify-content: center;
    }
    
    .notifications {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
    }
    
    .email-actions-footer {
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .email-actions-footer .action-btn {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 576px) {
    .search-card .row {
        flex-direction: column;
        gap: 1rem;
    }
    
    .search-card .col-md-4 {
        text-align: center;
    }
    
    .folder-nav-card .row {
        flex-direction: column;
    }
    
    .folder-nav-card .col-md-3 {
        margin-bottom: 1rem;
    }
}

/* =======================================
   ANIMACIONES
   ======================================= */
@keyframes slideIn {
    from { 
        opacity: 0; 
        transform: translateY(20px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

@keyframes fadeIn {
    from { 
        opacity: 0; 
    }
    to { 
        opacity: 1; 
    }
}

@keyframes cardEntrance {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.email-item {
    animation: slideIn 0.3s ease-out;
}

.card {
    animation: cardEntrance 0.6s ease-out;
    animation-fill-mode: both;
}

.card:nth-child(1) { animation-delay: 0.1s; }
.card:nth-child(2) { animation-delay: 0.2s; }
.card:nth-child(3) { animation-delay: 0.3s; }
.card:nth-child(4) { animation-delay: 0.4s; }

/* =======================================
   ESTADOS DE CARGA
   ======================================= */
.loading {
    position: relative;
    overflow: hidden;
}

.loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(244, 211, 94, 0.4), transparent);
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { left: -100%; }
    100% { left: 100%; }
}

/* =======================================
   MEJORAS ADICIONALES
   ======================================= */
/* Asegurar que el contenido sea clickeable */
.card-body,
.folder-info,
.email-item .row {
    position: relative;
    z-index: 10;
    pointer-events: auto;
}

/* Asegurar que los botones y enlaces sean clickeables */
.btn,
button,
a,
input,
textarea,
select {
    position: relative;
    z-index: 10;
    pointer-events: auto;
}

.form-check-input:checked {
    background-color: var(--accent4);
    border-color: var(--accent4);
}

.btn-outline-primary {
    border-color: var(--accent4);
    color: var(--accent4);
}

.btn-outline-primary:hover {
    background-color: var(--accent4);
    border-color: var(--accent4);
}

.btn-outline-danger {
    border-color: var(--accent1);
    color: var(--accent1);
}

.btn-outline-danger:hover {
    background-color: var(--accent1);
    border-color: var(--accent1);
}

.btn-outline-info {
    border-color: var(--accent2);
    color: var(--accent2);
}

.btn-outline-info:hover {
    background-color: var(--accent2);
    border-color: var(--accent2);
}

.btn-outline-secondary {
    border-color: var(--gray);
    color: var(--gray);
}

.btn-outline-secondary:hover {
    background-color: var(--gray);
    border-color: var(--gray);
}
</style>
{% endblock %}
