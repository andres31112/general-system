<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reportes de Inventario</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin/gestion_usuarios/profesores.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin/gestion_inventario/reporte.css') }}">
</head>
<body>
{% extends "base.html" %}
{% block content %}

<header class="main-header">
    <a onclick="history.back()" class="btn btn-outline-secondary btn-sm border-0 me-3">
        <i class="fa-solid fa-arrow-left"></i>
    </a>
    <h1>Reportes de Inventario</h1>
    <div class="header-icons">
        <i class="fa-solid fa-bell"></i>
        <i class="fa-solid fa-user"></i>
    </div>
</header>

<div class="container-fluid py-3">
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card">
                <div class="metric-number" id="totalEquipos">0</div>
                <div class="metric-label">
                    <i class="fa-solid fa-computer me-2"></i>Total Equipos
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card success">
                <div class="metric-number" id="equiposDisponibles">0</div>
                <div class="metric-label">
                    <i class="fa-solid fa-check-circle me-2"></i>Disponibles
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card warning">
                <div class="metric-number" id="equiposMantenimiento">0</div>
                <div class="metric-label">
                    <i class="fa-solid fa-wrench me-2"></i>Mantenimiento
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card danger">
                <div class="metric-number" id="equiposIncidente">0</div>
                <div class="metric-label">
                    <i class="fa-solid fa-triangle-exclamation me-2"></i>Incidentes
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card dashboard-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-chart-pie me-2"></i>Estado de Equipos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="estadosChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card dashboard-card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-chart-bar me-2"></i>Equipos por Sede
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="sedesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Tabla Salones -->
        <div class="col-lg-6 mb-4">
            <div class="card dashboard-card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-door-open me-2"></i>Salones
                    </h5>
                    <div class="export-buttons">
                        <select id="limiteSalones" class="form-select form-select-sm" style="width: auto;">
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="all">Todos</option>
                        </select>
                        <button id="exportSalonesPDF" class="btn btn-light btn-sm">
                            <i class="fa-solid fa-file-pdf"></i> PDF
                        </button>
                        </div>
                </div>
                <div class="card-body">
                    <div class="loading-spinner" id="loadingSalones">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="tablaSalones" class="table table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Tipo</th>
                                    <th>Sede</th>
                                    <th>Capacidad</th>
                                    <th>Equipos</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <button id="prevSalones" class="btn btn-outline-secondary btn-sm">
                            <i class="fa-solid fa-chevron-left"></i> Anterior
                        </button>
                        <span id="paginaSalones" class="small text-muted">Página 1</span>
                        <button id="nextSalones" class="btn btn-outline-secondary btn-sm">
                            Siguiente <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tabla Equipos -->
        <div class="col-lg-6 mb-4">
            <div class="card dashboard-card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-computer me-2"></i>Equipos
                    </h5>
                    <div class="export-buttons">
                        <select id="limiteEquipos" class="form-select form-select-sm" style="width: auto;">
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="all">Todos</option>
                        </select>
                        <button id="exportEquiposPDF" class="btn btn-light btn-sm">
                            <i class="fa-solid fa-file-pdf"></i> PDF
                        </button>
                        </div>
                </div>
                <div class="card-body">
                    <div class="loading-spinner" id="loadingEquipos">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="tablaEquipos" class="table table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Estado</th>
                                    <th>Salón</th>
                                    <th>Sede</th>
                                    <th>Asignado</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <button id="prevEquipos" class="btn btn-outline-secondary btn-sm">
                            <i class="fa-solid fa-chevron-left"></i> Anterior
                        </button>
                        <span id="paginaEquipos" class="small text-muted">Página 1</span>
                        <button id="nextEquipos" class="btn btn-outline-secondary btn-sm">
                            Siguiente <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
    let estadosChartInstance = null;
    let sedesChartInstance = null;
    
    // Colores personalizados para las gráficas
    const estadoColors = {
        'Disponible': '#28a745',
        'Asignado': '#0078ad',
        'Mantenimiento': '#ffc107',
        'Incidente': '#dc3545',
        'Revisión': '#17a2b8',
        'Otro': '#6c757d'
    };
    
    // Variables de paginación
    let salonesData = []; 
    let equiposData = []; 
    let limiteSalones = 5;
    let limiteEquipos = 5;
    let paginaSalonesActual = 1;
    let paginaEquiposActual = 1;

    // Cargar métricas, gráficas y tablas
    async function cargarDatosReportes() {
        try {
            const resEquipos = await fetch('/admin/api/reportes/estado_equipos');
            const dataEquipos = await resEquipos.json();
            actualizarMetricas(dataEquipos);
            crearEstadosChart(dataEquipos.estados);

            const resSedes = await fetch('/admin/api/reportes/equipos_por_sede');
            const dataSedes = await resSedes.json();
            crearSedesChart(dataSedes);

            await cargarSalonesData(); 
            await cargarEquiposData();
            
            renderizarSalones();
            renderizarEquipos();
        } catch (error) {
            console.error('Error general al cargar los reportes:', error);
        }
    }

    async function cargarSalonesData() {
        const loadingSalones = document.getElementById('loadingSalones');
        loadingSalones.style.display = 'block';
        try {
            const res = await fetch('/admin/api/salones'); 
            const data = await res.json();
            salonesData = data;
        } catch (error) {
            console.error('Error cargando datos de salones:', error);
            salonesData = [];
        } finally {
            loadingSalones.style.display = 'none';
        }
    }

    async function cargarEquiposData() {
        const loadingEquipos = document.getElementById('loadingEquipos');
        loadingEquipos.style.display = 'block';
        try {
            const res = await fetch('/admin/api/equipos'); 
            const data = await res.json();
            equiposData = data;
        } catch (error) {
            console.error('Error cargando datos de equipos:', error);
            equiposData = [];
        } finally {
            loadingEquipos.style.display = 'none';
        }
    }

    // Renderizar tablas con paginación
    function renderizarSalones() {
        const tbody = document.querySelector('#tablaSalones tbody');
        tbody.innerHTML = '';
        
        let limite = limiteSalones === 'all' ? salonesData.length : limiteSalones;
        const inicio = (paginaSalonesActual - 1) * limite;
        const fin = inicio + limite;
        const salonesPagina = salonesData.slice(inicio, fin);

        if (salonesPagina.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">No hay salones para mostrar.</td></tr>';
        }

        salonesPagina.forEach(salon => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${salon.nombre || '-'}</td>
                <td>${salon.tipo || '-'}</td>
                <td>${salon.sede || '-'}</td>
                <td>${salon.capacidad || 'N/A'}</td>
                <td>${salon.total_equipos || 0}</td>
            `;
            tbody.appendChild(row);
        });

        const totalPaginas = Math.ceil(salonesData.length / limite);
        const paginaSpan = document.getElementById('paginaSalones');
        paginaSpan.textContent = limiteSalones === 'all' ? 'Todos' : `Página ${paginaSalonesActual} de ${totalPaginas}`;
        
        document.getElementById('prevSalones').disabled = paginaSalonesActual === 1 || limiteSalones === 'all';
        document.getElementById('nextSalones').disabled = paginaSalonesActual >= totalPaginas || limiteSalones === 'all';
    }
    
    function renderizarEquipos() {
        const tbody = document.querySelector('#tablaEquipos tbody');
        tbody.innerHTML = '';

        let limite = limiteEquipos === 'all' ? equiposData.length : limiteEquipos;
        const inicio = (paginaEquiposActual - 1) * limite;
        const fin = inicio + limite;
        const equiposPagina = equiposData.slice(inicio, fin);

        if (equiposPagina.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">No hay equipos para mostrar.</td></tr>';
        }

        equiposPagina.forEach(equipo => {
            const estado = equipo.estado || 'Desconocido';
            const estadoColor = estadoColors[estado] || estadoColors['Otro'];
            
            const estadoBadge = `<span class="status-badge" style="background-color: ${estadoColor}; color: white;">${estado}</span>`;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${equipo.nombre || '-'}</td>
                <td>${estadoBadge}</td>
                <td>${equipo.sala || '-'}</td>
                <td>${equipo.sede || '-'}</td>
                <td>${equipo.asignado_a || 'N/A'}</td>
            `;
            tbody.appendChild(row);
        });

        const totalPaginas = Math.ceil(equiposData.length / limite);
        const paginaSpan = document.getElementById('paginaEquipos');
        paginaSpan.textContent = limiteEquipos === 'all' ? 'Todos' : `Página ${paginaEquiposActual} de ${totalPaginas}`;
        
        document.getElementById('prevEquipos').disabled = paginaEquiposActual === 1 || limiteEquipos === 'all';
        document.getElementById('nextEquipos').disabled = paginaEquiposActual >= totalPaginas || limiteEquipos === 'all';
    }

    // Métricas y gráficas
    function actualizarMetricas(data) {
        const estados = data.estados;
        document.getElementById('totalEquipos').textContent = data.total_equipos;
        document.getElementById('equiposDisponibles').textContent = estados['Disponible'] || 0;
        document.getElementById('equiposMantenimiento').textContent = estados['Mantenimiento'] || 0;
        document.getElementById('equiposIncidente').textContent = estados['Incidente'] || 0;
    }

    function crearEstadosChart(estados) {
        const labels = Object.keys(estados);
        const data = Object.values(estados);
        const colores = labels.map(label => estadoColors[label] || estadoColors['Otro']);

        const ctx = document.getElementById('estadosChart').getContext('2d');
        
        if (estadosChartInstance) {
            estadosChartInstance.destroy();
        }

        estadosChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colores,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    title: { display: true, text: 'Distribución de Equipos por Estado' }
                }
            }
        });
    }

    function crearSedesChart(dataSedes) {
        const labels = dataSedes.map(d => d.sede);
        const data = dataSedes.map(d => d.total);
        const ctx = document.getElementById('sedesChart').getContext('2d');
        
        if (sedesChartInstance) {
            sedesChartInstance.destroy();
        }

        sedesChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total de Equipos',
                    data: data,
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--color-info'), 
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-info'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Equipos Registrados por Sede' }
                }
            }
        });
    }

    // Exportación PDF con gráficas y tablas
    async function exportarPDF(tipo) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4'); 
        let yOffset = 20;

        doc.setFontSize(18);
        doc.text('Reporte de Inventario', 14, yOffset);
        yOffset += 10;
        
        try {
            const canvasEstados = document.getElementById('estadosChart');
            if (canvasEstados) {
                const imgDataEstados = await html2canvas(canvasEstados, { scale: 2 });
                const imgWidth = 80; 
                const imgHeight = (imgDataEstados.height * imgWidth) / imgDataEstados.width;
                
                doc.setFontSize(14);
                doc.text('1. Estado de Equipos', 14, yOffset);
                yOffset += 6;
                doc.addImage(imgDataEstados.toDataURL('image/png'), 'PNG', 14, yOffset, imgWidth, imgHeight);
                yOffset += imgHeight + 10;
            }
            const canvasSedes = document.getElementById('sedesChart');
            if (canvasSedes) {
                const imgDataSedes = await html2canvas(canvasSedes, { scale: 2 });
                const imgWidth = 80; 
                const imgHeight = (imgDataSedes.height * imgWidth) / imgDataSedes.width;
                
                doc.setFontSize(14);
                doc.text('2. Equipos por Sede', 14, yOffset);
                yOffset += 6;
                doc.addImage(imgDataSedes.toDataURL('image/png'), 'PNG', 14, yOffset, imgWidth, imgHeight);
                yOffset += imgHeight + 10;
            }
            if (tipo === 'salones') {
                doc.setFontSize(14);
                doc.text('3. Lista de Salones', 14, yOffset);
                yOffset += 6;

                const tablaSalones = salonesData.map(salon => [
                    salon.nombre || '-',
                    salon.tipo || '-',
                    salon.sede || '-',
                    salon.capacidad || 'N/A',
                    salon.total_equipos || 0
                ]);

                doc.autoTable({
                    head: [['Nombre', 'Tipo', 'Sede', 'Capacidad', 'Equipos']],
                    body: tablaSalones,
                    startY: yOffset,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [22, 160, 133] },
                    margin: { left: 14, right: 14 }
                });
            } else if (tipo === 'equipos') {
                doc.setFontSize(14);
                doc.text('3. Lista de Equipos', 14, yOffset);
                yOffset += 6;

                const tablaEquipos = equiposData.map(equipo => [
                    equipo.nombre || '-',
                    equipo.estado || 'Desconocido',
                    equipo.sala || '-',
                    equipo.sede || '-',
                    equipo.asignado_a || 'N/A'
                ]);

                doc.autoTable({
                    head: [['Nombre', 'Estado', 'Salón', 'Sede', 'Asignado']],
                    body: tablaEquipos,
                    startY: yOffset,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [39, 174, 96] },
                    margin: { left: 14, right: 14 }
                });
            }
            doc.save(`reporte_inventario_${tipo}.pdf`);
        } catch (error) {
            console.error('Error al generar el PDF:', error);
        }
    }
    // Eventos de paginación y exportación
    document.getElementById('prevSalones').addEventListener('click', () => {
        if (paginaSalonesActual > 1) {
            paginaSalonesActual--;
            renderizarSalones();
        }
    });
    document.getElementById('nextSalones').addEventListener('click', () => {
        const limite = limiteSalones === 'all' ? salonesData.length : limiteSalones;
        const totalPaginas = Math.ceil(salonesData.length / limite);
        if (paginaSalonesActual < totalPaginas) {
            paginaSalonesActual++;
            renderizarSalones();
        }
    });
    document.getElementById('limiteSalones').addEventListener('change', (e) => {
        limiteSalones = e.target.value === 'all' ? 'all' : parseInt(e.target.value);
        paginaSalonesActual = 1;
        renderizarSalones();
    });
    document.getElementById('exportSalonesPDF').addEventListener('click', () => {
        exportarPDF('salones');
    });
    document.getElementById('prevEquipos').addEventListener('click', () => {
        if (paginaEquiposActual > 1) {
            paginaEquiposActual--;
            renderizarEquipos();
        }
    });
    document.getElementById('nextEquipos').addEventListener('click', () => {
        const limite = limiteEquipos === 'all' ? equiposData.length : limiteEquipos;
        const totalPaginas = Math.ceil(equiposData.length / limite);
        if (paginaEquiposActual < totalPaginas) {
            paginaEquiposActual++;
            renderizarEquipos();
        }
    });
    document.getElementById('limiteEquipos').addEventListener('change', (e) => {
        limiteEquipos = e.target.value === 'all' ? 'all' : parseInt(e.target.value);
        paginaEquiposActual = 1;
        renderizarEquipos();
    });
    document.getElementById('exportEquiposPDF').addEventListener('click', () => {
        exportarPDF('equipos');
    });
    // Inicializar carga de datos al cargar la página
    window.onload = cargarDatosReportes;
</script>
{% endblock %}
</body>
</html>