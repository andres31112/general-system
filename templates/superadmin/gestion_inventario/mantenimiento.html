<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestión de Mantenimientos TIC</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin/gestion_usuarios/profesores.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin/gestion_inventario/equipos.css') }}" />
    <style>
        .table-controls {
            margin-bottom: 15px;
        }

        .paginacion {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-sm { font-size: 0.8rem; }
        .badge { font-size: 0.75rem; }
    </style>
</head>

<body>
    {% extends "base.html" %}
    {% block content %}

    <header class="main-header">
        <a onclick="history.back()" class="btn btn-outline-secondary btn-sm border-0 me-3">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <h1>Gestión de Mantenimientos</h1>
        <div class="header-icons">
            <i class="fa-solid fa-bell"></i>
            <i class="fa-solid fa-user"></i>
        </div>
    </header>

    <main class="content-area">

        <!-- Controles: Buscador y Botón Nuevo -->
        <div class="table-controls mb-2 d-flex gap-2 justify-content-between">
            <input type="text" id="buscarMantenimiento" placeholder="Buscar por equipo, sede, fecha o tipo"
                class="form-control w-auto" />
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#programarModal">
                <i class="fas fa-plus me-1"></i>Nuevo Mantenimiento
            </button>
        </div>

        <!-- Tabla de mantenimientos -->
        <section class="table-container">
            <table class="table table-striped table-hover" id="tablaMantenimientos">
                <thead class="table-dark">
                    <tr>
                        <th>Equipo</th>
                        <th>Sede</th>
                        <th>Fecha Programada</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="mantenimientosBody">
                    <!-- Se llenará dinámicamente -->
                </tbody>
            </table>

            <!-- Paginación -->
            <div class="paginacion">
                <button id="prevMantenimientos" class="btn btn-secondary btn-sm">Anterior</button>
                <span id="paginaMantenimientos">Página 1</span>
                <button id="nextMantenimientos" class="btn btn-secondary btn-sm">Siguiente</button>
            </div>
        </section>
    </main>

    <!-- Modal para Ver Detalles -->
    <div class="modal fade" id="detallesModal" tabindex="-1" aria-labelledby="detallesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles del Mantenimiento - <span id="detallesEquipo"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="detallesContent">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Actualizar Estado -->
    <div class="modal fade" id="actualizarModal" tabindex="-1" aria-labelledby="actualizarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formActualizar" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actualizarModalLabel">Actualizar Estado - <span id="actualizarEquipo"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nuevoEstado" class="form-label">Nuevo Estado</label>
                        <select id="nuevoEstado" class="form-select" required>
                            <option value="">Seleccione un estado</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="en_progreso">En Progreso</option>
                            <option value="completado">Completado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="tecnicoInput" class="form-label">Técnico (opcional)</label>
                        <input type="text" id="tecnicoInput" class="form-control" placeholder="Nombre del técnico" />
                    </div>
                    <div class="mb-3">
                        <label for="fechaRealizada" class="form-label">Fecha Realizada (opcional)</label>
                        <input type="date" id="fechaRealizada" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-warning">Actualizar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Programar Nuevo Mantenimiento -->
    <div class="modal fade" id="programarModal" tabindex="-1" aria-labelledby="programarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formProgramar" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="programarModalLabel">Programar Mantenimiento / Revisión</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="equipoSelect" class="form-label">Equipo</label>
                        <select id="equipoSelect" class="form-select" required>
                            <option value="">Seleccione un equipo</option>
                            <!-- Se llenará dinámicamente -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="fechaProgramacion" class="form-label">Fecha Programada</label>
                        <input type="date" id="fechaProgramacion" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label for="tipoProgramacion" class="form-label">Tipo</label>
                        <select id="tipoProgramacion" class="form-select" required>
                            <option value="mantenimiento">Mantenimiento</option>
                            <option value="revision">Revisión</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="descripcionInput" class="form-label">Descripción (opcional)</label>
                        <textarea id="descripcionInput" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Guardar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let todosLosMantenimientos = [];  // Para almacenar datos cargados

        // Cargar equipos para el select (necesitas una API /admin/api/equipos_todos)
        async function cargarEquipos() {
            try {
                const response = await fetch('/admin/api/equipos_todos');
                const equipos = await response.json();
                const select = document.getElementById('equipoSelect');
                select.innerHTML = '<option value="">Seleccione un equipo</option>';
                equipos.forEach(eq => {
                    const option = document.createElement('option');
                    option.value = eq.id;
                    option.textContent = `${eq.nombre} (${eq.sede_nombre || ''})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando equipos:', error);
            }
        }

        // Cargar mantenimientos desde API
        async function cargarMantenimientos() {
            try {
                const response = await fetch('/admin/api/mantenimientos');
                todosLosMantenimientos = await response.json();
                const tbody = document.getElementById('mantenimientosBody');
                tbody.innerHTML = '';
                todosLosMantenimientos.forEach(mantenimiento => {
                    const row = document.createElement('tr');
                    row.dataset.equipo = mantenimiento.equipo_nombre.toLowerCase();
                    row.dataset.sede = mantenimiento.sede.toLowerCase();
                    row.dataset.fecha = mantenimiento.fecha_programada;
                    row.dataset.tipo = mantenimiento.tipo.toLowerCase();
                    row.dataset.estado = mantenimiento.estado.toLowerCase();

                    const estadoBadge = {
                        'pendiente': '<span class="badge bg-warning">Pendiente</span>',
                        'en_progreso': '<span class="badge bg-info">En Progreso</span>',
                        'completado': '<span class="badge bg-success">Completado</span>',
                        'cancelado': '<span class="badge bg-danger">Cancelado</span>'
                    }[mantenimiento.estado] || '<span class="badge bg-secondary">Desconocido</span>';

                    const tipoTexto = mantenimiento.tipo.charAt(0).toUpperCase() + mantenimiento.tipo.slice(1);

                    row.innerHTML = `
                        <td>${mantenimiento.equipo_nombre}</td>
                        <td>${mantenimiento.sede}</td>
                        <td>${mantenimiento.fecha_programada}</td>
                        <td>${tipoTexto}</td>
                        <td>${estadoBadge}</td>
                        <td>
                            <button class="btn btn-primary btn-sm detalles-btn" data-id="${mantenimiento.id}" data-bs-toggle="modal" data-bs-target="#detallesModal">
                                <i class="fas fa-eye me-1"></i>Detalles
                            </button>
                            <button class="btn btn-warning btn-sm ms-1 actualizar-btn" data-id="${mantenimiento.id}" data-estado="${mantenimiento.estado}" data-bs-toggle="modal" data-bs-target="#actualizarModal">
                                <i class="fas fa-edit me-1"></i>Actualizar
                            </button>
                            <button class="btn btn-danger btn-sm ms-1 cancelar-btn" data-id="${mantenimiento.id}">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                mostrarFilas('tablaMantenimientos', 1);
                agregarEventosBotones();
            } catch (error) {
                console.error('Error cargando mantenimientos:', error);
            }
        }

        // Mostrar filas para paginación
        function mostrarFilas(tablaID, pagina) {
            const filas = document.querySelectorAll(`#${tablaID} tbody tr`);
            const limit = 5;
            const start = (pagina - 1) * limit;
            const end = start + limit;
            filas.forEach((f, i) => f.style.display = (i >= start && i < end) ? "" : "none");
            const totalPaginas = Math.ceil(filas.length / limit);
            document.getElementById('paginaMantenimientos').innerText = `Página ${pagina} de ${totalPaginas}`;
        }

        // Eventos de paginación
        document.getElementById('prevMantenimientos').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                mostrarFilas('tablaMantenimientos', currentPage);
            }
        });

        document.getElementById('nextMantenimientos').addEventListener('click', () => {
            const filas = document.querySelectorAll('#tablaMantenimientos tbody tr');
            const totalPaginas = Math.ceil(filas.length / 5);
            if (currentPage < totalPaginas) {
                currentPage++;
                mostrarFilas('tablaMantenimientos', currentPage);
            }
        });

        // Buscador
        document.getElementById('buscarMantenimiento').addEventListener('input', function () {
            const valor = this.value.toLowerCase();
            const filas = document.querySelectorAll('#tablaMantenimientos tbody tr');
            filas.forEach(f => {
                const equipo = f.dataset.equipo || '';
                const sede = f.dataset.sede || '';
                const fecha = f.dataset.fecha || '';
                const tipo = f.dataset.tipo || '';
                const estado = f.dataset.estado || '';
                const texto = (equipo + sede + fecha + tipo + estado).toLowerCase();
                f.style.display = texto.includes(valor) ? "" : "none";
            });
            // Reiniciar paginación al filtrar
            currentPage = 1;
            mostrarFilas('tablaMantenimientos', currentPage);
        });

        // Agregar eventos a botones de acciones
        function agregarEventosBotones() {
            // Detalles
            document.querySelectorAll('.detalles-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    const equipoNombre = btn.closest('tr').querySelector('td:first-child').textContent;
                    document.getElementById('detallesEquipo').textContent = equipoNombre;

                    const content = document.getElementById('detallesContent');
                    content.innerHTML = '<div class="text-center">Cargando...</div>';

                    try {
                        const response = await fetch(`/admin/api/mantenimientos/${id}`);
                        const mantenimiento = await response.json();
                        content.innerHTML = `
                            <p><strong>Sede:</strong> ${mantenimiento.sede}</p>
                            <p><strong>Fecha Programada:</strong> ${mantenimiento.fecha_programada}</p>
                            <p><strong>Tipo:</strong> ${mantenimiento.tipo.charAt(0).toUpperCase() + mantenimiento.tipo.slice(1)}</p>
                            <p><strong>Estado:</strong> <span class="badge bg-${mantenimiento.estado === 'pendiente' ? 'warning' : mantenimiento.estado === 'en_progreso' ? 'info' : mantenimiento.estado === 'completado' ? 'success' : 'danger'}">${mantenimiento.estado}</span></p>
                            <p><strong>Descripción:</strong> ${mantenimiento.descripcion || 'N/A'}</p>
                            <p><strong>Fecha Realizada:</strong> ${mantenimiento.fecha_realizada || 'N/A'}</p>
                            <p><strong>Técnico:</strong> ${mantenimiento.tecnico || 'N/A'}</p>
                        `;
                    } catch (error) {
                        content.innerHTML = '<div class="text-danger">Error al cargar detalles.</div>';
                    }
                });
            });

            // Actualizar (abre modal)
            document.querySelectorAll('.actualizar-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-id');
                    const equipoNombre = btn.closest('tr').querySelector('td:first-child').textContent;
                    document.getElementById('actualizarEquipo').textContent = equipoNombre;
                    const form = document.getElementById('formActualizar');
                    form.dataset.id = id;
                    form.reset();  // Resetear formulario
                    // Opcional: pre-seleccionar el estado actual
                    document.getElementById('nuevoEstado').value = btn.getAttribute('data-estado');

                    // Mostrar modal
                    const modalEl = document.getElementById('actualizarModal');
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                });
            });

            // Cancelar (directo, sin modal)
            document.querySelectorAll('.cancelar-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                                        if (confirm('¿Está seguro de que desea cancelar este mantenimiento?')) {
                        try {
                            const res = await fetch(`/admin/api/mantenimientos/${id}/cancelar`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            if (res.ok) {
                                alert('Mantenimiento cancelado con éxito');
                                cargarMantenimientos();
                            } else {
                                alert('Error al cancelar el mantenimiento');
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Error al cancelar el mantenimiento');
                        }
                    }
                });
            });
        }

        // Envío formulario actualizar estado
        document.getElementById('formActualizar').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.dataset.id;
            const estado = document.getElementById('nuevoEstado').value;
            const tecnico = document.getElementById('tecnicoInput').value;
            const fecha_realizada = document.getElementById('fechaRealizada').value;

            try {
                const res = await fetch(`/admin/api/mantenimientos/${id}/actualizar`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ estado, tecnico, fecha_realizada })
                });
                if (res.ok) {
                    alert('Estado actualizado con éxito');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('actualizarModal'));
                    modal.hide();
                    cargarMantenimientos();
                } else {
                    alert('Error al actualizar estado');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error en la conexión');
            }
        });

        // Envío formulario programar mantenimiento
        document.getElementById('formProgramar').addEventListener('submit', async (e) => {
            e.preventDefault();
            const equipo_id = document.getElementById('equipoSelect').value;
            const fecha_programada = document.getElementById('fechaProgramacion').value;
            const tipo = document.getElementById('tipoProgramacion').value;
            const descripcion = document.getElementById('descripcionInput').value;

            try {
                const res = await fetch('/admin/api/mantenimientos/programar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ equipo_id, fecha_programada, tipo, descripcion })
                });
                if (res.ok) {
                    alert('Mantenimiento programado con éxito');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('programarModal'));
                    modal.hide();
                    e.target.reset();
                    cargarMantenimientos();
                } else {
                    alert('Error al programar mantenimiento');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error en la conexión');
            }
        });

        // Inicializar al cargar
        window.addEventListener('DOMContentLoaded', () => {
            cargarEquipos();
            cargarMantenimientos();
        });
    </script>
    {% endblock %}
</body>
</html>
