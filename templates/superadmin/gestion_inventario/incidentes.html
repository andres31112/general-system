<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Mantenimientos TIC</title>
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin/gestion_usuarios/profesores.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin/gestion_inventario/equipos.css') }}" />
  <style>
    .table-controls { margin-bottom: 15px; }
    .paginacion {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .badge { padding: 5px 10px; border-radius: 5px; font-size: 0.85em; }
    .incidente { background: #dc3545; color: white; }
    .mantenimiento { background: #ffc107; color: black; }
  </style>
</head>

<body>
  {% extends "base.html" %}
  {% block content %}

  <header class="main-header">
    <a onclick="history.back()" class="btn btn-outline-secondary btn-sm border-0 me-3">
      <i class="fa-solid fa-arrow-left"></i>
    </a>
    <h1>Gestión de Mantenimientos TIC</h1>
    <div class="header-icons">
      <i class="fa-solid fa-bell"></i>
      <i class="fa-solid fa-user"></i>
    </div>
  </header>

  <main class="content-area">

    <!-- Controles -->
    <div class="table-controls d-flex gap-2 justify-content-between">
      <input type="text" id="buscarMantenimiento"
        placeholder="Buscar por equipo, sede, fecha o tipo"
        class="form-control w-auto" />
      <button class="btn btn-success" data-bs-toggle="modal"
        data-bs-target="#programarModal">
        <i class="fas fa-plus me-1"></i>Programar Mantenimiento
      </button>
    </div>

    <!-- Tabla -->
    <section class="table-container">
      <table class="table table-striped table-hover" id="tablaMantenimientos">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Equipo</th>
            <th>Sede</th>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Descripción</th>
            <th>Estado</th>
            <th>Origen</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="mantenimientosBody">
          <!-- Registros dinámicos -->
        </tbody>
      </table>

      <!-- Paginación -->
      <div class="paginacion">
        <button id="prevMantenimientos" class="btn btn-secondary btn-sm">Anterior</button>
        <span id="paginaMantenimientos">Página 1</span>
        <button id="nextMantenimientos" class="btn btn-secondary btn-sm">Siguiente</button>
      </div>
    </section>
  </main>

  <!-- Modal Programar -->
  <div class="modal fade" id="programarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="formProgramar" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Programar Mantenimiento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="equipoSelect" class="form-label">Equipo</label>
            <select id="equipoSelect" class="form-select" required></select>
          </div>
          <div class="mb-3">
            <label for="fechaProgramacion" class="form-label">Fecha Programada</label>
            <input type="date" id="fechaProgramacion" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="tipoProgramacion" class="form-label">Tipo</label>
            <input type="text" id="tipoProgramacion" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="descripcionInput" class="form-label">Descripción</label>
            <textarea id="descripcionInput" class="form-control" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Guardar</button>
          <button type="button" class="btn btn-secondary"
            data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentPage = 1;
    let todosLosMantenimientos = [];

    // Cargar equipos
    async function cargarEquipos() {
      const res = await fetch('/admin/api/equipos_todos');
      const equipos = await res.json();
      const select = document.getElementById('equipoSelect');
      select.innerHTML = '';
      equipos.forEach(eq => {
        const option = document.createElement('option');
        option.value = eq.id;
        option.textContent = `${eq.nombre} (${eq.sede_nombre})`;
        select.appendChild(option);
      });
    }

    // Cargar mantenimientos/incidentes
    async function cargarMantenimientos() {
      const res = await fetch('/admin/api/incidentes'); // trae incidentes + equipos en mantenimiento
      todosLosMantenimientos = await res.json();
      const tbody = document.getElementById('mantenimientosBody');
      tbody.innerHTML = '';

      todosLosMantenimientos.forEach(m => {
        const origen = m.id ? "Incidente" : "Mantenimiento";
        const badgeClass = m.estado === "Mantenimiento" ? "mantenimiento" : "incidente";

        const row = document.createElement('tr');
        row.dataset.equipo = m.equipo_nombre.toLowerCase();
        row.dataset.sede = (m.sede || "").toLowerCase();
        row.dataset.fecha = m.fecha || "";
        row.dataset.tipo = (m.tipo || "").toLowerCase();

        row.innerHTML = `
          <td>${m.id || "-"}</td>
          <td>${m.equipo_nombre}</td>
          <td>${m.sede || "-"}</td>
          <td>${m.fecha}</td>
          <td>${m.tipo || "-"}</td>
          <td>${m.descripcion}</td>
          <td><span class="badge ${badgeClass}">${m.estado}</span></td>
          <td>${origen}</td>
          <td>
            ${origen === "Incidente" ? `
              <button class="btn btn-danger btn-sm cancelar-btn" data-id="${m.id}">
                <i class="fas fa-times"></i> Cancelar
              </button>` : "-"}
          </td>
        `;
        tbody.appendChild(row);
      });
      mostrarFilas(1);
      agregarEventosBotones();
    }

    // Mostrar filas con paginación
    function mostrarFilas(pagina) {
      const filas = document.querySelectorAll('#tablaMantenimientos tbody tr');
      const limit = 5;
      const start = (pagina - 1) * limit;
      const end = start + limit;
      filas.forEach((f, i) => f.style.display = (i >= start && i < end) ? "" : "none");
      const totalPaginas = Math.ceil(filas.length / limit) || 1;
      document.getElementById('paginaMantenimientos').innerText = `Página ${pagina} de ${totalPaginas}`;
    }

    // Eventos de paginación
    document.getElementById('prevMantenimientos').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        mostrarFilas(currentPage);
      }
    });

    document.getElementById('nextMantenimientos').addEventListener('click', () => {
      const filas = document.querySelectorAll('#tablaMantenimientos tbody tr');
      const totalPaginas = Math.ceil(filas.length / 5);
      if (currentPage < totalPaginas) {
        currentPage++;
        mostrarFilas(currentPage);
      }
    });

    // Buscar
    document.getElementById('buscarMantenimiento').addEventListener('input', function () {
      const valor = this.value.toLowerCase();
      const filas = document.querySelectorAll('#tablaMantenimientos tbody tr');
      filas.forEach(f => {
        const texto = (f.dataset.equipo + f.dataset.sede + f.dataset.fecha + f.dataset.tipo).toLowerCase();
        f.style.display = texto.includes(valor) ? "" : "none";
      });
      currentPage = 1;
      mostrarFilas(currentPage);
    });

    // Eventos botones
    function agregarEventosBotones() {
      document.querySelectorAll('.cancelar-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          if (confirm('¿Cancelar mantenimiento?')) {
            await fetch(`/admin/api/mantenimientos/${id}/cancelar`, { method: 'PUT' });
            cargarMantenimientos();
          }
        });
      });
    }

    // Guardar nuevo
    document.getElementById('formProgramar').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        equipo_id: document.getElementById('equipoSelect').value,
        fecha_programada: document.getElementById('fechaProgramacion').value,
        tipo: document.getElementById('tipoProgramacion').value,
        descripcion: document.getElementById('descripcionInput').value,
      };
      await fetch('/admin/api/mantenimientos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const modal = bootstrap.Modal.getInstance(document.getElementById('programarModal'));
      modal.hide();
      e.target.reset();
      cargarMantenimientos();
    });

    // Inicializar
    window.addEventListener('DOMContentLoaded', () => {
      cargarEquipos();
      cargarMantenimientos();
    });
  </script>
  {% endblock %}
</body>
</html>