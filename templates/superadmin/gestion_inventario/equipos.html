<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestión de Equipos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin/gestion_inventario/equipos.css') }}">

</head>
<body>
{% extends "base.html" %}
{% block content %}

<header class="custom-header">
    <div class="d-flex align-items-center">
        <a href="{{ url_for('admin.gestion_i') }}" class="btn btn-outline-secondary border-0 me-3 text-white atras">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <i class="fa-solid fa-desktop logo me-3"></i>
        <h1>Gestión de Inventario - Equipos</h1>
    </div>
    <div class="header-icons">
        <i class="fa-solid fa-bell"></i>
        <i class="fa-solid fa-user"></i>
    </div>
</header>

<!-- TARJETAS RESUMEN -->
<main class="container-fluid p-4 py-3">
    <section class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="summary-card">
                <i class="fa-solid fa-list lista"></i>
                <h3 class="h6 mb-0">Total Equipos</h3>
                <p class="number mb-0" id="total-equipos">0</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="summary-card">
                <i class="fa-solid fa-thumbs-up disponible"></i>
                <h3 class="h6 mb-0">Disponibles</h3>
                <p class="number mb-0" id="equipos-disponibles">0</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="summary-card">
                <i class="fa-solid fa-screwdriver-wrench mantenimiento"></i>
                <h3 class="h6 mb-0">En Mantenimiento</h3>
                <p class="number mb-0" id="equipos-mantenimiento">0</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="summary-card">
                <i class="fa-solid fa-triangle-exclamation incidente"></i>
                <h3 class="h6 mb-0">Con Incidentes</h3>
                <p class="number mb-0" id="equipos-incidentes">0</p>
            </div>
        </div>
    </section>
</main>

<!-- TABLA PRINCIPAL + SALAS -->
<main class="row m-3">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8 col-12 mb-4">
                <div class="card equipment-main-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fa-solid fa-desktop me-2"></i>Equipos Registrados</h5>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-light btn-sm me-3" onclick="mostrarTodosLosEquipos()">
                                <i class="fa-solid fa-globe me-1"></i>Ver Todos
                            </button>
                            <select id="registrosPorPagina" class="form-select form-select-sm w-auto me-2">
                                <option value="5" selected>5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                            </select>
                            <a href="{{ url_for('admin.crear_equipo') }}">
                                <button type="button" class="btn btn-success-medium btn-sm">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle text-center">
                                <thead>
                                    <tr>
                                        <th><i class="fa-solid fa-laptop me-2"></i>Equipo</th>
                                        <th><i class="fa-solid fa-signal me-2"></i>Estado</th>
                                        <th><i class="fa-solid fa-door-open me-2"></i>Sala</th>
                                        <th><i class="fa-solid fa-user me-2"></i>Asignado a</th>
                                        <th><i class="fa-solid fa-cog me-2"></i>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaEquiposGlobal"></tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <button id="btnAnterior" class="btn btn-outline-secondary btn-sm">
                                <i class="fa-solid fa-chevron-left me-1"></i>Anterior
                            </button>
                            <span id="paginaActual" class="fw-bold">Página 1</span>
                            <button id="btnSiguiente" class="btn btn-outline-secondary btn-sm">
                                Siguiente<i class="fa-solid fa-chevron-right ms-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN SALAS -->
            <div class="col-md-4 col-12">
                <div class="card salas-card">
                    <div class="card-header bg-white border-0">
                        <ul class="nav nav-tabs card-header-tabs position-relative">
                            <!-- Las pestañas se llenarán dinámicamente -->
                        </ul>
                    </div>
                    <div class="card-body p-2">
                        <div id="contenedorSede">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover align-middle text-center">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Sala</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaSalas"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Modal Editar Equipo -->
<div class="modal fade" id="editarEquipoModal" tabindex="-1" aria-labelledby="editarEquipoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <form id="editarEquipoForm">
        <div class="modal-header">
          <h5 class="modal-title" id="editarEquipoModalLabel">
            <i class="fas fa-edit me-2"></i>Editar Equipo
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <!-- ID oculto -->
          <input type="hidden" id="equipoId" name="id">
          <input type="hidden" id="nombreEquipoHidden" name="nombre">
          <input type="hidden" id="idReferenciaHidden" name="id_referencia">
          <input type="hidden" id="tipoEquipoHidden" name="tipo">
          <input type="hidden" id="salaEquipo" name="id_salon_fk">

          <div class="row">
            <!-- Columna Izquierda: Información del Equipo -->
            <div class="col-lg-6">
              <h6 class="section-title">
                <i class="fas fa-info-circle me-2"></i>Información del Equipo
              </h6>
              
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="idReferencia" class="form-label"><i class="fa-solid fa-hashtag me-1"></i>ID/Referencia</label>
                  <input type="text" class="form-control" id="idReferencia" readonly style="background-color: #f8f9fa;">
                </div>
                <div class="col-md-6">
                  <label for="nombreEquipo" class="form-label"><i class="fa-solid fa-laptop me-1"></i>Nombre del equipo</label>
                  <input type="text" class="form-control" id="nombreEquipo" readonly style="background-color: #f8f9fa;">
                </div>
                
                <div class="col-md-6">
                  <label for="tipoEquipo" class="form-label"><i class="fa-solid fa-tag me-1"></i>Tipo de equipo</label>
                  <input type="text" class="form-control" id="tipoEquipo" readonly style="background-color: #f8f9fa;">
                </div>
                <div class="col-md-6">
                  <label for="estadoEquipoTexto" class="form-label"><i class="fa-solid fa-signal me-1"></i>Estado del equipo</label>
                  <input type="text" class="form-control" id="estadoEquipoTexto" readonly style="background-color: #f8f9fa;">
                  <input type="hidden" id="estadoEquipo" name="estado">
                </div>
                
                <div class="col-12">
                  <label for="salaEquipoTexto" class="form-label"><i class="fa-solid fa-door-open me-1"></i>Sala</label>
                  <input type="text" class="form-control" id="salaEquipoTexto" readonly style="background-color: #f8f9fa;">
                </div>
              </div>

              <!-- Especificaciones Técnicas -->
              <h6 class="section-title mt-4">
                <i class="fas fa-microchip me-2"></i>Especificaciones Técnicas
              </h6>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="sistemaOperativo" class="form-label"><i class="fa-brands fa-windows me-1"></i>Sistema operativo</label>
                  <input type="text" class="form-control" id="sistemaOperativo" name="sistema_operativo">
                </div>
                <div class="col-md-6">
                  <label for="ramEquipo" class="form-label"><i class="fa-solid fa-memory me-1"></i>RAM</label>
                  <input type="text" class="form-control" id="ramEquipo" name="ram">
                </div>
                <div class="col-md-6">
                  <label for="discoDuro" class="form-label"><i class="fa-solid fa-hard-drive me-1"></i>Disco duro</label>
                  <input type="text" class="form-control" id="discoDuro" name="disco_duro">
                </div>
                <div class="col-md-6">
                  <label for="fechaAdquisicion" class="form-label"><i class="fa-solid fa-calendar me-1"></i>Fecha de adquisición</label>
                  <input type="date" class="form-control" id="fechaAdquisicion" name="fecha_adquisicion">
                </div>
                <div class="col-12">
                  <label for="descripcionEquipo" class="form-label"><i class="fa-solid fa-align-left me-1"></i>Descripción</label>
                  <textarea class="form-control" id="descripcionEquipo" name="descripcion" rows="2"></textarea>
                </div>
                <div class="col-12">
                  <label for="observacionesEquipo" class="form-label"><i class="fa-solid fa-comment me-1"></i>Observaciones</label>
                  <textarea class="form-control" id="observacionesEquipo" name="observaciones" rows="2"></textarea>
                </div>
              </div>
            </div>

            <!-- Columna Derecha: Gestión de Asignaciones -->
            <div class="col-lg-6">
              <h6 class="section-title">
                <i class="fas fa-users me-2"></i>Asignaciones de Estudiantes
              </h6>
              
              <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Importante:</strong> Solo puedes asignar un estudiante por curso.
              </div>

              <!-- Formulario para agregar asignación -->
              <div class="card mb-3" style="border-left: 4px solid var(--accent2);">
                <div class="card-body">
                  <div class="row g-2">
                    <div class="col-md-6">
                      <label for="cursoSelectorEditar" class="form-label"><i class="fa-solid fa-graduation-cap me-1"></i>Curso</label>
                      <select class="form-select form-select-sm" id="cursoSelectorEditar">
                        <option value="">-- Selecciona un curso --</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="estudianteSelectorEditar" class="form-label"><i class="fa-solid fa-user-graduate me-1"></i>Estudiante</label>
                      <select class="form-select form-select-sm" id="estudianteSelectorEditar" disabled>
                        <option value="">Primero selecciona un curso</option>
                      </select>
                    </div>
                    <div class="col-12 text-end">
                      <button type="button" class="btn btn-sm btn-success" id="btnAgregarAsignacionEditar">
                        <i class="fas fa-plus me-1"></i>Agregar
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Lista de asignaciones actuales -->
              <div id="listaAsignacionesEditar">
                <div class="text-muted text-center py-3">
                  <i class="fas fa-user-slash fa-2x mb-2"></i>
                  <p class="mb-0">No hay asignaciones</p>
                </div>
              </div>

              <!-- Resumen -->
              <div class="card mt-3" style="background: linear-gradient(135deg, rgba(238, 150, 75, 0.1), rgba(244, 211, 94, 0.1)); border-left: 5px solid var(--accent2);">
                <div class="card-body p-3">
                  <h6 class="card-title mb-2">
                    <i class="fas fa-chart-bar me-2"></i>Resumen
                  </h6>
                  <div class="d-flex justify-content-between mb-2">
                    <span><strong>Estudiantes asignados:</strong></span>
                    <span class="badge bg-primary" id="totalEstudiantesEditar">0</span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span><strong>Cursos cubiertos:</strong></span>
                    <span class="badge bg-secondary" id="totalCursosEditar">0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Cerrar
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i>Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL VER DETALLES -->
<div class="modal fade" id="verEquipoModal" tabindex="-1" aria-labelledby="verEquipoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-eye me-2"></i>Detalles del Equipo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Columna izquierda -->
                    <div class="col-md-6">
                        <div class="mb-3 info-box">
                            <strong><i class="fa-solid fa-hashtag me-1"></i>ID/Referencia:</strong> <span id="detalle-id-referencia">-</span>
                        </div>
                        <div class="mb-3 info-box">
                            <strong><i class="fa-solid fa-laptop me-1"></i>Nombre del equipo:</strong> <span id="detalle-nombre">-</span>
                        </div>
                        <div class="mb-3 info-box">
                            <strong><i class="fa-solid fa-tag me-1"></i>Tipo de equipo:</strong> <span id="detalle-tipo">-</span>
                        </div>
                        
                        <h6 class="section-title mt-4">
                            <i class="fas fa-microchip me-2"></i>Especificaciones Técnicas
                        </h6>
                        <div class="mb-3 info-box">
                            <strong><i class="fa-brands fa-windows me-1"></i>Sistema Operativo:</strong> <span id="detalle-so">-</span>
                        </div>
                        <div class="mb-3 info-box">
                            <strong><i class="fa-solid fa-memory me-1"></i>RAM:</strong> <span id="detalle-ram">-</span>
                        </div>
                        <div class="mb-3 info-box">
                            <strong><i class="fa-solid fa-hard-drive me-1"></i>Disco Duro:</strong> <span id="detalle-disco">-</span>
                        </div>
                        <div class="mb-3 info-box">
                            <strong><i class="fa-solid fa-calendar me-1"></i>Fecha de adquisición:</strong> <span id="detalle-fecha">-</span>
                        </div>
                        <div class="mb-3 info-box">
                            <strong><i class="fa-solid fa-align-left me-1"></i>Descripción:</strong> <span id="detalle-descripcion">-</span>
                        </div>
                        <div class="mb-3 info-box">
                            <strong><i class="fa-solid fa-comment me-1"></i>Observaciones:</strong> <span id="detalle-observaciones">-</span>
                        </div>
                    </div>
                    
                    <!-- Columna derecha -->
                    <div class="col-md-6">
                        <div class="mb-3 info-box">
                            <strong><i class="fa-solid fa-user me-1"></i>Usuario asignado:</strong> <span id="detalle-usuario">-</span>
                        </div>
                        <div class="mb-3 info-box">
                            <strong><i class="fa-solid fa-signal me-1"></i>Estado del equipo:</strong> 
                            <span id="detalle-estado-badge" class="badge">-</span>
                        </div>
                        <div class="mb-3 info-box">
                            <strong><i class="fa-solid fa-door-open me-1"></i>Sala:</strong> <span id="detalle-sala">-</span>
                        </div>
                        
                        <h6 class="section-title mt-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>Historial de Incidentes
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead style="background: var(--accent4); color: white;">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Descripción</th>
                                    </tr>
                                </thead>
                                <tbody id="detalle-incidentes">
                                    <!-- Historial cargado dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                        
                        <h6 class="section-title mt-4">
                            <i class="fas fa-tools me-2"></i>Historial de Mantenimientos
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead style="background: var(--accent4); color: white;">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Tipo</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="detalle-mantenimientos">
                                    <!-- Historial cargado dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ========================================
// VARIABLES GLOBALES
// ========================================
let sedesGlobal = [];
let equiposGlobal = [];
let paginaActual = 1;
let registrosPorPagina = 5;
let salasDisponibles = [];
let equiposConIncidentes = [];
let equiposConMantenimientos = [];

// ========================================
// INICIALIZACIÓN
// ========================================
document.addEventListener('DOMContentLoaded', async () => {
    console.log('🚀 Iniciando aplicación...');
    await cargarEquiposConIncidentes();
    await cargarEquiposConMantenimientos();
    await cargarSedes();
    configurarEventListeners();
});

function configurarEventListeners() {
    document.getElementById('btnAnterior').addEventListener('click', paginaAnterior);
    document.getElementById('btnSiguiente').addEventListener('click', paginaSiguiente);
    document.getElementById('registrosPorPagina').addEventListener('change', cambiarRegistrosPorPagina);
    document.getElementById('editarEquipoForm').addEventListener('submit', guardarEdicionEquipo);
}

// ========================================
// CARGAR EQUIPOS CON INCIDENTES
// ========================================
async function cargarEquiposConIncidentes() {
    try {
        const res = await fetch('/admin/api/equipos/con-incidentes');
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();
        equiposConIncidentes = data.equipos_con_incidentes || [];
        console.log('Equipos con incidentes:', equiposConIncidentes);
    } catch (error) {
        console.error('Error cargando equipos con incidentes:', error);
        equiposConIncidentes = [];
    }
}

// ========================================
// CARGAR EQUIPOS CON MANTENIMIENTOS
// ========================================
async function cargarEquiposConMantenimientos() {
    try {
        const res = await fetch('/admin/api/equipos/con-mantenimientos');
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();
        equiposConMantenimientos = data.equipos_con_mantenimientos || [];
        console.log('Equipos con mantenimientos:', equiposConMantenimientos);
    } catch (error) {
        console.error('Error cargando equipos con mantenimientos:', error);
        equiposConMantenimientos = [];
    }
}

// ========================================
// CARGAR SALAS
// ========================================
async function cargarSalas() {
    try {
        const res = await fetch('/api/salas_todas');
        const salas = await res.json();
        salasDisponibles = salas.map(sala => ({
            id: sala.id_salon,
            nombre: sala.nombre,
            sede_id: sala.sede_id,
            sede_nombre: sala.sede_nombre || 'Desconocida'
        }));
    } catch (error) {
        console.error('Error cargando salas:', error);
    }
}

// ========================================
// GESTIÓN DE SEDES Y TABS
// ========================================
function crearTabsSedes(sedes) {
    const tabsContainer = document.querySelector('.nav.nav-tabs.card-header-tabs');
    tabsContainer.innerHTML = '';
    
    sedes.forEach((sede, index) => {
        const tabItem = document.createElement('li');
        tabItem.className = 'nav-item';
        
        const tabLink = document.createElement('a');
        tabLink.className = `nav-link ${index === 0 ? 'active' : ''}`;
        tabLink.id = `tab-sede-${sede.id_sede || sede.id}`;
        tabLink.href = '#';
        tabLink.innerHTML = `<i class="fa-solid fa-building me-1"></i>${sede.nombre}`;
        
        // Agregar evento de clic
        tabLink.addEventListener('click', async (event) => {
            event.preventDefault();
            
            // Remover clase active de todos los tabs
            document.querySelectorAll('.salas-card .nav-link').forEach(el => {
                el.classList.remove('active');
            });
            
            // Agregar clase active al tab seleccionado
            tabLink.classList.add('active');
            
            // Mostrar los datos de la sede
            await mostrarSede(sede.id_sede || sede.id);
        });
        
        tabItem.appendChild(tabLink);
        tabsContainer.appendChild(tabItem);
    });
}

async function cargarSedes() {
    try {
        const res = await fetch('/admin/api/sedes');
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const sedes = await res.json();
        sedesGlobal = sedes;
        
        crearTabsSedes(sedes);
        await cargarSalas();
        await mostrarTodosLosEquipos();
        
    } catch (error) {
        console.error('Error cargando sedes:', error);
        await mostrarTodosLosEquipos();
    }
}

async function mostrarSede(sedeId) {
    // Actualizar tab activo
    document.querySelectorAll('.salas-card .nav-link').forEach(el => el.classList.remove('active'));
    const tab = document.getElementById(`tab-sede-${sedeId}`);
    if (tab) tab.classList.add('active');

    const tbodySalas = document.getElementById('tablaSalas');
    tbodySalas.innerHTML = '<tr><td colspan="2" class="text-muted">Cargando salas...</td></tr>';

    try {
        const res = await fetch(`/admin/api/sedes/${sedeId}/salas`);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const salones = await res.json();
        
        tbodySalas.innerHTML = '';
        
        if (salones.length === 0) {
            tbodySalas.innerHTML = '<tr><td colspan="2" class="text-muted">No hay salas en esta sede.</td></tr>';
            mostrarEquiposDeSede(sedeId);
            return;
        }

        salones.forEach((salon, index) => {
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            row.onclick = () => mostrarEquiposDeSala(sedeId, salon.id);
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><i class="fa-solid fa-door-open me-1"></i>${salon.nombre}</td>
            `;
            tbodySalas.appendChild(row);
        });

        // Mostrar equipos de la sede seleccionada
        await mostrarEquiposDeSede(sedeId);

    } catch (error) {
        console.error('Error cargando salones:', error);
        tbodySalas.innerHTML = '<tr><td colspan="2" class="text-danger">Error al cargar salas.</td></tr>';
        await mostrarEquiposDeSede(sedeId);
    }
}
// ========================================
// MOSTRAR EQUIPOS
// ========================================
async function mostrarTodosLosEquipos() {
    equiposGlobal = [];
    paginaActual = 1;
    
    try {
        await cargarEquiposConIncidentes();
        
        const res = await fetch('/admin/api/equipos');
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const equipos = await res.json();

        equiposGlobal = equipos.map(eq => ({
            ...eq,
            sede: eq.sede_nombre || 'Desconocida',
            sala: eq.salon || 'Desconocida'
        }));
        
        console.log('📊 Total equipos:', equiposGlobal.length);
        
        actualizarResumen(equiposGlobal);
        renderizarTabla();
    } catch (error) {
        console.error('Error cargando todos los equipos:', error);
        equiposGlobal = [];
        actualizarResumen(equiposGlobal);
        renderizarTabla();
    }
}

async function mostrarEquiposDeSede(id_sede) {
    equiposGlobal = [];
    paginaActual = 1;
    
    try {
        await cargarEquiposConIncidentes();
        
        const resSalas = await fetch(`/admin/api/sedes/${id_sede}/salas`);
        if (!resSalas.ok) throw new Error(`HTTP error! status: ${resSalas.status}`);
        const salas = await resSalas.json();

        for (const sala of salas) {
            const resEquipos = await fetch(`/admin/api/sedes/${id_sede}/salas/${sala.id_salon}/equipos`);
            if (!resEquipos.ok) throw new Error(`HTTP error! status: ${resEquipos.status}`);
            const equipos = await resEquipos.json();
            equipos.forEach(eq => {
                equiposGlobal.push({
                    ...eq,
                    sede: sedesGlobal.find(s => s.id === id_sede)?.nombre || 'Desconocida',
                    sala: sala.nombre || 'Desconocida'
                });
            });
        }
        actualizarResumen(equiposGlobal);
        renderizarTabla();
    } catch (error) {
        console.error('Error cargando equipos de la sede:', error);
        equiposGlobal = [];
        actualizarResumen(equiposGlobal);
        renderizarTabla();
    }
}

async function mostrarEquiposDeSala(id_sede, id_salon) {
    equiposGlobal = [];
    paginaActual = 1;
    
    try {
        await cargarEquiposConIncidentes();
        
        const res = await fetch(`/admin/api/sedes/${id_sede}/salas/${id_salon}/equipos`);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const equipos = await res.json();

        const sede = sedesGlobal.find(s => s.id === id_sede);
        const sala = salasDisponibles.find(s => s.id === id_salon);

        equipos.forEach(eq => {
            equiposGlobal.push({
                ...eq,
                sede: sede ? sede.nombre : 'Desconocida',
                sala: sala ? sala.nombre : 'Desconocida'
            });
        });

        actualizarResumen(equiposGlobal);
        renderizarTabla();
    } catch (error) {
        console.error('Error cargando equipos:', error);
        equiposGlobal = [];
        actualizarResumen(equiposGlobal);
        renderizarTabla();
    }
}

// ========================================
// RENDERIZAR TABLA
// ========================================
function renderizarTabla() {
    const tbody = document.getElementById('tablaEquiposGlobal');
    tbody.innerHTML = '';

    const inicio = (paginaActual - 1) * registrosPorPagina;
    const fin = inicio + registrosPorPagina;
    const equiposPagina = equiposGlobal.slice(inicio, fin);

    if (equiposPagina.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-muted py-3">No se encontraron equipos.</td></tr>`;
        document.getElementById('paginaActual').textContent = `Página 0 de 0`;
        document.getElementById('btnAnterior').disabled = true;
        document.getElementById('btnSiguiente').disabled = true;
        return;
    }

    equiposPagina.forEach(eq => {
        const equipoId = parseInt(eq.id_equipo);
        const tieneIncidente = equiposConIncidentes.includes(eq.id_equipo);
        const tieneMantenimiento = equiposConMantenimientos.includes(eq.id_equipo);
        
        console.log(`Equipo: ${eq.nombre}, ID: ${equipoId}, Incidente: ${tieneIncidente}`);

        let estadoBadge = '';
        if (eq.estado === 'Disponible') estadoBadge = `<span class="badge text-bg-primary">Disponible</span>`;
        else if (eq.estado === 'Asignado') estadoBadge = `<span class="badge text-bg-secondary">Asignado</span>`;
        else if (eq.estado === 'Mantenimiento') estadoBadge = `<span class="badge text-bg-warning">Mantenimiento</span>`;
        else if (eq.estado === 'Incidente') estadoBadge = `<span class="badge text-bg-danger">Incidente</span>`;
        else if (eq.estado === 'Revisión') estadoBadge = `<span class="badge text-bg-info">Revisión</span>`;
        else estadoBadge = `<span class="badge text-bg-light">${eq.estado || 'Desconocido'}</span>`;

        const row = document.createElement('tr');
        
        if (tieneIncidente) {
            row.classList.add('equipo-con-incidente');
        } else if (tieneMantenimiento) {
            row.classList.add('equipo-con-mantenimiento');
        }
        
        row.innerHTML = `
            <td>
                ${tieneIncidente ? '<i class="fa-solid fa-exclamation-triangle text-danger me-2" title="Tiene incidentes activos"></i>' : ''}
                ${tieneMantenimiento && !tieneIncidente ? '<i class="fa-solid fa-wrench text-warning me-2" title="Tiene mantenimientos programados"></i>' : ''}
                ${eq.nombre || '-'}
            </td>
            <td>${estadoBadge}</td>
            <td>${eq.sala || '-'}</td>
            <td>${eq.asignado_a || '-'}</td>
            <td>
                <button class="btn btn-sm btn-info me-2" onclick="verEquipo(${eq.id_equipo})" title="Ver detalles">
                    <i class="fa-solid fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-warning me-2" onclick="editarEquipo(${eq.id_equipo})" title="Editar equipo">
                    <i class="fa-solid fa-pen"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="eliminarEquipo(${eq.id_equipo})" title="Eliminar equipo">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </td> 
        `;
        tbody.appendChild(row);
    });

    const totalPaginas = Math.ceil(equiposGlobal.length / registrosPorPagina);
    document.getElementById('paginaActual').textContent = `Página ${paginaActual} de ${totalPaginas}`;
    document.getElementById('btnAnterior').disabled = paginaActual === 1;
    document.getElementById('btnSiguiente').disabled = paginaActual >= totalPaginas;
}

// ========================================
// PAGINACIÓN
// ========================================
function paginaAnterior() {
    if (paginaActual > 1) {
        paginaActual--;
        renderizarTabla();
    }
}

function paginaSiguiente() {
    const totalPaginas = Math.ceil(equiposGlobal.length / registrosPorPagina);
    if (paginaActual < totalPaginas) {
        paginaActual++;
        renderizarTabla();
    }
}

function cambiarRegistrosPorPagina(e) {
    registrosPorPagina = parseInt(e.target.value);
    paginaActual = 1;
    renderizarTabla();
}

// ========================================
// RESUMEN
// ========================================
function actualizarResumen(equipos) {
    const total = equipos.length;
    const disponibles = equipos.filter(e => e.estado === 'Disponible').length;
    
    const conMantenimiento = equipos.filter(e => 
        equiposConMantenimientos.includes(parseInt(e.id_equipo))
    ).length;
    
    const conIncidentes = equipos.filter(e => 
        equiposConIncidentes.includes(parseInt(e.id_equipo))
    ).length;

    document.getElementById('total-equipos').textContent = total;
    document.getElementById('equipos-disponibles').textContent = disponibles;
    document.getElementById('equipos-mantenimiento').textContent = conMantenimiento;
    document.getElementById('equipos-incidentes').textContent = conIncidentes;
}

// ========================================
// GESTIÓN DE ASIGNACIONES EN EDICIÓN
// ========================================
let asignacionesEditar = [];
let cursosAsignadosEditar = new Set();
let cursosDisponibles = [];

async function cargarCursosEditar() {
    try {
        const res = await fetch('/admin/api/cursos');
        if (!res.ok) throw new Error('Error cargando cursos');
        const data = await res.json();
        cursosDisponibles = data.data || data;
        
        const selector = document.getElementById('cursoSelectorEditar');
        selector.innerHTML = '<option value="">-- Selecciona un curso --</option>';
        
        cursosDisponibles.forEach(curso => {
            const option = document.createElement('option');
            option.value = curso.id_curso;
            option.textContent = curso.nombreCurso;
            selector.appendChild(option);
        });
    } catch (error) {
        console.error('Error cargando cursos:', error);
    }
}

document.getElementById('cursoSelectorEditar').addEventListener('change', async function() {
    const cursoId = this.value;
    const estudianteSelector = document.getElementById('estudianteSelectorEditar');
    
    estudianteSelector.innerHTML = '<option value="">Cargando...</option>';
    estudianteSelector.disabled = true;
    
    if (!cursoId) {
        estudianteSelector.innerHTML = '<option value="">Primero selecciona un curso</option>';
        return;
    }
    
    if (cursosAsignadosEditar.has(parseInt(cursoId))) {
        estudianteSelector.innerHTML = '<option value="">Ya hay un estudiante de este curso asignado</option>';
        return;
    }
    
    try {
        const res = await fetch(`/admin/api/estudiantes-por-curso/${cursoId}`);
        if (!res.ok) throw new Error('Error cargando estudiantes');
        const estudiantes = await res.json();
        
        estudianteSelector.innerHTML = '<option value="">-- Selecciona un estudiante --</option>';
        
        if (estudiantes.length === 0) {
            estudianteSelector.innerHTML = '<option value="">No hay estudiantes en este curso</option>';
        } else {
            estudiantes.forEach(est => {
                if (!asignacionesEditar.find(a => a.estudiante_id === est.id_usuario)) {
                    const option = document.createElement('option');
                    option.value = est.id_usuario;
                    option.textContent = `${est.nombre_completo} (${est.no_identidad})`;
                    option.dataset.nombre = est.nombre_completo;
                    option.dataset.cursoId = cursoId;
                    option.dataset.cursoNombre = this.options[this.selectedIndex].text;
                    estudianteSelector.appendChild(option);
                }
            });
        }
        
        estudianteSelector.disabled = false;
    } catch (error) {
        console.error('Error:', error);
        estudianteSelector.innerHTML = '<option value="">Error al cargar estudiantes</option>';
    }
});

document.getElementById('btnAgregarAsignacionEditar').addEventListener('click', async function() {
    const estudianteSelector = document.getElementById('estudianteSelectorEditar');
    const estudianteId = estudianteSelector.value;
    
    if (!estudianteId) {
        alert('Por favor selecciona un estudiante');
        return;
    }
    
    const selectedOption = estudianteSelector.options[estudianteSelector.selectedIndex];
    const estudianteNombre = selectedOption.dataset.nombre;
    const cursoId = parseInt(selectedOption.dataset.cursoId);
    const cursoNombre = selectedOption.dataset.cursoNombre;
    
    if (asignacionesEditar.find(a => a.estudiante_id === parseInt(estudianteId))) {
        alert('Este estudiante ya está asignado a este equipo');
        return;
    }
    
    try {
        const salonActualId = parseInt(document.getElementById('salaEquipo').value);
        const salonActualNombre = document.getElementById('salaEquipoTexto').value;
        
        const response = await fetch(`/admin/api/estudiante/${estudianteId}/equipos-en-sala/${salonActualId}`);
        const data = await response.json();
        
        if (data.tiene_equipo_en_sala) {
            alert(`⚠️ Este estudiante ya tiene el equipo "${data.equipo_nombre}" asignado en esta sala (${salonActualNombre}).\n\n❌ Solo puede tener UN equipo por sala.`);
            return;
        }
    } catch (error) {
        console.error('Error verificando equipos del estudiante:', error);
        alert('Error al verificar las asignaciones del estudiante');
        return;
    }
    
    const asignacion = {
        estudiante_id: parseInt(estudianteId),
        estudiante_nombre: estudianteNombre,
        curso_id: cursoId,
        curso_nombre: cursoNombre,
        es_nueva: true
    };
    
    asignacionesEditar.push(asignacion);
    cursosAsignadosEditar.add(cursoId);
    
    renderizarAsignacionesEditar();
    actualizarResumenEditar();
    
    document.getElementById('cursoSelectorEditar').value = '';
    estudianteSelector.innerHTML = '<option value="">Primero selecciona un curso</option>';
    estudianteSelector.disabled = true;
});

function renderizarAsignacionesEditar() {
    const container = document.getElementById('listaAsignacionesEditar');
    
    if (asignacionesEditar.length === 0) {
        container.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-user-slash fa-2x mb-2"></i>
                <p class="mb-0">No hay asignaciones</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="list-group list-group-flush">';
    
    asignacionesEditar.forEach((asig, index) => {
        const badgeClass = asig.es_nueva ? 'bg-success' : 'bg-info';
        const badgeText = asig.es_nueva ? 'NUEVA' : 'EXISTENTE';
        
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-circle fa-lg text-primary me-2"></i>
                        <div>
                            <strong>${asig.estudiante_nombre}</strong>
                            <br>
                            <small class="text-muted">
                                <i class="fas fa-graduation-cap me-1"></i>${asig.curso_nombre}
                            </small>
                        </div>
                    </div>
                </div>
                <div>
                    <span class="badge ${badgeClass} me-2">${badgeText}</span>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarAsignacionEditar(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function eliminarAsignacionEditar(index) {
    const asignacion = asignacionesEditar[index];
    cursosAsignadosEditar.delete(asignacion.curso_id);
    asignacionesEditar.splice(index, 1);
    renderizarAsignacionesEditar();
    actualizarResumenEditar();
}

function actualizarResumenEditar() {
    document.getElementById('totalEstudiantesEditar').textContent = asignacionesEditar.length;
    document.getElementById('totalCursosEditar').textContent = cursosAsignadosEditar.size;
}

// ========================================
// EDITAR EQUIPO
// ========================================
async function editarEquipo(id) {
    try {
        asignacionesEditar = [];
        cursosAsignadosEditar = new Set();
        
        await cargarCursosEditar();
        
        const res = await fetch(`/admin/api/equipos/${id}`);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const equipo = await res.json();

        document.getElementById('equipoId').value = equipo.id_equipo || '';
        document.getElementById('idReferencia').value = equipo.id_referencia || '';
        document.getElementById('nombreEquipo').value = equipo.nombre || '';
        document.getElementById('tipoEquipo').value = equipo.tipo || '';
        document.getElementById('estadoEquipoTexto').value = equipo.estado || '';
        document.getElementById('estadoEquipo').value = equipo.estado || '';
        document.getElementById('salaEquipoTexto').value = equipo.salon || 'Sin Salón';
        document.getElementById('salaEquipo').value = equipo.id_salon_fk || '';
        document.getElementById('nombreEquipoHidden').value = equipo.nombre || '';
        document.getElementById('idReferenciaHidden').value = equipo.id_referencia || '';
        document.getElementById('tipoEquipoHidden').value = equipo.tipo || '';
        document.getElementById('sistemaOperativo').value = equipo.sistema_operativo || '';
        document.getElementById('ramEquipo').value = equipo.ram || '';
        document.getElementById('discoDuro').value = equipo.disco_duro || '';
        document.getElementById('fechaAdquisicion').value = equipo.fecha_adquisicion || '';
        document.getElementById('descripcionEquipo').value = equipo.descripcion || '';
        document.getElementById('observacionesEquipo').value = equipo.observaciones || '';

        if (equipo.asignaciones && equipo.asignaciones.length > 0) {
            for (const asig of equipo.asignaciones) {
                asignacionesEditar.push({
                    id_asignacion: asig.id_asignacion,
                    estudiante_id: asig.estudiante_id,
                    estudiante_nombre: asig.estudiante_nombre,
                    curso_id: asig.curso_id,
                    curso_nombre: asig.estudiante_curso,
                    es_nueva: false
                });
                cursosAsignadosEditar.add(asig.curso_id);
            }
        }
        
        renderizarAsignacionesEditar();
        actualizarResumenEditar();

        new bootstrap.Modal(document.getElementById('editarEquipoModal')).show();
    } catch (err) {
        console.error('Error al editar equipo', err);
        alert('Error al cargar los datos del equipo para edición.');
    }
}

// ========================================
// GUARDAR EDICIÓN
// ========================================
async function guardarEdicionEquipo(e) {
    e.preventDefault();
    
    const equipoId = document.getElementById('equipoId').value;
    
    const datosEquipo = {
        sistema_operativo: document.getElementById('sistemaOperativo').value,
        ram: document.getElementById('ramEquipo').value,
        disco_duro: document.getElementById('discoDuro').value,
        fecha_adquisicion: document.getElementById('fechaAdquisicion').value,
        descripcion: document.getElementById('descripcionEquipo').value,
        observaciones: document.getElementById('observacionesEquipo').value,
        asignaciones: asignacionesEditar.map(asig => ({
            estudiante_id: asig.estudiante_id,
            curso_id: asig.curso_id,
            es_nueva: asig.es_nueva
        }))
    };
    
    try {
        const res = await fetch(`/admin/api/equipos/${equipoId}/actualizar`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(datosEquipo)
        });
        
        const data = await res.json();
        
        if (res.ok) {
            alert('Equipo actualizado correctamente');
            bootstrap.Modal.getInstance(document.getElementById('editarEquipoModal')).hide();
            await mostrarTodosLosEquipos();
        } else {
            alert(`Error: ${data.error || 'No se pudo actualizar el equipo'}`);
        }
    } catch (error) {
        console.error('Error guardando edición:', error);
        alert('Error al guardar los cambios');
    }
}

// ========================================
// ELIMINAR EQUIPO
// ========================================
async function eliminarEquipo(id) {
    const equipo = equiposGlobal.find(e => e.id_equipo === id);
    const nombreEquipo = equipo ? equipo.nombre : 'este equipo';
    
    if (!confirm(`¿Estás seguro de que deseas eliminar "${nombreEquipo}"? Esta acción no se puede deshacer.`)) {
        return;
    }
    
    try {
        const res = await fetch(`/admin/api/equipos/${id}`, { 
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const responseData = await res.json();
        
        if (res.ok) {
            alert(responseData.message || 'Equipo eliminado con éxito.');
            await mostrarTodosLosEquipos();
        } else {
            alert(`Error al eliminar el equipo: ${responseData.error || 'Error desconocido'}`);
        }
    } catch (err) {
        console.error('Error al eliminar equipo', err);
        alert('Error de conexión al eliminar el equipo.');
    }
}

// ========================================
// VER EQUIPO
// ========================================
async function verEquipo(id) {
    try {
        const res = await fetch(`/admin/api/equipos/${id}`);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const equipo = await res.json();

        document.getElementById('detalle-id-referencia').textContent = equipo.id_referencia || '-';
        document.getElementById('detalle-nombre').textContent = equipo.nombre || '-';
        document.getElementById('detalle-tipo').textContent = equipo.tipo || '-';
        document.getElementById('detalle-usuario').textContent = equipo.asignado_a || '-';
        document.getElementById('detalle-sala').textContent = equipo.salon_nombre || '-';
        
        const estadoBadge = document.getElementById('detalle-estado-badge');
        estadoBadge.textContent = equipo.estado || 'Desconocido';
        estadoBadge.className = 'badge ';
        if (equipo.estado === 'Disponible') estadoBadge.className += 'text-bg-primary';
        else if (equipo.estado === 'Asignado') estadoBadge.className += 'text-bg-secondary';
        else if (equipo.estado === 'Mantenimiento') estadoBadge.className += 'text-bg-warning';
        else if (equipo.estado === 'Incidente') estadoBadge.className += 'text-bg-danger';
        else if (equipo.estado === 'Revisión') estadoBadge.className += 'text-bg-info';
        else estadoBadge.className += 'text-bg-light';

        document.getElementById('detalle-so').textContent = equipo.sistema_operativo || '-';
        document.getElementById('detalle-ram').textContent = equipo.ram || '-';
        document.getElementById('detalle-disco').textContent = equipo.disco_duro || '-';
        document.getElementById('detalle-fecha').textContent = equipo.fecha_adquisicion || '-';
        document.getElementById('detalle-descripcion').textContent = equipo.descripcion || '-';
        document.getElementById('detalle-observaciones').textContent = equipo.observaciones || '-';

        const incidentesTable = document.getElementById('detalle-incidentes');
        if (equipo.incidentes && equipo.incidentes.length > 0) {
            incidentesTable.innerHTML = equipo.incidentes.map(inc => `
                <tr>
                    <td>${inc.fecha}</td>
                    <td>${inc.descripcion}</td>
                </tr>
            `).join('');
        } else {
            incidentesTable.innerHTML = '<tr><td colspan="2" class="text-muted">Sin incidentes registrados</td></tr>'; 
        }

        const mantenimientosTable = document.getElementById('detalle-mantenimientos');
        if (equipo.mantenimientos && equipo.mantenimientos.length > 0) {
            mantenimientosTable.innerHTML = equipo.mantenimientos.map(mant => `
                <tr>
                    <td>${mant.fecha}</td>
                    <td>${mant.tipo}</td>
                    <td>${mant.estado}</td>
                </tr>
            `).join('');
        } else {
            mantenimientosTable.innerHTML = '<tr><td colspan="3" class="text-muted">Sin mantenimientos registrados</td></tr>';
        }

        new bootstrap.Modal(document.getElementById('verEquipoModal')).show();
    } catch (err) {
        console.error('Error al ver equipo', err);
        alert('Error al cargar los detalles del equipo.');
    }
}
</script>
{% endblock %}
</body>
</html>