<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestión de Equipos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin/gestion_usuarios/profesores.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin/gestion_inventario/equipos.css') }}">
</head>
<body>
{% extends "base.html" %}
{% block content %}

<header class="main-header">
    <a onclick="history.back()" class="btn btn-outline-secondary btn-sm border-0 me-3">
        <i class="fa-solid fa-arrow-left"></i>
    </a>
    <h1>Gestión Inventario</h1>
    <div class="header-icons">
        <i class="fa-solid fa-bell"></i>
        <i class="fa-solid fa-user"></i>
    </div>
</header>

<!-- TARJETAS RESUMEN -->
<main class="container-fluid p-4 py-3 m-3">
    <section class="row mb-3">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="summary-card">
                <i class="fa-solid fa-list"></i>
                <h3 class="h6 mb-0">Total equipos</h3>
                <p class="number mb-0" id="total-equipos">0</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="summary-card">
                <i class="fa-solid fa-thumbs-up"></i>
                <h3 class="h6 mb-0">Disponibles</h3>
                <p class="number mb-0" id="equipos-disponibles">0</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="summary-card">
                <i class="fa-solid fa-screwdriver-wrench"></i>
                <h3 class="h6 mb-0">Mantenimiento</h3>
                <p class="number mb-0" id="equipos-mantenimiento">0</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="summary-card">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <h3 class="h6 mb-0">Incidentes</h3>
                <p class="number mb-0" id="equipos-incidentes">0</p>
            </div>
        </div>
    </section>
</main>

<!-- TABLA PRINCIPAL + SALAS -->
<main class="row m-3">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-9 col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Equipos Registrados</h5>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-light btn-sm me-3" onclick="mostrarTodosLosEquipos()">Ver Todos</button>
                            <select id="registrosPorPagina" class="form-select form-select-sm w-auto">
                                <option value="5" selected>5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                            </select>
                            <a href="{{ url_for('admin.crear_equipo') }}">
                                <button type="button" class="btn btn-success-medium btn-sm me-3 ms-2" style="border-color: #28a745; background-color: #28a745;">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle text-center">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Equipo</th>
                                        <th>Estado</th>
                                        <th>Sede</th>
                                        <th>Sala</th>
                                        <th>Asignado a</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaEquiposGlobal"></tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <button id="btnAnterior" class="btn btn-outline-secondary btn-sm">‹ Anterior</button>
                            <span id="paginaActual">Página 1</span>
                            <button id="btnSiguiente" class="btn btn-outline-secondary btn-sm">Siguiente ›</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN SALAS - ACTUALIZADA PARA PESTAÑAS DINÁMICAS -->
            <div class="col-md-3 col-12">
                <div class="card shadow-sm salas-card">
                    <div class="card-header">
                        <!-- Pestañas dinámicas - se crean automáticamente -->
                        <ul class="nav nav-tabs card-header-tabs">
                            <!-- Las pestañas se llenarán dinámicamente con JavaScript -->
                        </ul>
                    </div>
                    <div class="card-body p-2">
                        <div id="contenedorSede">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover align-middle text-center">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID</th>
                                            <th>Sala</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaSalas"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Modal Editar Equipo -->
<div class="modal fade" id="editarEquipoModal" tabindex="-1" aria-labelledby="editarEquipoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="editarEquipoForm">
        <div class="modal-header">
          <h5 class="modal-title" id="editarEquipoModalLabel">Editar Equipo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <!-- ID oculto -->
          <input type="hidden" id="equipoId" name="id">
          <!-- Campos ocultos para valores no editables -->
          <input type="hidden" id="nombreEquipoHidden" name="nombre">
          <input type="hidden" id="idReferenciaHidden" name="id_referencia">
          <input type="hidden" id="tipoEquipoHidden" name="tipo">

          <div class="row g-3">
            <!-- Primera fila -->
            <div class="col-md-6">
              <label for="idReferencia" class="form-label">ID/Referencia</label>
              <input type="text" class="form-control" id="idReferencia" readonly style="background-color: #f8f9fa;">
            </div>
            <div class="col-md-6">
              <label for="usuarioAsignado" class="form-label">Usuario asignado</label>
              <input type="text" class="form-control" id="usuarioAsignado" name="asignado_a">
            </div>
            
            <!-- Segunda fila -->
            <div class="col-md-6">
              <label for="nombreEquipo" class="form-label">Nombre del equipo</label>
              <input type="text" class="form-control" id="nombreEquipo" readonly style="background-color: #f8f9fa;">
            </div>
            <div class="col-md-6">
              <label for="estadoEquipo" class="form-label">Estado del equipo</label>
              <select class="form-select" id="estadoEquipo" name="estado" required>
                <option value="">Seleccionar estado</option>
                <option value="Disponible">Disponible</option>
                <option value="Mantenimiento">Mantenimiento</option>
                <option value="Asignado">Asignado</option>
                <option value="Incidente">Incidente</option>
                <option value="Revisión">Revisión</option>
              </select>
            </div>
            
            <!-- Tercera fila -->
            <div class="col-md-6">
              <label for="tipoEquipo" class="form-label">Tipo de equipo</label>
              <input type="text" class="form-control" id="tipoEquipo" readonly style="background-color: #f8f9fa;">
            </div>
            <div class="col-md-6">
              <label for="salaEquipo" class="form-label">Sala</label>
              <input type="text" class="form-control" id="salaEquipoTexto" readonly style="background-color: #f8f9fa;">
              <input type="hidden" id="salaEquipo" name="id_salon_fk">
            </div>
          </div>

          <!-- Especificaciones Técnicas -->
          <h6 class="mt-4 mb-3">Especificaciones Técnicas</h6>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="sistemaOperativo" class="form-label">Sistema operativo</label>
              <input type="text" class="form-control" id="sistemaOperativo" name="sistema_operativo">
            </div>
            <div class="col-md-6">
              <label for="ramEquipo" class="form-label">RAM</label>
              <input type="text" class="form-control" id="ramEquipo" name="ram">
            </div>
            <div class="col-md-6">
              <label for="discoDuro" class="form-label">Disco duro</label>
              <input type="text" class="form-control" id="discoDuro" name="disco_duro">
            </div>
            <div class="col-md-6">
              <label for="fechaAdquisicion" class="form-label">Fecha de adquisición</label>
              <input type="date" class="form-control" id="fechaAdquisicion" name="fecha_adquisicion">
            </div>
            <div class="col-12">
              <label for="descripcionEquipo" class="form-label">Descripción</label>
              <textarea class="form-control" id="descripcionEquipo" name="descripcion" rows="2"></textarea>
            </div>
            <div class="col-12">
              <label for="observacionesEquipo" class="form-label">Observaciones</label>
              <textarea class="form-control" id="observacionesEquipo" name="observaciones" rows="2"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL VER DETALLES -->
<div class="modal fade" id="verEquipoModal" tabindex="-1" aria-labelledby="verEquipoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Equipo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Columna izquierda -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <strong>ID/Referencia:</strong> <span id="detalle-id-referencia">-</span>
                        </div>
                        <div class="mb-3">
                            <strong>Nombre del equipo:</strong> <span id="detalle-nombre">-</span>
                        </div>
                        <div class="mb-3">
                            <strong>Tipo de equipo:</strong> <span id="detalle-tipo">-</span>
                        </div>
                        
                        <h6 class="mt-4 mb-3">Especificaciones Técnicas</h6>
                        <div class="mb-3">
                            <strong>Sistema Operativo:</strong> <span id="detalle-so">-</span>
                        </div>
                        <div class="mb-3">
                            <strong>RAM:</strong> <span id="detalle-ram">-</span>
                        </div>
                        <div class="mb-3">
                            <strong>Disco Duro:</strong> <span id="detalle-disco">-</span>
                        </div>
                        <div class="mb-3">
                            <strong>Fecha de adquisición:</strong> <span id="detalle-fecha">-</span>
                        </div>
                        <div class="mb-3">
                            <strong>Descripción:</strong> <span id="detalle-descripcion">-</span>
                        </div>
                        <div class="mb-3">
                            <strong>Observaciones:</strong> <span id="detalle-observaciones">-</span>
                        </div>
                    </div>
                    
                    <!-- Columna derecha -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <strong>Usuario asignado:</strong> <span id="detalle-usuario">-</span>
                        </div>
                        <div class="mb-3">
                            <strong>Estado del equipo:</strong> 
                            <span id="detalle-estado-badge" class="badge">-</span>
                        </div>
                        <div class="mb-3">
                            <strong>Sala:</strong> <span id="detalle-sala">-</span>
                        </div>
                        
                        <h6 class="mt-4 mb-3">Historial de incidentes</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Descripción</th>
                                    </tr>
                                </thead>
                                <tbody id="detalle-incidentes">
                                    <!-- Historial cargado dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                        
                        <h6 class="mt-4 mb-3">Historial de mantenimientos</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Tipo</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="detalle-mantenimientos">
                                    <!-- Historial cargado dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // CÓDIGO JAVASCRIPT COMPLETO ACTUALIZADO PARA PESTAÑAS DINÁMICAS
    let sedesGlobal = [];
    let equiposGlobal = [];
    let paginaActual = 1;
    let registrosPorPagina = 5;
    let salasDisponibles = [];

    // Cargar salas para el select en el modal
    async function cargarSalas() {
        try {
            const res = await fetch('/admin/api/salas_todas');
            const salas = await res.json();
            salasDisponibles = salas.map(sala => ({
                id: sala.id,
                nombre: sala.nombre,
                sede_nombre: sala.sede_nombre || 'Desconocida'
            }));
        } catch (error) {
            console.error('Error cargando salas:', error);
        }
    }

    // NUEVA: Función para crear dinámicamente pestañas para sedes
    function crearTabsSedes(sedes) {
        const tabsContainer = document.querySelector('.nav.nav-tabs.card-header-tabs');
        
        // Limpiar pestañas existentes
        tabsContainer.innerHTML = '';
        
        // Crear una pestaña para cada sede
        sedes.forEach((sede, index) => {
            const tabItem = document.createElement('li');
            tabItem.className = 'nav-item';
            
            const tabLink = document.createElement('a');
            tabLink.className = `nav-link ${index === 0 ? 'active' : ''}`;
            tabLink.id = `tab-sede${sede.id}`;
            tabLink.href = '#';
            tabLink.textContent = sede.nombre;
            tabLink.onclick = () => mostrarSede(sede.id);
            
            tabItem.appendChild(tabLink);
            tabsContainer.appendChild(tabItem);
        });
    }

    // ACTUALIZADA: Función cargarSedes modificada
    async function cargarSedes() {
        try {
            const res = await fetch('/admin/api/sedes');
            const sedes = await res.json();
            sedesGlobal = sedes;
            
            // NUEVA: Crear pestañas dinámicamente en lugar de codificarlas
            crearTabsSedes(sedes);
            
            // Cargar salas después de sedes
            await cargarSalas();
            
            // Mostrar primera sede por defecto si existe alguna
            if (sedes.length > 0) {
                mostrarSede(sedes[0].id);
            }
            
            mostrarTodosLosEquipos();
        } catch (error) {
            console.error('Error cargando sedes:', error);
        }
    }

    // ACTUALIZADA: Función mostrarSede modificada para manejar pestañas dinámicas
    async function mostrarSede(sedeId) {
        // Remover clase activa de todas las pestañas
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        
        // Agregar clase activa a la pestaña seleccionada
        const tab = document.getElementById(`tab-sede${sedeId}`);
        if (tab) tab.classList.add('active');

        const tbodySalas = document.getElementById('tablaSalas');
        tbodySalas.innerHTML = '';

        try {
            const res = await fetch(`/admin/api/sedes/${sedeId}/salas`);
            const salones = await res.json();
            salones.forEach((salon, index) => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.onclick = () => mostrarEquiposDeSala(sedeId, salon.id);
                row.innerHTML = `<td>${index + 1}</td><td>${salon.nombre}</td>`;
                tbodySalas.appendChild(row);
            });
        } catch (error) {
            console.error('Error cargando salones:', error);
        }
    }

    // NUEVA: Función para refrescar pestañas cuando se agrega una nueva sede
    async function refrescarTabsSedes() {
        await cargarSedes();
    }

    // FUNCIÓN PARA INTEGRAR CON CREACIÓN DE SEDES
    async function onSedeCreada() {
        // Si estás en la página de equipos, refrescar las pestañas
        if (typeof refrescarTabsSedes === 'function') {
            await refrescarTabsSedes();
        }
    }

    async function mostrarEquiposDeSala(sedeId, salonId) {
        equiposGlobal = [];
        paginaActual = 1;
        try {
            const res = await fetch(`/admin/api/sedes/${sedeId}/salas/${salonId}/equipos`);
            const equipos = await res.json();

            const sede = sedesGlobal.find(s => s.id === sedeId);
            const resSalas = await fetch(`/admin/api/sedes/${sedeId}/salas`);
            const salas = await resSalas.json();
            const sala = salas.find(s => s.id === salonId);

            equipos.forEach(eq => {
                equiposGlobal.push({
                    ...eq,
                    sede: sede ? sede.nombre : 'Desconocida',
                    sala: sala ? sala.nombre : 'Desconocida'
                });
            });

            actualizarResumen(equiposGlobal);
            renderizarTabla();
        } catch (error) {
            console.error('Error cargando equipos:', error);
        }
    }

    async function mostrarTodosLosEquipos() {
        equiposGlobal = [];
        paginaActual = 1;
        try {
            for (const sede of sedesGlobal) {
                const resSalas = await fetch(`/admin/api/sedes/${sede.id}/salas`);
                const salas = await resSalas.json();
                for (const sala of salas) {
                    const resEquipos = await fetch(`/admin/api/sedes/${sede.id}/salas/${sala.id}/equipos`);
                    const equipos = await resEquipos.json();
                    equipos.forEach(eq => {
                        equiposGlobal.push({
                            ...eq,
                            sede: sede.nombre,
                            sala: sala.nombre
                        });
                    });
                }
            }
            actualizarResumen(equiposGlobal);
            renderizarTabla();
        } catch (error) {
            console.error('Error cargando todos los equipos:', error);
        }
    }

    function renderizarTabla() {
        const tbody = document.getElementById('tablaEquiposGlobal');
        tbody.innerHTML = '';

        const inicio = (paginaActual - 1) * registrosPorPagina;
        const fin = inicio + registrosPorPagina;
        const equiposPagina = equiposGlobal.slice(inicio, fin);

        equiposPagina.forEach(eq => {
            let estadoBadge = '';
            if (eq.estado === 'Disponible') estadoBadge = `<span class="badge text-bg-primary">Disponible</span>`;
            else if (eq.estado === 'Asignado') estadoBadge = `<span class="badge text-bg-secondary">Asignado</span>`;
            else if (eq.estado === 'Mantenimiento') estadoBadge = `<span class="badge text-bg-warning">Mantenimiento</span>`;
            else if (eq.estado === 'Incidente') estadoBadge = `<span class="badge text-bg-danger">Incidente</span>`;
            else if (eq.estado === 'Revisión') estadoBadge = `<span class="badge text-bg-info">Revisión</span>`;
            else estadoBadge = `<span class="badge text-bg-light">${eq.estado || 'Desconocido'}</span>`;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${eq.nombre || '-'}</td>
                <td>${estadoBadge}</td>
                <td>${eq.sede || '-'}</td>
                <td>${eq.sala || '-'}</td>
                <td>${eq.asignado_a || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-info me-2" onclick="verEquipo(${eq.id})">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-warning me-2" onclick="editarEquipo(${eq.id})">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="eliminarEquipo(${eq.id})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('paginaActual').textContent = `Página ${paginaActual}`;
        document.getElementById('btnAnterior').disabled = paginaActual === 1;
        document.getElementById('btnSiguiente').disabled = fin >= equiposGlobal.length;
    }

    // Paginación
    document.getElementById('btnAnterior').addEventListener('click', () => {
        if (paginaActual > 1) {
            paginaActual--;
            renderizarTabla();
        }
    });

    document.getElementById('btnSiguiente').addEventListener('click', () => {
        if (paginaActual * registrosPorPagina < equiposGlobal.length) {
            paginaActual++;
            renderizarTabla();
        }
    });

    document.getElementById('registrosPorPagina').addEventListener('change', (e) => {
        registrosPorPagina = parseInt(e.target.value);
        paginaActual = 1;
        renderizarTabla();
    });

    function actualizarResumen(equipos) {
        const total = equipos.length;
        const disponibles = equipos.filter(e => e.estado === 'Disponible').length;
        const mantenimiento = equipos.filter(e => e.estado === 'Mantenimiento').length;
        const incidentes = equipos.filter(e => e.estado === 'Incidente').length;

        document.getElementById('total-equipos').textContent = total;
        document.getElementById('equipos-disponibles').textContent = disponibles;
        document.getElementById('equipos-mantenimiento').textContent = mantenimiento;
        document.getElementById('equipos-incidentes').textContent = incidentes;
    }

    // Función para editar equipo - MEJORADA
async function editarEquipo(id) {
    try {
        const res = await fetch(`/admin/api/equipos/${id}`);
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        const equipo = await res.json();

        // Llenar el formulario del modal con los datos del equipo
        document.getElementById('equipoId').value = equipo.id || '';
        document.getElementById('idReferencia').value = equipo.id_referencia || '';
        document.getElementById('nombreEquipo').value = equipo.nombre || '';
        document.getElementById('tipoEquipo').value = equipo.tipo || '';
        document.getElementById('usuarioAsignado').value = equipo.asignado_a || '';
        document.getElementById('estadoEquipo').value = equipo.estado || '';
        document.getElementById('salaEquipoTexto').value = equipo.salon_nombre || '';
        document.getElementById('salaEquipo').value = equipo.id_salon_fk || '';

        // Campos ocultos para valores no editables
        document.getElementById('nombreEquipoHidden').value = equipo.nombre || '';
        document.getElementById('idReferenciaHidden').value = equipo.id_referencia || '';
        document.getElementById('tipoEquipoHidden').value = equipo.tipo || '';

        // Especificaciones técnicas
        document.getElementById('sistemaOperativo').value = equipo.sistema_operativo || '';
        document.getElementById('ramEquipo').value = equipo.ram || '';
        document.getElementById('discoDuro').value = equipo.disco_duro || '';
        document.getElementById('fechaAdquisicion').value = equipo.fecha_adquisicion || '';
        document.getElementById('descripcionEquipo').value = equipo.descripcion || '';
        document.getElementById('observacionesEquipo').value = equipo.observaciones || '';

        new bootstrap.Modal(document.getElementById('editarEquipoModal')).show();
    } catch (err) {
        console.error('Error al editar equipo', err);
        alert('Error al cargar los datos del equipo para edición.');
    }
}

// Manejar el envío del formulario de edición - MEJORADO
document.getElementById('editarEquipoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('equipoId').value;
    
    // Preparar datos para enviar
    const data = {
        asignado_a: document.getElementById('usuarioAsignado').value,
        estado: document.getElementById('estadoEquipo').value,
        sistema_operativo: document.getElementById('sistemaOperativo').value,
        ram: document.getElementById('ramEquipo').value,
        disco_duro: document.getElementById('discoDuro').value,
        fecha_adquisicion: document.getElementById('fechaAdquisicion').value,
        descripcion: document.getElementById('descripcionEquipo').value,
        observaciones: document.getElementById('observacionesEquipo').value
    };

    // Solo incluir id_salon_fk si tiene valor
    const salonId = document.getElementById('salaEquipo').value;
    if (salonId) {
        data.id_salon_fk = parseInt(salonId);
    }

    try {
        const res = await fetch(`/admin/api/equipos/${id}`, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        });

        const responseData = await res.json();

        if (res.ok) {
            alert(responseData.message || 'Equipo actualizado con éxito.');
            bootstrap.Modal.getInstance(document.getElementById('editarEquipoModal')).hide();
            
            // Recargar la tabla
            await mostrarTodosLosEquipos();
        } else {
            alert(`Error al actualizar el equipo: ${responseData.error || 'Error desconocido'}`);
        }
    } catch (err) {
        console.error('Error al actualizar equipo', err);
        alert('Error de conexión al actualizar el equipo.');
    }
});

// Función para eliminar equipo - MEJORADA
async function eliminarEquipo(id) {
    // Buscar el equipo para mostrar su nombre en la confirmación
    const equipo = equiposGlobal.find(e => e.id === id);
    const nombreEquipo = equipo ? equipo.nombre : 'este equipo';
    
    if (!confirm(`¿Estás seguro de que deseas eliminar "${nombreEquipo}"? Esta acción no se puede deshacer.`)) {
        return;
    }
    
    try {
        const res = await fetch(`/admin/api/equipos/${id}`, { 
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const responseData = await res.json();
        
        if (res.ok) {
            alert(responseData.message || 'Equipo eliminado con éxito.');
            
            // Recargar la tabla
            await mostrarTodosLosEquipos();
        } else {
            alert(`Error al eliminar el equipo: ${responseData.error || 'Error desconocido'}`);
        }
    } catch (err) {
        console.error('Error al eliminar equipo', err);
        alert('Error de conexión al eliminar el equipo.');
    }
}

// Función para ver detalles del equipo - MEJORADA
async function verEquipo(id) {
    try {
        const res = await fetch(`/admin/api/equipos/${id}`);
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        const equipo = await res.json();

        // Llenar información básica en el modal de detalles
        document.getElementById('detalle-id-referencia').textContent = equipo.id_referencia || '-';
        document.getElementById('detalle-nombre').textContent = equipo.nombre || '-';
        document.getElementById('detalle-tipo').textContent = equipo.tipo || '-';
        document.getElementById('detalle-usuario').textContent = equipo.asignado_a || '-';
        document.getElementById('detalle-sala').textContent = equipo.salon_nombre || '-';

        // Estado con badge
        const estadoBadge = document.getElementById('detalle-estado-badge');
        estadoBadge.textContent = equipo.estado || 'Desconocido';
        estadoBadge.className = 'badge ';
        if (equipo.estado === 'Disponible') estadoBadge.className += 'text-bg-primary';
        else if (equipo.estado === 'Asignado') estadoBadge.className += 'text-bg-secondary';
        else if (equipo.estado === 'Mantenimiento') estadoBadge.className += 'text-bg-warning';
        else if (equipo.estado === 'Incidente') estadoBadge.className += 'text-bg-danger';
        else if (equipo.estado === 'Revisión') estadoBadge.className += 'text-bg-info';
        else estadoBadge.className += 'text-bg-light';

        // Especificaciones técnicas
        document.getElementById('detalle-so').textContent = equipo.sistema_operativo || '-';
        document.getElementById('detalle-ram').textContent = equipo.ram || '-';
        document.getElementById('detalle-disco').textContent = equipo.disco_duro || '-';
        document.getElementById('detalle-fecha').textContent = equipo.fecha_adquisicion || '-';
        document.getElementById('detalle-descripcion').textContent = equipo.descripcion || '-';
        document.getElementById('detalle-observaciones').textContent = equipo.observaciones || '-';

        // Cargar historial de incidentes (usando datos reales si están disponibles)
        const incidentesTable = document.getElementById('detalle-incidentes');
        if (equipo.incidentes && equipo.incidentes.length > 0) {
            incidentesTable.innerHTML = equipo.incidentes.map(inc => `
                <tr>
                    <td>${inc.fecha}</td>
                    <td>${inc.descripcion}</td>
                </tr>
            `).join('');
        } else {
            incidentesTable.innerHTML = '<tr><td colspan="2" class="text-muted">Sin incidentes registrados</td></tr>';
        }

        // Cargar historial de mantenimientos (usando datos reales si están disponibles)
        const mantenimientosTable = document.getElementById('detalle-mantenimientos');
        if (equipo.mantenimientos && equipo.mantenimientos.length > 0) {
            mantenimientosTable.innerHTML = equipo.mantenimientos.map(mant => `
                <tr>
                    <td>${mant.fecha}</td>
                    <td>${mant.tipo}</td>
                    <td>${mant.estado}</td>
                </tr>
            `).join('');
        } else {
            mantenimientosTable.innerHTML = '<tr><td colspan="3" class="text-muted">Sin mantenimientos registrados</td></tr>';
        }

        new bootstrap.Modal(document.getElementById('verEquipoModal')).show();
    } catch (err) {
        console.error('Error al ver equipo', err);
        alert('Error al cargar los detalles del equipo.');
    }
}
    // Cargar sedes al iniciar
    window.onload = cargarSedes;
</script>
{% endblock %}
</body>
</html>