<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Horarios de Cursos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin/GHC.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-calendar-alt"></i>
                <h1>Gesti√≥n de Horarios de Cursos</h1>
            </div>
            <a href="{{ url_for('admin.gestion_horarios') }}" class="btn">
                <i class="fas fa-arrow-left"></i> Volver a Horarios Generales
            </a>
        </header>
        
        <div class="dashboard">
            <div class="stat-card">
                <h2><i class="fas fa-book"></i> Materias Disponibles</h2>
                <div class="stat" id="total-materias">0</div>
            </div>
            
            <div class="stat-card">
                <h2><i class="fas fa-users"></i> Cursos Activos</h2>
                <div class="stat" id="total-cursos">0</div>
            </div>
            
            <div class="stat-card">
                <h2><i class="fas fa-clock"></i> Horarios Asignados</h2>
                <div class="stat" id="horarios-asignados">0</div>
            </div>
            
            <div class="stat-card">
                <h2><i class="fas fa-share-alt"></i> Compartir</h2>
                <button class="small" onclick="mostrarModalCompartir()"><i class="fas fa-share"></i> Compartir Horario</button>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-calendar-alt"></i> Seleccionar Curso</h2>
            <div class="form-group">
                <label>Curso</label>
                <select id="course-select">
                    <option value="">Cargando cursos...</option>
                </select>
            </div>
            
            <button onclick="loadCourseSchedule()"><i class="fas fa-search"></i> Mostrar Horario</button>
        </div>
        
        <div class="table-container">
            <h2 class="table-title"><i class="fas fa-table"></i> Horario del Curso: <span id="current-course-name">No seleccionado</span></h2>
            <div id="course-schedule-table-container">
                <p style="text-align: center; padding: 20px; color: #666;">Seleccione un curso para ver su horario</p>
            </div>
        </div>
        
        <div class="course-management">
            <h2><i class="fas fa-tasks"></i> Gesti√≥n de Materias</h2>
            
            <div class="form-group">
                <label>Materias Disponibles</label>
                <div class="courses-list" id="subjects-list">
                    <p style="text-align: center; color: #666; padding: 20px;">Cargando materias...</p>
                </div>
            </div>
            
            <div class="schedule-actions">
                <button class="secondary" onclick="saveCourseSchedule()"><i class="fas fa-save"></i> Guardar Horario</button>
                <button class="secondary" onclick="clearCourseSchedule()"><i class="fas fa-broom"></i> Limpiar Horario</button>
                <button class="danger" onclick="resetCourseSchedule()"><i class="fas fa-undo"></i> Restablecer Horario</button>
            </div>
        </div>
    </div>

    <!-- Modal de carga -->
    <div class="modal" id="loading-modal">
        <div class="modal-content">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin fa-3x"></i>
            </div>
            <p style="margin-top: 20px; font-size: 16px;" id="loading-message">Cargando...</p>
        </div>
    </div>

    <!-- Modal para compartir -->
    <div class="modal" id="share-modal">
        <div class="modal-content share-modal">
            <div class="modal-header">
                <h2><i class="fas fa-share-alt"></i> Compartir Horario</h2>
                <button class="close-modal" onclick="cerrarModalCompartir()">&times;</button>
            </div>
            <div class="share-modal-content">
                <p>Seleccione con qui√©n desea compartir el horario:</p>
                
                <div class="share-options">
                    <div class="share-option" onclick="seleccionarDestinatario('profesores', event)">                        <i class="fas fa-user-graduate fa-2x"></i>
                        <h3>Estudiantes</h3>
                        <p>Compartir con todos los estudiantes del curso</p>
                    </div>
                    <div class="share-option" onclick="seleccionarDestinatario('profesores')">
                        <i class="fas fa-chalkboard-teacher fa-2x"></i>
                        <h3>Profesores</h3>
                        <p>Compartir con los profesores asignados</p>
                    </div>
                </div>
                
                <div id="share-details" style="display: none; margin-top: 20px; padding: 15px; background: var(--light-gray); border-radius: 8px;">
                    <h4 id="share-title">Detalles del Compartir</h4>
                    <p id="share-description">Se compartir√° el horario con los destinatarios seleccionados.</p>
                </div>
                
                <button onclick="confirmarCompartir()" style="margin-top: 20px; width: 100%;">
                    <i class="fas fa-paper-plane"></i> Compartir Horario
                </button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text">Operaci√≥n realizada con √©xito</span>
    </div>

    <script>
        // =============================================
        // CONFIGURACI√ìN Y VARIABLES GLOBALES
        // =============================================
        const API_URLS = {
            cursos: '/admin/api/cursos',
            horarios: '/admin/api/horarios',
            asignaturas: '/admin/api/asignaturas',
            profesores: '/admin/api/profesores',
            salones: '/admin/api/salones',
            horarioCurso: '/admin/api/horario_curso/cargar',
            guardarHorarioCurso: '/admin/api/horario_curso/guardar',
            compartirHorario: '/admin/api/horario_curso/compartir',
            estadisticas: '/admin/api/estadisticas/horarios-cursos'
        };

        // Estado de la aplicaci√≥n
        let estado = {
            cursos: [],
            horarios: [],
            asignaturas: [],
            profesores: [],
            salones: [],
            cursoSeleccionado: null,
            horarioSeleccionado: null,
            bloquesHorario: [],
            asignaciones: {},
            salonesAsignaciones: {},
            estadisticas: {
                total_materias: 0,
                total_cursos: 0,
                horarios_asignados: 0
            },
            destinatarioCompartir: null
        };

        // =============================================
        // FUNCIONES DE UTILIDAD
        // =============================================

        function mostrarLoading(mensaje = 'Cargando...') {
            document.getElementById('loading-message').textContent = mensaje;
            document.getElementById('loading-modal').style.display = 'flex';
        }

        function ocultarLoading() {
            document.getElementById('loading-modal').style.display = 'none';
        }

        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            const icon = notification.querySelector('i');
            
            // Configurar icono seg√∫n el tipo
            if (tipo === 'error') {
                icon.className = 'fas fa-exclamation-circle';
            } else if (tipo === 'warning') {
                icon.className = 'fas fa-exclamation-triangle';
            } else {
                icon.className = 'fas fa-check-circle';
            }
            
            notificationText.textContent = mensaje;
            notification.className = `notification ${tipo} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // =============================================
        // FUNCIONES DE COMUNICACI√ìN CON LA API
        // =============================================

        async function apiRequest(url, options = {}) {
            console.log('üîó API Request:', url, options.method || 'GET');
            
            try {
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    ...options
                };

                if (config.body) {
                    config.body = JSON.stringify(config.body);
                }

                const response = await fetch(url, config);
                console.log('üì• API Response:', response.status);
                
                if (!response.ok) {
                    let errorMessage = `Error ${response.status}`;
                    
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || errorMessage;
                    } catch (e) {
                        const text = await response.text();
                        if (text) errorMessage += ` - ${text.substring(0, 200)}`;
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('‚úÖ API Success:', data);
                return data;
                
            } catch (error) {
                console.error('‚ùå API Error:', error);
                throw error;
            }
        }

        // =============================================
        // FUNCIONES DE CARGA DE DATOS
        // =============================================

        async function cargarDatosIniciales() {
            mostrarLoading('Cargando datos del sistema...');
            
            try {
                // Cargar todos los datos en paralelo
                const [cursosData, horariosData, asignaturasData, salonesData, estadisticasData] = await Promise.allSettled([
                    apiRequest(API_URLS.cursos),
                    apiRequest(API_URLS.horarios),
                    apiRequest(API_URLS.asignaturas),
                    apiRequest(API_URLS.salones),
                    apiRequest(API_URLS.estadisticas)
                ]);

                // Procesar cursos
                if (cursosData.status === 'fulfilled') {
                    estado.cursos = cursosData.value.data || cursosData.value || [];
                } else {
                    console.error('Error cargando cursos:', cursosData.reason);
                    estado.cursos = [];
                }

                // Procesar horarios
                if (horariosData.status === 'fulfilled') {
                    estado.horarios = horariosData.value || [];
                } else {
                    console.error('Error cargando horarios:', horariosData.reason);
                    estado.horarios = [];
                }

                // Procesar asignaturas
                if (asignaturasData.status === 'fulfilled') {
                    estado.asignaturas = Array.isArray(asignaturasData.value) ? asignaturasData.value : [];
                    console.log('üìö Asignaturas cargadas con profesores:', estado.asignaturas);
                } else {
                    console.error('Error cargando asignaturas:', asignaturasData.reason);
                    estado.asignaturas = [];
                }

                // Procesar salones
                if (salonesData.status === 'fulfilled') {
                    estado.salones = Array.isArray(salonesData.value) ? salonesData.value : [];
                    console.log('üè´ Salones cargados:', estado.salones);
                } else {
                    console.error('Error cargando salones:', salonesData.reason);
                    estado.salones = [];
                }

                // Procesar estad√≠sticas
                if (estadisticasData.status === 'fulfilled') {
                    estado.estadisticas = estadisticasData.value;
                } else {
                    console.error('Error cargando estad√≠sticas:', estadisticasData.reason);
                    // Calcular estad√≠sticas b√°sicas desde los datos cargados
                    estado.estadisticas = {
                        total_materias: estado.asignaturas.length,
                        total_cursos: estado.cursos.length,
                        horarios_asignados: estado.cursos.filter(c => c.horario_general_id).length
                    };
                }

                actualizarEstadisticas();
                actualizarSelectCursos();
                actualizarListaMaterias();

                console.log('‚úÖ Datos cargados correctamente');
                mostrarNotificacion('Sistema cargado correctamente', 'success');

            } catch (error) {
                console.error('‚ùå Error cargando datos iniciales:', error);
                mostrarNotificacion('Error al cargar los datos del sistema', 'error');
            } finally {
                ocultarLoading();
            }
        }

       async function cargarHorarioCurso(cursoId) {
    mostrarLoading('Cargando horario del curso...');
    
    try {
        // Cargar informaci√≥n actualizada del curso
        const cursoData = await apiRequest(`${API_URLS.cursos}/${cursoId}`);
        if (cursoData) {
            estado.cursoSeleccionado = cursoData;
            console.log('üìã Curso actualizado:', cursoData);
        }

        // Cargar horario espec√≠fico del curso
        const horarioData = await apiRequest(`${API_URLS.horarioCurso}/${cursoId}`);
        console.log('üìä Datos del horario recibidos:', horarioData);
        
        // Reiniciar asignaciones
        estado.asignaciones = {};
        estado.salonesAsignaciones = {};
        
        // Procesar asignaciones si existen
        if (horarioData && horarioData.asignaciones) {
            // Convertir todas las claves a n√∫meros si es necesario
            Object.keys(horarioData.asignaciones).forEach(key => {
                const valor = horarioData.asignaciones[key];
                estado.asignaciones[key] = typeof valor === 'string' ? parseInt(valor) : valor;
            });
            console.log('üìö Asignaciones cargadas:', estado.asignaciones);
        }

        // Procesar salones si existen
        if (horarioData && horarioData.salones_asignaciones) {
            Object.keys(horarioData.salones_asignaciones).forEach(key => {
                const valor = horarioData.salones_asignaciones[key];
                estado.salonesAsignaciones[key] = typeof valor === 'string' ? parseInt(valor) : valor;
            });
            console.log('üè´ Salones cargados:', estado.salonesAsignaciones);
        }
        
        // Cargar bloques del horario
        if (horarioData && horarioData.bloques_horario) {
            estado.bloquesHorario = horarioData.bloques_horario;
            estado.horarioSeleccionado = {
                id: horarioData.horario_general_id,
                nombre: 'Horario del curso'
            };
            console.log('üïí Bloques cargados desde API:', estado.bloquesHorario.length);
        } else if (horarioData && horarioData.horario_general_id) {
            // Si no vienen los bloques, cargarlos por separado
            await cargarHorarioBase(horarioData.horario_general_id);
        } else {
            console.warn('‚ö†Ô∏è No se encontraron bloques de horario');
        }
        
        return horarioData;
    } catch (error) {
        console.error('‚ùå Error cargando horario del curso:', error);
        // Reiniciar asignaciones en caso de error
        estado.asignaciones = {};
        estado.salonesAsignaciones = {};
        return { asignaciones: {}, salones_asignaciones: {} };
    } finally {
        ocultarLoading();
    }
}
        async function cargarHorarioBase(horarioId) {
            try {
                const horarioData = await apiRequest(`${API_URLS.horarios}/${horarioId}`);
                
                if (horarioData && horarioData.bloques) {
                    estado.bloquesHorario = horarioData.bloques;
                    return horarioData;
                } else {
                    throw new Error('Estructura de horario inv√°lida');
                }
            } catch (error) {
                console.error('‚ùå Error cargando horario base:', error);
                throw error;
            }
        }

        async function guardarHorarioCurso() {
            if (!estado.cursoSeleccionado) {
                mostrarNotificacion('Seleccione un curso primero', 'error');
                return false;
            }

            mostrarLoading('Guardando horario del curso...');
            
            try {
                const datos = {
                    curso_id: estado.cursoSeleccionado.id,
                    horario_general_id: estado.horarioSeleccionado?.id,
                    asignaciones: estado.asignaciones,
                    salones_asignaciones: estado.salonesAsignaciones
                };

                const resultado = await apiRequest(API_URLS.guardarHorarioCurso, {
                    method: 'POST',
                    body: datos
                });

                if (resultado.success) {
                    mostrarNotificacion('Horario del curso guardado correctamente', 'success');
                    return true;
                } else {
                    throw new Error(resultado.error || 'Error desconocido al guardar');
                }
            } catch (error) {
                console.error('‚ùå Error guardando horario:', error);
                mostrarNotificacion(`Error al guardar: ${error.message}`, 'error');
                return false;
            } finally {
                ocultarLoading();
            }
        }

        async function compartirHorario() {
            if (!estado.cursoSeleccionado) {
                mostrarNotificacion('Seleccione un curso primero', 'error');
                return false;
            }

            if (!estado.destinatarioCompartir) {
                mostrarNotificacion('Seleccione un destinatario', 'error');
                return false;
            }

            mostrarLoading('Compartiendo horario...');
            
            try {
                const datos = {
                    curso_id: estado.cursoSeleccionado.id,
                    destinatario: estado.destinatarioCompartir,
                    horario_general_id: estado.horarioSeleccionado?.id,
                    asignaciones: estado.asignaciones,
                    salones_asignaciones: estado.salonesAsignaciones
                };

                const resultado = await apiRequest(API_URLS.compartirHorario, {
                    method: 'POST',
                    body: datos
                });

                if (resultado.success) {
                    mostrarNotificacion(`Horario compartido con ${estado.destinatarioCompartir} correctamente`, 'success');
                    cerrarModalCompartir();
                    return true;
                } else {
                    throw new Error(resultado.error || 'Error desconocido al compartir');
                }
            } catch (error) {
                console.error('‚ùå Error compartiendo horario:', error);
                mostrarNotificacion(`Error al compartir: ${error.message}`, 'error');
                return false;
            } finally {
                ocultarLoading();
            }
        }

        // =============================================
        // FUNCIONES DE LA INTERFAZ DE USUARIO
        // =============================================

        function actualizarEstadisticas() {
            document.getElementById('total-materias').textContent = estado.estadisticas.total_materias || 0;
            document.getElementById('total-cursos').textContent = estado.estadisticas.total_cursos || 0;
            document.getElementById('horarios-asignados').textContent = estado.estadisticas.horarios_asignados || 0;
        }

        function actualizarSelectCursos() {
            const select = document.getElementById('course-select');
            
            if (estado.cursos.length === 0) {
                select.innerHTML = '<option value="">No hay cursos disponibles</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Seleccione un curso</option>' +
                estado.cursos.map(curso => {
                    const nombre = curso.nombreCurso || curso.nombre || 'Curso sin nombre';
                    const sede = curso.sede || (curso.sedeId ? `Sede ${curso.sedeId}` : '');
                    const horarioAsignado = curso.horario_general_id ? ' (Horario asignado)' : ' (Sin horario)';
                    return `<option value="${curso.id}">${nombre} ${sede ? '- ' + sede : ''}${horarioAsignado}</option>`;
                }).join('');
        }

        function actualizarListaMaterias() {
            const container = document.getElementById('subjects-list');
            
            if (estado.asignaturas.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay materias disponibles</p>';
                return;
            }
            
            container.innerHTML = estado.asignaturas.map(asignatura => {
                // Obtener lista de profesores
                const profesores = asignatura.profesores || [];
                const profesoresTexto = profesores.length > 0 
                    ? profesores.map(p => p.nombre_completo).join(', ')
                    : 'Sin profesores asignados';
                
                return `
                    <div class="course-item">
                        <div class="course-info">
                            <div class="course-name">${asignatura.nombre}</div>
                            <div class="course-teacher">
                                ${asignatura.descripcion || 'Sin descripci√≥n'}
                                ${profesores.length > 0 ? 
                                    `<div style="margin-top: 5px;">
                                        <strong>Profesores:</strong> 
                                        ${profesores.map(p => 
                                            `<span class="profesor-badge">${p.nombre_completo}</span>`
                                        ).join('')}
                                    </div>` : 
                                    ''
                                }
                            </div>
                        </div>
                        <div class="course-schedule">${profesores.length > 0 ? 'Con profesores' : 'Sin profesores'}</div>
                    </div>
                `;
            }).join('');
        }

        async function loadCourseSchedule() {
            const cursoId = document.getElementById('course-select').value;

            if (!cursoId) {
                mostrarNotificacion('Por favor seleccione un curso', 'error');
                return;
            }

            try {
                // Encontrar curso seleccionado
                estado.cursoSeleccionado = estado.cursos.find(c => c.id == cursoId);

                if (!estado.cursoSeleccionado) {
                    mostrarNotificacion('Error al cargar los datos del curso', 'error');
                    return;
                }

                document.getElementById('current-course-name').textContent = 
                    estado.cursoSeleccionado.nombreCurso || estado.cursoSeleccionado.nombre || 'Curso';

                // Cargar horario existente del curso
                await cargarHorarioCurso(cursoId);

                // Verificar si el curso tiene un horario general asignado
                if (!estado.horarioSeleccionado) {
                    mostrarNotificacion('Este curso no tiene un horario general asignado', 'warning');
                    document.getElementById('course-schedule-table-container').innerHTML = 
                        '<p style="text-align: center; padding: 20px; color: #666;">Este curso no tiene un horario general asignado. Asigne un horario en la gesti√≥n de horarios generales.</p>';
                    return;
                }

                // Generar tabla de horario
                generarTablaHorario();

                mostrarNotificacion(`Horario cargado para ${estado.cursoSeleccionado.nombreCurso}`, 'success');

            } catch (error) {
                console.error('‚ùå Error cargando horario del curso:', error);
                mostrarNotificacion('Error al cargar el horario del curso', 'error');
            }
        }

        function generarTablaHorario() {
            const container = document.getElementById('course-schedule-table-container');
            
            if (!estado.horarioSeleccionado || estado.bloquesHorario.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No hay horario disponible para mostrar</p>';
                return;
            }

            // Obtener d√≠as √∫nicos del horario
            const diasUnicos = [...new Set(estado.bloquesHorario.map(bloque => bloque.dia_semana))].sort();
            
            // Agrupar bloques por d√≠a
            const bloquesPorDia = {};
            diasUnicos.forEach(dia => {
                bloquesPorDia[dia] = estado.bloquesHorario
                    .filter(bloque => bloque.dia_semana === dia)
                    .sort((a, b) => a.horaInicio.localeCompare(b.horaInicio));
            });

            let tablaHTML = `
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            ${diasUnicos.map(dia => `<th>${dia}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Crear filas para cada bloque de tiempo √∫nico
            const todosLosBloques = estado.bloquesHorario.flat();
            const horasUnicas = [...new Set(todosLosBloques.map(bloque => bloque.horaInicio))].sort();

            horasUnicas.forEach(hora => {
                const bloquesEnEstaHora = estado.bloquesHorario.filter(bloque => bloque.horaInicio === hora);
                
                if (bloquesEnEstaHora.length > 0) {
                    const primerBloque = bloquesEnEstaHora[0];
                    tablaHTML += `
                        <tr>
                            <td class="time-cell">${primerBloque.horaInicio} - ${primerBloque.horaFin}</td>
                            ${diasUnicos.map(dia => {
                                const bloque = bloquesPorDia[dia]?.find(b => b.horaInicio === hora);
                                
                                if (!bloque) {
                                    return '<td class="empty-block"></td>';
                                }
                                
                                if (bloque.tipo === 'break') {
                                    let claseBreak = 'break-block';
                                    if (bloque.break_type === 'morning') claseBreak += ' morning-break';
                                    else if (bloque.break_type === 'lunch') claseBreak += ' lunch-break';
                                    else if (bloque.break_type === 'afternoon') claseBreak += ' afternoon-break';
                                    else claseBreak += ' custom-break';
                                    
                                    return `<td class="${claseBreak}">${bloque.nombre || 'Descanso'}</td>`;
                                } else {
                                    const asignacionKey = `${dia}-${bloque.horaInicio}`;
                                    const asignaturaId = estado.asignaciones[asignacionKey];
                                    const salonId = estado.salonesAsignaciones[asignacionKey];
                                    const asignatura = estado.asignaturas.find(a => a.id == asignaturaId);
                                    const salon = estado.salones.find(s => s.id == salonId);
                                    
                                    // Obtener profesores de la asignatura
                                    const profesores = asignatura?.profesores || [];
                                    const profesoresTexto = profesores.length > 0 
                                        ? profesores.map(p => p.nombre_completo).join(', ')
                                        : '';
                                    
                                    // Dentro de generarTablaHorario, en la parte de los selects, cambia esto:
return `
    <td class="empty-block">
        <select class="subject-select" data-day="${dia}" data-time="${bloque.horaInicio}" onchange="guardarAsignacion(this)">
            <option value="">Seleccionar materia</option>
            ${estado.asignaturas.map(asignatura => {
                const profesoresAsignatura = asignatura.profesores || [];
                const textoProfesores = profesoresAsignatura.length > 0 
                    ? ` (${profesoresAsignatura.map(p => p.nombre_completo).join(', ')})`
                    : '';
                
                // VERIFICAR SI EST√Å SELECCIONADA - CORREGIDO
                const estaSeleccionada = estado.asignaciones[asignacionKey] == asignatura.id;
                
                return `
                    <option value="${asignatura.id}" ${estaSeleccionada ? 'selected' : ''}>
                        ${asignatura.nombre}${textoProfesores}
                    </option>
                `;
            }).join('')}
        </select>
        <select class="salon-select" data-day="${dia}" data-time="${bloque.horaInicio}" onchange="guardarSalon(this)">
            <option value="">Seleccionar sal√≥n</option>
            ${estado.salones.map(salon => {
                // VERIFICAR SI EST√Å SELECCIONADO - CORREGIDO
                const estaSeleccionado = estado.salonesAsignaciones[asignacionKey] == salon.id;
                
                return `
                    <option value="${salon.id}" ${estaSeleccionado ? 'selected' : ''}>
                        ${salon.nombre} - ${salon.tipo}
                    </option>
                `;
            }).join('')}
        </select>
        ${asignatura && profesores.length > 0 ? 
            `<div style="margin-top: 5px; font-size: 0.8rem; color: #666;">
                <strong>Profesor:</strong> ${profesoresTexto}
            </div>` : 
            ''
        }
        ${salon ? 
            `<div style="margin-top: 2px; font-size: 0.8rem; color: #666;">
                <strong>Sal√≥n:</strong> ${salon.nombre}
            </div>` : 
            ''
        }
    </td>
`;
                                }
                            }).join('')}
                        </tr>
                    `;
                }
            });

            tablaHTML += '</tbody></table>';
            container.innerHTML = tablaHTML;
        }

        function guardarAsignacion(select) {
    const dia = select.getAttribute('data-day');
    const tiempo = select.getAttribute('data-time');
    const asignaturaId = select.value;

    const clave = `${dia}-${tiempo}`;
    
    if (asignaturaId) {
        // Asegurar que se guarda como n√∫mero
        estado.asignaciones[clave] = parseInt(asignaturaId);
        console.log('üíæ Asignaci√≥n guardada:', clave, estado.asignaciones[clave]);
        mostrarNotificacion('Asignaci√≥n guardada temporalmente', 'success');
    } else {
        delete estado.asignaciones[clave];
        console.log('üóëÔ∏è Asignaci√≥n eliminada:', clave);
        mostrarNotificacion('Asignaci√≥n eliminada', 'warning');
    }
}

function guardarSalon(select) {
    const dia = select.getAttribute('data-day');
    const tiempo = select.getAttribute('data-time');
    const salonId = select.value;

    const clave = `${dia}-${tiempo}`;
    
    if (salonId) {
        // Asegurar que se guarda como n√∫mero
        estado.salonesAsignaciones[clave] = parseInt(salonId);
        console.log('üíæ Sal√≥n guardado:', clave, estado.salonesAsignaciones[clave]);
        mostrarNotificacion('Sal√≥n asignado temporalmente', 'success');
    } else {
        delete estado.salonesAsignaciones[clave];
        console.log('üóëÔ∏è Sal√≥n eliminado:', clave);
        mostrarNotificacion('Sal√≥n eliminado', 'warning');
    }
}

        async function saveCourseSchedule() {
            const exito = await guardarHorarioCurso();
            if (exito) {
                // Actualizar estad√≠sticas despu√©s de guardar
                estado.estadisticas.horarios_asignados = estado.cursos.filter(c => c.horario_general_id).length;
                actualizarEstadisticas();
            }
        }

        function clearCourseSchedule() {
            if (!estado.cursoSeleccionado) {
                mostrarNotificacion('Seleccione un curso primero', 'error');
                return;
            }

            if (confirm('¬øEst√° seguro de que desea limpiar todas las asignaciones del horario?')) {
                estado.asignaciones = {};
                estado.salonesAsignaciones = {};
                generarTablaHorario();
                mostrarNotificacion('Horario limpiado correctamente', 'success');
            }
        }

        async function resetCourseSchedule() {
            if (!estado.cursoSeleccionado) {
                mostrarNotificacion('Seleccione un curso primero', 'error');
                return;
            }

            if (confirm('¬øEst√° seguro de que desea restablecer el horario a su estado original? Se perder√°n todas las asignaciones actuales.')) {
                await cargarHorarioCurso(estado.cursoSeleccionado.id);
                generarTablaHorario();
                mostrarNotificacion('Horario restablecido correctamente', 'success');
            }
        }

        // =============================================
        // FUNCIONALIDAD DE COMPARTIR
        // =============================================

        function mostrarModalCompartir() {
            if (!estado.cursoSeleccionado) {
                mostrarNotificacion('Seleccione un curso primero', 'error');
                return;
            }

            estado.destinatarioCompartir = null;
            document.querySelectorAll('.share-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.getElementById('share-details').style.display = 'none';
            document.getElementById('share-modal').style.display = 'flex';
        }

        function cerrarModalCompartir() {
            document.getElementById('share-modal').style.display = 'none';
        }

        function seleccionarDestinatario(destinatario, event) {
    estado.destinatarioCompartir = destinatario;
    
    document.querySelectorAll('.share-option').forEach(option => {
        option.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    
            
            const details = document.getElementById('share-details');
            const title = document.getElementById('share-title');
            const description = document.getElementById('share-description');
            
            details.style.display = 'block';
            
            if (destinatario === 'estudiantes') {
                title.textContent = 'Compartir con Estudiantes';
                description.textContent = `Se compartir√° el horario con todos los estudiantes del curso ${estado.cursoSeleccionado.nombreCurso}. Los estudiantes podr√°n ver su horario semanal con materias, profesores y salones asignados.`;
            } else {
                title.textContent = 'Compartir con Profesores';
                description.textContent = `Se compartir√° el horario con los profesores asignados a las materias. Cada profesor podr√° ver su horario semanal con los cursos, materias, horarios y salones asignados.`;
            }
        }

        function confirmarCompartir() {
            if (!estado.destinatarioCompartir) {
                mostrarNotificacion('Seleccione un destinatario', 'error');
                return;
            }
            compartirHorario();
        }

        // =============================================
        // INICIALIZACI√ìN
        // =============================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando gesti√≥n de horarios de cursos...');
            cargarDatosIniciales();
        });

        // Hacer funciones globales para los eventos onclick
        window.loadCourseSchedule = loadCourseSchedule;
        window.saveCourseSchedule = saveCourseSchedule;
        window.clearCourseSchedule = clearCourseSchedule;
        window.resetCourseSchedule = resetCourseSchedule;
        window.guardarAsignacion = guardarAsignacion;
        window.guardarSalon = guardarSalon;
        window.mostrarModalCompartir = mostrarModalCompartir;
        window.cerrarModalCompartir = cerrarModalCompartir;
        window.seleccionarDestinatario = seleccionarDestinatario;
        window.confirmarCompartir = confirmarCompartir;
    </script>
</body>
</html>