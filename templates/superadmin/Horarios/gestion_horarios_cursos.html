<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Horarios de Cursos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --accent1: #F95738;
            --accent2: #EE964B;
            --accent3: #F4D35E;
            --accent4: #0D3B66;
            --light: #FAF0CA;
            --white: #FFFFFF;
            --black: #333333;
            --gray: #666666;
            --light-gray: #F8F9FA;
            --border: #E9ECEF;
            --card-bg: #FFFFFF;
            --header-bg: #FFFFFF;
            --main-bg: #F8F9FA;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--main-bg);
            color: var(--black);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--accent4), #1a5080);
            color: var(--white);
            padding: 18px 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 32px;
            color: var(--accent3);
        }
        
        .logo h1 {
            color: var(--white);
            font-weight: 700;
            font-size: 1.8rem;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 22px;
            transition: transform 0.3s, box-shadow 0.3s;
            border-top: 4px solid var(--accent4);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .stat-card:nth-child(2) {
            border-top: 4px solid var(--accent1);
        }
        
        .stat-card:nth-child(3) {
            border-top: 4px solid var(--accent2);
        }
        
        .stat-card:nth-child(4) {
            border-top: 4px solid var(--accent3);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        
        .stat-card h2 {
            color: var(--accent4);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        .stat-card h2 i {
            font-size: 22px;
        }
        
        .stat-card:nth-child(2) h2 {
            color: var(--accent1);
        }
        
        .stat-card:nth-child(3) h2 {
            color: var(--accent2);
        }
        
        .stat-card:nth-child(4) h2 {
            color: var(--accent4);
        }
        
        .stat {
            font-size: 36px;
            font-weight: 800;
            color: var(--accent4);
            margin: 15px 0;
            padding: 15px;
            background: linear-gradient(135deg, var(--light), #f5e9b8);
            border-radius: 10px;
            border: 2px solid var(--accent3);
        }
        
        .stat-card:nth-child(2) .stat {
            color: var(--accent1);
            border: 2px solid rgba(249, 87, 56, 0.3);
        }
        
        .stat-card:nth-child(3) .stat {
            color: var(--accent2);
            border: 2px solid rgba(238, 150, 75, 0.3);
        }
        
        .stat-card:nth-child(4) .stat {
            color: var(--accent4);
            border: 2px solid rgba(244, 211, 94, 0.3);
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 22px;
            transition: transform 0.3s, box-shadow 0.3s;
            border-top: 4px solid var(--accent4);
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }
        
        .card h2 {
            color: var(--accent4);
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.25rem;
        }
        
        .card h2 i {
            font-size: 22px;
            color: var(--accent1);
            background-color: rgba(249, 87, 56, 0.1);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }
        
        .table-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-top: 30px;
            border-top: 4px solid var(--accent3);
            overflow-x: auto;
        }
        
        .table-title {
            color: var(--accent4);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.25rem;
        }
        
        .table-title i {
            font-size: 22px;
            color: var(--accent3);
            background-color: rgba(244, 211, 94, 0.1);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }
        
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .schedule-table th {
            background-color: var(--accent4);
            color: white;
            padding: 12px 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .schedule-table td {
            padding: 10px 12px;
            border: 1px solid var(--border);
            text-align: center;
            vertical-align: middle;
        }
        
        .schedule-table .time-cell {
            background-color: var(--light);
            font-weight: 600;
            width: 100px;
        }
        
        .schedule-table .break-block {
            background-color: #F95738;
            color: white;
            font-weight: 500;
            border-radius: 4px;
        }
        
        .schedule-table .empty-block {
            background-color: var(--light-gray);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--accent4);
        }
        
        select, input {
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            margin: 10px 0;
            width: 100%;
            background-color: var(--white);
            color: var(--black);
            font-weight: 500;
            font-size: 1rem;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--accent2);
            box-shadow: 0 0 0 3px rgba(238, 150, 75, 0.2);
        }
        
        button {
            background: linear-gradient(135deg, var(--accent4), #1a5080);
            color: var(--white);
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 18px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            width: 100%;
            justify-content: center;
            font-size: 1.05rem;
            box-shadow: 0 4px 10px rgba(13, 59, 102, 0.25);
        }
        
        button:hover {
            background: linear-gradient(135deg, #1a5080, var(--accent4));
            box-shadow: 0 6px 15px rgba(13, 59, 102, 0.35);
            transform: translateY(-2px);
        }
        
        button.secondary {
            background: linear-gradient(135deg, var(--accent2), #f0a868);
        }
        
        button.secondary:hover {
            background: linear-gradient(135deg, #f0a868, var(--accent2));
        }
        
        button.danger {
            background: linear-gradient(135deg, #dc3545, #e25563);
        }
        
        button.danger:hover {
            background: linear-gradient(135deg, #e25563, #dc3545);
        }
        
        button.small {
            padding: 10px 15px;
            font-size: 0.9rem;
            width: auto;
        }
        
        button i {
            font-size: 18px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 18px 25px;
            background: linear-gradient(135deg, var(--accent4), #1a5080);
            color: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
            border-left: 5px solid var(--accent3);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #28a745, #20c997);
            border-left-color: #20c997;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #dc3545, #e25563);
            border-left-color: #e25563;
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            border-left-color: #fd7e14;
        }
        
        .notification i {
            font-size: 22px;
        }
        
        .schedule-table .morning-break {
            background-color: #FFA726;
            color: white;
        }
        
        .schedule-table .lunch-break {
            background-color: #EF5350;
            color: white;
        }
        
        .schedule-table .afternoon-break {
            background-color: #AB47BC;
            color: white;
        }
        
        .schedule-table .custom-break {
            background-color: #26A69A;
            color: white;
        }
        
        .schedule-table .subject-select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background-color: white;
        }
        
        .schedule-table .subject-select:focus {
            outline: none;
            border-color: var(--accent2);
            box-shadow: 0 0 0 2px rgba(238, 150, 75, 0.2);
        }
        
        .course-management {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid var(--light);
        }
        
        .course-management h2 {
            color: var(--accent4);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.25rem;
        }
        
        .course-management h2 i {
            font-size: 22px;
            color: var(--accent2);
            background-color: rgba(238, 150, 75, 0.1);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }
        
        .courses-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
        }
        
        .course-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background-color: var(--white);
            border-radius: 8px;
            margin-bottom: 10px;
            gap: 15px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }
        
        .course-item:hover {
            background-color: var(--light);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .course-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .course-name {
            font-weight: 600;
            color: var(--accent4);
            margin-bottom: 5px;
        }
        
        .course-teacher {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        .course-schedule {
            font-size: 0.8rem;
            color: var(--accent4);
            font-weight: 600;
            background-color: rgba(13, 59, 102, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            min-width: 120px;
            text-align: center;
        }
        
        .schedule-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .schedule-actions button {
            margin-top: 0;
            flex: 1;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--accent4), #1a5080);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent4);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal de carga */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            max-width: 300px;
        }
        
        .loading-spinner {
            color: var(--accent4);
            margin-bottom: 20px;
        }
        
        @media (max-width: 1100px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 650px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
                padding: 15px;
            }
            
            .logo h1 {
                font-size: 1.5rem;
            }
            
            .schedule-actions {
                flex-direction: column;
            }
            
            .course-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .course-schedule {
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-calendar-alt"></i>
                <h1>Gesti√≥n de Horarios de Cursos</h1>
            </div>
            <a href="{{ url_for('admin.gestion_horarios') }}" class="btn">
                <i class="fas fa-arrow-left"></i> Volver a Horarios Generales
            </a>
        </header>
        
        <div class="dashboard">
            <div class="stat-card">
                <h2><i class="fas fa-book"></i> Materias Disponibles</h2>
                <div class="stat" id="total-materias">0</div>
            </div>
            
            <div class="stat-card">
                <h2><i class="fas fa-users"></i> Cursos Activos</h2>
                <div class="stat" id="total-cursos">0</div>
            </div>
            
            <div class="stat-card">
                <h2><i class="fas fa-clock"></i> Horarios Asignados</h2>
                <div class="stat" id="horarios-asignados">0</div>
            </div>
            
            <div class="stat-card">
                <h2><i class="fas fa-share-alt"></i> Exportar</h2>
                <button class="small" onclick="exportSchedule()"><i class="fas fa-download"></i> Exportar</button>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-calendar-alt"></i> Seleccionar Curso</h2>
            <div class="form-group">
                <label>Curso</label>
                <select id="course-select">
                    <option value="">Cargando cursos...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Horario Base</label>
                <select id="base-schedule">
                    <option value="">Cargando horarios...</option>
                </select>
            </div>
            
            <button onclick="loadCourseSchedule()"><i class="fas fa-search"></i> Cargar Horario del Curso</button>
        </div>
        
        <div class="table-container">
            <h2 class="table-title"><i class="fas fa-table"></i> Horario del Curso: <span id="current-course-name">No seleccionado</span></h2>
            <div id="course-schedule-table-container">
                <p style="text-align: center; padding: 20px; color: #666;">Seleccione un curso para ver su horario</p>
            </div>
        </div>
        
        <div class="course-management">
            <h2><i class="fas fa-tasks"></i> Gesti√≥n de Materias</h2>
            
            <div class="form-group">
                <label>Materias Disponibles</label>
                <div class="courses-list" id="subjects-list">
                    <p style="text-align: center; color: #666; padding: 20px;">Cargando materias...</p>
                </div>
            </div>
            
            <div class="schedule-actions">
                <button class="secondary" onclick="saveCourseSchedule()"><i class="fas fa-save"></i> Guardar Horario</button>
                <button class="secondary" onclick="clearCourseSchedule()"><i class="fas fa-broom"></i> Limpiar Horario</button>
                <button class="danger" onclick="resetCourseSchedule()"><i class="fas fa-undo"></i> Restablecer Horario</button>
            </div>
        </div>
    </div>

    <!-- Modal de carga -->
    <div class="modal" id="loading-modal">
        <div class="modal-content">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin fa-3x"></i>
            </div>
            <p style="margin-top: 20px; font-size: 16px;" id="loading-message">Cargando...</p>
        </div>
    </div>

    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text">Operaci√≥n realizada con √©xito</span>
    </div>

    <script>
        // =============================================
        // CONFIGURACI√ìN Y VARIABLES GLOBALES
        // =============================================
        const API_URLS = {
            cursos: '/admin/api/cursos',
            horarios: '/admin/api/horarios',
            asignaturas: '/admin/api/asignaturas',
            profesores: '/admin/api/profesores',
            horarioCurso: '/admin/api/horario_curso/cargar',
            guardarHorarioCurso: '/admin/api/horario_curso/guardar',
            estadisticas: '/admin/api/estadisticas/horarios-cursos'
        };

        // Estado de la aplicaci√≥n
        let estado = {
            cursos: [],
            horarios: [],
            asignaturas: [],
            profesores: [],
            cursoSeleccionado: null,
            horarioSeleccionado: null,
            bloquesHorario: [],
            asignaciones: {},
            estadisticas: {
                total_materias: 0,
                total_cursos: 0,
                horarios_asignados: 0
            }
        };

        // =============================================
        // FUNCIONES DE UTILIDAD
        // =============================================

        function mostrarLoading(mensaje = 'Cargando...') {
            document.getElementById('loading-message').textContent = mensaje;
            document.getElementById('loading-modal').style.display = 'flex';
        }

        function ocultarLoading() {
            document.getElementById('loading-modal').style.display = 'none';
        }

        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            const icon = notification.querySelector('i');
            
            // Configurar icono seg√∫n el tipo
            if (tipo === 'error') {
                icon.className = 'fas fa-exclamation-circle';
            } else if (tipo === 'warning') {
                icon.className = 'fas fa-exclamation-triangle';
            } else {
                icon.className = 'fas fa-check-circle';
            }
            
            notificationText.textContent = mensaje;
            notification.className = `notification ${tipo} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // =============================================
        // FUNCIONES DE COMUNICACI√ìN CON LA API
        // =============================================

        async function apiRequest(url, options = {}) {
            console.log('üîó API Request:', url, options.method || 'GET');
            
            try {
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    ...options
                };

                if (config.body) {
                    config.body = JSON.stringify(config.body);
                }

                const response = await fetch(url, config);
                console.log('üì• API Response:', response.status);
                
                if (!response.ok) {
                    let errorMessage = `Error ${response.status}`;
                    
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || errorMessage;
                    } catch (e) {
                        const text = await response.text();
                        if (text) errorMessage += ` - ${text.substring(0, 200)}`;
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('‚úÖ API Success:', data);
                return data;
                
            } catch (error) {
                console.error('‚ùå API Error:', error);
                throw error;
            }
        }

        // =============================================
        // FUNCIONES DE CARGA DE DATOS
        // =============================================

        async function cargarDatosIniciales() {
            mostrarLoading('Cargando datos del sistema...');
            
            try {
                // Cargar todos los datos en paralelo
                const [cursosData, horariosData, asignaturasData, estadisticasData] = await Promise.allSettled([
                    apiRequest(API_URLS.cursos),
                    apiRequest(API_URLS.horarios),
                    apiRequest(API_URLS.asignaturas),
                    apiRequest(API_URLS.estadisticas)
                ]);

                // Procesar cursos
                if (cursosData.status === 'fulfilled') {
                    estado.cursos = cursosData.value.data || cursosData.value || [];
                } else {
                    console.error('Error cargando cursos:', cursosData.reason);
                    estado.cursos = [];
                }

                // Procesar horarios
                if (horariosData.status === 'fulfilled') {
                    estado.horarios = horariosData.value || [];
                } else {
                    console.error('Error cargando horarios:', horariosData.reason);
                    estado.horarios = [];
                }

                // Procesar asignaturas
                if (asignaturasData.status === 'fulfilled') {
                    estado.asignaturas = Array.isArray(asignaturasData.value) ? asignaturasData.value : [];
                } else {
                    console.error('Error cargando asignaturas:', asignaturasData.reason);
                    estado.asignaturas = [];
                }

                // Procesar estad√≠sticas
                if (estadisticasData.status === 'fulfilled') {
                    estado.estadisticas = estadisticasData.value;
                } else {
                    console.error('Error cargando estad√≠sticas:', estadisticasData.reason);
                    // Calcular estad√≠sticas b√°sicas desde los datos cargados
                    estado.estadisticas = {
                        total_materias: estado.asignaturas.length,
                        total_cursos: estado.cursos.length,
                        horarios_asignados: estado.cursos.filter(c => c.horario_general_id).length,
                        total_materias: estado.asignaturas.length
                    };
                }

                actualizarEstadisticas();
                actualizarSelectCursos();
                actualizarSelectHorarios();
                actualizarListaMaterias();

                console.log('‚úÖ Datos cargados correctamente');
                mostrarNotificacion('Sistema cargado correctamente', 'success');

            } catch (error) {
                console.error('‚ùå Error cargando datos iniciales:', error);
                mostrarNotificacion('Error al cargar los datos del sistema', 'error');
            } finally {
                ocultarLoading();
            }
        }

        async function cargarHorarioCurso(cursoId) {
            mostrarLoading('Cargando horario del curso...');
            
            try {
                const horarioData = await apiRequest(`${API_URLS.horarioCurso}/${cursoId}`);
                
                if (horarioData && horarioData.asignaciones) {
                    estado.asignaciones = horarioData.asignaciones;
                } else {
                    estado.asignaciones = {};
                }
                
                return horarioData;
            } catch (error) {
                console.error('‚ùå Error cargando horario del curso:', error);
                estado.asignaciones = {};
                return { asignaciones: {} };
            } finally {
                ocultarLoading();
            }
        }

        async function cargarHorarioBase(horarioId) {
            try {
                const horarioData = await apiRequest(`${API_URLS.horarios}/${horarioId}`);
                
                if (horarioData && horarioData.bloques) {
                    estado.bloquesHorario = horarioData.bloques;
                    return horarioData;
                } else {
                    throw new Error('Estructura de horario inv√°lida');
                }
            } catch (error) {
                console.error('‚ùå Error cargando horario base:', error);
                throw error;
            }
        }

        async function guardarHorarioCurso() {
            if (!estado.cursoSeleccionado) {
                mostrarNotificacion('Seleccione un curso primero', 'error');
                return false;
            }

            mostrarLoading('Guardando horario del curso...');
            
            try {
                const datos = {
                    curso_id: estado.cursoSeleccionado.id,
                    horario_general_id: estado.horarioSeleccionado?.id,
                    asignaciones: estado.asignaciones
                };

                const resultado = await apiRequest(API_URLS.guardarHorarioCurso, {
                    method: 'POST',
                    body: datos
                });

                if (resultado.success) {
                    mostrarNotificacion('Horario del curso guardado correctamente', 'success');
                    return true;
                } else {
                    throw new Error(resultado.error || 'Error desconocido al guardar');
                }
            } catch (error) {
                console.error('‚ùå Error guardando horario:', error);
                mostrarNotificacion(`Error al guardar: ${error.message}`, 'error');
                return false;
            } finally {
                ocultarLoading();
            }
        }

        // =============================================
        // FUNCIONES DE LA INTERFAZ DE USUARIO
        // =============================================

        function actualizarEstadisticas() {
            document.getElementById('total-materias').textContent = estado.estadisticas.total_materias || 0;
            document.getElementById('total-cursos').textContent = estado.estadisticas.total_cursos || 0;
            document.getElementById('horarios-asignados').textContent = estado.estadisticas.horarios_asignados || 0;
        }

        function actualizarSelectCursos() {
            const select = document.getElementById('course-select');
            
            if (estado.cursos.length === 0) {
                select.innerHTML = '<option value="">No hay cursos disponibles</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Seleccione un curso</option>' +
                estado.cursos.map(curso => {
                    const nombre = curso.nombreCurso || curso.nombre || 'Curso sin nombre';
                    const sede = curso.sede || (curso.sedeId ? `Sede ${curso.sedeId}` : '');
                    return `<option value="${curso.id}">${nombre} ${sede ? '- ' + sede : ''}</option>`;
                }).join('');
        }

        function actualizarSelectHorarios() {
            const select = document.getElementById('base-schedule');
            
            if (estado.horarios.length === 0) {
                select.innerHTML = '<option value="">No hay horarios disponibles</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Seleccione un horario base</option>' +
                estado.horarios.map(horario => 
                    `<option value="${horario.id}">${horario.nombre} (${horario.periodo || 'Sin per√≠odo'})</option>`
                ).join('');
        }

        function actualizarListaMaterias() {
            const container = document.getElementById('subjects-list');
            
            if (estado.asignaturas.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay materias disponibles</p>';
                return;
            }
            
            container.innerHTML = estado.asignaturas.map(asignatura => `
                <div class="course-item">
                    <div class="course-info">
                        <div class="course-name">${asignatura.nombre}</div>
                        <div class="course-teacher">${asignatura.descripcion || 'Sin descripci√≥n'}</div>
                    </div>
                    <div class="course-schedule">Disponible</div>
                </div>
            `).join('');
        }

        async function loadCourseSchedule() {
            const cursoId = document.getElementById('course-select').value;
            const horarioId = document.getElementById('base-schedule').value;

            if (!cursoId) {
                mostrarNotificacion('Por favor seleccione un curso', 'error');
                return;
            }

            if (!horarioId) {
                mostrarNotificacion('Por favor seleccione un horario base', 'error');
                return;
            }

            try {
                // Encontrar curso y horario seleccionados
                estado.cursoSeleccionado = estado.cursos.find(c => c.id == cursoId);
                estado.horarioSeleccionado = estado.horarios.find(h => h.id == horarioId);

                if (!estado.cursoSeleccionado || !estado.horarioSeleccionado) {
                    mostrarNotificacion('Error al cargar los datos seleccionados', 'error');
                    return;
                }

                document.getElementById('current-course-name').textContent = 
                    estado.cursoSeleccionado.nombreCurso || estado.cursoSeleccionado.nombre || 'Curso';

                // Cargar horario base y horario existente del curso en paralelo
                await Promise.all([
                    cargarHorarioBase(horarioId),
                    cargarHorarioCurso(cursoId)
                ]);

                // Generar tabla de horario
                generarTablaHorario();

                mostrarNotificacion(`Horario cargado para ${estado.cursoSeleccionado.nombreCurso}`, 'success');

            } catch (error) {
                console.error('‚ùå Error cargando horario del curso:', error);
                mostrarNotificacion('Error al cargar el horario del curso', 'error');
            }
        }

        function generarTablaHorario() {
            const container = document.getElementById('course-schedule-table-container');
            
            if (!estado.horarioSeleccionado || estado.bloquesHorario.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No hay horario disponible para mostrar</p>';
                return;
            }

            // Obtener d√≠as √∫nicos del horario
            const diasUnicos = [...new Set(estado.bloquesHorario.map(bloque => bloque.dia_semana))].sort();
            
            // Agrupar bloques por d√≠a
            const bloquesPorDia = {};
            diasUnicos.forEach(dia => {
                bloquesPorDia[dia] = estado.bloquesHorario
                    .filter(bloque => bloque.dia_semana === dia)
                    .sort((a, b) => a.horaInicio.localeCompare(b.horaInicio));
            });

            let tablaHTML = `
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            ${diasUnicos.map(dia => `<th>${dia}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Crear filas para cada bloque de tiempo √∫nico
            const todosLosBloques = estado.bloquesHorario.flat();
            const horasUnicas = [...new Set(todosLosBloques.map(bloque => bloque.horaInicio))].sort();

            horasUnicas.forEach(hora => {
                const bloquesEnEstaHora = estado.bloquesHorario.filter(bloque => bloque.horaInicio === hora);
                
                if (bloquesEnEstaHora.length > 0) {
                    const primerBloque = bloquesEnEstaHora[0];
                    tablaHTML += `
                        <tr>
                            <td class="time-cell">${primerBloque.horaInicio} - ${primerBloque.horaFin}</td>
                            ${diasUnicos.map(dia => {
                                const bloque = bloquesPorDia[dia]?.find(b => b.horaInicio === hora);
                                
                                if (!bloque) {
                                    return '<td class="empty-block"></td>';
                                }
                                
                                if (bloque.tipo === 'break') {
                                    let claseBreak = 'break-block';
                                    if (bloque.break_type === 'morning') claseBreak += ' morning-break';
                                    else if (bloque.break_type === 'lunch') claseBreak += ' lunch-break';
                                    else if (bloque.break_type === 'afternoon') claseBreak += ' afternoon-break';
                                    else claseBreak += ' custom-break';
                                    
                                    return `<td class="${claseBreak}">${bloque.nombre || 'Descanso'}</td>`;
                                } else {
                                    const asignacionKey = `${dia}-${bloque.horaInicio}`;
                                    const asignaturaId = estado.asignaciones[asignacionKey];
                                    const asignatura = estado.asignaturas.find(a => a.id == asignaturaId);
                                    
                                    return `
                                        <td class="empty-block">
                                            <select class="subject-select" data-day="${dia}" data-time="${bloque.horaInicio}" onchange="guardarAsignacion(this)">
                                                <option value="">Seleccionar materia</option>
                                                ${estado.asignaturas.map(asignatura => `
                                                    <option value="${asignatura.id}" ${asignaturaId == asignatura.id ? 'selected' : ''}>
                                                        ${asignatura.nombre}
                                                    </option>
                                                `).join('')}
                                            </select>
                                        </td>
                                    `;
                                }
                            }).join('')}
                        </tr>
                    `;
                }
            });

            tablaHTML += '</tbody></table>';
            container.innerHTML = tablaHTML;
        }

        function guardarAsignacion(select) {
            const dia = select.getAttribute('data-day');
            const tiempo = select.getAttribute('data-time');
            const asignaturaId = select.value;

            const clave = `${dia}-${tiempo}`;
            
            if (asignaturaId) {
                estado.asignaciones[clave] = parseInt(asignaturaId);
                mostrarNotificacion('Asignaci√≥n guardada temporalmente', 'success');
            } else {
                delete estado.asignaciones[clave];
                mostrarNotificacion('Asignaci√≥n eliminada', 'warning');
            }
        }

        async function saveCourseSchedule() {
            const exito = await guardarHorarioCurso();
            if (exito) {
                // Actualizar estad√≠sticas despu√©s de guardar
                estado.estadisticas.horarios_asignados = estado.cursos.filter(c => c.horario_general_id).length;
                actualizarEstadisticas();
            }
        }

        function clearCourseSchedule() {
            if (!estado.cursoSeleccionado) {
                mostrarNotificacion('Seleccione un curso primero', 'error');
                return;
            }

            if (confirm('¬øEst√° seguro de que desea limpiar todas las asignaciones del horario?')) {
                estado.asignaciones = {};
                generarTablaHorario();
                mostrarNotificacion('Horario limpiado correctamente', 'success');
            }
        }

        async function resetCourseSchedule() {
            if (!estado.cursoSeleccionado) {
                mostrarNotificacion('Seleccione un curso primero', 'error');
                return;
            }

            if (confirm('¬øEst√° seguro de que desea restablecer el horario a su estado original? Se perder√°n todas las asignaciones actuales.')) {
                await cargarHorarioCurso(estado.cursoSeleccionado.id);
                generarTablaHorario();
                mostrarNotificacion('Horario restablecido correctamente', 'success');
            }
        }

        function exportSchedule() {
            if (!estado.cursoSeleccionado) {
                mostrarNotificacion('Seleccione un curso primero', 'error');
                return;
            }

            // Crear datos para exportaci√≥n
            const datosExportacion = {
                curso: estado.cursoSeleccionado.nombreCurso || estado.cursoSeleccionado.nombre,
                horario: estado.horarioSeleccionado?.nombre,
                asignaciones: estado.asignaciones,
                fecha: new Date().toLocaleDateString()
            };

            // Crear y descargar archivo JSON
            const blob = new Blob([JSON.stringify(datosExportacion, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `horario-${estado.cursoSeleccionado.nombreCurso || 'curso'}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            mostrarNotificacion('Horario exportado correctamente', 'success');
        }

        // =============================================
        // INICIALIZACI√ìN
        // =============================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando gesti√≥n de horarios de cursos...');
            cargarDatosIniciales();
        });

        // Hacer funciones globales para los eventos onclick
        window.loadCourseSchedule = loadCourseSchedule;
        window.saveCourseSchedule = saveCourseSchedule;
        window.clearCourseSchedule = clearCourseSchedule;
        window.resetCourseSchedule = resetCourseSchedule;
        window.exportSchedule = exportSchedule;
        window.guardarAsignacion = guardarAsignacion;
    </script>
</body>
</html>