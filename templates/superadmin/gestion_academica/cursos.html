{% extends "base.html" %}

{% block content %}
<style>
    /* Variables CSS */
    :root {
        --accent1: #F95738;
        --accent2: #EE964B;
        --accent3: #F4D35E;
        --accent4: #0D3B66;
        --light: #FAF0CA;
        --white: #FFFFFF;
        --black: #333333;
        --gray: #666666;
        --light-gray: #F8F9FA;
        --border: #E9ECEF;
        --card-bg: #FFFFFF;
        --header-bg: #FFFFFF;
        --main-bg: #F8F9FA;
        --shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
        --gradient-primary: linear-gradient(135deg, var(--accent4), #1a5080);
        --gradient-secondary: linear-gradient(135deg, var(--accent3), #e9c440);
        --gradient-accent: linear-gradient(135deg, var(--accent1), #ff6b4a);
    }

    /* RESET CR√çTICO - Desbloquear inputs */
    #nombreCurso, #sedeId {
        pointer-events: all !important;
        user-select: all !important;
        -webkit-user-select: all !important;
        opacity: 1 !important;
        background: white !important;
        position: relative !important;
        z-index: 100 !important;
    }

    /* Estilos generales */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, var(--light) 0%, var(--main-bg) 100%);
        color: var(--black);
        min-height: 100vh;
    }

    .header-main {
        background: var(--gradient-primary);
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        box-shadow: var(--shadow);
        border: none;
        position: relative;
        overflow: hidden;
    }

    .h4 {
        color: var(--white);
        font-weight: 800;
        font-size: 2.2rem;
        margin-bottom: 0.5rem;
    }

    .card {
        border-radius: 20px;
        border: none;
        background: var(--card-bg);
        box-shadow: var(--shadow);
        transition: all 0.4s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-hover);
    }

    .card-header {
        background: var(--gradient-primary);
        color: var(--white);
        border: none;
        border-radius: 20px 20px 0 0 !important;
        padding: 1.5rem;
    }

    .card-body {
        padding: 2rem;
    }

    .form-label {
        font-weight: 600;
        color: var(--accent4);
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border-radius: 12px;
        border: 2px solid var(--border);
        padding: 0.875rem 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--accent4);
        box-shadow: 0 0 0 3px rgba(13, 59, 102, 0.1);
    }

    .btn-primary {
        background: var(--gradient-primary);
        border: none;
        border-radius: 12px;
        padding: 1rem 2rem;
        font-weight: 600;
    }

    .btn-danger {
        background: var(--gradient-accent);
        border: none;
        border-radius: 10px;
        padding: 0.5rem 1rem;
        font-weight: 600;
    }

    .table thead th {
        background: var(--gradient-primary);
        color: var(--white);
        border: none;
        padding: 1.2rem 1rem;
    }

    .badge.bg-gradient-primary {
        background: var(--gradient-primary) !important;
        color: var(--white) !important;
    }

    /* Estilo modal estudiantes */
    #studentsModal .modal-header {
        background: var(--gradient-primary);
        color: var(--white);
        border-bottom: none;
    }
    #studentsModal .modal-title {
        font-weight: 700;
    }
    .students-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    .count-pill {
        background: var(--gradient-secondary);
        color: var(--black);
        border-radius: 999px;
        padding: 6px 12px;
        font-weight: 700;
        box-shadow: var(--shadow);
    }
    #studentsList {
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
    }
    .student-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
    }
    .student-item + .student-item { border-top: 1px solid var(--border); }
    .student-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--gradient-primary);
        color: var(--white);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        box-shadow: var(--shadow);
        flex: 0 0 40px;
    }
    .student-meta strong { color: var(--accent4); }
    .student-meta small { color: var(--gray); }
</style>

<div class="container-fluid px-4">
    <header class="d-flex justify-content-between align-items-center header-main">
        <div>
            <h1 class="h4 mb-1">Gesti√≥n de Cursos</h1>
            <p class="text-light mb-0 opacity-75">Administra y organiza los cursos acad√©micos</p>
        </div>
    </header>

    <div class="main-container mt-4">
        <!-- Flash Messages Container -->
        <div id="flashMessagesContainer"></div>

        <div class="row">
            <!-- Formulario -->
            <div class="col-lg-5 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Registrar Nuevo Curso</h5>
                    </div>
                    <div class="card-body">
                        <form id="cursoForm">
                            {{ form.hidden_tag() }}
                            <div class="mb-4">
                                <label for="nombreCurso" class="form-label">
                                    <i class="fas fa-book me-2"></i>Nombre del Curso
                                </label>
                                <input type="text" class="form-control" id="nombreCurso" name="nombreCurso" 
                                       placeholder="Ingrese el nombre del curso" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="mb-4">
                                <label for="sedeId" class="form-label">
                                    <i class="fas fa-building me-2"></i>Sede
                                </label>
                                <select class="form-select" id="sedeId" name="sedeId" required>
                                    <option value="">Seleccione una sede</option>
                                    <!-- Las opciones se cargar√°n din√°micamente -->
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 mt-2 py-3">
                                <i class="fas fa-save me-2"></i>Guardar Curso
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tabla -->
            <div class="col-lg-7">
                <div class="card shadow-sm h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Cursos Registrados</h5>
                        <div class="w-50">
                            <input type="text" id="searchBar" class="form-control" placeholder="Buscar curso...">
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th>Nombre del Curso</th>
                                        <th>Sede</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="cursosTableBody">
                                    <!-- Los cursos se cargar√°n aqu√≠ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver estudiantes -->
<div class="modal fade" id="studentsModal" tabindex="-1" aria-labelledby="studentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentsModalLabel">Estudiantes del Curso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="students-header">
                    <div class="fw-semibold text-muted">Listado de estudiantes</div>
                    <span id="studentsCount" class="count-pill">0</span>
                </div>
                <ul id="studentsList" class="list-group"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript CORREGIDO - COMPATIBLE CON WTForms
document.addEventListener('DOMContentLoaded', function() {
    // Elementos DOM
    const cursoForm = document.getElementById('cursoForm');
    const cursosTableBody = document.getElementById('cursosTableBody');
    const searchBar = document.getElementById('searchBar');
    const flashContainer = document.getElementById('flashMessagesContainer');
    const sedeSelect = document.getElementById('sedeId');

    // Obtener token CSRF del formulario
    function getCSRFToken() {
        const csrfTokenInput = document.querySelector('input[name="csrf_token"]');
        return csrfTokenInput ? csrfTokenInput.value : '';
    }

    // 1. CARGAR SEDES - VERSI√ìN CORREGIDA
    function cargarSedes() {
        console.log('üîÑ CARGANDO SEDES DESDE:', '{{ url_for("admin.api_sedes") }}');
        
        fetch('{{ url_for("admin.api_sedes") }}')
            .then(response => {
                console.log('üì• RESPUESTA SEDES - Status:', response.status);
                if (!response.ok) {
                    throw new Error(`Error ${response.status} al cargar sedes`);
                }
                return response.json();
            })
            .then(sedes => {
                console.log('üè¢ SEDES CARGADAS:', sedes);
                sedeSelect.innerHTML = '<option value="">Seleccione una sede</option>';
                
                const sedesArray = Array.isArray(sedes) ? sedes : (sedes.data || []);
                console.log('üìä SEDES PROCESADAS:', sedesArray);
                
                if (sedesArray.length === 0) {
                    console.warn('‚ö†Ô∏è  No hay sedes disponibles');
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "No hay sedes disponibles";
                    sedeSelect.appendChild(option);
                    return;
                }

                sedesArray.forEach((sede, index) => {
                    console.log(`üè¢ Sede ${index}:`, sede);
                    const option = document.createElement('option');
                    // IMPORTANTE: Usar id_sede que es el nombre correcto en el modelo
                    option.value = sede.id_sede || sede.id;
                    option.textContent = sede.nombre || sede.nombreSede || `Sede ${sede.id_sede || sede.id}`;
                    sedeSelect.appendChild(option);
                });

                console.log('‚úÖ SEDES CARGADAS EN SELECT. Total:', sedesArray.length);
            })
            .catch(error => {
                console.error('‚ùå ERROR CARGANDO SEDES:', error);
                mostrarMensaje('Error cargando sedes: ' + error.message, 'warning');
                
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "Error cargando sedes";
                sedeSelect.appendChild(option);
            });
    }

    // 2. CARGAR CURSOS
    function cargarCursos() {
        fetch('{{ url_for("admin.api_cursos") }}')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al cargar cursos');
                }
                return response.json();
            })
            .then(data => {
                console.log('Cursos cargados:', data);
                const cursos = data.data || data;
                cursosTableBody.innerHTML = '';
                
                if (!cursos || cursos.length === 0) {
                    cursosTableBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center py-4 text-muted">
                                <i class="fas fa-book fa-2x mb-3"></i><br>
                                No hay cursos registrados
                            </td>
                        </tr>
                    `;
                    return;
                }

                cursos.forEach(curso => {
                    const cursoId = curso.id_curso || curso.id;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-book text-primary me-3"></i>
                                <strong>${curso.nombreCurso || curso.nombre}</strong>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-gradient-primary">${curso.sede || 'Sin sede'}</span>
                        </td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm me-2 btn-ver-estudiantes" 
                                    data-id="${cursoId}" 
                                    data-nombre="${(curso.nombreCurso || curso.nombre) || ''}">
                                <i class="fas fa-users"></i> Estudiantes
                            </button>
                            <button class="btn btn-danger btn-sm btn-eliminar" 
                                    data-id="${curso.id}" 
                                    data-nombre="${curso.nombreCurso || curso.nombre}">
                                <i class="fas fa-trash-alt"></i> Eliminar
                            </button>
                        </td>
                    `;
                    cursosTableBody.appendChild(row);
                });

                // Agregar event listeners a los botones de eliminar
                document.querySelectorAll('.btn-eliminar').forEach(btn => {
                    btn.addEventListener('click', eliminarCurso);
                });

                // Agregar event listeners a los botones de ver estudiantes
                document.querySelectorAll('.btn-ver-estudiantes').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = btn.dataset.id;
                        const nombre = btn.dataset.nombre;
                        verEstudiantesCurso(id, nombre);
                    });
                });
            })
            .catch(error => {
                console.error('Error cargando cursos:', error);
                mostrarMensaje('Error cargando cursos: ' + error.message, 'danger');
                
                // Mostrar mensaje de error en la tabla
                cursosTableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i><br>
                            Error cargando cursos
                        </td>
                    </tr>
                `;
            });
    }

    // 3. CREAR CURSO - VERSI√ìN COMPATIBLE CON WTForms
    cursoForm.addEventListener('submit', function(event) {
        event.preventDefault();
        
        const formData = new FormData(cursoForm);
        const datosRaw = Object.fromEntries(formData.entries());
        const csrfToken = getCSRFToken();

        console.log('üéØ DATOS DEL FORMULARIO (ORIGINALES):', datosRaw);
        console.log('üîê CSRF TOKEN:', csrfToken ? 'PRESENTE' : 'AUSENTE');

        // Validaci√≥n mejorada
        if (!datosRaw.nombreCurso || !datosRaw.nombreCurso.trim()) {
            mostrarMensaje('Por favor ingrese el nombre del curso', 'warning');
            document.getElementById('nombreCurso').focus();
            return;
        }

        if (!datosRaw.sedeId || datosRaw.sedeId === "") {
            mostrarMensaje('Por favor seleccione una sede', 'warning');
            sedeSelect.focus();
            return;
        }

        // Convertir a n√∫mero y validar
        const sedeIdNumero = parseInt(datosRaw.sedeId);
        console.log('üî¢ sedeId convertido a n√∫mero:', sedeIdNumero);

        if (isNaN(sedeIdNumero) || sedeIdNumero <= 0) {
            mostrarMensaje('Por favor seleccione una sede v√°lida', 'warning');
            return;
        }

        // IMPORTANTE: Para WTForms necesitamos enviar el formulario como FormData, no como JSON
        console.log('üì§ ENVIANDO COMO FORM DATA A:', '{{ url_for("admin.api_cursos") }}');
        
        // Crear FormData para enviar como formulario tradicional
        const formDataToSend = new FormData();
        formDataToSend.append('nombreCurso', datosRaw.nombreCurso.trim());
        formDataToSend.append('sedeId', sedeIdNumero.toString()); // WTForms espera string para QuerySelectField
        formDataToSend.append('csrf_token', csrfToken);

        fetch('{{ url_for("admin.api_cursos") }}', {
            method: 'POST',
            body: formDataToSend  // Enviar como FormData, no JSON
        })
        .then(response => {
            console.log('üì• RESPUESTA HTTP:', {
                status: response.status,
                statusText: response.statusText,
                ok: response.ok,
                url: response.url
            });
            
            return response.text().then(text => {
                console.log('üìÑ CONTENIDO DE LA RESPUESTA:', text);
                
                let jsonData;
                try {
                    jsonData = text ? JSON.parse(text) : {};
                } catch (e) {
                    console.error('‚ùå ERROR PARSEANDO JSON:', e);
                    jsonData = { raw: text };
                }
                
                return {
                    status: response.status,
                    ok: response.ok,
                    data: jsonData
                };
            });
        })
        .then(({ status, ok, data }) => {
            console.log('‚úÖ RESULTADO PROCESADO:', { status, ok, data });
            
            if (ok) {
                if (data.message) {
                    cursoForm.reset();
                    cargarCursos();
                    mostrarMensaje(data.message, 'success');
                } else if (data.error) {
                    mostrarMensaje(data.error, 'danger');
                } else {
                    cursoForm.reset();
                    cargarCursos();
                    mostrarMensaje('Curso creado exitosamente', 'success');
                }
            } else {
                if (data.error) {
                    mostrarMensaje(data.error, 'danger');
                } else if (data.errors) {
                    let mensajeError = 'Errores en el formulario: ';
                    Object.values(data.errors).forEach(errorArray => {
                        mensajeError += errorArray.join(', ') + ' ';
                    });
                    mostrarMensaje(mensajeError, 'danger');
                } else if (data.raw) {
                    mostrarMensaje(`Error del servidor: ${data.raw}`, 'danger');
                } else {
                    mostrarMensaje(`Error ${status}: No se pudo crear el curso`, 'danger');
                }
            }
        })
        .catch(error => {
            console.error('üî• ERROR CR√çTICO:', error);
            mostrarMensaje('Error de conexi√≥n: ' + error.message, 'danger');
        });
    });

    // 4. ELIMINAR CURSO - CON CSRF
    function eliminarCurso(event) {
        const button = event.currentTarget;
        const cursoId = button.dataset.id;
        const cursoNombre = button.dataset.nombre;
        const csrfToken = getCSRFToken();

        if (confirm(`¬øEst√° seguro de eliminar el curso "${cursoNombre}"?`)) {
            // Para DELETE tambi√©n usar FormData
            const formData = new FormData();
            formData.append('id', cursoId);
            formData.append('csrf_token', csrfToken);

            fetch('{{ url_for("admin.api_cursos") }}', {
                method: 'DELETE',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || `Error ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(resultado => {
                if (resultado.message) {
                    mostrarMensaje(resultado.message, 'success');
                    cargarCursos();
                } else if (resultado.error) {
                    mostrarMensaje(resultado.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error eliminando curso:', error);
                mostrarMensaje('Error al eliminar el curso: ' + error.message, 'danger');
            });
        }
    }

    // 4.1 VER ESTUDIANTES DEL CURSO
    async function verEstudiantesCurso(cursoId, cursoNombre) {
        try {
            // Limpiar modal
            const titleEl = document.getElementById('studentsModalLabel');
            const countEl = document.getElementById('studentsCount');
            const listEl = document.getElementById('studentsList');
            if (titleEl) titleEl.textContent = `Estudiantes de ${cursoNombre || 'Curso'}`;
            if (countEl) countEl.textContent = '0';
            if (listEl) listEl.innerHTML = '<li class="list-group-item text-muted">Cargando...</li>';

            const resp = await fetch(`/admin/api/estudiantes-por-curso/${cursoId}`);
            if (!resp.ok) {
                throw new Error(`Error ${resp.status}`);
            }
            const estudiantes = await resp.json();

            if (countEl) countEl.textContent = Array.isArray(estudiantes) ? estudiantes.length : 0;
            if (listEl) {
                if (!Array.isArray(estudiantes) || estudiantes.length === 0) {
                    listEl.innerHTML = '<li class="list-group-item text-muted">No hay estudiantes asignados</li>';
                } else {
                    listEl.innerHTML = estudiantes.map(e => {
                        const nombre = e.nombre_completo || '';
                        const iniciales = nombre
                            .split(' ')
                            .filter(Boolean)
                            .slice(0,2)
                            .map(p => p[0]?.toUpperCase() || '')
                            .join('');
                        return `
                            <li class="list-group-item student-item">
                                <div class="student-avatar">${iniciales || 'E'}</div>
                                <div class="student-meta">
                                    <strong>${nombre}</strong><br>
                                    <small>ID: ${e.no_identidad || ''} ‚Ä¢ ${e.correo || ''}</small>
                                </div>
                            </li>
                        `;
                    }).join('');
                }
            }

            const modalEl = document.getElementById('studentsModal');
            if (modalEl && window.bootstrap && bootstrap.Modal) {
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
            } else if (modalEl) {
                // Fallback b√°sico
                modalEl.style.display = 'block';
                modalEl.classList.add('show');
            }
        } catch (err) {
            console.error('Error obteniendo estudiantes del curso:', err);
            mostrarMensaje('No se pudieron cargar los estudiantes del curso', 'danger');
        }
    }

    // 5. BUSCAR CURSOS
    searchBar.addEventListener('input', function() {
        const texto = this.value.toLowerCase();
        const filas = cursosTableBody.querySelectorAll('tr');
        
        filas.forEach(fila => {
            const textoFila = fila.textContent.toLowerCase();
            fila.style.display = textoFila.includes(texto) ? '' : 'none';
        });
    });

    // 6. MOSTRAR MENSAJES
    function mostrarMensaje(mensaje, tipo) {
        // Limpiar mensajes anteriores
        flashContainer.innerHTML = '';
        
        const alerta = document.createElement('div');
        alerta.className = `alert alert-${tipo} alert-dismissible fade show`;
        alerta.innerHTML = `
            <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'} me-2"></i>
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        flashContainer.appendChild(alerta);
        
        // Auto-eliminar despu√©s de 5 segundos
        setTimeout(() => {
            if (alerta.parentNode) {
                alerta.remove();
            }
        }, 5000);
    }

    // INICIALIZAR
    console.log('üöÄ INICIANDO APLICACI√ìN...');
    cargarSedes();
    cargarCursos();
});
</script>
{% endblock %}