{% extends "padres/base.html" %}

{% block title %}Notificaciones - Panel de Padre{% endblock %}

{% block extra_css %}
<style>
    .notification-card {
        border-left: 4px solid #F95738;
        transition: all 0.3s ease;
        cursor: pointer;
        margin-bottom: 1rem;
    }
    
    .notification-card:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border-left-color: #F95738;
    }
    
    .notification-card.read {
        background: #f8f9fa;
        border-left-color: #6c757d;
        opacity: 0.8;
    }
    
    .notification-card.unread {
        background: #f0f7ff;
        border-left-color: #F95738;
    }
    
    .notification-type-badge {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 600;
    }
    
    .type-comunicacion { background: #e3f2fd; color: #1976d2; }
    .type-calificacion { background: #f3e5f5; color: #7b1fa2; }
    .type-asistencia { background: #e8f5e8; color: #388e3c; }
    .type-solicitud { background: #fff3e0; color: #f57c00; }
    .type-solicitud_consulta { background: #fff8e1; color: #f57c00; }
    .type-evento { background: #fce4ec; color: #c2185b; }
    .type-votacion { background: #e1f5fe; color: #0277bd; }
    .type-admin { background: #f1f8e9; color: #689f38; }
    .type-sistema { background: #f5f5f5; color: #424242; }
    
    .filters-container {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }
    
    .btn-filter {
        border-radius: 25px;
        padding: 8px 20px;
        margin: 0 5px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: 2px solid #0D3B66;
        color: #0D3B66;
        background: white;
    }
    
    .btn-filter.active {
        background: #0D3B66;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(13, 59, 102, 0.3);
    }
    
    .notification-actions {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .notification-card:hover .notification-actions {
        opacity: 1;
    }
    
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: #dee2e6;
    }

    .notification-link {
        color: #0D3B66;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.3s ease;
    }

    .notification-link:hover {
        color: #F95738;
        text-decoration: underline;
    }

    .notification-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .icon-evento { background: #fce4ec; color: #c2185b; }
    .icon-calificacion { background: #f3e5f5; color: #7b1fa2; }
    .icon-solicitud { background: #fff3e0; color: #f57c00; }
    .icon-comunicacion { background: #e3f2fd; color: #1976d2; }
    .icon-asistencia { background: #e8f5e8; color: #388e3c; }
    .icon-sistema { background: #f5f5f5; color: #424242; }

    .stats-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        margin: 0 0.5rem;
    }

    .welcome-card {
        background: linear-gradient(135deg, var(--accent4), var(--accent1));
        color: white;
        border-radius: 15px;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="welcome-card p-4 rounded">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="mb-2"><i class="fas fa-bell me-2"></i>Mis Notificaciones</h1>
                        <p class="mb-0">Mantente informado sobre eventos, calificaciones y actividades de tus hijos.</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="stats-badge d-inline-block">
                            <h4 class="mb-0" id="totalNotifications">0</h4>
                            <small>Total</small>
                        </div>
                        <div class="stats-badge d-inline-block">
                            <h4 class="mb-0" id="unreadNotifications">0</h4>
                            <small>Pendientes</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Controles -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filters-container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="mb-2">Filtrar por estado:</h6>
                        <div>
                            <button class="btn btn-filter active" data-filtro="todas" onclick="cambiarFiltro('todas')">
                                Todas
                            </button>
                            <button class="btn btn-filter" data-filtro="pendientes" onclick="cambiarFiltro('pendientes')">
                                Pendientes
                            </button>
                            <button class="btn btn-filter" data-filtro="leidas" onclick="cambiarFiltro('leidas')">
                                Le√≠das
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="d-flex align-items-center justify-content-end">
                            <span class="me-2">Notificaciones por p√°gina:</span>
                            <select class="form-select form-select-sm" style="width: auto;" onchange="cambiarPerPage(this.value)">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                            </select>
                            <button class="btn btn-success ms-3" onclick="marcarTodasComoLeidas()">
                                <i class="fas fa-check-double me-1"></i>Marcar todas como le√≠das
                            </button>
                            <button class="btn btn-danger ms-2" onclick="eliminarTodas()">
                                <i class="fas fa-trash me-1"></i>Eliminar todas
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de notificaciones -->
    <div id="notifications-container">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2 text-muted">Cargando notificaciones...</p>
        </div>
    </div>

    <!-- Paginaci√≥n -->
    <div class="pagination-container" id="pagination-container" style="display: none;">
        <!-- Se llena din√°micamente -->
    </div>
</div>

<!-- Modal de confirmaci√≥n -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar acci√≥n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">¬øEst√°s seguro de que quieres realizar esta acci√≥n?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmButton">Confirmar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilter = 'todas';
let currentPerPage = 20;

// Cargar notificaciones al iniciar
document.addEventListener('DOMContentLoaded', function() {
    cargarNotificaciones();
    
    // Polling cada 30 segundos para actualizar el badge
    setInterval(actualizarBadge, 30000);
});

function cargarNotificaciones(page = 1) {
    currentPage = page;
    
    const url = `/padre/api/notificaciones?page=${page}&per_page=${currentPerPage}&filtro=${currentFilter}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarNotificaciones(data);
                actualizarContadores(data);
            } else {
                mostrarError('Error cargando notificaciones: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarError('Error de conexi√≥n');
        });
}

function mostrarNotificaciones(data) {
    const container = document.getElementById('notifications-container');
    
    // ‚úÖ CORRECCI√ìN: Manejar diferentes estructuras de datos
    console.log("üîç DATOS DE NOTIFICACIONES RECIBIDOS:", data);
    
    // Obtener las notificaciones de la estructura correcta
    let notificaciones = [];
    let total = 0;
    let paginationData = {};
    
    if (data.notificaciones) {
        // Estructura: {success: true, notificaciones: [], total: X, ...}
        notificaciones = data.notificaciones;
        total = data.total || notificaciones.length;
        paginationData = {
            current_page: data.current_page || 1,
            pages: data.pages || 1,
            has_prev: data.has_prev || false,
            has_next: data.has_next || false
        };
    } else if (data.data && data.data.notificaciones) {
        // Estructura: {success: true, data: {notificaciones: [], total: X, ...}}
        notificaciones = data.data.notificaciones;
        total = data.data.total || notificaciones.length;
        paginationData = {
            current_page: data.data.current_page || 1,
            pages: data.data.pages || 1,
            has_prev: data.data.has_prev || false,
            has_next: data.data.has_next || false
        };
    } else {
        // Estructura desconocida
        console.error("‚ùå Estructura de datos desconocida:", data);
        notificaciones = [];
        total = 0;
    }
    
    // ‚úÖ DIAGN√ìSTICO TEMPORAL - Ver qu√© datos llegan
    if (notificaciones.length > 0) {
        console.log("üìã Notificaciones procesadas:");
        notificaciones.forEach((notif, index) => {
            console.log(`   ${index + 1}. ID: ${notif.id} | Tipo: "${notif.tipo}" | T√≠tulo: "${notif.titulo}" | Le√≠da: ${notif.leida}`);
        });
    } else {
        console.log("üì≠ No hay notificaciones para mostrar");
    }
    
    if (notificaciones.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-bell-slash"></i>
                <h4>No hay notificaciones</h4>
                <p>No se encontraron notificaciones con los filtros seleccionados.</p>
                <a href="/padre/dashboard" class="btn btn-primary mt-3">
                    <i class="fas fa-arrow-left me-1"></i>Volver al Dashboard
                </a>
            </div>
        `;
        document.getElementById('pagination-container').style.display = 'none';
        return;
    }
    
    let html = '';
    notificaciones.forEach(notif => {
        const fecha = new Date(notif.creada_en || notif.fecha_creacion || notif.fecha).toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Determinar el enlace seg√∫n el tipo de notificaci√≥n
        let actionLink = '';
        if (notif.link) {
            actionLink = `<a href="${notif.link}" class="notification-link" onclick="marcarComoLeida(${notif.id})">
                <i class="fas fa-external-link-alt me-1"></i>Ver detalles
            </a>`;
        } else if (notif.tipo === 'evento') {
            actionLink = `<a href="/padre/eventos" class="notification-link" onclick="marcarComoLeida(${notif.id})">
                <i class="fas fa-calendar-alt me-1"></i>Ver calendario
            </a>`;
        } else if (notif.tipo === 'solicitud' || notif.tipo === 'solicitud_consulta') {
            actionLink = `<a href="/padre/consultar_estudiante" class="notification-link" onclick="marcarComoLeida(${notif.id})">
                <i class="fas fa-search me-1"></i>Ver solicitudes
            </a>`;
        } else if (notif.tipo === 'calificacion') {
            actionLink = `<a href="/padre/informacion_academica" class="notification-link" onclick="marcarComoLeida(${notif.id})">
                <i class="fas fa-chart-line me-1"></i>Ver calificaciones
            </a>`;
        }
        
        // Determinar icono seg√∫n el tipo
        const iconClass = `icon-${notif.tipo}`;
        const icon = getIconForType(notif.tipo);
        
        html += `
            <div class="card notification-card ${notif.leida ? 'read' : 'unread'}" data-id="${notif.id}">
                <div class="card-body">
                    <div class="row align-items-start">
                        <div class="col-md-1 text-center">
                            <div class="notification-icon ${iconClass}">
                                <i class="fas ${icon}"></i>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="d-flex align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 ${notif.leida ? '' : 'fw-bold'}">
                                        ${notif.titulo}
                                        ${!notif.leida ? '<span class="badge bg-primary ms-2">Nuevo</span>' : ''}
                                    </h6>
                                    <p class="text-muted mb-2">${notif.mensaje}</p>
                                    <div class="d-flex align-items-center">
                                        <small class="text-muted me-3">
                                            <i class="fas fa-clock me-1"></i>${fecha}
                                        </small>
                                        <span class="notification-type-badge type-${notif.tipo}">
                                            ${getTipoText(notif.tipo)}
                                        </span>
                                        ${actionLink}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="notification-actions">
                                ${notif.leida ? '' : `
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="marcarComoLeida(${notif.id})">
                                        <i class="fas fa-check me-1"></i>Le√≠da
                                    </button>
                                `}
                                <button class="btn btn-sm btn-outline-danger" onclick="eliminarNotificacion(${notif.id})">
                                    <i class="fas fa-trash me-1"></i>Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    mostrarPaginacion(paginationData);
}

function mostrarPaginacion(data) {
    const container = document.getElementById('pagination-container');
    
    if (data.pages <= 1) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'flex';
    
    let html = '<nav><ul class="pagination">';
    
    // Bot√≥n anterior
    if (data.has_prev) {
        html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="cargarNotificaciones(${data.current_page - 1})">
                        <i class="fas fa-chevron-left"></i> Anterior
                    </a>
                 </li>`;
    }
    
    // P√°ginas
    for (let i = Math.max(1, data.current_page - 2); i <= Math.min(data.pages, data.current_page + 2); i++) {
        html += `<li class="page-item ${i === data.current_page ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="cargarNotificaciones(${i})">${i}</a>
                 </li>`;
    }
    
    // Bot√≥n siguiente
    if (data.has_next) {
        html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="cargarNotificaciones(${data.current_page + 1})">
                        Siguiente <i class="fas fa-chevron-right"></i>
                    </a>
                 </li>`;
    }
    
    html += '</ul></nav>';
    container.innerHTML = html;
}

function actualizarContadores() {
    // Actualizar el badge en el men√∫ lateral
    fetch('/padre/api/notificaciones/contador')
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const badge = document.getElementById('notificationBadge');
                if (badge) {
                    const count = data.count;
                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error actualizando badge:', error);
            // No mostrar error en consola para evitar spam
        });
}
function cambiarFiltro(filtro) {
    currentFilter = filtro;
    currentPage = 1;
    
    // Actualizar botones
    document.querySelectorAll('.btn-filter').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-filtro="${filtro}"]`).classList.add('active');
    
    cargarNotificaciones();
}

function cambiarPerPage(perPage) {
    currentPerPage = parseInt(perPage);
    currentPage = 1;
    cargarNotificaciones();
}

function marcarComoLeida(notificacionId) {
    fetch('/padre/api/notificaciones/marcar-leidas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            notificacion_ids: [notificacionId]
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            cargarNotificaciones(currentPage);
            actualizarBadge();
            mostrarMensaje('Notificaci√≥n marcada como le√≠da', 'success');
        } else {
            mostrarError('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarError('Error de conexi√≥n');
    });
}

function marcarTodasComoLeidas() {
    mostrarConfirmacion(
        '¬øEst√°s seguro de que quieres marcar todas las notificaciones como le√≠das?',
        () => {
            fetch('/padre/api/notificaciones/marcar-leidas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cargarNotificaciones(currentPage);
                    actualizarBadge();
                    mostrarMensaje('Todas las notificaciones fueron marcadas como le√≠das', 'success');
                } else {
                    mostrarError('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarError('Error de conexi√≥n');
            });
        }
    );
}

function eliminarNotificacion(notificacionId) {
    mostrarConfirmacion(
        '¬øEst√°s seguro de que quieres eliminar esta notificaci√≥n?',
        () => {
            fetch('/padre/api/notificaciones/eliminar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    notificacion_ids: [notificacionId]
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cargarNotificaciones(currentPage);
                    actualizarBadge();
                    mostrarMensaje('Notificaci√≥n eliminada', 'success');
                } else {
                    mostrarError('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarError('Error de conexi√≥n');
            });
        }
    );
}

function eliminarTodas() {
    mostrarConfirmacion(
        '¬øEst√°s seguro de que quieres eliminar TODAS las notificaciones? Esta acci√≥n no se puede deshacer.',
        () => {
            fetch('/padre/api/notificaciones/eliminar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    eliminar_todas: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cargarNotificaciones(currentPage);
                    actualizarBadge();
                    mostrarMensaje('Todas las notificaciones fueron eliminadas', 'success');
                } else {
                    mostrarError('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarError('Error de conexi√≥n');
            });
        }
    );
}

function actualizarBadge() {
    // Actualizar el badge en el men√∫ lateral
    fetch('/padre/api/notificaciones/contador')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const badge = document.getElementById('notificationBadge');
                if (badge) {
                    const count = data.count;
                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }
        })
        .catch(error => console.error('Error actualizando badge:', error));
}

function getTipoText(tipo) {
    const tipos = {
        'comunicacion': 'Comunicaci√≥n',
        'calificacion': 'Calificaci√≥n',
        'asistencia': 'Asistencia',
        'solicitud': 'Solicitud',
        'solicitud_consulta': 'Consulta de Notas',
        'evento': 'Evento',
        'votacion': 'Votaci√≥n',
        'admin': 'Administraci√≥n',
        'sistema': 'Sistema'
    };
    return tipos[tipo] || tipo;
}

function getIconForType(tipo) {
    const icons = {
        'evento': 'fa-calendar-alt',
        'calificacion': 'fa-chart-line',
        'solicitud': 'fa-search',
        'solicitud_consulta': 'fa-search',
        'comunicacion': 'fa-envelope',
        'asistencia': 'fa-user-check',
        'votacion': 'fa-vote-yea',
        'admin': 'fa-cog',
        'sistema': 'fa-bell'
    };
    return icons[tipo] || 'fa-bell';
}

function mostrarConfirmacion(mensaje, callback) {
    document.getElementById('confirmMessage').textContent = mensaje;
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
    
    document.getElementById('confirmButton').onclick = () => {
        modal.hide();
        callback();
    };
}

function mostrarMensaje(mensaje, tipo = 'info') {
    const alertClass = tipo === 'success' ? 'alert-success' : 
                      tipo === 'error' ? 'alert-danger' : 'alert-info';
    const html = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas ${tipo === 'success' ? 'fa-check-circle' : tipo === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} me-2"></i>
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Insertar al inicio del contenido
    const container = document.querySelector('.container-fluid');
    container.insertAdjacentHTML('afterbegin', html);
    
    // Auto-remover despu√©s de 3 segundos
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 3000);
}

function mostrarError(mensaje) {
    mostrarMensaje(mensaje, 'error');
}
</script>
{% endblock %}