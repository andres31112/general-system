{% extends "/estudiantes/base.html" %}

{% block title %}Calendario de Eventos{% endblock %}

{% block content %}
<div class="container my-4">
    <h2 class="mb-4 text-center calendar-title">üìÖ Calendario de Eventos</h2>

    <!-- Controles del calendario -->
    <div class="calendar-controls mb-4">
        <button id="prevMonth" class="btn-control">
            <span class="btn-icon">‚Üê</span> Mes Anterior
        </button>
        <h3 id="currentMonth" class="month-display"></h3>
        <button id="nextMonth" class="btn-control">
            Siguiente Mes <span class="btn-icon">‚Üí</span>
        </button>
    </div>

    <!-- Encabezados de d√≠as de la semana -->
    <div class="weekdays-header">
        <div class="weekday">Dom</div>
        <div class="weekday">Lun</div>
        <div class="weekday">Mar</div>
        <div class="weekday">Mi√©</div>
        <div class="weekday">Jue</div>
        <div class="weekday">Vie</div>
        <div class="weekday">S√°b</div>
    </div>

    <!-- Contenedor del calendario -->
    <div id="calendar" class="calendar-grid"></div>

    <!-- Indicador de carga -->
    <div id="loading" class="loading-indicator">
        <div class="spinner"></div>
        <p>Cargando eventos...</p>
    </div>

    <!-- Modal de detalles -->
    <div id="eventDetails" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div class="modal-header">
                <h3 id="detailTitle"></h3>
                <div class="event-badge" id="detailBadge"></div>
            </div>
            <div class="modal-body">
                <p><strong>üìÖ Fecha:</strong> <span id="detailDate"></span></p>
                <p><strong>‚è∞ Hora:</strong> <span id="detailTime"></span></p>
                <p><strong>üë• Dirigido a:</strong> <span id="detailRole"></span></p>
                <div class="description-container">
                    <strong>üìù Descripci√≥n:</strong>
                    <p id="detailDescription"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-close" onclick="closeModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Notificaci√≥n toast -->
    <div id="toast" class="toast"></div>
</div>

<style>
    :root {
        --accent1: #F95738;
        --accent2: #EE964B;
        --accent3: #F4D35E;
        --accent4: #0D3B66;
        --light: #FAF0CA;
        --white: #FFFFFF;
        --black: #333333;
        --gray: #666666;
        --light-gray: #F8F9FA;
        --border: #E9ECEF;
        --card-bg: #FFFFFF;
        --header-bg: #FFFFFF;
        --main-bg: #F8F9FA;
        --shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.12);
        --shadow-large: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    /* Animaciones clave */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes ripple {
        0% { transform: scale(0); opacity: 1; }
        100% { transform: scale(4); opacity: 0; }
    }

    /* Estilos generales */
    .calendar-title {
        color: var(--accent4);
        font-weight: 700;
        animation: fadeIn 0.8s ease-out;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Controles del calendario */
    .calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        animation: slideIn 0.6s ease-out;
    }

    .btn-control {
        background: var(--accent4);
        color: var(--white);
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: var(--shadow);
    }

    .btn-control:hover {
        background: var(--accent1);
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
    }

    .btn-control:active {
        transform: translateY(0);
    }

    .btn-icon {
        font-weight: bold;
        transition: transform 0.3s ease;
    }

    .btn-control:hover .btn-icon {
        animation: bounce 0.6s ease;
    }

    .month-display {
        color: var(--accent4);
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
        animation: pulse 2s infinite;
    }

    /* Encabezados de d√≠as */
    .weekdays-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 12px;
        margin-bottom: 10px;
        animation: fadeIn 0.8s ease-out 0.2s both;
    }

    .weekday {
        text-align: center;
        font-weight: 600;
        color: var(--accent4);
        padding: 10px;
        background: var(--light);
        border-radius: 8px;
        box-shadow: var(--shadow);
    }

    /* Grid del calendario */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 12px;
        background-color: var(--main-bg);
        padding: 20px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        animation: fadeIn 1s ease-out 0.4s both;
    }

    .day {
        border: 2px solid var(--border);
        padding: 12px;
        min-height: 120px;
        position: relative;
        border-radius: 10px;
        background: var(--card-bg);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: var(--shadow);
        cursor: pointer;
        overflow: hidden;
    }

    .day::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--accent3);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .day:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: var(--shadow-hover);
        border-color: var(--accent3);
    }

    .day:hover::before {
        transform: scaleX(1);
    }

    .day.current-day {
        border-color: var(--accent1);
        background: var(--light);
        animation: pulse 2s infinite;
    }

    .day.current-day::before {
        background: var(--accent1);
        transform: scaleX(1);
    }

    .day.has-events {
        border-color: var(--accent4);
    }

    .day strong {
        display: block;
        font-size: 16px;
        margin-bottom: 8px;
        color: var(--accent4);
        font-weight: 600;
        transition: color 0.3s ease;
    }

    .day:hover strong {
        color: var(--accent1);
    }

    .events {
        font-size: 12px;
    }

    .event {
        background: linear-gradient(135deg, var(--accent4), #1a4a7a);
        color: var(--white);
        padding: 6px 8px;
        margin-bottom: 5px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 11px;
        line-height: 1.3;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        position: relative;
        overflow: hidden;
    }

    .event::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255,255,255,0.3);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    .event:hover {
        background: linear-gradient(135deg, var(--accent1), #ff6b4a);
        transform: translateX(3px);
        box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }

    .event:hover::before {
        width: 300px;
        height: 300px;
    }

    .event.urgent {
        background: linear-gradient(135deg, var(--accent1), #ff6b4a);
        animation: pulse 1.5s infinite;
    }

    /* Indicador de carga */
    .loading-indicator {
        text-align: center;
        padding: 30px;
        color: var(--accent4);
        display: none;
    }

    .spinner {
        border: 4px solid var(--light);
        border-top: 4px solid var(--accent4);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    /* Modal mejorado */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background: var(--card-bg);
        padding: 0;
        border-radius: 15px;
        width: 500px;
        max-width: 90vw;
        box-shadow: var(--shadow-large);
        position: relative;
        animation: fadeIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform-origin: center;
        overflow: hidden;
    }

    .modal-header {
        background: linear-gradient(135deg, var(--accent4), #1a4a7a);
        color: var(--white);
        padding: 20px;
        position: relative;
    }

    .modal-header h3 {
        margin: 0;
        padding-right: 30px;
    }

    .event-badge {
        display: inline-block;
        background: var(--accent3);
        color: var(--black);
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 8px;
        animation: pulse 2s infinite;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-body p {
        margin-bottom: 12px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
    }

    .modal-body strong {
        color: var(--accent4);
        min-width: 100px;
    }

    .description-container {
        margin-top: 15px;
        padding: 15px;
        background: var(--light-gray);
        border-radius: 8px;
        border-left: 4px solid var(--accent3);
    }

    .modal-footer {
        padding: 15px 20px;
        text-align: right;
        border-top: 1px solid var(--border);
    }

    .btn-close {
        background: var(--accent1);
        color: var(--white);
        border: none;
        padding: 8px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-close:hover {
        background: var(--accent2);
        transform: translateY(-2px);
    }

    .close {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 28px;
        cursor: pointer;
        color: var(--white);
        transition: all 0.3s ease;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .close:hover {
        color: var(--accent3);
        background: rgba(255,255,255,0.1);
        transform: rotate(90deg);
    }

    /* Toast notifications */
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--accent4);
        color: var(--white);
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: var(--shadow-large);
        transform: translateX(150%);
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 1001;
    }

    .toast.show {
        transform: translateX(0);
    }

    /* Efectos de part√≠culas para interacci√≥n */
    .particles {
        position: absolute;
        pointer-events: none;
        z-index: 100;
    }

    .particle {
        position: absolute;
        width: 6px;
        height: 6px;
        background: var(--accent3);
        border-radius: 50%;
        animation: ripple 1s ease-out forwards;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .calendar-grid {
            gap: 8px;
            padding: 10px;
        }
        
        .day {
            min-height: 80px;
            padding: 8px;
        }
        
        .calendar-controls {
            flex-direction: column;
            gap: 15px;
        }
    }
</style>

<script>
let events = [];
let currentDate = new Date();
const calendar = document.getElementById("calendar");
const currentMonthElement = document.getElementById("currentMonth");
const loadingIndicator = document.getElementById("loading");

// Efecto de part√≠culas
function createParticles(x, y, color) {
    const particles = document.createElement('div');
    particles.className = 'particles';
    
    for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        particle.style.background = color;
        particle.style.setProperty('--delay', i * 0.1 + 's');
        particles.appendChild(particle);
    }
    
    document.body.appendChild(particles);
    setTimeout(() => particles.remove(), 1000);
}

// Mostrar notificaci√≥n toast
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

function createCalendar() {
    calendar.innerHTML = '';
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // Actualizar display del mes
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    currentMonthElement.textContent = `${monthNames[month]} ${year}`;
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();

    // espacios vac√≠os hasta el primer d√≠a
    for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement("div");
        empty.classList.add('day-empty');
        calendar.appendChild(empty);
    }

    // d√≠as del mes
    for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = document.createElement("div");
        dayDiv.classList.add("day");
        
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        dayDiv.dataset.date = dateStr;
        
        // Marcar d√≠a actual
        if (today.getDate() === day && 
            today.getMonth() === month && 
            today.getFullYear() === year) {
            dayDiv.classList.add('current-day');
        }
        
        dayDiv.innerHTML = `<strong>${day}</strong><div class="events"></div>`;
        
        // Efecto al hacer click
        dayDiv.addEventListener('click', function(e) {
            if (e.target === this) {
                createParticles(e.clientX, e.clientY, '#F4D35E');
                this.style.animation = 'shake 0.5s ease';
                setTimeout(() => this.style.animation = '', 500);
                
                const dayEvents = events.filter(ev => ev.date === dateStr);
                if (dayEvents.length > 0) {
                    showToast(`Tienes ${dayEvents.length} evento(s) este d√≠a`, 'info');
                }
            }
        });
        
        calendar.appendChild(dayDiv);
    }

    renderEvents();
}

function loadEvents() {
    loadingIndicator.style.display = 'block';
    
    // Simular carga con timeout para mostrar la animaci√≥n
    setTimeout(() => {
        fetch("/estudiante/api/eventos")
            .then(r => {
                if (!r.ok) throw new Error("Error al cargar eventos");
                return r.json();
            })
            .then(data => {
                console.log("‚úÖ Eventos recibidos:", data);
                events = data.map(e => ({
                    id: e.IdEvento,
                    title: e.Nombre,
                    description: e.Descripcion,
                    date: e.Fecha,
                    time: (e.Hora || '').slice(0,5),
                    role: e.RolDestino,
                    urgent: Math.random() > 0.8 // Simular eventos urgentes
                }));
                renderEvents();
                loadingIndicator.style.display = 'none';
                showToast(`Se cargaron ${events.length} eventos`, 'success');
            })
            .catch(err => {
                console.error("‚ùå Error cargando eventos:", err);
                loadingIndicator.style.display = 'none';
                showToast('Error al cargar eventos', 'error');
            });
    }, 1000);
}

function renderEvents() {
    document.querySelectorAll(".day").forEach(dayDiv => {
        const dayEventsDiv = dayDiv.querySelector(".events");
        dayEventsDiv.innerHTML = '';
        const date = dayDiv.dataset.date;

        const dayEvents = events.filter(ev => ev.date === date);
        
        if (dayEvents.length > 0) {
            dayDiv.classList.add('has-events');
        }

        dayEvents.forEach((ev, index) => {
            const evDiv = document.createElement("div");
            evDiv.classList.add("event");
            if (ev.urgent) {
                evDiv.classList.add("urgent");
            }
            
            evDiv.textContent = `${ev.time} - ${ev.title}`;
            evDiv.onclick = (e) => {
                e.stopPropagation();
                createParticles(e.clientX, e.clientY, '#F95738');
                showEventDetails(ev, index);
            };
            
            // Animaci√≥n de entrada escalonada
            evDiv.style.animation = `fadeIn 0.5s ease ${index * 0.1}s both`;
            dayEventsDiv.appendChild(evDiv);
        });
    });
}

function showEventDetails(ev, index) {
    document.getElementById("detailTitle").textContent = ev.title;
    document.getElementById("detailDate").textContent = ev.date;
    document.getElementById("detailTime").textContent = ev.time || 'Por definir';
    document.getElementById("detailRole").textContent = ev.role || 'Todos los estudiantes';
    document.getElementById("detailDescription").textContent = ev.description || 'Sin descripci√≥n disponible.';
    
    // Badge para eventos urgentes
    const badge = document.getElementById("detailBadge");
    if (ev.urgent) {
        badge.textContent = '‚ö†Ô∏è URGENTE';
        badge.style.background = 'var(--accent1)';
    } else {
        badge.textContent = 'üìÖ Programado';
        badge.style.background = 'var(--accent3)';
    }
    
    const modal = document.getElementById("eventDetails");
    modal.style.display = "flex";
    
    // Efecto de entrada del modal
    const modalContent = modal.querySelector('.modal-content');
    modalContent.style.animation = 'fadeIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
}

function closeModal() {
    const modal = document.getElementById("eventDetails");
    const modalContent = modal.querySelector('.modal-content');
    modalContent.style.animation = 'fadeIn 0.3s ease reverse';
    
    setTimeout(() => {
        modal.style.display = "none";
    }, 300);
}

// Navegaci√≥n entre meses
document.getElementById('prevMonth').addEventListener('click', function() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    createCalendar();
    showToast('Mes anterior', 'info');
});

document.getElementById('nextMonth').addEventListener('click', function() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    createCalendar();
    showToast('Siguiente mes', 'info');
});

// Cerrar modal con ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});

// Cerrar modal haciendo click fuera
document.getElementById('eventDetails').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// inicializar
createCalendar();
loadEvents();
</script>
{% endblock %}